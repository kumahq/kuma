import{d as Te,f as U,cy as Ce,cu as ge,cz as Pe,cA as Le,cB as xe,i as ze,o as i,j as p,l as t,e as a,a as L,w as I,t as k,B as Me,u as r,A as $,F as K,n as H,b as He,C as Ue,D as Ae,E as Ee,p as je,r as w,g as be,R as ke,k as Be,c as Z,m as qe,cC as Ze,cD as Fe,cE as Ge,P as De,q as Ye,G as Je,H as Qe,cs as we,cF as We,cG as Xe,cw as et,cx as tt,cH as at,cv as nt}from"./index.c8e7c817.js";import{C as st}from"./ContentWrapper.7c707ca8.js";import{p as ne,D as lt}from"./patchQueryParam.c472bece.js";import{T as ot}from"./TagList.5f93cc3d.js";import{_ as it}from"./YamlView.vue_vue_type_script_setup_true_lang.14695642.js";import{_ as rt}from"./EmptyBlock.vue_vue_type_script_setup_true_lang.ccd40ead.js";import"./EntityStatus.c76c23bb.js";import"./ErrorBlock.26868ad8.js";import"./LoadingBlock.vue_vue_type_script_setup_true_lang.5817f994.js";import"./index.58caa11d.js";import"./CodeBlock.vue_vue_type_style_index_0_lang.660b597c.js";import"./_commonjsHelpers.f037b798.js";const A=d=>(Ue("data-v-2bce1d35"),d=d(),Ae(),d),dt={class:"entity-summary entity-section-list"},ct={class:"entity-title","data-testid":"data-plane-proxy-title"},ut=A(()=>t("span",{class:"visually-hidden"},"Data plane proxy:",-1)),pt={class:"definition"},mt=A(()=>t("span",null,"Mesh:",-1)),vt={key:0},yt=A(()=>t("h4",null,"Tags",-1)),ft={key:1},_t=A(()=>t("h4",null,"Dependencies",-1)),ht={class:"mt-2 heading-with-icon"},gt=A(()=>t("h4",null,"Insights",-1)),bt={class:"entity-section-list"},kt=["data-testid"],Dt=A(()=>t("span",null,"Connect time:",-1)),wt=["data-testid"],Tt=A(()=>t("span",null,"Disconnect time:",-1)),Ct={class:"definition"},Pt=A(()=>t("span",null,"Control plane instance ID:",-1)),Ut={key:0},At=A(()=>t("summary",null,`
                Responses (acknowledged / sent)
              `,-1)),Et=["data-testid"],Vt=Te({__name:"DataPlaneEntitySummary",props:{dataPlaneOverview:{type:Object,required:!0}},setup(d){const f=d,O={"Partially degraded":"partially_degraded",Offline:"offline",Online:"online"},W=U(()=>{const{name:c,mesh:m,dataplane:v}=f.dataPlaneOverview;return{type:"Dataplane",name:c,mesh:m,networking:v.networking}}),_=U(()=>Ce(f.dataPlaneOverview.dataplane)),j=U(()=>{var m,v;const c=Array.from((v=(m=f.dataPlaneOverview.dataplaneInsight)==null?void 0:m.subscriptions)!=null?v:[]);return c.reverse(),c.map(l=>{const u=l.connectTime!==void 0?ge(l.connectTime):"\u2014",C=l.disconnectTime!==void 0?ge(l.disconnectTime):"\u2014",V=Object.entries(l.status).filter(([h])=>!["total","lastUpdateTime"].includes(h)).map(([h,D])=>{var F,G,B,Y,J;const R=`${(F=D.responsesAcknowledged)!=null?F:0} / ${(G=D.responsesSent)!=null?G:0}`;return{type:h.toUpperCase(),ratio:R,responsesSent:(B=D.responsesSent)!=null?B:0,responsesAcknowledged:(Y=D.responsesAcknowledged)!=null?Y:0,responsesRejected:(J=D.responsesRejected)!=null?J:0}});return{subscription:l,formattedConnectDate:u,formattedDisconnectDate:C,statuses:V}})}),T=U(()=>{const{status:c}=Pe(f.dataPlaneOverview.dataplane,f.dataPlaneOverview.dataplaneInsight);return Le[O[c]]}),x=U(()=>{const c=xe(f.dataPlaneOverview.dataplaneInsight);return c!==null?Object.entries(c).map(([m,v])=>({name:m,version:v})):[]}),E=U(()=>{var h,D;const c=(D=(h=f.dataPlaneOverview.dataplaneInsight)==null?void 0:h.subscriptions)!=null?D:[];if(c.length===0)return[];const m=c[c.length-1];if(!m.version)return[];const v=[],l=m.version.envoy,u=m.version.kumaDp;if(!(l.kumaDpCompatible!==void 0?l.kumaDpCompatible:!0)){const R=`Envoy ${l.version} is not supported by Kuma DP ${u.version}.`;v.push(R)}if(!(u.kumaCpCompatible!==void 0?u.kumaCpCompatible:!0)){const R=`Kuma DP ${u.version} is not supported by this Kuma control plane.`;v.push(R)}return v});return(c,m)=>{const v=ze("router-link");return i(),p("div",dt,[t("section",null,[t("h3",ct,[ut,a(),L(v,{to:{name:"data-plane-detail-view",params:{mesh:d.dataPlaneOverview.mesh,dataPlane:d.dataPlaneOverview.name}}},{default:I(()=>[a(k(d.dataPlaneOverview.name),1)]),_:1},8,["to"]),a(),t("div",{class:Me(`status status--${r(T).appearance}`),"data-testid":"data-plane-status-badge"},k(r(T).title.toLowerCase()),3)]),a(),t("div",pt,[mt,a(),t("span",null,k(d.dataPlaneOverview.mesh),1)])]),a(),r(_).length>0?(i(),p("section",vt,[yt,a(),L(ot,{tags:r(_)},null,8,["tags"])])):$("",!0),a(),r(x).length>0?(i(),p("section",ft,[_t,a(),(i(!0),p(K,null,H(r(x),(l,u)=>(i(),p("div",{key:u,class:"definition"},[t("span",null,k(l.name)+":",1),a(),t("span",null,k(l.version),1)]))),128)),a(),r(E).length>0?(i(),p(K,{key:0},[t("h5",ht,[a(`
          Warnings

          `),L(r(He),{class:"ml-1",icon:"warning",color:"var(--black-75)","secondary-color":"var(--yellow-300)",size:"20"})]),a(),(i(!0),p(K,null,H(r(E),(l,u)=>(i(),p("p",{key:u},k(l),1))),128))],64)):$("",!0)])):$("",!0),a(),r(j).length>0?(i(),p(K,{key:2},[t("section",null,[gt,a(),t("div",bt,[(i(!0),p(K,null,H(r(j),(l,u)=>(i(),p("div",{key:u},[t("div",{class:"definition","data-testid":`data-plane-connect-time-${u}`},[Dt,a(),t("span",null,k(l.formattedConnectDate),1)],8,kt),a(),t("div",{class:"definition","data-testid":`data-plane-disconnect-time-${u}`},[Tt,a(),t("span",null,k(l.formattedDisconnectDate),1)],8,wt),a(),t("div",Ct,[Pt,a(),t("span",null,k(l.subscription.controlPlaneInstanceId),1)]),a(),l.statuses.length>0?(i(),p("details",Ut,[At,a(),(i(!0),p(K,null,H(l.statuses,(C,V)=>(i(),p("div",{key:`${u}-${V}`,class:"definition","data-testid":`data-plane-subscription-status-${u}-${V}`},[t("span",null,k(C.type)+":",1),a(),t("span",null,k(C.ratio),1)],8,Et))),128))])):$("",!0)]))),128))])]),a(),t("section",null,[L(it,{id:"code-block-data-plane-summary",content:r(W),"code-max-height":"250px"},null,8,["content"])])],64)):$("",!0)])}}});const St=Ee(Vt,[["__scopeId","data-v-2bce1d35"]]),Ve=[{key:"status",label:"Status"},{key:"name",label:"Name"},{key:"type",label:"Type"},{key:"service",label:"Service"},{key:"protocol",label:"Protocol"},{key:"zone",label:"Zone"},{key:"lastConnected",label:"Last Connected"},{key:"lastUpdated",label:"Last Updated"},{key:"totalUpdates",label:"Total Updates"},{key:"dpVersion",label:"Kuma DP version"},{key:"envoyVersion",label:"Envoy version"},{key:"details",label:"Details",hideLabel:!0}],It=["name","details"],Kt=Ve.filter(d=>!It.includes(d.key)).map(d=>({tableHeaderKey:d.key,label:d.label,isChecked:!1})),Se=["status","name","type","service","protocol","zone","lastUpdated","dpVersion","details"];function Ot(d,f=Se){return Ve.filter(O=>f.includes(O.key)?d?!0:O.key!=="zone":!1)}const Rt=d=>(Ue("data-v-41943630"),d=d(),Ae(),d),Nt={key:0},$t=Rt(()=>t("label",{for:"data-planes-type-filter",class:"mr-2"},`
              Type:
            `,-1)),Lt=["value"],xt=["for"],zt=["id","checked","onChange"],Mt=Te({__name:"DataPlaneListView",props:{name:{type:String,required:!1,default:null},offset:{type:Number,required:!1,default:0}},setup(d){const f=d,O=50,W=["All","Builtin","Delegated"],_=je(),j=Ye(),T=w(Se),x=w(!0),E=w(!1),c=w(null),m=w(!1),v=w({headers:[],data:[]}),l=w([]),u=w(null),C=w("All"),V=w(f.offset),h=w(null),D=U(()=>j.getters["config/getMulticlusterStatus"]),R=U(()=>({name:j.getters["config/getEnvironment"]==="universal"?"universal-dataplane":"kubernetes-dataplane"})),F=U(()=>{let e=Ot(D.value,T.value);return _.meta.type==="standard"?e=e.filter(n=>n.key!=="type"):e=e.filter(n=>n.key!=="protocol"),{data:v.value.data,headers:e}}),G=U(()=>Kt.filter(e=>_.meta.type==="standard"?e.tableHeaderKey!=="type":e.tableHeaderKey!=="protocol").filter(e=>D.value?!0:e.tableHeaderKey!=="zone").map(e=>{const n=T.value.includes(e.tableHeaderKey);return{...e,isChecked:n}}));be(()=>_.params.mesh,function(){_.name!=="data-plane-list-view"&&_.name!=="gateway-list-view"||(E.value=!1,c.value=null,m.value=!1,Q(0))}),be(C,function(){E.value=!1,c.value=null,m.value=!1,Q(0)});const B=ke.get("dpVisibleTableHeaderKeys");Array.isArray(B)&&(T.value=B),Q(f.offset);function Y(e){e.stopPropagation()}function J(e,n){const g=e.target,o=T.value.findIndex(y=>y===n);g.checked&&o===-1?T.value.push(n):!g.checked&&o>-1&&T.value.splice(o,1),ke.set("dpVisibleTableHeaderKeys",Array.from(new Set(T.value)))}function Ie(){Je.logger.info(Qe.CREATE_DATA_PLANE_PROXY_CLICKED)}function Ke(){return{title:"No Data",message:"There are no data plane proxies present."}}async function Oe(e){var oe,ie,re,de,ce,ue,pe,me;const n=e.mesh,g=e.name,o=((oe=e.dataplane.networking.gateway)==null?void 0:oe.type)||"STANDARD",y={name:o==="STANDARD"?"data-plane-detail-view":"gateway-detail-view",params:{mesh:n,dataPlane:g}},S={name:"mesh-detail-view",params:{mesh:n}},ee=["kuma.io/protocol","kuma.io/service","kuma.io/zone"],z=Ce(e.dataplane).filter(s=>ee.includes(s.label)),N=(ie=z.find(s=>s.label==="kuma.io/service"))==null?void 0:ie.value,te=(re=z.find(s=>s.label==="kuma.io/protocol"))==null?void 0:re.value,q=(de=z.find(s=>s.label==="kuma.io/zone"))==null?void 0:de.value;let se;N!==void 0&&(se={name:"service-insight-detail-view",params:{mesh:n,service:N}});let le;q!==void 0&&(le={name:"zones",query:{ns:q}});const{status:Re}=Pe(e.dataplane,e.dataplaneInsight),Ne=(ue=(ce=e.dataplaneInsight)==null?void 0:ce.subscriptions)!=null?ue:[],$e={totalUpdates:0,totalRejectedUpdates:0,dpVersion:null,envoyVersion:null,selectedTime:NaN,selectedUpdateTime:NaN,version:null},b=Ne.reduce((s,P)=>{var ve,ye,fe,_e;if(P.connectTime){const he=Date.parse(P.connectTime);(!s.selectedTime||he>s.selectedTime)&&(s.selectedTime=he)}const ae=Date.parse(P.status.lastUpdateTime);return ae&&(!s.selectedUpdateTime||ae>s.selectedUpdateTime)&&(s.selectedUpdateTime=ae),{totalUpdates:s.totalUpdates+parseInt((ve=P.status.total.responsesSent)!=null?ve:"0",10),totalRejectedUpdates:s.totalRejectedUpdates+parseInt((ye=P.status.total.responsesRejected)!=null?ye:"0",10),dpVersion:((fe=P.version)==null?void 0:fe.kumaDp.version)||s.dpVersion,envoyVersion:((_e=P.version)==null?void 0:_e.envoy.version)||s.envoyVersion,selectedTime:s.selectedTime,selectedUpdateTime:s.selectedUpdateTime,version:P.version||s.version}},$e),M={name:g,nameRoute:y,mesh:n,meshRoute:S,type:o,zone:q!=null?q:"\u2014",zoneRoute:le,service:N!=null?N:"\u2014",serviceInsightRoute:se,protocol:te!=null?te:"\u2014",status:Re,totalUpdates:b.totalUpdates,totalRejectedUpdates:b.totalRejectedUpdates,dpVersion:(pe=b.dpVersion)!=null?pe:"\u2014",envoyVersion:(me=b.envoyVersion)!=null?me:"\u2014",warnings:[],unsupportedEnvoyVersion:!1,unsupportedKumaDPVersion:!1,kumaDpAndKumaCpMismatch:!1,lastUpdated:b.selectedUpdateTime?we(new Date(b.selectedUpdateTime).toUTCString()):"\u2014",lastConnected:b.selectedTime?we(new Date(b.selectedTime).toUTCString()):"\u2014",overview:e};if(b.version){const{kind:s}=We(b.version);switch(s!==Xe&&M.warnings.push(s),s){case tt:M.unsupportedEnvoyVersion=!0;break;case et:M.unsupportedKumaDPVersion=!0;break}}return D.value&&b.dpVersion&&z.find(P=>P.label===at)&&typeof b.version.kumaDp.kumaCpCompatible=="boolean"&&!b.version.kumaDp.kumaCpCompatible&&(M.warnings.push(nt),M.kumaDpAndKumaCpMismatch=!0),M}async function Q(e){var o;V.value=e,ne("offset",e>0?e:null),x.value=!0;const n=_.params.mesh,g=O;try{const y={All:"true",Builtin:"builtin",Delegated:"delegated"},{items:S,next:ee}=await Be.getAllDataplaneOverviewsFromMesh({mesh:n},{size:g,offset:e,gateway:_.meta.type!=="gateway"?!1:y[C.value]});if(Array.isArray(S)&&S.length>0){u.value=ee,l.value=S,X((o=f.name)!=null?o:S[0].name);const z=await Promise.all(l.value.map(N=>Oe(N)));v.value.data=z,m.value=!1,E.value=!1}else X(null),v.value.data=[],m.value=!0,E.value=!0}catch(y){y instanceof Error?c.value=y:console.error(y),E.value=!0}finally{x.value=!1}}function X(e){var g;const n=l.value;e&&n.length>0?(h.value=(g=n.find(o=>o.name===e))!=null?g:n[0],ne("name",h.value.name)):(h.value=null,ne("name",null))}return(e,n)=>(i(),Z(st,null,{content:I(()=>{var g;return[L(lt,{"selected-entity-name":(g=h.value)==null?void 0:g.name,"page-size":O,"is-loading":x.value,error:c.value,"empty-state":Ke(),"table-data":r(F),"table-data-is-empty":m.value,"show-details":"",next:u.value!==null,"page-offset":V.value,onTableAction:n[1]||(n[1]=o=>X(o.name)),onLoadData:n[2]||(n[2]=o=>Q(o))},{additionalControls:I(()=>[r(_).meta.type==="gateway"?(i(),p("div",Nt,[$t,a(),qe(t("select",{id:"data-planes-type-filter","onUpdate:modelValue":n[0]||(n[0]=o=>C.value=o),"data-testid":"data-planes-type-filter"},[(i(!0),p(K,null,H(r(W),(o,y)=>(i(),p("option",{key:y,value:o},k(o),9,Lt))),128))],512),[[Ze,C.value]])])):$("",!0),a(),L(r(Fe),{label:"Columns",icon:"cogwheel","button-appearance":"outline"},{items:I(()=>[t("div",{onClick:Y},[(i(!0),p(K,null,H(r(G),(o,y)=>(i(),Z(r(Ge),{key:y,class:"table-header-selector-item",item:o},{default:I(()=>[t("label",{for:`data-plane-table-header-checkbox-${y}`,class:"k-checkbox table-header-selector-item-checkbox"},[t("input",{id:`data-plane-table-header-checkbox-${y}`,checked:o.isChecked,type:"checkbox",class:"k-input",onChange:S=>J(S,o.tableHeaderKey)},null,40,zt),a(" "+k(o.label),1)],8,xt)]),_:2},1032,["item"]))),128))])]),_:1}),a(),L(r(De),{class:"add-dp-button",appearance:"creation",to:r(R),icon:"plus","data-testid":"data-plane-create-data-plane-button",onClick:Ie},{default:I(()=>[a(`
            Create data plane proxy
          `)]),_:1},8,["to"]),a(),r(_).query.ns?(i(),Z(r(De),{key:1,appearance:"primary",icon:"arrowLeft",to:{name:r(_).name},"data-testid":"data-plane-ns-back-button"},{default:I(()=>[a(`
            View all
          `)]),_:1},8,["to"])):$("",!0)]),_:1},8,["selected-entity-name","is-loading","error","empty-state","table-data","table-data-is-empty","next","page-offset"])]}),sidebar:I(()=>[h.value!==null?(i(),Z(St,{key:0,"data-plane-overview":h.value},null,8,["data-plane-overview"])):(i(),Z(rt,{key:1}))]),_:1}))}});const ea=Ee(Mt,[["__scopeId","data-v-41943630"]]);export{ea as default};
