import{d as ke,e as w,cz as be,cv as ve,cA as we,cB as Se,h as Ke,o as r,i as m,j as t,b as a,a as U,w as C,t as h,u as c,A as E,F as I,n as N,m as Ne,D as De,E as Te,G as Pe,q as Re,r as F,f as ye,T as fe,ct as _e,cC as $e,cD as Le,cx as xe,cy as Me,cE as ze,cw as He,c as z,s as Be,l as je,cF as qe,cG as Ge,cH as Ze,O as he,H as Fe,I as Ye}from"./index.0c4c6d47.js";import{C as Je}from"./ContentWrapper.0535eefe.js";import{p as ge,D as Qe}from"./patchQueryParam.3ef0b93e.js";import{T as Xe}from"./TagList.0486290a.js";import{S as We}from"./StatusBadge.e9f457ff.js";import{_ as et}from"./YamlView.vue_vue_type_script_setup_true_lang.812a5c39.js";import{_ as tt}from"./EmptyBlock.vue_vue_type_script_setup_true_lang.16c6ba85.js";const A=l=>(De("data-v-5b05c159"),l=l(),Te(),l),at={class:"entity-summary entity-section-list"},nt={class:"block-list"},st={class:"entity-title","data-testid":"data-plane-proxy-title"},ot={class:"definition"},lt=A(()=>t("span",null,"Mesh:",-1)),it={key:0},rt=A(()=>t("h4",null,"Tags",-1)),dt={key:1},ct=A(()=>t("h4",null,"Dependencies",-1)),ut={class:"mt-2 heading-with-icon"},pt={key:0},mt=A(()=>t("h4",null,"Insights",-1)),vt={class:"block-list"},yt=["data-testid"],ft=A(()=>t("span",null,"Connect time:",-1)),_t=["data-testid"],ht=A(()=>t("span",null,"Disconnect time:",-1)),gt={class:"definition"},kt=A(()=>t("span",null,"CP instance ID:",-1)),bt={key:0},wt=A(()=>t("summary",null,`
              Responses (acknowledged / sent)
            `,-1)),Dt=["data-testid"],Tt={class:"config-section"},Pt=ke({__name:"DataPlaneEntitySummary",props:{dataPlaneOverview:{type:Object,required:!0}},setup(l){const _=l,i=w(()=>{const{name:d,mesh:y,dataplane:v}=_.dataPlaneOverview;return{type:"Dataplane",name:d,mesh:y,networking:v.networking}}),H=w(()=>be(_.dataPlaneOverview.dataplane)),B=w(()=>{var y,v;const d=Array.from((v=(y=_.dataPlaneOverview.dataplaneInsight)==null?void 0:y.subscriptions)!=null?v:[]);return d.reverse(),d.map(n=>{const u=n.connectTime!==void 0?ve(n.connectTime):"\u2014",V=n.disconnectTime!==void 0?ve(n.disconnectTime):"\u2014",T=Object.entries(n.status).filter(([P])=>!["total","lastUpdateTime"].includes(P)).map(([P,g])=>{var j,q,G,L,S;const O=`${(j=g.responsesAcknowledged)!=null?j:0} / ${(q=g.responsesSent)!=null?q:0}`;return{type:P.toUpperCase(),ratio:O,responsesSent:(G=g.responsesSent)!=null?G:0,responsesAcknowledged:(L=g.responsesAcknowledged)!=null?L:0,responsesRejected:(S=g.responsesRejected)!=null?S:0}});return{subscription:n,formattedConnectDate:u,formattedDisconnectDate:V,statuses:T}})}),Y=w(()=>{const{status:d}=we(_.dataPlaneOverview.dataplane,_.dataPlaneOverview.dataplaneInsight);return d}),R=w(()=>{const d=Se(_.dataPlaneOverview.dataplaneInsight);return d!==null?Object.entries(d).map(([y,v])=>({name:y,version:v})):[]}),$=w(()=>{var P,g;const d=(g=(P=_.dataPlaneOverview.dataplaneInsight)==null?void 0:P.subscriptions)!=null?g:[];if(d.length===0)return[];const y=d[d.length-1];if(!y.version)return[];const v=[],n=y.version.envoy,u=y.version.kumaDp;if(!(n.kumaDpCompatible!==void 0?n.kumaDpCompatible:!0)){const O=`Envoy ${n.version} is not supported by Kuma DP ${u.version}.`;v.push(O)}if(!(u.kumaCpCompatible!==void 0?u.kumaCpCompatible:!0)){const O=`Kuma DP ${u.version} is not supported by this Kuma control plane.`;v.push(O)}return v});return(d,y)=>{const v=Ke("router-link");return r(),m("div",at,[t("section",null,[t("div",nt,[t("div",null,[t("h3",st,[t("span",null,[a(`
              DPP:

              `),U(v,{to:{name:"data-plane-detail-view",params:{mesh:l.dataPlaneOverview.mesh,dataPlane:l.dataPlaneOverview.name}}},{default:C(()=>[a(h(l.dataPlaneOverview.name),1)]),_:1},8,["to"])]),a(),U(We,{status:c(Y)},null,8,["status"])]),a(),t("div",ot,[lt,a(),t("span",null,h(l.dataPlaneOverview.mesh),1)])]),a(),c(H).length>0?(r(),m("div",it,[rt,a(),U(Xe,{tags:c(H)},null,8,["tags"])])):E("",!0),a(),c(R).length>0?(r(),m("div",dt,[ct,a(),(r(!0),m(I,null,N(c(R),(n,u)=>(r(),m("div",{key:u,class:"definition"},[t("span",null,h(n.name)+":",1),a(),t("span",null,h(n.version),1)]))),128)),a(),c($).length>0?(r(),m(I,{key:0},[t("h5",ut,[a(`
              Warnings

              `),U(c(Ne),{class:"ml-1",icon:"warning",color:"var(--black-75)","secondary-color":"var(--yellow-300)",size:"20"})]),a(),(r(!0),m(I,null,N(c($),(n,u)=>(r(),m("p",{key:u},h(n),1))),128))],64)):E("",!0)])):E("",!0)])]),a(),c(B).length>0?(r(),m("section",pt,[mt,a(),t("div",vt,[(r(!0),m(I,null,N(c(B),(n,u)=>(r(),m("div",{key:u},[t("div",{class:"definition","data-testid":`data-plane-connect-time-${u}`},[ft,a(),t("span",null,h(n.formattedConnectDate),1)],8,yt),a(),t("div",{class:"definition","data-testid":`data-plane-disconnect-time-${u}`},[ht,a(),t("span",null,h(n.formattedDisconnectDate),1)],8,_t),a(),t("div",gt,[kt,a(),t("span",null,h(n.subscription.controlPlaneInstanceId),1)]),a(),n.statuses.length>0?(r(),m("details",bt,[wt,a(),(r(!0),m(I,null,N(n.statuses,(V,T)=>(r(),m("div",{key:`${u}-${T}`,class:"definition","data-testid":`data-plane-subscription-status-${u}-${T}`},[t("span",null,h(V.type)+":",1),a(),t("span",null,h(V.ratio),1)],8,Dt))),128))])):E("",!0)]))),128))])])):E("",!0),a(),t("section",Tt,[U(et,{id:"code-block-data-plane-summary",content:c(i),"code-max-height":"250px"},null,8,["content"])])])}}});const Ct=Pe(Pt,[["__scopeId","data-v-5b05c159"]]),Ce=[{key:"status",label:"Status"},{key:"name",label:"DPP"},{key:"type",label:"Type"},{key:"service",label:"Service"},{key:"protocol",label:"Protocol"},{key:"zone",label:"Zone"},{key:"lastConnected",label:"Last Connected"},{key:"lastUpdated",label:"Last Updated"},{key:"totalUpdates",label:"Total Updates"},{key:"dpVersion",label:"Kuma DP version"},{key:"envoyVersion",label:"Envoy version"},{key:"details",label:"Details",hideLabel:!0}],Ut=["name","details"],At=Ce.filter(l=>!Ut.includes(l.key)).map(l=>({tableHeaderKey:l.key,label:l.label,isChecked:!1})),Ue=["status","name","type","service","protocol","zone","lastUpdated","dpVersion","details"];function Vt(l,_=Ue){return Ce.filter(i=>_.includes(i.key)?l?!0:i.key!=="zone":!1)}const Ot=l=>(De("data-v-e1da3dcf"),l=l(),Te(),l),Et={key:0},It=Ot(()=>t("label",{for:"data-planes-type-filter",class:"mr-2"},`
              Type:
            `,-1)),St=["value"],Kt=["for"],Nt=["id","checked","onChange"],Rt=ke({__name:"DataPlaneList",props:{dataPlaneOverviews:{type:Array,required:!0},isLoading:{type:Boolean,required:!1,default:!1},error:{type:Error,required:!1,default:null},nextUrl:{type:String,required:!1,default:null},pageOffset:{type:Number,required:!1,default:0},selectedDppName:{type:String,required:!1,default:null},isGatewayView:{type:Boolean,required:!1,default:!1}},emits:["gateway-type-change","load-data"],setup(l,{emit:_}){const i=l,H=50,B=["All","Builtin","Delegated"],Y={title:"No Data",message:"There are no data plane proxies present."},R=Re(),$=Be(),d=F(Ue),y=F({headers:[],data:[]}),v=F("All"),n=F(null),u=w(()=>$.getters["config/getMulticlusterStatus"]),V=w(()=>({name:$.getters["config/getEnvironment"]==="universal"?"universal-dataplane":"kubernetes-dataplane"})),T=w(()=>{let e=Vt(u.value,d.value);return i.isGatewayView?e=e.filter(s=>s.key!=="protocol"):e=e.filter(s=>s.key!=="type"),{data:y.value.data,headers:e}}),P=w(()=>At.filter(e=>i.isGatewayView?e.tableHeaderKey!=="protocol":e.tableHeaderKey!=="type").filter(e=>u.value?!0:e.tableHeaderKey!=="zone").map(e=>{const s=d.value.includes(e.tableHeaderKey);return{...e,isChecked:s}}));ye(v,function(){_("gateway-type-change",v.value)}),ye(()=>i.dataPlaneOverviews,function(){L()});const g=fe.get("dpVisibleTableHeaderKeys");Array.isArray(g)&&(d.value=g),L();function O(e){_("load-data",e)}function j(e){e.stopPropagation()}function q(e,s){const k=e.target,p=d.value.findIndex(D=>D===s);k.checked&&p===-1?d.value.push(s):!k.checked&&p>-1&&d.value.splice(p,1),fe.set("dpVisibleTableHeaderKeys",Array.from(new Set(d.value)))}function G(){Fe.logger.info(Ye.CREATE_DATA_PLANE_PROXY_CLICKED)}async function L(){var e;try{Array.isArray(i.dataPlaneOverviews)&&i.dataPlaneOverviews.length>0?(S((e=i.selectedDppName)!=null?e:i.dataPlaneOverviews[0].name),y.value.data=await Promise.all(i.dataPlaneOverviews.map(s=>Ae(s)))):(S(null),y.value.data=[])}catch(s){console.error(s)}}function S(e){var s;e&&i.dataPlaneOverviews.length>0?(n.value=(s=i.dataPlaneOverviews.find(k=>k.name===e))!=null?s:i.dataPlaneOverviews[0],ge(i.isGatewayView?"gateway":"dpp",n.value.name)):(n.value=null,ge(i.isGatewayView?"gateway":"dpp",null))}async function Ae(e){var te,ae,ne,se,oe,le,ie,re;const s=e.mesh,k=e.name,p=((te=e.dataplane.networking.gateway)==null?void 0:te.type)||"STANDARD",D={name:p==="STANDARD"?"data-plane-detail-view":"gateway-detail-view",params:{mesh:s,dataPlane:k}},J={name:"mesh-detail-view",params:{mesh:s}},Ve=["kuma.io/protocol","kuma.io/service","kuma.io/zone"],Z=be(e.dataplane).filter(o=>Ve.includes(o.label)),x=(ae=Z.find(o=>o.label==="kuma.io/service"))==null?void 0:ae.value,Q=(ne=Z.find(o=>o.label==="kuma.io/protocol"))==null?void 0:ne.value,M=(se=Z.find(o=>o.label==="kuma.io/zone"))==null?void 0:se.value;let W;x!==void 0&&(W={name:"service-detail-view",params:{mesh:s,service:x}});let ee;M!==void 0&&(ee={name:"zones",query:{ns:M}});const{status:Oe}=we(e.dataplane,e.dataplaneInsight),Ee=(le=(oe=e.dataplaneInsight)==null?void 0:oe.subscriptions)!=null?le:[],Ie={totalUpdates:0,totalRejectedUpdates:0,dpVersion:null,envoyVersion:null,selectedTime:NaN,selectedUpdateTime:NaN,version:null},f=Ee.reduce((o,b)=>{var de,ce,ue,pe;if(b.connectTime){const me=Date.parse(b.connectTime);(!o.selectedTime||me>o.selectedTime)&&(o.selectedTime=me)}const X=Date.parse(b.status.lastUpdateTime);return X&&(!o.selectedUpdateTime||X>o.selectedUpdateTime)&&(o.selectedUpdateTime=X),{totalUpdates:o.totalUpdates+parseInt((de=b.status.total.responsesSent)!=null?de:"0",10),totalRejectedUpdates:o.totalRejectedUpdates+parseInt((ce=b.status.total.responsesRejected)!=null?ce:"0",10),dpVersion:((ue=b.version)==null?void 0:ue.kumaDp.version)||o.dpVersion,envoyVersion:((pe=b.version)==null?void 0:pe.envoy.version)||o.envoyVersion,selectedTime:o.selectedTime,selectedUpdateTime:o.selectedUpdateTime,version:b.version||o.version}},Ie),K={name:k,nameRoute:D,mesh:s,meshRoute:J,type:p,zone:M!=null?M:"\u2014",zoneRoute:ee,service:x!=null?x:"\u2014",serviceInsightRoute:W,protocol:Q!=null?Q:"\u2014",status:Oe,totalUpdates:f.totalUpdates,totalRejectedUpdates:f.totalRejectedUpdates,dpVersion:(ie=f.dpVersion)!=null?ie:"\u2014",envoyVersion:(re=f.envoyVersion)!=null?re:"\u2014",warnings:[],unsupportedEnvoyVersion:!1,unsupportedKumaDPVersion:!1,kumaDpAndKumaCpMismatch:!1,lastUpdated:f.selectedUpdateTime?_e(new Date(f.selectedUpdateTime).toUTCString()):"\u2014",lastConnected:f.selectedTime?_e(new Date(f.selectedTime).toUTCString()):"\u2014",overview:e};if(f.version){const{kind:o}=$e(f.version);switch(o!==Le&&K.warnings.push(o),o){case Me:K.unsupportedEnvoyVersion=!0;break;case xe:K.unsupportedKumaDPVersion=!0;break}}return u.value&&f.dpVersion&&Z.find(b=>b.label===ze)&&typeof f.version.kumaDp.kumaCpCompatible=="boolean"&&!f.version.kumaDp.kumaCpCompatible&&(K.warnings.push(He),K.kumaDpAndKumaCpMismatch=!0),K}return(e,s)=>(r(),z(Je,null,{content:C(()=>{var k;return[U(Qe,{"selected-entity-name":(k=n.value)==null?void 0:k.name,"page-size":H,"is-loading":i.isLoading,error:l.error,"empty-state":Y,"table-data":c(T),"table-data-is-empty":c(T).data.length===0,"show-details":"",next:i.nextUrl!==null,"page-offset":i.pageOffset,onTableAction:s[1]||(s[1]=p=>S(p.name)),onLoadData:s[2]||(s[2]=p=>O(i.pageOffset))},{additionalControls:C(()=>[i.isGatewayView?(r(),m("div",Et,[It,a(),je(t("select",{id:"data-planes-type-filter","onUpdate:modelValue":s[0]||(s[0]=p=>v.value=p),"data-testid":"data-planes-type-filter"},[(r(!0),m(I,null,N(c(B),(p,D)=>(r(),m("option",{key:D,value:p},h(p),9,St))),128))],512),[[qe,v.value]])])):E("",!0),a(),U(c(Ge),{label:"Columns",icon:"cogwheel","button-appearance":"outline"},{items:C(()=>[t("div",{onClick:j},[(r(!0),m(I,null,N(c(P),(p,D)=>(r(),z(c(Ze),{key:D,class:"table-header-selector-item",item:p},{default:C(()=>[t("label",{for:`data-plane-table-header-checkbox-${D}`,class:"k-checkbox table-header-selector-item-checkbox"},[t("input",{id:`data-plane-table-header-checkbox-${D}`,checked:p.isChecked,type:"checkbox",class:"k-input",onChange:J=>q(J,p.tableHeaderKey)},null,40,Nt),a(" "+h(p.label),1)],8,Kt)]),_:2},1032,["item"]))),128))])]),_:1}),a(),U(c(he),{appearance:"creation",to:c(V),icon:"plus","data-testid":"data-plane-create-data-plane-button",onClick:G},{default:C(()=>[a(`
            Create data plane proxy
          `)]),_:1},8,["to"]),a(),c(R).query.ns?(r(),z(c(he),{key:1,appearance:"primary",icon:"arrowLeft",to:{name:c(R).name},"data-testid":"data-plane-ns-back-button"},{default:C(()=>[a(`
            View All
          `)]),_:1},8,["to"])):E("",!0)]),_:1},8,["selected-entity-name","is-loading","error","table-data","table-data-is-empty","next","page-offset"])]}),sidebar:C(()=>[n.value!==null?(r(),z(Ct,{key:0,"data-plane-overview":n.value},null,8,["data-plane-overview"])):(r(),z(tt,{key:1}))]),_:1}))}});const jt=Pe(Rt,[["__scopeId","data-v-e1da3dcf"]]);export{jt as D};
