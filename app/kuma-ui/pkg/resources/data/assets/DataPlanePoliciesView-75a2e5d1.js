import{A as F,a as V}from"./AccordionList-1bf0a552.js";import{d as D,N as I,a as T,o as t,c as l,p as u,f as c,F as _,J as B,t as y,e as f,w as a,v as x,b as p,$ as J,z as X,A as Z,_ as z,l as U,n as ee,q as A}from"./index-68e88176.js";import{_ as Y}from"./CodeBlock.vue_vue_type_style_index_0_lang-705a141e.js";import{P as Q}from"./PolicyTypeTag-2e943c3f.js";import{T as H}from"./TagList-17487963.js";import{t as M}from"./toYaml-4e00099e.js";import{E as O}from"./ErrorBlock-da53de46.js";import{_ as q}from"./LoadingBlock.vue_vue_type_script_setup_true_lang-809764e3.js";import"./index-52545d1d.js";import"./TextWithCopyButton-319c2206.js";import"./CopyButton-ab771b52.js";import"./WarningIcon.vue_vue_type_script_setup_true_lang-a5e56b96.js";const S=w=>(X("data-v-d33ad9ee"),w=w(),Z(),w),te={class:"policies-list","data-testid":"builtin-gateway-dataplane-policies"},se={class:"mesh-gateway-policy-list"},oe=S(()=>u("h3",{class:"mb-2"},`
        Gateway policies
      `,-1)),ne={key:0},ae=S(()=>u("h3",{class:"mt-6 mb-2"},`
        Listeners
      `,-1)),le=S(()=>u("b",null,"Host",-1)),ce=S(()=>u("h4",{class:"mt-2 mb-2"},`
                Routes
              `,-1)),ie={class:"dataplane-policy-header"},re=S(()=>u("b",null,"Route",-1)),pe=S(()=>u("b",null,"Service",-1)),ue={key:0,class:"badge-list"},de={class:"mt-1"},ye=D({__name:"BuiltinGatewayPolicies",props:{gatewayDataplane:{},policyTypesByName:{}},setup(w){const v=w,m=I(()=>R(v.gatewayDataplane)),C=I(()=>N(v.gatewayDataplane.policies));function R(g){const $=[],d=g.listeners??[];for(const h of d)for(const e of h.hosts)for(const s of e.routes){const o=[];for(const n of s.destinations){const i=N(n.policies),r={routeName:s.route,route:{name:"policy-detail-view",params:{mesh:g.gateway.mesh,policyPath:"meshgatewayroutes",policy:s.route}},service:n.tags["kuma.io/service"],policies:i};o.push(r)}$.push({protocol:h.protocol,port:h.port,hostName:e.hostName,routeEntries:o})}return $}function N(g){if(g===void 0)return[];const $=[];for(const d of Object.values(g)){const h=v.policyTypesByName[d.type];$.push({type:d.type,name:d.name,route:{name:"policy-detail-view",params:{mesh:d.mesh,policyPath:h.path,policy:d.name}}})}return $}return(g,$)=>{const d=T("router-link"),h=T("KBadge"),e=T("RouterLink");return t(),l("div",te,[u("div",se,[oe,c(),C.value.length>0?(t(),l("ul",ne,[(t(!0),l(_,null,B(C.value,(s,o)=>(t(),l("li",{key:o},[u("span",null,y(s.type),1),c(`:

          `),f(d,{to:s.route},{default:a(()=>[c(y(s.name),1)]),_:2},1032,["to"])]))),128))])):x("",!0),c(),ae,c(),u("div",null,[(t(!0),l(_,null,B(m.value,(s,o)=>(t(),l("div",{key:o},[u("div",null,[u("div",null,[le,c(": "+y(s.hostName)+":"+y(s.port)+" ("+y(s.protocol)+`)
            `,1)]),c(),s.routeEntries.length>0?(t(),l(_,{key:0},[ce,c(),f(V,{"initially-open":[],"multiple-open":""},{default:a(()=>[(t(!0),l(_,null,B(s.routeEntries,(n,i)=>(t(),p(F,{key:i},J({"accordion-header":a(()=>[u("div",ie,[u("div",null,[u("div",null,[re,c(": "),f(d,{to:n.route},{default:a(()=>[c(y(n.routeName),1)]),_:2},1032,["to"])]),c(),u("div",null,[pe,c(": "+y(n.service),1)])]),c(),n.policies.length>0?(t(),l("div",ue,[(t(!0),l(_,null,B(n.policies,(r,k)=>(t(),p(h,{key:`${o}-${k}`},{default:a(()=>[c(y(r.type),1)]),_:2},1024))),128))])):x("",!0)])]),_:2},[n.policies.length>0?{name:"accordion-content",fn:a(()=>[u("ul",de,[(t(!0),l(_,null,B(n.policies,(r,k)=>(t(),l("li",{key:`${o}-${k}`},[c(y(r.type)+`:

                        `,1),f(e,{to:r.route},{default:a(()=>[c(y(r.name),1)]),_:2},1032,["to"])]))),128))])]),key:"0"}:void 0]),1024))),128))]),_:2},1024)],64)):x("",!0)])]))),128))])])])}}});const _e=z(ye,[["__scopeId","data-v-d33ad9ee"]]),me={class:"policy-type-heading"},he={class:"policy-list"},fe={key:0},ge=D({__name:"PolicyTypeEntryList",props:{id:{},policyTypeEntries:{}},setup(w){const v=[{label:"From",key:"sourceTags"},{label:"To",key:"destinationTags"},{label:"On",key:"name"},{label:"Conf",key:"config"},{label:"Origin policies",key:"origins"}],m=w;function C({headerKey:R}){return{class:`cell-${R}`}}return(R,N)=>{const g=T("router-link"),$=T("KTable");return t(),p(V,{"initially-open":[],"multiple-open":""},{default:a(()=>[(t(!0),l(_,null,B(m.policyTypeEntries,(d,h)=>(t(),p(F,{key:h},{"accordion-header":a(()=>[u("h3",me,[f(Q,{"policy-type":d.type},{default:a(()=>[c(y(d.type)+" ("+y(d.connections.length)+`)
          `,1)]),_:2},1032,["policy-type"])])]),"accordion-content":a(()=>[u("div",he,[f($,{class:"policy-type-table",fetcher:()=>({data:d.connections,total:d.connections.length}),headers:v,"cell-attrs":C,"disable-pagination":"","is-clickable":""},{sourceTags:a(({rowValue:e})=>[e.length>0?(t(),p(H,{key:0,class:"tag-list","should-truncate":"",tags:e},null,8,["tags"])):(t(),l(_,{key:1},[c(`
                —
              `)],64))]),destinationTags:a(({rowValue:e})=>[e.length>0?(t(),p(H,{key:0,class:"tag-list","should-truncate":"",tags:e},null,8,["tags"])):(t(),l(_,{key:1},[c(`
                —
              `)],64))]),name:a(({rowValue:e})=>[e!==null?(t(),l(_,{key:0},[c(y(e),1)],64)):(t(),l(_,{key:1},[c(`
                —
              `)],64))]),origins:a(({rowValue:e})=>[e.length>0?(t(),l("ul",fe,[(t(!0),l(_,null,B(e,(s,o)=>(t(),l("li",{key:`${h}-${o}`},[f(g,{to:s.route},{default:a(()=>[c(y(s.name),1)]),_:2},1032,["to"])]))),128))])):(t(),l(_,{key:1},[c(`
                —
              `)],64))]),config:a(({rowValue:e,rowKey:s})=>[e!==null?(t(),p(Y,{key:0,id:`${m.id}-${h}-${s}-code-block`,code:e,language:"yaml","show-copy-button":!1},null,8,["id","code"])):(t(),l(_,{key:1},[c(`
                —
              `)],64))]),_:2},1032,["fetcher"])])]),_:2},1024))),128))]),_:1})}}});const ke=z(ge,[["__scopeId","data-v-cd1528a1"]]),ve={class:"policy-type-heading"},be={class:"policy-list"},$e={key:0,class:"matcher"},we={key:0,class:"matcher__and"},Te={key:1,class:"matcher__not"},Re={class:"matcher__term"},Pe={key:1},Be={key:0},Le=D({__name:"RuleEntryList",props:{id:{},ruleEntries:{},showMatchers:{type:Boolean,default:!0}},setup(w){const{t:v}=U(),m=w;function C({headerKey:R}){return{class:`cell-${R}`}}return(R,N)=>{const g=T("RouterLink"),$=T("KTable");return t(),p(V,{"initially-open":[],"multiple-open":""},{default:a(()=>[(t(!0),l(_,null,B(m.ruleEntries,(d,h)=>(t(),p(F,{key:h},{"accordion-header":a(()=>[u("h3",ve,[f(Q,{"policy-type":d.type},{default:a(()=>[c(y(d.type),1)]),_:2},1032,["policy-type"])])]),"accordion-content":a(()=>[u("div",be,[f($,{class:ee(["policy-type-table",{"policy-type-table--with-matchers":m.showMatchers}]),fetcher:()=>({data:d.rules,total:d.rules.length}),headers:[...m.showMatchers?[{label:"Matchers",key:"matchers"}]:[],{label:"Origin policies",key:"origins"},{label:"Conf",key:"config"}],"cell-attrs":C,"disable-pagination":""},J({origins:a(({row:e})=>[e.origins.length>0?(t(),l("ul",Be,[(t(!0),l(_,null,B(e.origins,(s,o)=>(t(),l("li",{key:`${h}-${o}`},[f(g,{to:s.route},{default:a(()=>[c(y(s.name),1)]),_:2},1032,["to"])]))),128))])):(t(),l(_,{key:1},[c(y(A(v)("common.collection.none")),1)],64))]),config:a(({row:e,rowKey:s})=>[e.config!==void 0?(t(),p(Y,{key:0,id:`${m.id}-${h}-${s}-code-block`,code:e.config,language:"yaml","show-copy-button":!1},null,8,["id","code"])):(t(),l(_,{key:1},[c(y(A(v)("common.collection.none")),1)],64))]),_:2},[m.showMatchers?{name:"matchers",fn:a(({row:e})=>[e.matchers&&e.matchers.length>0?(t(),l("span",$e,[(t(!0),l(_,null,B(e.matchers,({key:s,value:o,not:n},i)=>(t(),l(_,{key:i},[i>0?(t(),l("span",we," and ")):x("",!0),n?(t(),l("span",Te,"!")):x("",!0),u("span",Re,y(`${s}:${o}`),1)],64))),128))])):(t(),l("i",Pe,y(A(v)("data-planes.routes.item.matches_everything")),1))]),key:"0"}:void 0]),1032,["class","fetcher","headers"])])]),_:2},1024))),128))]),_:1})}}});const j=z(Le,[["__scopeId","data-v-ce204159"]]),Ce={"data-testid":"standard-dataplane-policies",class:"stack"},Ne={class:"mb-2"},Ee=D({__name:"StandardDataplanePolicies",props:{sidecarDataplanes:{},inspectRulesForDataplane:{},policyTypesByName:{},showPoliciesSection:{type:Boolean}},setup(w){const{t:v}=U(),m=w,C=I(()=>$(m.sidecarDataplanes)),R=I(()=>{const e=m.inspectRulesForDataplane.rules.find(r=>r.proxyRule);if(!e||!e.proxyRule)return null;const{type:s,proxyRule:o}=e,n=o.conf&&Object.keys(o.conf).length>0?M(o.conf):void 0,i=o.origin.map(r=>{const k=m.policyTypesByName[r.type];return{name:r.name,route:{name:"policy-detail-view",params:{mesh:r.mesh,policyPath:k.path,policy:r.name}}}});return{type:s,rules:[{config:n,origins:i}]}}),N=I(()=>{const e=[];for(const s of m.inspectRulesForDataplane.rules){const o=s.toRules??[];o.length>0&&e.push({type:s.type,rules:h(o)})}return e.sort((s,o)=>s.type.localeCompare(o.type)),e}),g=I(()=>{const e=new Map;for(const o of m.inspectRulesForDataplane.rules){const n=o.fromRules??[];if(n.length!==0)for(const i of n)e.has(i.inbound.port)||e.set(i.inbound.port,[]),e.get(i.inbound.port).push({type:o.type,rules:h(i.rules)})}for(const[,o]of e)o.sort((n,i)=>n.type.localeCompare(i.type));const s=Array.from(e);return s.sort(([o],[n])=>n-o),s.map(([o,n])=>({port:o,ruleEntries:n}))});function $(e){const s=new Map;for(const n of e){const{type:i,service:r}=n,k=typeof r=="string"&&r!==""?[{label:"kuma.io/service",value:r}]:[],P=i==="inbound"||i==="outbound"?n.name:null;for(const[b,E]of Object.entries(n.matchedPolicies)){s.has(b)||s.set(b,{type:b,connections:[]});const L=s.get(b),K=m.policyTypesByName[b];for(const G of E){const W=d(G,K,n,k,P);L.connections.push(...W)}}}const o=Array.from(s.values());return o.sort((n,i)=>n.type.localeCompare(i.type)),o}function d(e,s,o,n,i){const r=e.conf&&Object.keys(e.conf).length>0?M(e.conf):null,P=[{name:e.name,route:{name:"policy-detail-view",params:{mesh:e.mesh,policyPath:s.path,policy:e.name}}}],b=[];if(o.type==="inbound"&&Array.isArray(e.sources))for(const{match:E}of e.sources){const K={sourceTags:[{label:"kuma.io/service",value:E["kuma.io/service"]}],destinationTags:n,name:i,config:r,origins:P};b.push(K)}else{const L={sourceTags:[],destinationTags:n,name:i,config:r,origins:P};b.push(L)}return b}function h(e){return e.map(({conf:s,matchers:o,origin:n})=>{const i=s&&Object.keys(s).length>0?M(s):void 0,r=n.map(k=>{const P=m.policyTypesByName[k.type];return{name:k.name,route:{name:"policy-detail-view",params:{mesh:k.mesh,policyPath:P.path,policy:k.name}}}});return{config:i,matchers:o,origins:r}})}return(e,s)=>{const o=T("KCard");return t(),l("div",Ce,[m.showPoliciesSection?(t(),p(o,{key:0},{default:a(()=>[f(ke,{id:"policies","policy-type-entries":C.value,"data-testid":"policy-list"},null,8,["policy-type-entries"])]),_:1})):x("",!0),c(),R.value?(t(),p(o,{key:1},{default:a(()=>[u("h3",null,y(A(v)("data-planes.routes.item.proxy_rule")),1),c(),f(j,{id:"proxy-rules",class:"mt-2","rule-entries":[R.value],"show-matchers":!1,"data-testid":"proxy-rule-list"},null,8,["rule-entries"])]),_:1})):x("",!0),c(),N.value.length>0?(t(),p(o,{key:2},{default:a(()=>[u("h3",null,y(A(v)("data-planes.routes.item.to_rules")),1),c(),f(j,{id:"to-rules",class:"mt-2","rule-entries":N.value,"data-testid":"to-rule-list"},null,8,["rule-entries"])]),_:1})):x("",!0),c(),g.value.length>0?(t(),p(o,{key:3},{default:a(()=>[u("h3",Ne,y(A(v)("data-planes.routes.item.from_rules")),1),c(),(t(!0),l(_,null,B(g.value,(n,i)=>(t(),l("div",{key:i},[u("h4",null,y(A(v)("data-planes.routes.item.port",{port:n.port})),1),c(),f(j,{id:`from-rules-${i}`,class:"mt-2","rule-entries":n.ruleEntries,"data-testid":`from-rule-list-${i}`},null,8,["id","rule-entries","data-testid"])]))),128))]),_:1})):x("",!0)])}}}),ze=D({__name:"DataPlanePoliciesView",props:{data:{}},setup(w){const v=w;return(m,C)=>{const R=T("RouteTitle"),N=T("KCard"),g=T("DataSource"),$=T("AppView"),d=T("RouteView");return t(),p(d,{name:"data-plane-policies-view",params:{mesh:"",dataPlane:""}},{default:a(({can:h,route:e,t:s})=>[f($,null,{title:a(()=>[u("h2",null,[f(R,{title:s("data-planes.routes.item.navigation.data-plane-policies-view")},null,8,["title"])])]),default:a(()=>{var o,n,i;return[c(),((i=(n=(o=v.data.dataplane)==null?void 0:o.networking)==null?void 0:n.gateway)==null?void 0:i.type)==="BUILTIN"?(t(),p(g,{key:0,src:"/*/policy-types"},{default:a(({data:r,error:k})=>[f(g,{src:`/meshes/${e.params.mesh}/dataplanes/${e.params.dataPlane}/gateway-dataplane-policies`},{default:a(({data:P,error:b})=>[k?(t(),p(O,{key:0,error:k},null,8,["error"])):b?(t(),p(O,{key:1,error:b},null,8,["error"])):P===void 0||r===void 0?(t(),p(q,{key:2})):(t(),p(N,{key:3},{default:a(()=>[f(_e,{"policy-types-by-name":r.policies.reduce((E,L)=>Object.assign(E,{[L.name]:L}),{}),"gateway-dataplane":P},null,8,["policy-types-by-name","gateway-dataplane"])]),_:2},1024))]),_:2},1032,["src"])]),_:2},1024)):(t(),p(g,{key:1,src:"/*/policy-types"},{default:a(({data:r,error:k})=>[f(g,{src:`/meshes/${e.params.mesh}/dataplanes/${e.params.dataPlane}/sidecar-dataplane-policies`},{default:a(({data:P,error:b})=>[f(g,{src:`/meshes/${e.params.mesh}/dataplanes/${e.params.dataPlane}/rules`},{default:a(({data:E,error:L})=>[k?(t(),p(O,{key:0,error:k},null,8,["error"])):b?(t(),p(O,{key:1,error:b},null,8,["error"])):L?(t(),p(O,{key:2,error:L},null,8,["error"])):r===void 0||P===void 0||E===void 0?(t(),p(q,{key:3})):(t(),p(Ee,{key:4,"policy-types-by-name":r.policies.reduce((K,G)=>Object.assign(K,{[G.name]:G}),{}),"sidecar-dataplanes":P.items,"inspect-rules-for-dataplane":E,"show-policies-section":!h("use zones")},null,8,["policy-types-by-name","sidecar-dataplanes","inspect-rules-for-dataplane","show-policies-section"]))]),_:2},1032,["src"])]),_:2},1032,["src"])]),_:2},1024))]}),_:2},1024)]),_:1})}}});export{ze as default};
