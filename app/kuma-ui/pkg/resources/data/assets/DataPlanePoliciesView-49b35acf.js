import{d as j,r as H,o as e,e as s,g as n,F as y,v as A,i as p,t as f,h as d,w as o,f as q,a as b,E as oe,b as x,Y as ie,q as le,s as ce,B as Q,l as R,c as re,O as ue,k as pe}from"./index-229bb8cf.js";import{A as Y,a as U}from"./AccordionList-998ba25b.js";import{f as M,o as ye,h as W,E as X,t as de,g as _e,A as me,i as he,_ as ge}from"./RouteView.vue_vue_type_script_setup_true_lang-2c668296.js";import{_ as Z}from"./CodeBlock.vue_vue_type_style_index_0_lang-ea26346a.js";import{P as V}from"./PolicyTypeTag-9c0bef51.js";import{T as B}from"./TagList-0bd0a6fd.js";import{t as J}from"./toYaml-4e00099e.js";import{_ as ve}from"./RouteTitle.vue_vue_type_script_setup_true_lang-26164d70.js";import"./WarningIcon.vue_vue_type_script_setup_true_lang-2b7f9434.js";const I=h=>(le("data-v-23b43ae3"),h=h(),ce(),h),fe={class:"mesh-gateway-policy-list"},ke=I(()=>p("h3",{class:"mb-2"},`
      Gateway policies
    `,-1)),be={key:0},Te=I(()=>p("h3",{class:"mt-6 mb-2"},`
      Listeners
    `,-1)),we=I(()=>p("b",null,"Host",-1)),$e=I(()=>p("h4",{class:"mt-2 mb-2"},`
              Routes
            `,-1)),Pe={class:"dataplane-policy-header"},Ee=I(()=>p("b",null,"Route",-1)),Oe=I(()=>p("b",null,"Service",-1)),Le={key:0,class:"badge-list"},Ae={class:"mt-1"},De=j({__name:"MeshGatewayDataplanePolicyList",props:{meshGatewayDataplane:{type:Object,required:!0},meshGatewayListenerEntries:{type:Array,required:!0},meshGatewayRoutePolicies:{type:Array,required:!0}},setup(h){const r=h;return(L,P)=>{const w=H("router-link");return e(),s("div",fe,[ke,n(),h.meshGatewayRoutePolicies.length>0?(e(),s("ul",be,[(e(!0),s(y,null,A(h.meshGatewayRoutePolicies,(g,k)=>(e(),s("li",{key:k},[p("span",null,f(g.type),1),n(`:

        `),d(w,{to:g.route},{default:o(()=>[n(f(g.name),1)]),_:2},1032,["to"])]))),128))])):q("",!0),n(),Te,n(),p("div",null,[(e(!0),s(y,null,A(r.meshGatewayListenerEntries,(g,k)=>(e(),s("div",{key:k},[p("div",null,[p("div",null,[we,n(": "+f(g.hostName)+":"+f(g.port)+" ("+f(g.protocol)+`)
          `,1)]),n(),g.routeEntries.length>0?(e(),s(y,{key:0},[$e,n(),d(U,{"initially-open":[],"multiple-open":""},{default:o(()=>[(e(!0),s(y,null,A(g.routeEntries,(u,$)=>(e(),b(Y,{key:$},oe({"accordion-header":o(()=>[p("div",Pe,[p("div",null,[p("div",null,[Ee,n(": "),d(w,{to:u.route},{default:o(()=>[n(f(u.routeName),1)]),_:2},1032,["to"])]),n(),p("div",null,[Oe,n(": "+f(u.service),1)])]),n(),u.policies.length>0?(e(),s("div",Le,[(e(!0),s(y,null,A(u.policies,(t,_)=>(e(),b(x(ie),{key:`${k}-${_}`},{default:o(()=>[n(f(t.type),1)]),_:2},1024))),128))])):q("",!0)])]),_:2},[u.policies.length>0?{name:"accordion-content",fn:o(()=>[p("ul",Ae,[(e(!0),s(y,null,A(u.policies,(t,_)=>(e(),s("li",{key:`${k}-${_}`},[n(f(t.type)+`:

                      `,1),d(w,{to:t.route},{default:o(()=>[n(f(t.name),1)]),_:2},1032,["to"])]))),128))])]),key:"0"}:void 0]),1024))),128))]),_:2},1024)],64)):q("",!0)])]))),128))])])}}});const Ge=M(De,[["__scopeId","data-v-23b43ae3"]]),Ce={class:"policy-type-heading"},Re={class:"policy-list"},Ne={key:0},Se=j({__name:"PolicyTypeEntryList",props:{id:{type:String,required:!1,default:"entry-list"},policyTypeEntries:{type:Object,required:!0}},setup(h){const r=h,L=[{label:"From",key:"sourceTags"},{label:"To",key:"destinationTags"},{label:"On",key:"name"},{label:"Conf",key:"config"},{label:"Origin policies",key:"origins"}];function P({headerKey:w}){return{class:`cell-${w}`}}return(w,g)=>{const k=H("router-link");return e(),b(U,{"initially-open":[],"multiple-open":""},{default:o(()=>[(e(!0),s(y,null,A(r.policyTypeEntries,(u,$)=>(e(),b(Y,{key:$},{"accordion-header":o(()=>[p("h3",Ce,[d(V,{"policy-type":u.type},{default:o(()=>[n(f(u.type)+" ("+f(u.connections.length)+`)
          `,1)]),_:2},1032,["policy-type"])])]),"accordion-content":o(()=>[p("div",Re,[d(x(Q),{class:"policy-type-table",fetcher:()=>({data:u.connections,total:u.connections.length}),headers:L,"cell-attrs":P,"disable-pagination":"","is-clickable":""},{sourceTags:o(({rowValue:t})=>[t.length>0?(e(),b(B,{key:0,class:"tag-list",tags:t},null,8,["tags"])):(e(),s(y,{key:1},[n(`
                —
              `)],64))]),destinationTags:o(({rowValue:t})=>[t.length>0?(e(),b(B,{key:0,class:"tag-list",tags:t},null,8,["tags"])):(e(),s(y,{key:1},[n(`
                —
              `)],64))]),name:o(({rowValue:t})=>[t!==null?(e(),s(y,{key:0},[n(f(t),1)],64)):(e(),s(y,{key:1},[n(`
                —
              `)],64))]),origins:o(({rowValue:t})=>[t.length>0?(e(),s("ul",Ne,[(e(!0),s(y,null,A(t,(_,G)=>(e(),s("li",{key:`${$}-${G}`},[d(k,{to:_.route},{default:o(()=>[n(f(_.name),1)]),_:2},1032,["to"])]))),128))])):(e(),s(y,{key:1},[n(`
                —
              `)],64))]),config:o(({rowValue:t,rowKey:_})=>[t!==null?(e(),b(Z,{key:0,id:`${r.id}-${$}-${_}-code-block`,code:t,language:"yaml","show-copy-button":!1},null,8,["id","code"])):(e(),s(y,{key:1},[n(`
                —
              `)],64))]),_:2},1032,["fetcher"])])]),_:2},1024))),128))]),_:1})}}});const qe=M(Se,[["__scopeId","data-v-9a1971d5"]]),je={class:"policy-type-heading"},Ie={class:"policy-list"},xe={key:1,class:"tag-list-wrapper"},Be={key:0},Me={key:1},Fe={key:0},He={key:0},Ye=j({__name:"RuleEntryList",props:{id:{type:String,required:!1,default:"entry-list"},ruleEntries:{type:Object,required:!0}},setup(h){const r=h,L=[{label:"Type",key:"type"},{label:"Addresses",key:"addresses"},{label:"Conf",key:"config"},{label:"Origin policies",key:"origins"}];function P({headerKey:w}){return{class:`cell-${w}`}}return(w,g)=>{const k=H("router-link");return e(),b(U,{"initially-open":[],"multiple-open":""},{default:o(()=>[(e(!0),s(y,null,A(r.ruleEntries,(u,$)=>(e(),b(Y,{key:$},{"accordion-header":o(()=>[p("h3",je,[d(V,{"policy-type":u.type},{default:o(()=>[n(f(u.type)+" ("+f(u.connections.length)+`)
          `,1)]),_:2},1032,["policy-type"])])]),"accordion-content":o(()=>[p("div",Ie,[d(x(Q),{class:"policy-type-table",fetcher:()=>({data:u.connections,total:u.connections.length}),headers:L,"cell-attrs":P,"disable-pagination":"","is-clickable":""},{type:o(({rowValue:t})=>[t.sourceTags.length===0&&t.destinationTags.length===0?(e(),s(y,{key:0},[n(`
                —
              `)],64)):(e(),s("div",xe,[t.sourceTags.length>0?(e(),s("div",Be,[n(`
                  From

                  `),d(B,{class:"tag-list",tags:t.sourceTags},null,8,["tags"])])):q("",!0),n(),t.destinationTags.length>0?(e(),s("div",Me,[n(`
                  To

                  `),d(B,{class:"tag-list",tags:t.destinationTags},null,8,["tags"])])):q("",!0)]))]),addresses:o(({rowValue:t})=>[t.length>0?(e(),s("ul",Fe,[(e(!0),s(y,null,A(t,(_,G)=>(e(),s("li",{key:`${$}-${G}`},f(_),1))),128))])):(e(),s(y,{key:1},[n(`
                —
              `)],64))]),origins:o(({rowValue:t})=>[t.length>0?(e(),s("ul",He,[(e(!0),s(y,null,A(t,(_,G)=>(e(),s("li",{key:`${$}-${G}`},[d(k,{to:_.route},{default:o(()=>[n(f(_.name),1)]),_:2},1032,["to"])]))),128))])):(e(),s(y,{key:1},[n(`
                —
              `)],64))]),config:o(({rowValue:t,rowKey:_})=>[t!==null?(e(),b(Z,{key:0,id:`${r.id}-${$}-${_}-code-block`,code:t,language:"yaml","show-copy-button":!1},null,8,["id","code"])):(e(),s(y,{key:1},[n(`
                —
              `)],64))]),_:2},1032,["fetcher"])])]),_:2},1024))),128))]),_:1})}}});const Ue=M(Ye,[["__scopeId","data-v-3e59037c"]]),Ke=p("h2",{class:"visually-hidden"},`
    Policies
  `,-1),ze={key:0,class:"mt-2"},Je=p("h2",{class:"mb-2"},`
      Rules
    `,-1),Qe=j({__name:"SidecarDataplanePolicyList",props:{dppName:{type:String,required:!0},policyTypeEntries:{type:Object,required:!0},ruleEntries:{type:Array,required:!0}},setup(h){const r=h;return(L,P)=>(e(),s(y,null,[Ke,n(),d(qe,{id:"policies","policy-type-entries":r.policyTypeEntries,"data-testid":"policy-list"},null,8,["policy-type-entries"]),n(),h.ruleEntries.length>0?(e(),s("div",ze,[Je,n(),d(Ue,{id:"rules","rule-entries":r.ruleEntries,"data-testid":"rule-list"},null,8,["rule-entries"])])):q("",!0)],64))}}),We={key:2,class:"policies-list"},Xe={key:3,class:"policies-list"},Ze=j({__name:"DataplanePolicies",props:{dataplaneOverview:{type:Object,required:!0},policyTypes:{type:Array,required:!0}},setup(h){const r=h,L=ye(),P=R(null),w=R([]),g=R([]),k=R([]),u=R([]),$=R(!0),t=R(null),_=re(()=>r.policyTypes.reduce((i,l)=>Object.assign(i,{[l.name]:l}),{}));ue(()=>r.dataplaneOverview.name,function(){G()}),G();async function G(){var i,l;t.value=null,$.value=!0,w.value=[],g.value=[],k.value=[],u.value=[];try{if(((l=(i=r.dataplaneOverview.dataplane.networking.gateway)==null?void 0:i.type)==null?void 0:l.toUpperCase())==="BUILTIN")P.value=await L.getMeshGatewayDataplane({mesh:r.dataplaneOverview.mesh,name:r.dataplaneOverview.name}),k.value=ee(P.value),u.value=K(P.value.policies);else{const{items:a}=await L.getSidecarDataplanePolicies({mesh:r.dataplaneOverview.mesh,name:r.dataplaneOverview.name});w.value=te(a??[]);const{items:m}=await L.getDataplaneRules({mesh:r.dataplaneOverview.mesh,name:r.dataplaneOverview.name});g.value=ne(m??[])}}catch(c){c instanceof Error?t.value=c:console.error(c)}finally{$.value=!1}}function ee(i){const l=[],c=i.listeners??[];for(const a of c)for(const m of a.hosts)for(const T of m.routes){const E=[];for(const O of T.destinations){const v=K(O.policies),C={routeName:T.route,route:{name:"policy-detail-view",params:{mesh:i.gateway.mesh,policyPath:"meshgatewayroutes",policy:T.route}},service:O.tags["kuma.io/service"],policies:v};E.push(C)}l.push({protocol:a.protocol,port:a.port,hostName:m.hostName,routeEntries:E})}return l}function K(i){if(i===void 0)return[];const l=[];for(const c of Object.values(i)){const a=_.value[c.type];l.push({type:c.type,name:c.name,route:{name:"policy-detail-view",params:{mesh:c.mesh,policyPath:a.path,policy:c.name}}})}return l}function te(i){const l=new Map;for(const a of i){const{type:m,service:T}=a,E=typeof T=="string"&&T!==""?[{label:"kuma.io/service",value:T}]:[],O=m==="inbound"||m==="outbound"?a.name:null;for(const[v,C]of Object.entries(a.matchedPolicies)){l.has(v)||l.set(v,{type:v,connections:[]});const N=l.get(v),S=_.value[v];for(const z of C){const D=se(z,S,a,E,O);N.connections.push(...D)}}}const c=Array.from(l.values());return c.sort((a,m)=>a.type.localeCompare(m.type)),c}function se(i,l,c,a,m){const T=i.conf&&Object.keys(i.conf).length>0?J(i.conf):null,O=[{name:i.name,route:{name:"policy-detail-view",params:{mesh:i.mesh,policyPath:l.path,policy:i.name}}}],v=[];if(c.type==="inbound"&&Array.isArray(i.sources))for(const{match:C}of i.sources){const S={sourceTags:[{label:"kuma.io/service",value:C["kuma.io/service"]}],destinationTags:a,name:m,config:T,origins:O};v.push(S)}else{const N={sourceTags:[],destinationTags:a,name:m,config:T,origins:O};v.push(N)}return v}function ne(i){const l=new Map;for(const a of i){l.has(a.policyType)||l.set(a.policyType,{type:a.policyType,connections:[]});const m=l.get(a.policyType),T=_.value[a.policyType],E=ae(a,T);m.connections.push(...E)}const c=Array.from(l.values());return c.sort((a,m)=>a.type.localeCompare(m.type)),c}function ae(i,l){const{type:c,service:a,subset:m,conf:T}=i,E=m?Object.entries(m):[];let O,v;c==="ClientSubset"?E.length>0?O=E.map(([D,F])=>({label:D,value:F})):O=[{label:"kuma.io/service",value:"*"}]:O=[],c==="DestinationSubset"?E.length>0?v=E.map(([D,F])=>({label:D,value:F})):typeof a=="string"&&a!==""?v=[{label:"kuma.io/service",value:a}]:v=[{label:"kuma.io/service",value:"*"}]:c==="ClientSubset"&&typeof a=="string"&&a!==""?v=[{label:"kuma.io/service",value:a}]:v=[];const C=i.addresses??[],N=T&&Object.keys(T).length>0?J(T):null,S=[];for(const D of i.origins)S.push({name:D.name,route:{name:"policy-detail-view",params:{mesh:D.mesh,policyPath:l.path,policy:D.name}}});return[{type:{sourceTags:O,destinationTags:v},addresses:C,config:N,origins:S}]}return(i,l)=>$.value?(e(),b(W,{key:0})):t.value!==null?(e(),b(X,{key:1,error:t.value},null,8,["error"])):w.value.length>0?(e(),s("div",We,[d(Qe,{"dpp-name":r.dataplaneOverview.name,"policy-type-entries":w.value,"rule-entries":g.value},null,8,["dpp-name","policy-type-entries","rule-entries"])])):k.value.length>0&&P.value!==null?(e(),s("div",Xe,[d(Ge,{"mesh-gateway-dataplane":P.value,"mesh-gateway-listener-entries":k.value,"mesh-gateway-route-policies":u.value},null,8,["mesh-gateway-dataplane","mesh-gateway-listener-entries","mesh-gateway-route-policies"])])):(e(),b(de,{key:4}))}});const Ve=M(Ze,[["__scopeId","data-v-5489bd97"]]),rt=j({__name:"DataPlanePoliciesView",props:{data:{}},setup(h){const r=h,{t:L}=_e();return(P,w)=>(e(),b(ge,{name:"data-plane-policies-view","data-testid":"data-plane-policies-view"},{default:o(()=>[d(me,null,{title:o(()=>[p("h2",null,[d(ve,{title:x(L)("data-planes.routes.item.navigation.data-plane-policies-view"),render:!0},null,8,["title"])])]),default:o(()=>[n(),d(x(pe),null,{body:o(()=>[d(he,{src:"/*/policy-types"},{default:o(({data:g,error:k})=>[k?(e(),b(X,{key:0,error:k},null,8,["error"])):g===void 0?(e(),b(W,{key:1})):(e(),b(Ve,{key:2,"dataplane-overview":r.data,"policy-types":g.policies},null,8,["dataplane-overview","policy-types"]))]),_:1})]),_:1})]),_:1})]),_:1}))}});export{rt as default};
