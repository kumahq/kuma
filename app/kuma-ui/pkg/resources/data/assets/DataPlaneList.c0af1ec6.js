import{d as be,g as w,cw as ke,cn as ve,cx as we,cy as Ie,cd as Ke,o as r,c as m,e as t,b as a,a as U,w as C,bV as h,u as c,j as S,F as E,bX as N,m as Ne,bY as De,bZ as Te,k as Pe,cu as Re,f as $e,bP as Y,h as ye,b_ as fe,cl as _e,cz as Le,cA as xe,cq as Me,cr as ze,cB as Be,cp as He,i as z,cC as je,cD as qe,cE as Ge,cF as Ze,O as he,ce as Ye,cf as Fe}from"./index.2d238a59.js";import{C as Xe}from"./ContentWrapper.6f82fa9b.js";import{p as ge,D as Je}from"./DataOverview.b81dc292.js";import{T as Qe}from"./TagList.ebca8e2c.js";import{S as We}from"./StatusBadge.ce20a7cd.js";import{_ as et}from"./YamlView.vue_vue_type_script_setup_true_lang.196883ed.js";import{_ as tt}from"./EmptyBlock.vue_vue_type_script_setup_true_lang.a51bf735.js";const V=l=>(De("data-v-5b05c159"),l=l(),Te(),l),at={class:"entity-summary entity-section-list"},nt={class:"block-list"},st={class:"entity-title","data-testid":"data-plane-proxy-title"},ot={class:"definition"},lt=V(()=>t("span",null,"Mesh:",-1)),it={key:0},rt=V(()=>t("h4",null,"Tags",-1)),dt={key:1},ct=V(()=>t("h4",null,"Dependencies",-1)),ut={class:"mt-2 heading-with-icon"},pt={key:0},mt=V(()=>t("h4",null,"Insights",-1)),vt={class:"block-list"},yt=["data-testid"],ft=V(()=>t("span",null,"Connect time:",-1)),_t=["data-testid"],ht=V(()=>t("span",null,"Disconnect time:",-1)),gt={class:"definition"},bt=V(()=>t("span",null,"CP instance ID:",-1)),kt={key:0},wt=V(()=>t("summary",null,`
              Responses (acknowledged / sent)
            `,-1)),Dt=["data-testid"],Tt={class:"config-section"},Pt=be({__name:"DataPlaneEntitySummary",props:{dataPlaneOverview:{type:Object,required:!0}},setup(l){const _=l,i=w(()=>{const{name:d,mesh:y,dataplane:v}=_.dataPlaneOverview;return{type:"Dataplane",name:d,mesh:y,networking:v.networking}}),B=w(()=>ke(_.dataPlaneOverview.dataplane)),H=w(()=>{var y,v;const d=Array.from((v=(y=_.dataPlaneOverview.dataplaneInsight)==null?void 0:y.subscriptions)!=null?v:[]);return d.reverse(),d.map(n=>{const u=n.connectTime!==void 0?ve(n.connectTime):"\u2014",A=n.disconnectTime!==void 0?ve(n.disconnectTime):"\u2014",T=Object.entries(n.status).filter(([P])=>!["total","lastUpdateTime"].includes(P)).map(([P,g])=>{var j,q,G,L,I;const O=`${(j=g.responsesAcknowledged)!=null?j:0} / ${(q=g.responsesSent)!=null?q:0}`;return{type:P.toUpperCase(),ratio:O,responsesSent:(G=g.responsesSent)!=null?G:0,responsesAcknowledged:(L=g.responsesAcknowledged)!=null?L:0,responsesRejected:(I=g.responsesRejected)!=null?I:0}});return{subscription:n,formattedConnectDate:u,formattedDisconnectDate:A,statuses:T}})}),F=w(()=>{const{status:d}=we(_.dataPlaneOverview.dataplane,_.dataPlaneOverview.dataplaneInsight);return d}),R=w(()=>{const d=Ie(_.dataPlaneOverview.dataplaneInsight);return d!==null?Object.entries(d).map(([y,v])=>({name:y,version:v})):[]}),$=w(()=>{var P,g;const d=(g=(P=_.dataPlaneOverview.dataplaneInsight)==null?void 0:P.subscriptions)!=null?g:[];if(d.length===0)return[];const y=d[d.length-1];if(!y.version)return[];const v=[],n=y.version.envoy,u=y.version.kumaDp;if(!(n.kumaDpCompatible!==void 0?n.kumaDpCompatible:!0)){const O=`Envoy ${n.version} is not supported by Kuma DP ${u.version}.`;v.push(O)}if(!(u.kumaCpCompatible!==void 0?u.kumaCpCompatible:!0)){const O=`Kuma DP ${u.version} is not supported by this Kuma control plane.`;v.push(O)}return v});return(d,y)=>{const v=Ke("router-link");return r(),m("div",at,[t("section",null,[t("div",nt,[t("div",null,[t("h3",st,[t("span",null,[a(`
              DPP:

              `),U(v,{to:{name:"data-plane-detail-view",params:{mesh:l.dataPlaneOverview.mesh,dataPlane:l.dataPlaneOverview.name}}},{default:C(()=>[a(h(l.dataPlaneOverview.name),1)]),_:1},8,["to"])]),a(),U(We,{status:c(F)},null,8,["status"])]),a(),t("div",ot,[lt,a(),t("span",null,h(l.dataPlaneOverview.mesh),1)])]),a(),c(B).length>0?(r(),m("div",it,[rt,a(),U(Qe,{tags:c(B)},null,8,["tags"])])):S("",!0),a(),c(R).length>0?(r(),m("div",dt,[ct,a(),(r(!0),m(E,null,N(c(R),(n,u)=>(r(),m("div",{key:u,class:"definition"},[t("span",null,h(n.name)+":",1),a(),t("span",null,h(n.version),1)]))),128)),a(),c($).length>0?(r(),m(E,{key:0},[t("h5",ut,[a(`
              Warnings

              `),U(c(Ne),{class:"ml-1",icon:"warning",color:"var(--black-75)","secondary-color":"var(--yellow-300)",size:"20"})]),a(),(r(!0),m(E,null,N(c($),(n,u)=>(r(),m("p",{key:u},h(n),1))),128))],64)):S("",!0)])):S("",!0)])]),a(),c(H).length>0?(r(),m("section",pt,[mt,a(),t("div",vt,[(r(!0),m(E,null,N(c(H),(n,u)=>(r(),m("div",{key:u},[t("div",{class:"definition","data-testid":`data-plane-connect-time-${u}`},[ft,a(),t("span",null,h(n.formattedConnectDate),1)],8,yt),a(),t("div",{class:"definition","data-testid":`data-plane-disconnect-time-${u}`},[ht,a(),t("span",null,h(n.formattedDisconnectDate),1)],8,_t),a(),t("div",gt,[bt,a(),t("span",null,h(n.subscription.controlPlaneInstanceId),1)]),a(),n.statuses.length>0?(r(),m("details",kt,[wt,a(),(r(!0),m(E,null,N(n.statuses,(A,T)=>(r(),m("div",{key:`${u}-${T}`,class:"definition","data-testid":`data-plane-subscription-status-${u}-${T}`},[t("span",null,h(A.type)+":",1),a(),t("span",null,h(A.ratio),1)],8,Dt))),128))])):S("",!0)]))),128))])])):S("",!0),a(),t("section",Tt,[U(et,{id:"code-block-data-plane-summary",content:c(i),"code-max-height":"250px"},null,8,["content"])])])}}});const Ct=Pe(Pt,[["__scopeId","data-v-5b05c159"]]),Ce=[{key:"status",label:"Status"},{key:"name",label:"DPP"},{key:"type",label:"Type"},{key:"service",label:"Service"},{key:"protocol",label:"Protocol"},{key:"zone",label:"Zone"},{key:"lastConnected",label:"Last Connected"},{key:"lastUpdated",label:"Last Updated"},{key:"totalUpdates",label:"Total Updates"},{key:"dpVersion",label:"Kuma DP version"},{key:"envoyVersion",label:"Envoy version"},{key:"details",label:"Details",hideLabel:!0}],Ut=["name","details"],Vt=Ce.filter(l=>!Ut.includes(l.key)).map(l=>({tableHeaderKey:l.key,label:l.label,isChecked:!1})),Ue=["status","name","type","service","protocol","zone","lastUpdated","dpVersion","details"];function At(l,_=Ue){return Ce.filter(i=>_.includes(i.key)?l?!0:i.key!=="zone":!1)}const Ot=l=>(De("data-v-e1da3dcf"),l=l(),Te(),l),St={key:0},Et=Ot(()=>t("label",{for:"data-planes-type-filter",class:"mr-2"},`
              Type:
            `,-1)),It=["value"],Kt=["for"],Nt=["id","checked","onChange"],Rt=be({__name:"DataPlaneList",props:{dataPlaneOverviews:{type:Array,required:!0},isLoading:{type:Boolean,required:!1,default:!1},error:{type:Error,required:!1,default:null},nextUrl:{type:String,required:!1,default:null},pageOffset:{type:Number,required:!1,default:0},selectedDppName:{type:String,required:!1,default:null},isGatewayView:{type:Boolean,required:!1,default:!1}},emits:["gateway-type-change","load-data"],setup(l,{emit:_}){const i=l,B=50,H=["All","Builtin","Delegated"],F={title:"No Data",message:"There are no data plane proxies present."},R=Re(),$=$e(),d=Y(Ue),y=Y({headers:[],data:[]}),v=Y("All"),n=Y(null),u=w(()=>$.getters["config/getMulticlusterStatus"]),A=w(()=>({name:$.getters["config/getEnvironment"]==="universal"?"universal-dataplane":"kubernetes-dataplane"})),T=w(()=>{let e=At(u.value,d.value);return i.isGatewayView?e=e.filter(s=>s.key!=="protocol"):e=e.filter(s=>s.key!=="type"),{data:y.value.data,headers:e}}),P=w(()=>Vt.filter(e=>i.isGatewayView?e.tableHeaderKey!=="protocol":e.tableHeaderKey!=="type").filter(e=>u.value?!0:e.tableHeaderKey!=="zone").map(e=>{const s=d.value.includes(e.tableHeaderKey);return{...e,isChecked:s}}));ye(v,function(){_("gateway-type-change",v.value)}),ye(()=>i.dataPlaneOverviews,function(){L()});const g=fe.get("dpVisibleTableHeaderKeys");Array.isArray(g)&&(d.value=g),L();function O(e){_("load-data",e)}function j(e){e.stopPropagation()}function q(e,s){const b=e.target,p=d.value.findIndex(D=>D===s);b.checked&&p===-1?d.value.push(s):!b.checked&&p>-1&&d.value.splice(p,1),fe.set("dpVisibleTableHeaderKeys",Array.from(new Set(d.value)))}function G(){Ye.logger.info(Fe.CREATE_DATA_PLANE_PROXY_CLICKED)}async function L(){var e;try{Array.isArray(i.dataPlaneOverviews)&&i.dataPlaneOverviews.length>0?(I((e=i.selectedDppName)!=null?e:i.dataPlaneOverviews[0].name),y.value.data=await Promise.all(i.dataPlaneOverviews.map(s=>Ve(s)))):(I(null),y.value.data=[])}catch(s){console.error(s)}}function I(e){var s;e&&i.dataPlaneOverviews.length>0?(n.value=(s=i.dataPlaneOverviews.find(b=>b.name===e))!=null?s:i.dataPlaneOverviews[0],ge(i.isGatewayView?"gateway":"dpp",n.value.name)):(n.value=null,ge(i.isGatewayView?"gateway":"dpp",null))}async function Ve(e){var te,ae,ne,se,oe,le,ie,re;const s=e.mesh,b=e.name,p=((te=e.dataplane.networking.gateway)==null?void 0:te.type)||"STANDARD",D={name:p==="STANDARD"?"data-plane-detail-view":"gateway-detail-view",params:{mesh:s,dataPlane:b}},X={name:"mesh-detail-view",params:{mesh:s}},Ae=["kuma.io/protocol","kuma.io/service","kuma.io/zone"],Z=ke(e.dataplane).filter(o=>Ae.includes(o.label)),x=(ae=Z.find(o=>o.label==="kuma.io/service"))==null?void 0:ae.value,J=(ne=Z.find(o=>o.label==="kuma.io/protocol"))==null?void 0:ne.value,M=(se=Z.find(o=>o.label==="kuma.io/zone"))==null?void 0:se.value;let W;x!==void 0&&(W={name:"service-detail-view",params:{mesh:s,service:x}});let ee;M!==void 0&&(ee={name:"zones",query:{ns:M}});const{status:Oe}=we(e.dataplane,e.dataplaneInsight),Se=(le=(oe=e.dataplaneInsight)==null?void 0:oe.subscriptions)!=null?le:[],Ee={totalUpdates:0,totalRejectedUpdates:0,dpVersion:null,envoyVersion:null,selectedTime:NaN,selectedUpdateTime:NaN,version:null},f=Se.reduce((o,k)=>{var de,ce,ue,pe;if(k.connectTime){const me=Date.parse(k.connectTime);(!o.selectedTime||me>o.selectedTime)&&(o.selectedTime=me)}const Q=Date.parse(k.status.lastUpdateTime);return Q&&(!o.selectedUpdateTime||Q>o.selectedUpdateTime)&&(o.selectedUpdateTime=Q),{totalUpdates:o.totalUpdates+parseInt((de=k.status.total.responsesSent)!=null?de:"0",10),totalRejectedUpdates:o.totalRejectedUpdates+parseInt((ce=k.status.total.responsesRejected)!=null?ce:"0",10),dpVersion:((ue=k.version)==null?void 0:ue.kumaDp.version)||o.dpVersion,envoyVersion:((pe=k.version)==null?void 0:pe.envoy.version)||o.envoyVersion,selectedTime:o.selectedTime,selectedUpdateTime:o.selectedUpdateTime,version:k.version||o.version}},Ee),K={name:b,nameRoute:D,mesh:s,meshRoute:X,type:p,zone:M!=null?M:"\u2014",zoneRoute:ee,service:x!=null?x:"\u2014",serviceInsightRoute:W,protocol:J!=null?J:"\u2014",status:Oe,totalUpdates:f.totalUpdates,totalRejectedUpdates:f.totalRejectedUpdates,dpVersion:(ie=f.dpVersion)!=null?ie:"\u2014",envoyVersion:(re=f.envoyVersion)!=null?re:"\u2014",warnings:[],unsupportedEnvoyVersion:!1,unsupportedKumaDPVersion:!1,kumaDpAndKumaCpMismatch:!1,lastUpdated:f.selectedUpdateTime?_e(new Date(f.selectedUpdateTime).toUTCString()):"\u2014",lastConnected:f.selectedTime?_e(new Date(f.selectedTime).toUTCString()):"\u2014",overview:e};if(f.version){const{kind:o}=Le(f.version);switch(o!==xe&&K.warnings.push(o),o){case ze:K.unsupportedEnvoyVersion=!0;break;case Me:K.unsupportedKumaDPVersion=!0;break}}return u.value&&f.dpVersion&&Z.find(k=>k.label===Be)&&typeof f.version.kumaDp.kumaCpCompatible=="boolean"&&!f.version.kumaDp.kumaCpCompatible&&(K.warnings.push(He),K.kumaDpAndKumaCpMismatch=!0),K}return(e,s)=>(r(),z(Xe,null,{content:C(()=>{var b;return[U(Je,{"selected-entity-name":(b=n.value)==null?void 0:b.name,"page-size":B,"is-loading":i.isLoading,error:l.error,"empty-state":F,"table-data":c(T),"table-data-is-empty":c(T).data.length===0,"show-details":"",next:i.nextUrl!==null,"page-offset":i.pageOffset,onTableAction:s[1]||(s[1]=p=>I(p.name)),onLoadData:s[2]||(s[2]=p=>O(i.pageOffset))},{additionalControls:C(()=>[i.isGatewayView?(r(),m("div",St,[Et,a(),je(t("select",{id:"data-planes-type-filter","onUpdate:modelValue":s[0]||(s[0]=p=>v.value=p),"data-testid":"data-planes-type-filter"},[(r(!0),m(E,null,N(c(H),(p,D)=>(r(),m("option",{key:D,value:p},h(p),9,It))),128))],512),[[qe,v.value]])])):S("",!0),a(),U(c(Ge),{label:"Columns",icon:"cogwheel","button-appearance":"outline"},{items:C(()=>[t("div",{onClick:j},[(r(!0),m(E,null,N(c(P),(p,D)=>(r(),z(c(Ze),{key:D,class:"table-header-selector-item",item:p},{default:C(()=>[t("label",{for:`data-plane-table-header-checkbox-${D}`,class:"k-checkbox table-header-selector-item-checkbox"},[t("input",{id:`data-plane-table-header-checkbox-${D}`,checked:p.isChecked,type:"checkbox",class:"k-input",onChange:X=>q(X,p.tableHeaderKey)},null,40,Nt),a(" "+h(p.label),1)],8,Kt)]),_:2},1032,["item"]))),128))])]),_:1}),a(),U(c(he),{appearance:"creation",to:c(A),icon:"plus","data-testid":"data-plane-create-data-plane-button",onClick:G},{default:C(()=>[a(`
            Create data plane proxy
          `)]),_:1},8,["to"]),a(),c(R).query.ns?(r(),z(c(he),{key:1,appearance:"primary",icon:"arrowLeft",to:{name:c(R).name},"data-testid":"data-plane-ns-back-button"},{default:C(()=>[a(`
            View All
          `)]),_:1},8,["to"])):S("",!0)]),_:1},8,["selected-entity-name","is-loading","error","table-data","table-data-is-empty","next","page-offset"])]}),sidebar:C(()=>[n.value!==null?(r(),z(Ct,{key:0,"data-plane-overview":n.value},null,8,["data-plane-overview"])):(r(),z(tt,{key:1}))]),_:1}))}});const jt=Pe(Rt,[["__scopeId","data-v-e1da3dcf"]]);export{jt as D};
