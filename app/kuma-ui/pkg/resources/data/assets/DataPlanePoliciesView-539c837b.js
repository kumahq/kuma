import{A as D,a as F}from"./AccordionList-e1dac560.js";import{d as j,N as x,a as N,o as t,c as o,p as d,f as a,F as m,J as E,t as f,e as h,w as i,v as S,b as _,$ as Q,z as W,A as X,_ as K,q as z,a4 as J}from"./index-ddb38e98.js";import{_ as U}from"./CodeBlock.vue_vue_type_style_index_0_lang-f9124dc4.js";import{P as Y}from"./PolicyTypeTag-2a461ca6.js";import{T as G}from"./TagList-bd8e05fd.js";import{t as H}from"./toYaml-4e00099e.js";import{E as O}from"./ErrorBlock-a5cb6d15.js";import{_ as M}from"./LoadingBlock.vue_vue_type_script_setup_true_lang-b38e136a.js";import"./index-52545d1d.js";import"./TextWithCopyButton-7c7a35f6.js";import"./CopyButton-769bff11.js";import"./WarningIcon.vue_vue_type_script_setup_true_lang-726b6e24.js";const A=b=>(W("data-v-d33ad9ee"),b=b(),X(),b),Z={class:"policies-list","data-testid":"builtin-gateway-dataplane-policies"},V={class:"mesh-gateway-policy-list"},ee=A(()=>d("h3",{class:"mb-2"},`
        Gateway policies
      `,-1)),te={key:0},se=A(()=>d("h3",{class:"mt-6 mb-2"},`
        Listeners
      `,-1)),ne=A(()=>d("b",null,"Host",-1)),oe=A(()=>d("h4",{class:"mt-2 mb-2"},`
                Routes
              `,-1)),ae={class:"dataplane-policy-header"},ie=A(()=>d("b",null,"Route",-1)),le=A(()=>d("b",null,"Service",-1)),ce={key:0,class:"badge-list"},re={class:"mt-1"},pe=j({__name:"BuiltinGatewayPolicies",props:{gatewayDataplane:{},policyTypesByName:{}},setup(b){const k=b,R=x(()=>B(k.gatewayDataplane)),C=x(()=>T(k.gatewayDataplane.policies));function B(v){const y=[],n=v.listeners??[];for(const e of n)for(const l of e.hosts)for(const s of l.routes){const c=[];for(const r of s.destinations){const g=T(r.policies),u={routeName:s.route,route:{name:"policy-detail-view",params:{mesh:v.gateway.mesh,policyPath:"meshgatewayroutes",policy:s.route}},service:r.tags["kuma.io/service"],policies:g};c.push(u)}y.push({protocol:e.protocol,port:e.port,hostName:l.hostName,routeEntries:c})}return y}function T(v){if(v===void 0)return[];const y=[];for(const n of Object.values(v)){const e=k.policyTypesByName[n.type];y.push({type:n.type,name:n.name,route:{name:"policy-detail-view",params:{mesh:n.mesh,policyPath:e.path,policy:n.name}}})}return y}return(v,y)=>{const n=N("router-link"),e=N("KBadge"),l=N("RouterLink");return t(),o("div",Z,[d("div",V,[ee,a(),C.value.length>0?(t(),o("ul",te,[(t(!0),o(m,null,E(C.value,(s,c)=>(t(),o("li",{key:c},[d("span",null,f(s.type),1),a(`:

          `),h(n,{to:s.route},{default:i(()=>[a(f(s.name),1)]),_:2},1032,["to"])]))),128))])):S("",!0),a(),se,a(),d("div",null,[(t(!0),o(m,null,E(R.value,(s,c)=>(t(),o("div",{key:c},[d("div",null,[d("div",null,[ne,a(": "+f(s.hostName)+":"+f(s.port)+" ("+f(s.protocol)+`)
            `,1)]),a(),s.routeEntries.length>0?(t(),o(m,{key:0},[oe,a(),h(F,{"initially-open":[],"multiple-open":""},{default:i(()=>[(t(!0),o(m,null,E(s.routeEntries,(r,g)=>(t(),_(D,{key:g},Q({"accordion-header":i(()=>[d("div",ae,[d("div",null,[d("div",null,[ie,a(": "),h(n,{to:r.route},{default:i(()=>[a(f(r.routeName),1)]),_:2},1032,["to"])]),a(),d("div",null,[le,a(": "+f(r.service),1)])]),a(),r.policies.length>0?(t(),o("div",ce,[(t(!0),o(m,null,E(r.policies,(u,p)=>(t(),_(e,{key:`${c}-${p}`},{default:i(()=>[a(f(u.type),1)]),_:2},1024))),128))])):S("",!0)])]),_:2},[r.policies.length>0?{name:"accordion-content",fn:i(()=>[d("ul",re,[(t(!0),o(m,null,E(r.policies,(u,p)=>(t(),o("li",{key:`${c}-${p}`},[a(f(u.type)+`:

                        `,1),h(l,{to:u.route},{default:i(()=>[a(f(u.name),1)]),_:2},1032,["to"])]))),128))])]),key:"0"}:void 0]),1024))),128))]),_:2},1024)],64)):S("",!0)])]))),128))])])])}}});const ue=K(pe,[["__scopeId","data-v-d33ad9ee"]]),de={class:"policy-type-heading"},ye={class:"policy-list"},_e={key:0},me=j({__name:"PolicyTypeEntryList",props:{id:{type:String,required:!1,default:"entry-list"},policyTypeEntries:{type:Object,required:!0}},setup(b){const k=[{label:"From",key:"sourceTags"},{label:"To",key:"destinationTags"},{label:"On",key:"name"},{label:"Conf",key:"config"},{label:"Origin policies",key:"origins"}],R=b;function C({headerKey:B}){return{class:`cell-${B}`}}return(B,T)=>{const v=N("router-link");return t(),_(F,{"initially-open":[],"multiple-open":""},{default:i(()=>[(t(!0),o(m,null,E(R.policyTypeEntries,(y,n)=>(t(),_(D,{key:n},{"accordion-header":i(()=>[d("h3",de,[h(Y,{"policy-type":y.type},{default:i(()=>[a(f(y.type)+" ("+f(y.connections.length)+`)
          `,1)]),_:2},1032,["policy-type"])])]),"accordion-content":i(()=>[d("div",ye,[h(z(J),{class:"policy-type-table",fetcher:()=>({data:y.connections,total:y.connections.length}),headers:k,"cell-attrs":C,"disable-pagination":"","is-clickable":""},{sourceTags:i(({rowValue:e})=>[e.length>0?(t(),_(G,{key:0,class:"tag-list","should-truncate":"",tags:e},null,8,["tags"])):(t(),o(m,{key:1},[a(`
                —
              `)],64))]),destinationTags:i(({rowValue:e})=>[e.length>0?(t(),_(G,{key:0,class:"tag-list","should-truncate":"",tags:e},null,8,["tags"])):(t(),o(m,{key:1},[a(`
                —
              `)],64))]),name:i(({rowValue:e})=>[e!==null?(t(),o(m,{key:0},[a(f(e),1)],64)):(t(),o(m,{key:1},[a(`
                —
              `)],64))]),origins:i(({rowValue:e})=>[e.length>0?(t(),o("ul",_e,[(t(!0),o(m,null,E(e,(l,s)=>(t(),o("li",{key:`${n}-${s}`},[h(v,{to:l.route},{default:i(()=>[a(f(l.name),1)]),_:2},1032,["to"])]))),128))])):(t(),o(m,{key:1},[a(`
                —
              `)],64))]),config:i(({rowValue:e,rowKey:l})=>[e!==null?(t(),_(U,{key:0,id:`${R.id}-${n}-${l}-code-block`,code:e,language:"yaml","show-copy-button":!1},null,8,["id","code"])):(t(),o(m,{key:1},[a(`
                —
              `)],64))]),_:2},1032,["fetcher"])])]),_:2},1024))),128))]),_:1})}}});const he=K(me,[["__scopeId","data-v-a842ac46"]]),ge={class:"policy-type-heading"},fe={class:"policy-list"},ke={key:1,class:"tag-list-wrapper"},ve={key:0},be={key:1},Te={key:0},$e={key:0},Pe=j({__name:"RuleEntryList",props:{id:{type:String,required:!1,default:"entry-list"},ruleEntries:{type:Object,required:!0}},setup(b){const k=[{label:"Type",key:"type"},{label:"Addresses",key:"addresses"},{label:"Conf",key:"config"},{label:"Origin policies",key:"origins"}],R=b;function C({headerKey:B}){return{class:`cell-${B}`}}return(B,T)=>{const v=N("router-link");return t(),_(F,{"initially-open":[],"multiple-open":""},{default:i(()=>[(t(!0),o(m,null,E(R.ruleEntries,(y,n)=>(t(),_(D,{key:n},{"accordion-header":i(()=>[d("h3",ge,[h(Y,{"policy-type":y.type},{default:i(()=>[a(f(y.type)+" ("+f(y.connections.length)+`)
          `,1)]),_:2},1032,["policy-type"])])]),"accordion-content":i(()=>[d("div",fe,[h(z(J),{class:"policy-type-table",fetcher:()=>({data:y.connections,total:y.connections.length}),headers:k,"cell-attrs":C,"disable-pagination":"","is-clickable":""},{type:i(({rowValue:e})=>[e.sourceTags.length===0&&e.destinationTags.length===0?(t(),o(m,{key:0},[a(`
                —
              `)],64)):(t(),o("div",ke,[e.sourceTags.length>0?(t(),o("div",ve,[a(`
                  From

                  `),h(G,{class:"tag-list","should-truncate":"",tags:e.sourceTags},null,8,["tags"])])):S("",!0),a(),e.destinationTags.length>0?(t(),o("div",be,[a(`
                  To

                  `),h(G,{class:"tag-list","should-truncate":"",tags:e.destinationTags},null,8,["tags"])])):S("",!0)]))]),addresses:i(({rowValue:e})=>[e.length>0?(t(),o("ul",Te,[(t(!0),o(m,null,E(e,(l,s)=>(t(),o("li",{key:`${n}-${s}`},f(l),1))),128))])):(t(),o(m,{key:1},[a(`
                —
              `)],64))]),origins:i(({rowValue:e})=>[e.length>0?(t(),o("ul",$e,[(t(!0),o(m,null,E(e,(l,s)=>(t(),o("li",{key:`${n}-${s}`},[h(v,{to:l.route},{default:i(()=>[a(f(l.name),1)]),_:2},1032,["to"])]))),128))])):(t(),o(m,{key:1},[a(`
                —
              `)],64))]),config:i(({rowValue:e,rowKey:l})=>[e!==null?(t(),_(U,{key:0,id:`${R.id}-${n}-${l}-code-block`,code:e,language:"yaml","show-copy-button":!1},null,8,["id","code"])):(t(),o(m,{key:1},[a(`
                —
              `)],64))]),_:2},1032,["fetcher"])])]),_:2},1024))),128))]),_:1})}}});const we=K(Pe,[["__scopeId","data-v-50dcfabc"]]),Be={"data-testid":"standard-dataplane-policies"},Le=d("h2",{class:"visually-hidden"},`
      Policies
    `,-1),Re={key:0,class:"mt-2"},Ce=d("h2",{class:"mb-2"},`
        Rules
      `,-1),Ne=j({__name:"StandardDataplanePolicies",props:{sidecarDataplanes:{},rules:{},policyTypesByName:{}},setup(b){const k=b,R=x(()=>B(k.sidecarDataplanes)),C=x(()=>v(k.rules));function B(n){const e=new Map;for(const s of n){const{type:c,service:r}=s,g=typeof r=="string"&&r!==""?[{label:"kuma.io/service",value:r}]:[],u=c==="inbound"||c==="outbound"?s.name:null;for(const[p,$]of Object.entries(s.matchedPolicies)){e.has(p)||e.set(p,{type:p,connections:[]});const L=e.get(p),P=k.policyTypesByName[p];for(const I of $){const w=T(I,P,s,g,u);L.connections.push(...w)}}}const l=Array.from(e.values());return l.sort((s,c)=>s.type.localeCompare(c.type)),l}function T(n,e,l,s,c){const r=n.conf&&Object.keys(n.conf).length>0?H(n.conf):null,u=[{name:n.name,route:{name:"policy-detail-view",params:{mesh:n.mesh,policyPath:e.path,policy:n.name}}}],p=[];if(l.type==="inbound"&&Array.isArray(n.sources))for(const{match:$}of n.sources){const P={sourceTags:[{label:"kuma.io/service",value:$["kuma.io/service"]}],destinationTags:s,name:c,config:r,origins:u};p.push(P)}else{const L={sourceTags:[],destinationTags:s,name:c,config:r,origins:u};p.push(L)}return p}function v(n){const e=new Map;for(const s of n){e.has(s.policyType)||e.set(s.policyType,{type:s.policyType,connections:[]});const c=e.get(s.policyType),r=k.policyTypesByName[s.policyType],g=y(s,r);c.connections.push(...g)}const l=Array.from(e.values());return l.sort((s,c)=>s.type.localeCompare(c.type)),l}function y(n,e){const{type:l,service:s,subset:c,conf:r}=n,g=c?Object.entries(c):[];let u,p;l==="ClientSubset"?g.length>0?u=g.map(([w,q])=>({label:w,value:q})):u=[{label:"kuma.io/service",value:"*"}]:u=[],l==="DestinationSubset"?g.length>0?p=g.map(([w,q])=>({label:w,value:q})):typeof s=="string"&&s!==""?p=[{label:"kuma.io/service",value:s}]:p=[{label:"kuma.io/service",value:"*"}]:l==="ClientSubset"&&typeof s=="string"&&s!==""?p=[{label:"kuma.io/service",value:s}]:p=[];const $=n.addresses??[],L=r&&Object.keys(r).length>0?H(r):null,P=[];for(const w of n.origins)P.push({name:w.name,route:{name:"policy-detail-view",params:{mesh:w.mesh,policyPath:e.path,policy:w.name}}});return[{type:{sourceTags:u,destinationTags:p},addresses:$,config:L,origins:P}]}return(n,e)=>(t(),o("div",Be,[Le,a(),h(he,{id:"policies","policy-type-entries":R.value,"data-testid":"policy-list"},null,8,["policy-type-entries"]),a(),C.value.length>0?(t(),o("div",Re,[Ce,a(),h(we,{id:"rules","rule-entries":C.value,"data-testid":"rule-list"},null,8,["rule-entries"])])):S("",!0)]))}}),He=j({__name:"DataPlanePoliciesView",props:{data:{}},setup(b){const k=b;return(R,C)=>{const B=N("RouteTitle"),T=N("DataSource"),v=N("KCard"),y=N("AppView"),n=N("RouteView");return t(),_(n,{name:"data-plane-policies-view",params:{mesh:"",dataPlane:""}},{default:i(({route:e,t:l})=>[h(y,null,{title:i(()=>[d("h2",null,[h(B,{title:l("data-planes.routes.item.navigation.data-plane-policies-view")},null,8,["title"])])]),default:i(()=>[a(),h(v,null,{default:i(()=>{var s,c,r;return[((r=(c=(s=k.data.dataplane)==null?void 0:s.networking)==null?void 0:c.gateway)==null?void 0:r.type)==="BUILTIN"?(t(),_(T,{key:0,src:"/*/policy-types"},{default:i(({data:g,error:u})=>[h(T,{src:`/meshes/${e.params.mesh}/dataplanes/${e.params.dataPlane}/gateway-dataplane-policies`},{default:i(({data:p,error:$})=>[u?(t(),_(O,{key:0,error:u},null,8,["error"])):$?(t(),_(O,{key:1,error:$},null,8,["error"])):p===void 0||g===void 0?(t(),_(M,{key:2})):(t(),_(ue,{key:3,"policy-types-by-name":g.policies.reduce((L,P)=>Object.assign(L,{[P.name]:P}),{}),"gateway-dataplane":p},null,8,["policy-types-by-name","gateway-dataplane"]))]),_:2},1032,["src"])]),_:2},1024)):(t(),_(T,{key:1,src:"/*/policy-types"},{default:i(({data:g,error:u})=>[h(T,{src:`/meshes/${e.params.mesh}/dataplanes/${e.params.dataPlane}/sidecar-dataplane-policies`},{default:i(({data:p,error:$})=>[h(T,{src:`/meshes/${e.params.mesh}/dataplanes/${e.params.dataPlane}/rules`},{default:i(({data:L,error:P})=>[u?(t(),_(O,{key:0,error:u},null,8,["error"])):$?(t(),_(O,{key:1,error:$},null,8,["error"])):P?(t(),_(O,{key:2,error:P},null,8,["error"])):g===void 0||p===void 0||L===void 0?(t(),_(M,{key:3})):(t(),_(Ne,{key:4,"policy-types-by-name":g.policies.reduce((I,w)=>Object.assign(I,{[w.name]:w}),{}),"sidecar-dataplanes":p.items,rules:L.items},null,8,["policy-types-by-name","sidecar-dataplanes","rules"]))]),_:2},1032,["src"])]),_:2},1032,["src"])]),_:2},1024))]}),_:2},1024)]),_:2},1024)]),_:1})}}});export{He as default};
