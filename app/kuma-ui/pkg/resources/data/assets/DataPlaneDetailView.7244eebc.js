import{R as W,S as F,E as U,D as H,y as G,O as Z,m as J,K,_ as Y,r as D,o as e,c as g,w as l,a as d,e as n,h as v,f as a,k as A,t as c,F as _,b as $,d as q,H as O,I as w,J as p,cA as X,cB as Q,cE as ee,cs as M,cC as ae,a0 as te,L as j,ct as se,cv as ne,s as oe,cF as le,n as ie,cG as re,$ as ce,p as de,l as ue,cH as pe,cI as V}from"./index.dbfc69fe.js";import{S as z,E as B}from"./EnvoyData.5fb8765b.js";import{E as me}from"./EntityURLControl.79d97268.js";import{L as R}from"./LabelList.9e6f9cac.js";import{a as he,S as _e}from"./SubscriptionHeader.c5292777.js";import{T as ye}from"./TabsWidget.ad5c32a1.js";import{W as fe}from"./WarningsWidget.9d3e5b3a.js";import{Y as ve}from"./YamlView.aa325bb9.js";import{_ as ge}from"./EmptyBlock.vue_vue_type_script_setup_true_lang.5dc5cc90.js";import{E as Pe}from"./ErrorBlock.f52010c3.js";import{_ as be}from"./LoadingBlock.vue_vue_type_script_setup_true_lang.f2781028.js";import"./CodeBlock.83ca39be.js";import"./_commonjsHelpers.712cc82f.js";import"./index.58caa11d.js";const ke={inbound:"Policies applied on incoming connection on address",outbound:"Policies applied on outgoing connection to the address",service:"Policies applied on outgoing connections to service",dataplane:"Policies applied on all incoming and outgoing connections to the selected data plane proxy"},De={name:"DataplanePolicies",components:{StatusInfo:z,AccordionList:W,AccordionItem:F,KCard:U,KPop:H,KIcon:G,KBadge:Z},props:{mesh:{type:String,required:!0},dppName:{type:String,required:!0}},data(){return{items:[],hasItems:!1,isLoading:!0,error:null,searchInput:"",POLICY_TYPE_SUBTITLE:ke}},computed:{...J({policiesByType:s=>s.policiesByType})},watch:{dppName(){this.fetchPolicies()}},mounted(){this.fetchPolicies()},methods:{async fetchPolicies(){this.error=null,this.isLoading=!0;try{const{items:s,total:o,kind:h}=await K.getDataplanePolicies({mesh:this.mesh,dppName:this.dppName});(h===void 0||h==="SidecarDataplane")&&(this.processItems(s),this.items=s,this.hasItems=o>0)}catch(s){this.error=s}finally{this.isLoading=!1}},processItems(s){for(const o of s){o.policyTypes={};for(const h in o.matchedPolicies){const y=this.policiesByType[h],u={pluralDisplayName:y.pluralDisplayName,policies:o.matchedPolicies[h]};for(const f of u.policies)f.route={name:y.path,query:{ns:f.name},params:{mesh:f.mesh}};o.policyTypes[h]=u}}}}},we={class:"flex items-center justify-between"},Ie={key:0,class:"text-lg"},Se={key:1,class:"text-lg"},Te={class:"subtitle"},Ce={key:0},Le={key:1},Ee={class:"flex flex-wrap justify-end"},Oe={class:"policy-wrapper"},Ae={class:"policy-type"};function $e(s,o,h,y,u,f){const P=D("KIcon"),T=D("KPop"),I=D("KBadge"),b=D("router-link"),k=D("AccordionItem"),C=D("AccordionList"),S=D("KCard"),x=D("StatusInfo");return e(),g(x,{"has-error":u.error!==null,"is-loading":u.isLoading,error:u.error,"is-empty":!u.hasItems},{default:l(()=>[d(S,{"border-variant":"noBorder"},{body:l(()=>[d(C,{"initially-open":[],"multiple-open":""},{default:l(()=>[(e(!0),n(_,null,v(u.items,(t,m)=>(e(),g(k,{key:m},{"accordion-header":l(()=>[a("div",we,[a("div",null,[t.type==="dataplane"?(e(),n("p",Ie," Dataplane ")):A("",!0),t.type!=="dataplane"?(e(),n("p",Se,c(t.service),1)):A("",!0),a("p",Te,[t.type==="inbound"||t.type==="outbound"?(e(),n("span",Ce,c(t.type)+" "+c(t.name),1)):t.type==="service"||t.type==="dataplane"?(e(),n("span",Le,c(t.type),1)):A("",!0),d(T,{width:"300",placement:"right",trigger:"hover"},{content:l(()=>[a("div",null,c(u.POLICY_TYPE_SUBTITLE[t.type]),1)]),default:l(()=>[d(P,{icon:"help",size:"16",class:"ml-1"})]),_:2},1024)])]),a("div",Ee,[(e(!0),n(_,null,v(t.matchedPolicies,(r,i)=>(e(),g(I,{key:`${m}-${i}`,class:"mr-2 mb-2"},{default:l(()=>[$(c(i),1)]),_:2},1024))),128))])])]),"accordion-content":l(()=>[a("div",Oe,[(e(!0),n(_,null,v(t.policyTypes,(r,i)=>(e(),n("div",{key:`${m}-${i}`,class:"policy-item"},[a("h4",Ae,c(r.pluralDisplayName),1),a("ul",null,[(e(!0),n(_,null,v(r.policies,(L,E)=>(e(),n("li",{key:`${m}-${i}-${E}`,class:"my-1","data-testid":"policy-name"},[d(b,{to:L.route},{default:l(()=>[$(c(L.name),1)]),_:2},1032,["to"])]))),128))])]))),128))])]),_:2},1024))),128))]),_:1})]),_:1})]),_:1},8,["has-error","is-loading","error","is-empty"])}const xe=Y(De,[["render",$e],["__scopeId","data-v-7223f9a8"]]),N=s=>(de("data-v-119cf935"),s=s(),ue(),s),Be={key:0},Ke={class:"entity-status__label"},Ne=N(()=>a("span",{class:"entity-status__dot"},null,-1)),Me={key:1},Ve=N(()=>a("h4",null,"Tags",-1)),Re=N(()=>a("h4",null,"Versions",-1)),We={class:"config-wrapper"},Fe={key:0},Ue=["href"],Ye=q({__name:"DataPlaneDetails",props:{dataPlane:{type:Object,required:!0},dataPlaneOverview:{type:Object,required:!0}},setup(s){const o=s,h=j(),y=[{hash:"#overview",title:"Overview"},{hash:"#insights",title:"DPP Insights"},{hash:"#dpp-policies",title:"Policies"},{hash:"#xds-configuration",title:"XDS Configuration"},{hash:"#envoy-stats",title:"Stats"},{hash:"#envoy-clusters",title:"Clusters"},{hash:"#mtls",title:"Certificate Insights"},{hash:"#warnings",title:"Warnings"}],u=O([]),f=w(()=>{const{type:t,name:m,mesh:r}=o.dataPlane,i=se(o.dataPlane,o.dataPlaneOverview.dataplaneInsight);return{type:t,name:m,mesh:r,status:i}}),P=w(()=>M(o.dataPlane)),T=w(()=>ne(o.dataPlaneOverview.dataplaneInsight)),I=w(()=>oe(o.dataPlane)),b=w(()=>le(o.dataPlaneOverview)),k=w(()=>{const t=Array.from(o.dataPlaneOverview.dataplaneInsight.subscriptions);return t.reverse(),t}),C=w(()=>{const t=h.getters.getKumaDocsVersion;return t!==null?t:"latest"}),S=w(()=>u.value.length===0?y.filter(t=>t.hash!=="#warnings"):y);function x(){const t=o.dataPlaneOverview.dataplaneInsight.subscriptions;if(t.length===0||!("version"in t[0]))return;const m=t[0].version;if(m.kumaDp&&m.envoy){const i=X(m);i.kind!==Q&&i.kind!==ee&&u.value.push(i)}h.getters["config/getMulticlusterStatus"]&&M(o.dataPlane).find(E=>E.label===ae)&&typeof m.kumaDp.kumaCpCompatible=="boolean"&&!m.kumaDp.kumaCpCompatible&&u.value.push({kind:te,payload:{kumaDp:m.kumaDp.version}})}return x(),(t,m)=>(e(),g(ye,{tabs:p(S),"initial-tab-override":"overview"},{tabHeader:l(()=>[a("div",null,[a("h3",null," DPP: "+c(s.dataPlane.name),1)]),a("div",null,[d(me,{name:s.dataPlane.name,mesh:s.dataPlane.mesh},null,8,["name","mesh"])])]),overview:l(()=>[d(R,null,{default:l(()=>[a("div",null,[a("ul",null,[(e(!0),n(_,null,v(p(f),(r,i)=>(e(),n("li",{key:i},[a("h4",null,c(i),1),i==="status"&&typeof r!="string"?(e(),n("div",Be,[a("div",{class:ie(["entity-status",{"is-offline":r.status.toString().toLowerCase()==="offline","is-degraded":r.status.toString().toLowerCase()==="partially degraded"}])},[a("span",Ke,c(r.status),1)],2),(e(!0),n(_,null,v(r.reason,(L,E)=>(e(),n("div",{key:E,class:"reason"},[Ne,$(" "+c(L),1)]))),128))])):(e(),n("div",Me,c(r),1))]))),128))])]),a("div",null,[p(P).length>0?(e(),n(_,{key:0},[Ve,a("p",null,[(e(!0),n(_,null,v(p(P),(r,i)=>(e(),n("span",{key:i,class:"tag-cols"},[a("span",null,c(r.label)+": ",1),a("span",null,c(r.value),1)]))),128))])],64)):A("",!0),p(T)?(e(),n(_,{key:1},[Re,a("p",null,[(e(!0),n(_,null,v(p(T),(r,i)=>(e(),n("span",{key:i,class:"tag-cols"},[a("span",null,c(i)+": ",1),a("span",null,c(r),1)]))),128))])],64)):A("",!0)])]),_:1}),a("div",We,[d(ve,{content:p(I)},null,8,["content"])])]),insights:l(()=>[d(z,{"is-empty":p(k).length===0},{default:l(()=>[d(p(U),{"border-variant":"noBorder"},{body:l(()=>[d(W,{"initially-open":0},{default:l(()=>[(e(!0),n(_,null,v(p(k),(r,i)=>(e(),g(F,{key:i},{"accordion-header":l(()=>[d(he,{details:r},null,8,["details"])]),"accordion-content":l(()=>[d(_e,{details:r,"is-discovery-subscription":""},null,8,["details"])]),_:2},1024))),128))]),_:1})]),_:1})]),_:1},8,["is-empty"])]),"dpp-policies":l(()=>[d(xe,{mesh:s.dataPlane.mesh,"dpp-name":s.dataPlane.name},null,8,["mesh","dpp-name"])]),"xds-configuration":l(()=>[d(B,{"data-path":"xds",mesh:s.dataPlane.mesh,"dpp-name":s.dataPlane.name},null,8,["mesh","dpp-name"])]),"envoy-stats":l(()=>[d(B,{"data-path":"stats",mesh:s.dataPlane.mesh,"dpp-name":s.dataPlane.name},null,8,["mesh","dpp-name"])]),"envoy-clusters":l(()=>[d(B,{"data-path":"clusters",mesh:s.dataPlane.mesh,"dpp-name":s.dataPlane.name},null,8,["mesh","dpp-name"])]),mtls:l(()=>[d(R,null,{default:l(()=>[p(b)!==null?(e(),n("ul",Fe,[(e(!0),n(_,null,v(p(b),(r,i)=>(e(),n("li",{key:i},[a("h4",null,c(r.label),1),a("p",null,c(r.value),1)]))),128))])):(e(),g(p(re),{key:1,appearance:"danger"},{alertMessage:l(()=>[$(" This data plane proxy does not yet have mTLS configured \u2014 "),a("a",{href:`https://kuma.io/docs/${p(C)}/documentation/security/#certificates`,class:"external-link",target:"_blank"}," Learn About Certificates in "+c(p(ce)),9,Ue)]),_:1}))]),_:1})]),warnings:l(()=>[d(fe,{warnings:u.value},null,8,["warnings"])]),_:1},8,["tabs"]))}});const qe=Y(Ye,[["__scopeId","data-v-119cf935"]]),je={class:"component-frame"},ia=q({__name:"DataPlaneDetailView",setup(s){const o=pe(),h=j(),y=O(null),u=O(null),f=O(!0),P=O(null),T={};async function I(){P.value=null,f.value=!0;const b=o.params.mesh,k=o.params.dataPlane,C=T;try{y.value=await K.getDataplaneFromMesh({mesh:b,name:k},C),u.value=await K.getDataplaneOverviewFromMesh({mesh:b,name:k},C)}catch(S){y.value=null,S instanceof Error?P.value=S:console.error(S)}finally{f.value=!1}}return V(()=>o.params.mesh,function(){o.name==="data-plane-detail-view"&&I()}),V(()=>o.params.dataPlane,function(){o.name==="data-plane-detail-view"&&I()}),I(),h.dispatch("updatePageTitle",o.params.dataPlane),(b,k)=>(e(),n("div",je,[f.value?(e(),g(be,{key:0})):P.value!==null?(e(),g(Pe,{key:1,error:P.value},null,8,["error"])):y.value===null||u.value===null?(e(),g(ge,{key:2})):(e(),g(qe,{key:3,"data-plane":y.value,"data-plane-overview":u.value},null,8,["data-plane","data-plane-overview"]))]))}});export{ia as default};
