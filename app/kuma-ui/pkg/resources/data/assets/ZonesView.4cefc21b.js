import{D as N,cl as x,cm as K,R as F,e as H,M,P,cn as q,co as R,k as p,cp as S,s as G,cq as J,cr as j,o as l,j as m,c as h,w as o,a as u,b as z,z as _,l as f,t as E,F as C,n as D,i as r}from"./index.c8163df9.js";import{g as Y}from"./tableDataUtils.81ce466c.js";import{_ as Q}from"./CodeBlock.vue_vue_type_style_index_0_lang.14084b4c.js";import{D as U,p as X}from"./patchQueryParam.45d18194.js";import{F as $}from"./FrameSkeleton.37abf819.js";import{_ as ee}from"./LabelList.vue_vue_type_style_index_0_lang.17654be9.js";import{M as te}from"./MultizoneInfo.82949c74.js";import{S as se,a as ne}from"./SubscriptionHeader.64a00821.js";import{T as ie}from"./TabsWidget.33f56719.js";import{W as oe}from"./WarningsWidget.fee34c93.js";import"./_commonjsHelpers.f037b798.js";import"./EmptyBlock.vue_vue_type_script_setup_true_lang.045a908b.js";import"./ErrorBlock.5027dcb1.js";import"./LoadingBlock.vue_vue_type_script_setup_true_lang.c066d224.js";import"./TagList.86529845.js";const ae={name:"ZonesView",components:{AccordionItem:x,AccordionList:K,CodeBlock:Q,DataOverview:U,FrameSkeleton:$,LabelList:ee,MultizoneInfo:te,SubscriptionDetails:se,SubscriptionHeader:ne,TabsWidget:ie,WarningsWidget:oe,KBadge:F,KButton:H,KCard:M},props:{offset:{type:Number,required:!1,default:0}},data(){return{isLoading:!0,isEmpty:!1,error:null,entityIsLoading:!0,entityIsEmpty:!1,entityHasError:!1,tableDataIsEmpty:!1,empty_state:{title:"No Data",message:"There are no Zones present."},tableData:{headers:[{key:"actions",hideLabel:!0},{label:"Status",key:"status"},{label:"Name",key:"name"},{label:"Zone CP Version",key:"zoneCpVersion"},{label:"Storage type",key:"storeType"},{label:"Ingress",key:"hasIngress"},{label:"Egress",key:"hasEgress"},{key:"warnings",hideLabel:!0}],data:[]},tabs:[{hash:"#overview",title:"Overview"},{hash:"#insights",title:"Zone Insights"},{hash:"#config",title:"Config"},{hash:"#warnings",title:"Warnings"}],entity:{},pageSize:P,next:null,warnings:[],subscriptionsReversed:[],codeOutput:null,zonesWithIngress:new Set,pageOffset:this.offset}},computed:{...q({multicluster:"config/getMulticlusterStatus",globalCpVersion:"config/getVersion"})},watch:{$route(){this.isLoading=!0,this.isEmpty=!1,this.error=null,this.entityIsLoading=!0,this.entityIsEmpty=!1,this.entityHasError=!1,this.tableDataIsEmpty=!1,this.init(0)}},beforeMount(){this.init(this.offset)},methods:{init(t){this.multicluster&&this.loadData(t)},filterTabs(){return this.warnings.length?this.tabs:this.tabs.filter(t=>t.hash!=="#warnings")},tableAction(t){const s=t;this.getEntity(s)},parseData(t){const{zoneInsight:s={},name:n}=t;let g="-",e="",a=!0;return s.subscriptions&&s.subscriptions.length&&s.subscriptions.forEach(i=>{if(i.version&&i.version.kumaCp){g=i.version.kumaCp.version;const{kumaCpGlobalCompatible:d=!0}=i.version.kumaCp;a=d,i.config&&(e=JSON.parse(i.config).store.type)}}),{...t,status:R(s).status,zoneCpVersion:g,storeType:e,hasIngress:this.zonesWithIngress.has(n)?"Yes":"No",hasEgress:this.zonesWithEgress.has(n)?"Yes":"No",withWarnings:!a}},calculateZonesWithIngress(t){const s=new Set;t.forEach(({zoneIngress:{zone:n}})=>{s.add(n)}),this.zonesWithIngress=s},calculateZonesWithEgress(t){const s=new Set;t.forEach(({zoneEgress:{zone:n}})=>{s.add(n)}),this.zonesWithEgress=s},async loadData(t){this.pageOffset=t,X("offset",t>0?t:null),this.isLoading=!0,this.isEmpty=!1;const s=this.$route.query.ns||null;try{const[{data:n,next:g},{items:e},{items:a}]=await Promise.all([Y({getSingleEntity:p.getZoneOverview.bind(p),getAllEntities:p.getAllZoneOverviews.bind(p),size:this.pageSize,offset:t,query:s}),S({callEndpoint:p.getAllZoneIngressOverviews.bind(p)}),S({callEndpoint:p.getAllZoneEgressOverviews.bind(p)})]);this.next=g,n.length?(this.calculateZonesWithIngress(e),this.calculateZonesWithEgress(a),this.tableData.data=n.map(this.parseData),this.tableDataIsEmpty=!1,this.isEmpty=!1,this.getEntity({name:n[0].name})):(this.tableData.data=[],this.tableDataIsEmpty=!0,this.isEmpty=!0,this.entityIsEmpty=!0)}catch(n){n instanceof Error?error.value=n:console.error(n),this.isEmpty=!0}finally{this.isLoading=!1}},async getEntity(t){var g,e;this.entityIsLoading=!0,this.entityIsEmpty=!0;const s=["type","name"],n=setTimeout(()=>{this.entityIsEmpty=!0,this.entityIsLoading=!1},"500");if(t){this.entityIsEmpty=!1,this.warnings=[];try{const a=await p.getZoneOverview({name:t.name}),i=(e=(g=a.zoneInsight)==null?void 0:g.subscriptions)!=null?e:[];if(this.entity={...G(a,s),"Authentication Type":J(a)},this.subscriptionsReversed=Array.from(i).reverse(),i.length){const{version:d={}}=i[i.length-1],{kumaCp:b={}}=d,I=b.version||"-",{kumaCpGlobalCompatible:v=!0}=b;v||this.warnings.push({kind:j,payload:{zoneCpVersion:I,globalCpVersion:this.globalCpVersion}}),i[i.length-1].config&&(this.codeOutput=JSON.stringify(JSON.parse(i[i.length-1].config),null,2))}}catch(a){console.error(a),this.entity={},this.entityHasError=!0,this.entityIsEmpty=!0}finally{clearTimeout(n)}}this.entityIsLoading=!1}}},re={class:"zones"},le=f("span",{class:"custom-control-icon"}," \u2190 ",-1),ce={key:0},pe={key:1},ue={key:2};function ge(t,s,n,g,e,a){const i=r("MultizoneInfo"),d=r("KButton"),b=r("DataOverview"),I=r("KBadge"),v=r("LabelList"),L=r("SubscriptionHeader"),A=r("SubscriptionDetails"),O=r("AccordionItem"),W=r("AccordionList"),w=r("KCard"),T=r("CodeBlock"),Z=r("WarningsWidget"),B=r("TabsWidget"),V=r("FrameSkeleton");return l(),m("div",re,[t.multicluster===!1?(l(),h(i,{key:0})):(l(),h(V,{key:1},{default:o(()=>{var k;return[u(b,{"selected-entity-name":(k=e.entity)==null?void 0:k.name,"page-size":e.pageSize,"is-loading":e.isLoading,error:e.error,"empty-state":e.empty_state,"table-data":e.tableData,"table-data-is-empty":e.tableDataIsEmpty,"show-warnings":e.tableData.data.some(c=>c.withWarnings),next:e.next,"page-offset":e.pageOffset,onTableAction:a.tableAction,onLoadData:s[0]||(s[0]=c=>a.loadData(c))},{additionalControls:o(()=>[t.$route.query.ns?(l(),h(d,{key:0,class:"back-button",appearance:"primary",to:{name:"zones"}},{default:o(()=>[le,z(" View All ")]),_:1})):_("",!0)]),_:1},8,["selected-entity-name","page-size","is-loading","error","empty-state","table-data","table-data-is-empty","show-warnings","next","page-offset","onTableAction"]),e.isEmpty===!1?(l(),h(B,{key:0,"has-error":e.error,"is-loading":e.isLoading,tabs:a.filterTabs(),"initial-tab-override":"overview"},{tabHeader:o(()=>[f("div",null,[f("h3",null," Zone: "+E(e.entity.name),1)])]),overview:o(()=>[u(v,{"has-error":e.entityHasError,"is-loading":e.entityIsLoading,"is-empty":e.entityIsEmpty},{default:o(()=>[f("div",null,[f("ul",null,[(l(!0),m(C,null,D(e.entity,(c,y)=>(l(),m("li",{key:y},[c?(l(),m("h4",ce,E(y),1)):_("",!0),y==="status"?(l(),m("p",pe,[u(I,{appearance:c==="Offline"?"danger":"success"},{default:o(()=>[z(E(c),1)]),_:2},1032,["appearance"])])):(l(),m("p",ue,E(c),1))]))),128))])])]),_:1},8,["has-error","is-loading","is-empty"])]),insights:o(()=>[u(w,{"border-variant":"noBorder"},{body:o(()=>[u(W,{"initially-open":0},{default:o(()=>[(l(!0),m(C,null,D(e.subscriptionsReversed,(c,y)=>(l(),h(O,{key:y},{"accordion-header":o(()=>[u(L,{details:c},null,8,["details"])]),"accordion-content":o(()=>[u(A,{details:c},null,8,["details"])]),_:2},1024))),128))]),_:1})]),_:1})]),config:o(()=>[e.codeOutput?(l(),h(w,{key:0,"border-variant":"noBorder"},{body:o(()=>[u(T,{id:"code-block-zone-config",language:"json",code:e.codeOutput,"is-searchable":"","query-key":"zone-config"},null,8,["code"])]),_:1})):_("",!0)]),warnings:o(()=>[u(Z,{warnings:e.warnings},null,8,["warnings"])]),_:1},8,["has-error","is-loading","tabs"])):_("",!0)]}),_:1}))])}const De=N(ae,[["render",ge]]);export{De as default};
