import{d as ke,e as D,cz as be,cv as ve,cA as De,cB as Se,h as Ke,o as i,i as m,j as t,b as a,a as U,w as C,t as h,u as d,A as E,F as I,n as R,m as Re,D as we,E as Te,G as Pe,q as Ne,r as F,f as ye,T as fe,ct as _e,cC as $e,cD as Le,cx as xe,cy as Me,cE as ze,cw as He,c as z,s as Be,l as je,cF as qe,cG as Ge,cH as Ze,O as he,H as Fe,I as Ye}from"./index.7a1b9f3b.js";import{C as Je}from"./ContentWrapper.aa4fab69.js";import{p as ge,D as Qe}from"./patchQueryParam.15c2e324.js";import{T as Xe}from"./TagList.84f5f0a1.js";import{S as We}from"./StatusBadge.3c5db700.js";import{_ as et}from"./YamlView.vue_vue_type_script_setup_true_lang.6cc595be.js";import{_ as tt}from"./EmptyBlock.vue_vue_type_script_setup_true_lang.9d4cddf8.js";const A=l=>(we("data-v-5b05c159"),l=l(),Te(),l),at={class:"entity-summary entity-section-list"},nt={class:"block-list"},st={class:"entity-title","data-testid":"data-plane-proxy-title"},ot={class:"definition"},lt=A(()=>t("span",null,"Mesh:",-1)),it={key:0},rt=A(()=>t("h4",null,"Tags",-1)),dt={key:1},ct=A(()=>t("h4",null,"Dependencies",-1)),ut={class:"mt-2 heading-with-icon"},pt={key:0},mt=A(()=>t("h4",null,"Insights",-1)),vt={class:"block-list"},yt=["data-testid"],ft=A(()=>t("span",null,"Connect time:",-1)),_t=["data-testid"],ht=A(()=>t("span",null,"Disconnect time:",-1)),gt={class:"definition"},kt=A(()=>t("span",null,"CP instance ID:",-1)),bt={key:0},Dt=A(()=>t("summary",null,`
              Responses (acknowledged / sent)
            `,-1)),wt=["data-testid"],Tt={class:"config-section"},Pt=ke({__name:"DataPlaneEntitySummary",props:{dataPlaneOverview:{type:Object,required:!0}},setup(l){const _=l,c=D(()=>{const{name:r,mesh:y,dataplane:v}=_.dataPlaneOverview;return{type:"Dataplane",name:r,mesh:y,networking:v.networking}}),H=D(()=>be(_.dataPlaneOverview.dataplane)),B=D(()=>{var y,v;const r=Array.from((v=(y=_.dataPlaneOverview.dataplaneInsight)==null?void 0:y.subscriptions)!=null?v:[]);return r.reverse(),r.map(n=>{const u=n.connectTime!==void 0?ve(n.connectTime):"\u2014",O=n.disconnectTime!==void 0?ve(n.disconnectTime):"\u2014",T=Object.entries(n.status).filter(([P])=>!["total","lastUpdateTime"].includes(P)).map(([P,g])=>{var j,q,G,L,S;const V=`${(j=g.responsesAcknowledged)!=null?j:0} / ${(q=g.responsesSent)!=null?q:0}`;return{type:P.toUpperCase(),ratio:V,responsesSent:(G=g.responsesSent)!=null?G:0,responsesAcknowledged:(L=g.responsesAcknowledged)!=null?L:0,responsesRejected:(S=g.responsesRejected)!=null?S:0}});return{subscription:n,formattedConnectDate:u,formattedDisconnectDate:O,statuses:T}})}),Y=D(()=>{const{status:r}=De(_.dataPlaneOverview.dataplane,_.dataPlaneOverview.dataplaneInsight);return r}),N=D(()=>{const r=Se(_.dataPlaneOverview.dataplaneInsight);return r!==null?Object.entries(r).map(([y,v])=>({name:y,version:v})):[]}),$=D(()=>{var P,g;const r=(g=(P=_.dataPlaneOverview.dataplaneInsight)==null?void 0:P.subscriptions)!=null?g:[];if(r.length===0)return[];const y=r[r.length-1];if(!y.version)return[];const v=[],n=y.version.envoy,u=y.version.kumaDp;if(!(n.kumaDpCompatible!==void 0?n.kumaDpCompatible:!0)){const V=`Envoy ${n.version} is not supported by Kuma DP ${u.version}.`;v.push(V)}if(!(u.kumaCpCompatible!==void 0?u.kumaCpCompatible:!0)){const V=`Kuma DP ${u.version} is not supported by this Kuma control plane.`;v.push(V)}return v});return(r,y)=>{const v=Ke("router-link");return i(),m("div",at,[t("section",null,[t("div",nt,[t("div",null,[t("h3",st,[t("span",null,[a(`
              DPP:

              `),U(v,{to:{name:"data-plane-detail-view",params:{mesh:l.dataPlaneOverview.mesh,dataPlane:l.dataPlaneOverview.name}}},{default:C(()=>[a(h(l.dataPlaneOverview.name),1)]),_:1},8,["to"])]),a(),U(We,{status:d(Y)},null,8,["status"])]),a(),t("div",ot,[lt,a(),t("span",null,h(l.dataPlaneOverview.mesh),1)])]),a(),d(H).length>0?(i(),m("div",it,[rt,a(),U(Xe,{tags:d(H)},null,8,["tags"])])):E("",!0),a(),d(N).length>0?(i(),m("div",dt,[ct,a(),(i(!0),m(I,null,R(d(N),(n,u)=>(i(),m("div",{key:u,class:"definition"},[t("span",null,h(n.name)+":",1),a(),t("span",null,h(n.version),1)]))),128)),a(),d($).length>0?(i(),m(I,{key:0},[t("h5",ut,[a(`
              Warnings

              `),U(d(Re),{class:"ml-1",icon:"warning",color:"var(--black-75)","secondary-color":"var(--yellow-300)",size:"20"})]),a(),(i(!0),m(I,null,R(d($),(n,u)=>(i(),m("p",{key:u},h(n),1))),128))],64)):E("",!0)])):E("",!0)])]),a(),d(B).length>0?(i(),m("section",pt,[mt,a(),t("div",vt,[(i(!0),m(I,null,R(d(B),(n,u)=>(i(),m("div",{key:u},[t("div",{class:"definition","data-testid":`data-plane-connect-time-${u}`},[ft,a(),t("span",null,h(n.formattedConnectDate),1)],8,yt),a(),t("div",{class:"definition","data-testid":`data-plane-disconnect-time-${u}`},[ht,a(),t("span",null,h(n.formattedDisconnectDate),1)],8,_t),a(),t("div",gt,[kt,a(),t("span",null,h(n.subscription.controlPlaneInstanceId),1)]),a(),n.statuses.length>0?(i(),m("details",bt,[Dt,a(),(i(!0),m(I,null,R(n.statuses,(O,T)=>(i(),m("div",{key:`${u}-${T}`,class:"definition","data-testid":`data-plane-subscription-status-${u}-${T}`},[t("span",null,h(O.type)+":",1),a(),t("span",null,h(O.ratio),1)],8,wt))),128))])):E("",!0)]))),128))])])):E("",!0),a(),t("section",Tt,[U(et,{id:"code-block-data-plane-summary",content:d(c),"code-max-height":"250px"},null,8,["content"])])])}}});const Ct=Pe(Pt,[["__scopeId","data-v-5b05c159"]]),Ce=[{key:"status",label:"Status"},{key:"name",label:"DPP"},{key:"type",label:"Type"},{key:"service",label:"Service"},{key:"protocol",label:"Protocol"},{key:"zone",label:"Zone"},{key:"lastConnected",label:"Last Connected"},{key:"lastUpdated",label:"Last Updated"},{key:"totalUpdates",label:"Total Updates"},{key:"dpVersion",label:"Kuma DP version"},{key:"envoyVersion",label:"Envoy version"},{key:"details",label:"Details",hideLabel:!0}],Ut=["name","details"],At=Ce.filter(l=>!Ut.includes(l.key)).map(l=>({tableHeaderKey:l.key,label:l.label,isChecked:!1})),Ue=["status","name","type","service","protocol","zone","lastUpdated","dpVersion","details"];function Ot(l,_=Ue){return Ce.filter(c=>_.includes(c.key)?l?!0:c.key!=="zone":!1)}const Vt=l=>(we("data-v-aede973f"),l=l(),Te(),l),Et={key:0},It=Vt(()=>t("label",{for:"data-planes-type-filter",class:"mr-2"},`
              Type:
            `,-1)),St=["value"],Kt=["for"],Rt=["id","checked","onChange"],Nt=ke({__name:"DataPlaneList",props:{dataPlaneOverviews:{type:Array,required:!0},isLoading:{type:Boolean,required:!1,default:!1},error:{type:Error,required:!1,default:null},nextUrl:{type:String,required:!1,default:null},pageOffset:{type:Number,required:!1,default:0},name:{type:String,required:!1,default:null},isGatewayView:{type:Boolean,required:!1,default:!1}},emits:["gateway-type-change","load-data"],setup(l,{emit:_}){const c=l,H=50,B=["All","Builtin","Delegated"],Y={title:"No Data",message:"There are no data plane proxies present."},N=Ne(),$=Be(),r=F(Ue),y=F({headers:[],data:[]}),v=F("All"),n=F(null),u=D(()=>$.getters["config/getMulticlusterStatus"]),O=D(()=>({name:$.getters["config/getEnvironment"]==="universal"?"universal-dataplane":"kubernetes-dataplane"})),T=D(()=>{let e=Ot(u.value,r.value);return c.isGatewayView?e=e.filter(s=>s.key!=="protocol"):e=e.filter(s=>s.key!=="type"),{data:y.value.data,headers:e}}),P=D(()=>At.filter(e=>c.isGatewayView?e.tableHeaderKey!=="protocol":e.tableHeaderKey!=="type").filter(e=>u.value?!0:e.tableHeaderKey!=="zone").map(e=>{const s=r.value.includes(e.tableHeaderKey);return{...e,isChecked:s}}));ye(v,function(){_("gateway-type-change",v.value)}),ye(()=>c.dataPlaneOverviews,function(){L()});const g=fe.get("dpVisibleTableHeaderKeys");Array.isArray(g)&&(r.value=g),L();function V(e){_("load-data",e)}function j(e){e.stopPropagation()}function q(e,s){const k=e.target,p=r.value.findIndex(w=>w===s);k.checked&&p===-1?r.value.push(s):!k.checked&&p>-1&&r.value.splice(p,1),fe.set("dpVisibleTableHeaderKeys",Array.from(new Set(r.value)))}function G(){Fe.logger.info(Ye.CREATE_DATA_PLANE_PROXY_CLICKED)}async function L(){var e;try{Array.isArray(c.dataPlaneOverviews)&&c.dataPlaneOverviews.length>0?(S((e=c.name)!=null?e:c.dataPlaneOverviews[0].name),y.value.data=await Promise.all(c.dataPlaneOverviews.map(s=>Ae(s)))):(S(null),y.value.data=[])}catch(s){console.error(s)}}function S(e){var s;e&&c.dataPlaneOverviews.length>0?(n.value=(s=c.dataPlaneOverviews.find(k=>k.name===e))!=null?s:c.dataPlaneOverviews[0],ge("name",n.value.name)):(n.value=null,ge("name",null))}async function Ae(e){var te,ae,ne,se,oe,le,ie,re;const s=e.mesh,k=e.name,p=((te=e.dataplane.networking.gateway)==null?void 0:te.type)||"STANDARD",w={name:p==="STANDARD"?"data-plane-detail-view":"gateway-detail-view",params:{mesh:s,dataPlane:k}},J={name:"mesh-detail-view",params:{mesh:s}},Oe=["kuma.io/protocol","kuma.io/service","kuma.io/zone"],Z=be(e.dataplane).filter(o=>Oe.includes(o.label)),x=(ae=Z.find(o=>o.label==="kuma.io/service"))==null?void 0:ae.value,Q=(ne=Z.find(o=>o.label==="kuma.io/protocol"))==null?void 0:ne.value,M=(se=Z.find(o=>o.label==="kuma.io/zone"))==null?void 0:se.value;let W;x!==void 0&&(W={name:"service-detail-view",params:{mesh:s,service:x}});let ee;M!==void 0&&(ee={name:"zones",query:{ns:M}});const{status:Ve}=De(e.dataplane,e.dataplaneInsight),Ee=(le=(oe=e.dataplaneInsight)==null?void 0:oe.subscriptions)!=null?le:[],Ie={totalUpdates:0,totalRejectedUpdates:0,dpVersion:null,envoyVersion:null,selectedTime:NaN,selectedUpdateTime:NaN,version:null},f=Ee.reduce((o,b)=>{var de,ce,ue,pe;if(b.connectTime){const me=Date.parse(b.connectTime);(!o.selectedTime||me>o.selectedTime)&&(o.selectedTime=me)}const X=Date.parse(b.status.lastUpdateTime);return X&&(!o.selectedUpdateTime||X>o.selectedUpdateTime)&&(o.selectedUpdateTime=X),{totalUpdates:o.totalUpdates+parseInt((de=b.status.total.responsesSent)!=null?de:"0",10),totalRejectedUpdates:o.totalRejectedUpdates+parseInt((ce=b.status.total.responsesRejected)!=null?ce:"0",10),dpVersion:((ue=b.version)==null?void 0:ue.kumaDp.version)||o.dpVersion,envoyVersion:((pe=b.version)==null?void 0:pe.envoy.version)||o.envoyVersion,selectedTime:o.selectedTime,selectedUpdateTime:o.selectedUpdateTime,version:b.version||o.version}},Ie),K={name:k,nameRoute:w,mesh:s,meshRoute:J,type:p,zone:M!=null?M:"\u2014",zoneRoute:ee,service:x!=null?x:"\u2014",serviceInsightRoute:W,protocol:Q!=null?Q:"\u2014",status:Ve,totalUpdates:f.totalUpdates,totalRejectedUpdates:f.totalRejectedUpdates,dpVersion:(ie=f.dpVersion)!=null?ie:"\u2014",envoyVersion:(re=f.envoyVersion)!=null?re:"\u2014",warnings:[],unsupportedEnvoyVersion:!1,unsupportedKumaDPVersion:!1,kumaDpAndKumaCpMismatch:!1,lastUpdated:f.selectedUpdateTime?_e(new Date(f.selectedUpdateTime).toUTCString()):"\u2014",lastConnected:f.selectedTime?_e(new Date(f.selectedTime).toUTCString()):"\u2014",overview:e};if(f.version){const{kind:o}=$e(f.version);switch(o!==Le&&K.warnings.push(o),o){case Me:K.unsupportedEnvoyVersion=!0;break;case xe:K.unsupportedKumaDPVersion=!0;break}}return u.value&&f.dpVersion&&Z.find(b=>b.label===ze)&&typeof f.version.kumaDp.kumaCpCompatible=="boolean"&&!f.version.kumaDp.kumaCpCompatible&&(K.warnings.push(He),K.kumaDpAndKumaCpMismatch=!0),K}return(e,s)=>(i(),z(Je,null,{content:C(()=>{var k;return[U(Qe,{"selected-entity-name":(k=n.value)==null?void 0:k.name,"page-size":H,"is-loading":c.isLoading,error:l.error,"empty-state":Y,"table-data":d(T),"table-data-is-empty":d(T).data.length===0,"show-details":"",next:c.nextUrl!==null,"page-offset":c.pageOffset,onTableAction:s[1]||(s[1]=p=>S(p.name)),onLoadData:s[2]||(s[2]=p=>V(c.pageOffset))},{additionalControls:C(()=>[c.isGatewayView?(i(),m("div",Et,[It,a(),je(t("select",{id:"data-planes-type-filter","onUpdate:modelValue":s[0]||(s[0]=p=>v.value=p),"data-testid":"data-planes-type-filter"},[(i(!0),m(I,null,R(d(B),(p,w)=>(i(),m("option",{key:w,value:p},h(p),9,St))),128))],512),[[qe,v.value]])])):E("",!0),a(),U(d(Ge),{label:"Columns",icon:"cogwheel","button-appearance":"outline"},{items:C(()=>[t("div",{onClick:j},[(i(!0),m(I,null,R(d(P),(p,w)=>(i(),z(d(Ze),{key:w,class:"table-header-selector-item",item:p},{default:C(()=>[t("label",{for:`data-plane-table-header-checkbox-${w}`,class:"k-checkbox table-header-selector-item-checkbox"},[t("input",{id:`data-plane-table-header-checkbox-${w}`,checked:p.isChecked,type:"checkbox",class:"k-input",onChange:J=>q(J,p.tableHeaderKey)},null,40,Rt),a(" "+h(p.label),1)],8,Kt)]),_:2},1032,["item"]))),128))])]),_:1}),a(),U(d(he),{appearance:"creation",to:d(O),icon:"plus","data-testid":"data-plane-create-data-plane-button",onClick:G},{default:C(()=>[a(`
            Create data plane proxy
          `)]),_:1},8,["to"]),a(),d(N).query.ns?(i(),z(d(he),{key:1,appearance:"primary",icon:"arrowLeft",to:{name:d(N).name},"data-testid":"data-plane-ns-back-button"},{default:C(()=>[a(`
            View All
          `)]),_:1},8,["to"])):E("",!0)]),_:1},8,["selected-entity-name","is-loading","error","table-data","table-data-is-empty","next","page-offset"])]}),sidebar:C(()=>[n.value!==null?(i(),z(Ct,{key:0,"data-plane-overview":n.value},null,8,["data-plane-overview"])):(i(),z(tt,{key:1}))]),_:1}))}});const jt=Pe(Nt,[["__scopeId","data-v-aede973f"]]);export{jt as D};
