import{T as q,U as F,I as R,H,B as G,S as Z,m as J,K as A,_ as U,r as D,o as e,b as g,w as l,e as d,h as n,k as v,i as a,p as E,t as c,F as _,f as K,d as Y,L as O,M as I,N as p,cE as X,cF as Q,cI as ee,cw as M,cG as ae,a3 as te,O as j,cx as se,cz as ne,s as oe,cJ as ie,q as le,cK as re,a2 as ce,u as de,x as ue,cL as pe,cM as V}from"./index.f2463021.js";import{S as z,E as B}from"./EnvoyData.2847ea67.js";import{E as me}from"./EntityURLControl.210b712d.js";import{L as W}from"./LabelList.c9504cac.js";import{a as he,S as _e}from"./SubscriptionHeader.a69b1f1e.js";import{T as ye}from"./TabsWidget.817a2fd6.js";import{W as fe}from"./WarningsWidget.05a75c3e.js";import{Y as ve}from"./YamlView.dbf4ab2f.js";import{_ as ge}from"./EmptyBlock.vue_vue_type_script_setup_true_lang.79e60fc9.js";import{E as Pe}from"./ErrorBlock.6b7b6a0a.js";import{_ as we}from"./LoadingBlock.vue_vue_type_script_setup_true_lang.92dd8129.js";import"./CodeBlock.f31221ad.js";import"./index.58caa11d.js";const be={inbound:"Policies applied on incoming connection on address",outbound:"Policies applied on outgoing connection to the address",service:"Policies applied on outgoing connections to service",dataplane:"Policies applied on all incoming and outgoing connections to the selected data plane proxy"},De={name:"DataplanePolicies",components:{StatusInfo:z,AccordionList:q,AccordionItem:F,KCard:R,KPop:H,KIcon:G,KBadge:Z},props:{mesh:{type:String,required:!0},dppName:{type:String,required:!0}},data(){return{items:[],hasItems:!1,isLoading:!0,error:null,searchInput:"",POLICY_TYPE_SUBTITLE:be}},computed:{...J({policiesByType:s=>s.policiesByType})},watch:{dppName(){this.fetchPolicies()}},mounted(){this.fetchPolicies()},methods:{async fetchPolicies(){this.error=null,this.isLoading=!0;try{const{items:s,total:o,kind:m}=await A.getDataplanePolicies({mesh:this.mesh,dppName:this.dppName});(m===void 0||m==="SidecarDataplane")&&(this.processItems(s),this.items=s,this.hasItems=o>0)}catch(s){this.error=s}finally{this.isLoading=!1}},processItems(s){for(const o of s){o.policyTypes={};for(const m in o.matchedPolicies){const y=this.policiesByType[m],u={pluralDisplayName:y.pluralDisplayName,policies:o.matchedPolicies[m]};for(const f of u.policies)f.route={name:y.path,query:{ns:f.name},params:{mesh:f.mesh}};o.policyTypes[m]=u}}}}},Ie={class:"flex items-center justify-between"},ke={key:0,class:"text-lg"},Se={key:1,class:"text-lg"},Te={class:"subtitle"},Le={key:0},xe={key:1},Ce={class:"flex flex-wrap justify-end"},Oe={class:"policy-wrapper"},Ee={class:"policy-type"};function Ke(s,o,m,y,u,f){const P=D("KIcon"),T=D("KPop"),k=D("KBadge"),w=D("router-link"),b=D("AccordionItem"),L=D("AccordionList"),S=D("KCard"),$=D("StatusInfo");return e(),g($,{"has-error":u.error!==null,"is-loading":u.isLoading,error:u.error,"is-empty":!u.hasItems},{default:l(()=>[d(S,{"border-variant":"noBorder"},{body:l(()=>[d(L,{"initially-open":[],"multiple-open":""},{default:l(()=>[(e(!0),n(_,null,v(u.items,(t,h)=>(e(),g(b,{key:h},{"accordion-header":l(()=>[a("div",Ie,[a("div",null,[t.type==="dataplane"?(e(),n("p",ke," Dataplane ")):E("",!0),t.type!=="dataplane"?(e(),n("p",Se,c(t.service),1)):E("",!0),a("p",Te,[t.type==="inbound"||t.type==="outbound"?(e(),n("span",Le,c(t.type)+" "+c(t.name),1)):t.type==="service"||t.type==="dataplane"?(e(),n("span",xe,c(t.type),1)):E("",!0),d(T,{width:"300",placement:"right",trigger:"hover"},{content:l(()=>[a("div",null,c(u.POLICY_TYPE_SUBTITLE[t.type]),1)]),default:l(()=>[d(P,{icon:"help",size:"16",class:"ml-1"})]),_:2},1024)])]),a("div",Ce,[(e(!0),n(_,null,v(t.matchedPolicies,(r,i)=>(e(),g(k,{key:`${h}-${i}`,class:"mr-2 mb-2"},{default:l(()=>[K(c(i),1)]),_:2},1024))),128))])])]),"accordion-content":l(()=>[a("div",Oe,[(e(!0),n(_,null,v(t.policyTypes,(r,i)=>(e(),n("div",{key:`${h}-${i}`,class:"policy-item"},[a("h4",Ee,c(r.pluralDisplayName),1),a("ul",null,[(e(!0),n(_,null,v(r.policies,(x,C)=>(e(),n("li",{key:`${h}-${i}-${C}`,class:"my-1","data-testid":"policy-name"},[d(w,{to:x.route},{default:l(()=>[K(c(x.name),1)]),_:2},1032,["to"])]))),128))])]))),128))])]),_:2},1024))),128))]),_:1})]),_:1})]),_:1},8,["has-error","is-loading","error","is-empty"])}const $e=U(De,[["render",Ke],["__scopeId","data-v-7223f9a8"]]),N=s=>(de("data-v-be24047e"),s=s(),ue(),s),Be={key:0},Ae={class:"entity-status__label"},Ne=N(()=>a("span",{class:"entity-status__dot"},null,-1)),Me={key:1},Ve=N(()=>a("h4",null,"Tags",-1)),We=N(()=>a("h4",null,"Versions",-1)),qe={class:"config-wrapper"},Fe={key:0},Re=K(" This data plane proxy does not yet have mTLS configured \u2014 "),Ue=["href"],Ye=Y({__name:"DataPlaneDetails",props:{dataPlane:{type:Object,required:!0},dataPlaneOverview:{type:Object,required:!0}},setup(s){const o=s,m=j(),y=[{hash:"#overview",title:"Overview"},{hash:"#insights",title:"DPP Insights"},{hash:"#dpp-policies",title:"Policies"},{hash:"#xds-configuration",title:"XDS Configuration"},{hash:"#envoy-stats",title:"Stats"},{hash:"#envoy-clusters",title:"Clusters"},{hash:"#mtls",title:"Certificate Insights"},{hash:"#warnings",title:"Warnings"}],u=O([]),f=I(()=>{const{type:t,name:h,mesh:r}=o.dataPlane,i=se(o.dataPlane,o.dataPlaneOverview.dataplaneInsight);return{type:t,name:h,mesh:r,status:i}}),P=I(()=>M(o.dataPlane)),T=I(()=>ne(o.dataPlaneOverview.dataplaneInsight)),k=I(()=>oe(o.dataPlane)),w=I(()=>ie(o.dataPlaneOverview)),b=I(()=>{const t=Array.from(o.dataPlaneOverview.dataplaneInsight.subscriptions);return t.reverse(),t}),L=I(()=>{const t=m.getters.getKumaDocsVersion;return t!==null?t:"latest"}),S=I(()=>u.value.length===0?y.filter(t=>t.hash!=="#warnings"):y);async function $(){const t=o.dataPlaneOverview.dataplaneInsight.subscriptions;if(t.length===0||!("version"in t[0]))return;const h=t[0].version;if(h.kumaDp&&h.envoy){const i=X(h);i.kind!==Q&&i.kind!==ee&&u.value.push(i)}if(m.getters["config/getMulticlusterStatus"]){const i=M(o.dataPlane),{compatible:x,payload:C}=await ae(i,h.kumaDp.version);x||u.value.push({kind:te,payload:C})}}return $(),(t,h)=>(e(),g(ye,{tabs:p(S),"initial-tab-override":"overview"},{tabHeader:l(()=>[a("div",null,[a("h3",null," DPP: "+c(s.dataPlane.name),1)]),a("div",null,[d(me,{name:s.dataPlane.name,mesh:s.dataPlane.mesh},null,8,["name","mesh"])])]),overview:l(()=>[d(W,null,{default:l(()=>[a("div",null,[a("ul",null,[(e(!0),n(_,null,v(p(f),(r,i)=>(e(),n("li",{key:i},[a("h4",null,c(i),1),i==="status"&&typeof r!="string"?(e(),n("div",Be,[a("div",{class:le(["entity-status",{"is-offline":r.status.toString().toLowerCase()==="offline","is-degraded":r.status.toString().toLowerCase()==="partially degraded"}])},[a("span",Ae,c(r.status),1)],2),(e(!0),n(_,null,v(r.reason,(x,C)=>(e(),n("div",{key:C,class:"reason"},[Ne,K(" "+c(x),1)]))),128))])):(e(),n("div",Me,c(r),1))]))),128))])]),a("div",null,[p(P).length>0?(e(),n(_,{key:0},[Ve,a("p",null,[(e(!0),n(_,null,v(p(P),(r,i)=>(e(),n("span",{key:i,class:"tag-cols"},[a("span",null,c(r.label)+": ",1),a("span",null,c(r.value),1)]))),128))])],64)):E("",!0),p(T)?(e(),n(_,{key:1},[We,a("p",null,[(e(!0),n(_,null,v(p(T),(r,i)=>(e(),n("span",{key:i,class:"tag-cols"},[a("span",null,c(i)+": ",1),a("span",null,c(r),1)]))),128))])],64)):E("",!0)])]),_:1}),a("div",qe,[d(ve,{content:p(k)},null,8,["content"])])]),insights:l(()=>[d(z,{"is-empty":p(b).length===0},{default:l(()=>[d(p(R),{"border-variant":"noBorder"},{body:l(()=>[d(q,{"initially-open":0},{default:l(()=>[(e(!0),n(_,null,v(p(b),(r,i)=>(e(),g(F,{key:i},{"accordion-header":l(()=>[d(he,{details:r},null,8,["details"])]),"accordion-content":l(()=>[d(_e,{details:r,"is-discovery-subscription":""},null,8,["details"])]),_:2},1024))),128))]),_:1})]),_:1})]),_:1},8,["is-empty"])]),"dpp-policies":l(()=>[d($e,{mesh:s.dataPlane.mesh,"dpp-name":s.dataPlane.name},null,8,["mesh","dpp-name"])]),"xds-configuration":l(()=>[d(B,{"data-path":"xds",mesh:s.dataPlane.mesh,"dpp-name":s.dataPlane.name},null,8,["mesh","dpp-name"])]),"envoy-stats":l(()=>[d(B,{"data-path":"stats",mesh:s.dataPlane.mesh,"dpp-name":s.dataPlane.name},null,8,["mesh","dpp-name"])]),"envoy-clusters":l(()=>[d(B,{"data-path":"clusters",mesh:s.dataPlane.mesh,"dpp-name":s.dataPlane.name},null,8,["mesh","dpp-name"])]),mtls:l(()=>[d(W,null,{default:l(()=>[p(w)!==null?(e(),n("ul",Fe,[(e(!0),n(_,null,v(p(w),(r,i)=>(e(),n("li",{key:i},[a("h4",null,c(r.label),1),a("p",null,c(r.value),1)]))),128))])):(e(),g(p(re),{key:1,appearance:"danger"},{alertMessage:l(()=>[Re,a("a",{href:`https://kuma.io/docs/${p(L)}/documentation/security/#certificates`,class:"external-link",target:"_blank"}," Learn About Certificates in "+c(p(ce)),9,Ue)]),_:1}))]),_:1})]),warnings:l(()=>[d(fe,{warnings:u.value},null,8,["warnings"])]),_:1},8,["tabs"]))}});const je=U(Ye,[["__scopeId","data-v-be24047e"]]),ze={class:"component-frame"},la=Y({__name:"DataPlaneDetailView",setup(s){const o=pe(),m=j(),y=O(null),u=O(null),f=O(!0),P=O(null),T={};async function k(){P.value=null,f.value=!0;const w=o.params.mesh,b=o.params.dataPlane,L=T;try{y.value=await A.getDataplaneFromMesh({mesh:w,name:b},L),u.value=await A.getDataplaneOverviewFromMesh({mesh:w,name:b},L)}catch(S){y.value=null,S instanceof Error?P.value=S:console.error(S)}finally{f.value=!1}}return V(()=>o.params.mesh,function(){o.name==="data-plane-detail-view"&&k()}),V(()=>o.params.dataPlane,function(){o.name==="data-plane-detail-view"&&k()}),k(),m.dispatch("updatePageTitle",o.params.dataPlane),(w,b)=>(e(),n("div",ze,[f.value?(e(),g(we,{key:0})):P.value!==null?(e(),g(Pe,{key:1,error:P.value},null,8,["error"])):y.value===null||u.value===null?(e(),g(ge,{key:2})):(e(),g(je,{key:3,"data-plane":y.value,"data-plane-overview":u.value},null,8,["data-plane","data-plane-overview"]))]))}});export{la as default};
