import{A as j,a as V}from"./AccordionList-87e5ec5d.js";import{d as O,M as S,a as T,o as e,c as l,p,f as c,F as m,I as B,t as y,e as h,w as a,s as x,b as u,Z as U,y as Y,z as Z,_ as z,l as J,n as ee,q as I}from"./index-364a2367.js";import{_ as Q}from"./CodeBlock.vue_vue_type_style_index_0_lang-2e327125.js";import{P as W}from"./PolicyTypeTag-f2d12299.js";import{T as H}from"./TagList-7a0fabd2.js";import{_ as te}from"./EmptyBlock.vue_vue_type_script_setup_true_lang-3f5123fb.js";import{t as F}from"./toYaml-4e00099e.js";import{E as K}from"./ErrorBlock-470e75db.js";import{_ as q}from"./LoadingBlock.vue_vue_type_script_setup_true_lang-99252db2.js";import"./index-fce48c05.js";import"./TextWithCopyButton-331646e6.js";import"./CopyButton-0c187074.js";import"./WarningIcon.vue_vue_type_script_setup_true_lang-0e53d9b2.js";const A=v=>(Y("data-v-d33ad9ee"),v=v(),Z(),v),se={class:"policies-list","data-testid":"builtin-gateway-dataplane-policies"},oe={class:"mesh-gateway-policy-list"},ne=A(()=>p("h3",{class:"mb-2"},`
        Gateway policies
      `,-1)),ae={key:0},le=A(()=>p("h3",{class:"mt-6 mb-2"},`
        Listeners
      `,-1)),ce=A(()=>p("b",null,"Host",-1)),ie=A(()=>p("h4",{class:"mt-2 mb-2"},`
                Routes
              `,-1)),re={class:"dataplane-policy-header"},ue=A(()=>p("b",null,"Route",-1)),pe=A(()=>p("b",null,"Service",-1)),de={key:0,class:"badge-list"},ye={class:"mt-1"},_e=O({__name:"BuiltinGatewayPolicies",props:{gatewayDataplane:{},policyTypesByName:{}},setup(v){const b=v,_=S(()=>R(b.gatewayDataplane)),C=S(()=>N(b.gatewayDataplane.policies));function R(g){const w=[],d=g.listeners??[];for(const f of d)for(const t of f.hosts)for(const s of t.routes){const o=[];for(const n of s.destinations){const i=N(n.policies),r={routeName:s.route,route:{name:"policy-detail-view",params:{mesh:g.gateway.mesh,policyPath:"meshgatewayroutes",policy:s.route}},service:n.tags["kuma.io/service"],policies:i};o.push(r)}w.push({protocol:f.protocol,port:f.port,hostName:t.hostName,routeEntries:o})}return w}function N(g){if(g===void 0)return[];const w=[];for(const d of Object.values(g)){const f=b.policyTypesByName[d.type];w.push({type:d.type,name:d.name,route:{name:"policy-detail-view",params:{mesh:d.mesh,policyPath:f.path,policy:d.name}}})}return w}return(g,w)=>{const d=T("router-link"),f=T("KBadge"),t=T("RouterLink");return e(),l("div",se,[p("div",oe,[ne,c(),C.value.length>0?(e(),l("ul",ae,[(e(!0),l(m,null,B(C.value,(s,o)=>(e(),l("li",{key:o},[p("span",null,y(s.type),1),c(`:

          `),h(d,{to:s.route},{default:a(()=>[c(y(s.name),1)]),_:2},1032,["to"])]))),128))])):x("",!0),c(),le,c(),p("div",null,[(e(!0),l(m,null,B(_.value,(s,o)=>(e(),l("div",{key:o},[p("div",null,[p("div",null,[ce,c(": "+y(s.hostName)+":"+y(s.port)+" ("+y(s.protocol)+`)
            `,1)]),c(),s.routeEntries.length>0?(e(),l(m,{key:0},[ie,c(),h(V,{"initially-open":[],"multiple-open":""},{default:a(()=>[(e(!0),l(m,null,B(s.routeEntries,(n,i)=>(e(),u(j,{key:i},U({"accordion-header":a(()=>[p("div",re,[p("div",null,[p("div",null,[ue,c(": "),h(d,{to:n.route},{default:a(()=>[c(y(n.routeName),1)]),_:2},1032,["to"])]),c(),p("div",null,[pe,c(": "+y(n.service),1)])]),c(),n.policies.length>0?(e(),l("div",de,[(e(!0),l(m,null,B(n.policies,(r,k)=>(e(),u(f,{key:`${o}-${k}`},{default:a(()=>[c(y(r.type),1)]),_:2},1024))),128))])):x("",!0)])]),_:2},[n.policies.length>0?{name:"accordion-content",fn:a(()=>[p("ul",ye,[(e(!0),l(m,null,B(n.policies,(r,k)=>(e(),l("li",{key:`${o}-${k}`},[c(y(r.type)+`:

                        `,1),h(t,{to:r.route},{default:a(()=>[c(y(r.name),1)]),_:2},1032,["to"])]))),128))])]),key:"0"}:void 0]),1024))),128))]),_:2},1024)],64)):x("",!0)])]))),128))])])])}}});const me=z(_e,[["__scopeId","data-v-d33ad9ee"]]),he={class:"policy-type-heading"},fe={class:"policy-list"},ge={key:0},ke=O({__name:"PolicyTypeEntryList",props:{id:{},policyTypeEntries:{}},setup(v){const b=[{label:"From",key:"sourceTags"},{label:"To",key:"destinationTags"},{label:"On",key:"name"},{label:"Conf",key:"config"},{label:"Origin policies",key:"origins"}],_=v;function C({headerKey:R}){return{class:`cell-${R}`}}return(R,N)=>{const g=T("router-link"),w=T("KTable");return e(),u(V,{"initially-open":[],"multiple-open":""},{default:a(()=>[(e(!0),l(m,null,B(_.policyTypeEntries,(d,f)=>(e(),u(j,{key:f},{"accordion-header":a(()=>[p("h3",he,[h(W,{"policy-type":d.type},{default:a(()=>[c(y(d.type)+" ("+y(d.connections.length)+`)
          `,1)]),_:2},1032,["policy-type"])])]),"accordion-content":a(()=>[p("div",fe,[h(w,{class:"policy-type-table",fetcher:()=>({data:d.connections,total:d.connections.length}),headers:b,"cell-attrs":C,"disable-pagination":"","is-clickable":""},{sourceTags:a(({rowValue:t})=>[t.length>0?(e(),u(H,{key:0,class:"tag-list","should-truncate":"",tags:t},null,8,["tags"])):(e(),l(m,{key:1},[c(`
                —
              `)],64))]),destinationTags:a(({rowValue:t})=>[t.length>0?(e(),u(H,{key:0,class:"tag-list","should-truncate":"",tags:t},null,8,["tags"])):(e(),l(m,{key:1},[c(`
                —
              `)],64))]),name:a(({rowValue:t})=>[t!==null?(e(),l(m,{key:0},[c(y(t),1)],64)):(e(),l(m,{key:1},[c(`
                —
              `)],64))]),origins:a(({rowValue:t})=>[t.length>0?(e(),l("ul",ge,[(e(!0),l(m,null,B(t,(s,o)=>(e(),l("li",{key:`${f}-${o}`},[h(g,{to:s.route},{default:a(()=>[c(y(s.name),1)]),_:2},1032,["to"])]))),128))])):(e(),l(m,{key:1},[c(`
                —
              `)],64))]),config:a(({rowValue:t,rowKey:s})=>[t!==null?(e(),u(Q,{key:0,id:`${_.id}-${f}-${s}-code-block`,code:t,language:"yaml","show-copy-button":!1},null,8,["id","code"])):(e(),l(m,{key:1},[c(`
                —
              `)],64))]),_:2},1032,["fetcher"])])]),_:2},1024))),128))]),_:1})}}});const ve=z(ke,[["__scopeId","data-v-cd1528a1"]]),be=v=>(Y("data-v-45db36fa"),v=v(),Z(),v),$e={class:"policy-type-heading"},we={class:"policy-list"},Te={key:0,class:"matcher"},Re={key:0,class:"matcher__and"},Pe=be(()=>p("br",null,null,-1)),Be={key:1,class:"matcher__not"},Le={class:"matcher__term"},Ce={key:1},Ne={key:0},Ee=O({__name:"RuleEntryList",props:{id:{},ruleEntries:{},showMatchers:{type:Boolean,default:!0}},setup(v){const{t:b}=J(),_=v;function C({headerKey:R}){return{class:`cell-${R}`}}return(R,N)=>{const g=T("RouterLink"),w=T("KTable");return e(),u(V,{"initially-open":[],"multiple-open":""},{default:a(()=>[(e(!0),l(m,null,B(_.ruleEntries,(d,f)=>(e(),u(j,{key:f},{"accordion-header":a(()=>[p("h3",$e,[h(W,{"policy-type":d.type},{default:a(()=>[c(y(d.type),1)]),_:2},1032,["policy-type"])])]),"accordion-content":a(()=>[p("div",we,[h(w,{class:ee(["policy-type-table",{"has-matchers":_.showMatchers}]),fetcher:()=>({data:d.rules,total:d.rules.length}),headers:[..._.showMatchers?[{label:"Matchers",key:"matchers"}]:[],{label:"Origin policies",key:"origins"},{label:"Conf",key:"config"}],"cell-attrs":C,"disable-pagination":""},U({origins:a(({row:t})=>[t.origins.length>0?(e(),l("ul",Ne,[(e(!0),l(m,null,B(t.origins,(s,o)=>(e(),l("li",{key:`${f}-${o}`},[h(g,{to:s.route},{default:a(()=>[c(y(s.name),1)]),_:2},1032,["to"])]))),128))])):(e(),l(m,{key:1},[c(y(I(b)("common.collection.none")),1)],64))]),config:a(({row:t,rowKey:s})=>[t.config!==void 0?(e(),u(Q,{key:0,id:`${_.id}-${f}-${s}-code-block`,code:t.config,language:"yaml","show-copy-button":!1},null,8,["id","code"])):(e(),l(m,{key:1},[c(y(I(b)("common.collection.none")),1)],64))]),_:2},[_.showMatchers?{name:"matchers",fn:a(({row:t})=>[t.matchers&&t.matchers.length>0?(e(),l("span",Te,[(e(!0),l(m,null,B(t.matchers,({key:s,value:o,not:n},i)=>(e(),l(m,{key:i},[i>0?(e(),l("span",Re,[c(" and"),Pe])):x("",!0),n?(e(),l("span",Be,"!")):x("",!0),p("span",Le,y(`${s}:${o}`),1)],64))),128))])):(e(),l("i",Ce,y(I(b)("data-planes.routes.item.matches_everything")),1))]),key:"0"}:void 0]),1032,["class","fetcher","headers"])])]),_:2},1024))),128))]),_:1})}}});const G=z(Ee,[["__scopeId","data-v-45db36fa"]]),xe={"data-testid":"standard-dataplane-policies",class:"stack"},Ie={class:"mb-2"},Se=O({__name:"StandardDataplanePolicies",props:{sidecarDataplanes:{},inspectRulesForDataplane:{},policyTypesByName:{},showPoliciesSection:{type:Boolean}},setup(v){const{t:b}=J(),_=v,C=S(()=>w(_.sidecarDataplanes)),R=S(()=>{const t=_.inspectRulesForDataplane.rules.find(r=>r.proxyRule);if(!t||!t.proxyRule)return null;const{type:s,proxyRule:o}=t,n=o.conf&&Object.keys(o.conf).length>0?F(o.conf):void 0,i=o.origin.map(r=>{const k=_.policyTypesByName[r.type];return{name:r.name,route:{name:"policy-detail-view",params:{mesh:r.mesh,policyPath:k.path,policy:r.name}}}});return{type:s,rules:[{config:n,origins:i}]}}),N=S(()=>{const t=[];for(const s of _.inspectRulesForDataplane.rules){const o=s.toRules??[];o.length>0&&t.push({type:s.type,rules:f(o)})}return t.sort((s,o)=>s.type.localeCompare(o.type)),t}),g=S(()=>{const t=new Map;for(const o of _.inspectRulesForDataplane.rules){const n=o.fromRules??[];if(n.length!==0)for(const i of n)t.has(i.inbound.port)||t.set(i.inbound.port,[]),t.get(i.inbound.port).push({type:o.type,rules:f(i.rules)})}for(const[,o]of t)o.sort((n,i)=>n.type.localeCompare(i.type));const s=Array.from(t);return s.sort(([o],[n])=>n-o),s.map(([o,n])=>({port:o,ruleEntries:n}))});function w(t){const s=new Map;for(const n of t){const{type:i,service:r}=n,k=typeof r=="string"&&r!==""?[{label:"kuma.io/service",value:r}]:[],P=i==="inbound"||i==="outbound"?n.name:null;for(const[$,E]of Object.entries(n.matchedPolicies)){s.has($)||s.set($,{type:$,connections:[]});const L=s.get($),D=_.policyTypesByName[$];for(const M of E){const X=d(M,D,n,k,P);L.connections.push(...X)}}}const o=Array.from(s.values());return o.sort((n,i)=>n.type.localeCompare(i.type)),o}function d(t,s,o,n,i){const r=t.conf&&Object.keys(t.conf).length>0?F(t.conf):null,P=[{name:t.name,route:{name:"policy-detail-view",params:{mesh:t.mesh,policyPath:s.path,policy:t.name}}}],$=[];if(o.type==="inbound"&&Array.isArray(t.sources))for(const{match:E}of t.sources){const D={sourceTags:[{label:"kuma.io/service",value:E["kuma.io/service"]}],destinationTags:n,name:i,config:r,origins:P};$.push(D)}else{const L={sourceTags:[],destinationTags:n,name:i,config:r,origins:P};$.push(L)}return $}function f(t){return t.map(({conf:s,matchers:o,origin:n})=>{const i=s&&Object.keys(s).length>0?F(s):void 0,r=n.map(k=>{const P=_.policyTypesByName[k.type];return{name:k.name,route:{name:"policy-detail-view",params:{mesh:k.mesh,policyPath:P.path,policy:k.name}}}});return{config:i,matchers:o,origins:r}})}return(t,s)=>{const o=T("KCard");return e(),l("div",xe,[(!_.showPoliciesSection||_.sidecarDataplanes.length===0)&&_.inspectRulesForDataplane.rules.length===0?(e(),u(o,{key:0},{default:a(()=>[h(te)]),_:1})):(e(),l(m,{key:1},[_.showPoliciesSection?(e(),u(o,{key:0},{default:a(()=>[h(ve,{id:"policies","policy-type-entries":C.value,"data-testid":"policy-list"},null,8,["policy-type-entries"])]),_:1})):x("",!0),c(),R.value?(e(),u(o,{key:1},{default:a(()=>[p("h3",null,y(I(b)("data-planes.routes.item.proxy_rule")),1),c(),h(G,{id:"proxy-rules",class:"mt-2","rule-entries":[R.value],"show-matchers":!1,"data-testid":"proxy-rule-list"},null,8,["rule-entries"])]),_:1})):x("",!0),c(),N.value.length>0?(e(),u(o,{key:2},{default:a(()=>[p("h3",null,y(I(b)("data-planes.routes.item.to_rules")),1),c(),h(G,{id:"to-rules",class:"mt-2","rule-entries":N.value,"data-testid":"to-rule-list"},null,8,["rule-entries"])]),_:1})):x("",!0),c(),g.value.length>0?(e(),u(o,{key:3},{default:a(()=>[p("h3",Ie,y(I(b)("data-planes.routes.item.from_rules")),1),c(),(e(!0),l(m,null,B(g.value,(n,i)=>(e(),l("div",{key:i},[p("h4",null,y(I(b)("data-planes.routes.item.port",{port:n.port})),1),c(),h(G,{id:`from-rules-${i}`,class:"mt-2","rule-entries":n.ruleEntries,"data-testid":`from-rule-list-${i}`},null,8,["id","rule-entries","data-testid"])]))),128))]),_:1})):x("",!0)],64))])}}}),Ye=O({__name:"DataPlanePoliciesView",props:{data:{}},setup(v){const b=v;return(_,C)=>{const R=T("RouteTitle"),N=T("KCard"),g=T("DataSource"),w=T("AppView"),d=T("RouteView");return e(),u(d,{name:"data-plane-policies-view",params:{mesh:"",dataPlane:""}},{default:a(({can:f,route:t,t:s})=>[h(w,null,{title:a(()=>[p("h2",null,[h(R,{title:s("data-planes.routes.item.navigation.data-plane-policies-view")},null,8,["title"])])]),default:a(()=>{var o,n,i;return[c(),((i=(n=(o=b.data.dataplane)==null?void 0:o.networking)==null?void 0:n.gateway)==null?void 0:i.type)==="BUILTIN"?(e(),u(g,{key:0,src:"/*/policy-types"},{default:a(({data:r,error:k})=>[h(g,{src:`/meshes/${t.params.mesh}/dataplanes/${t.params.dataPlane}/gateway-dataplane-policies`},{default:a(({data:P,error:$})=>[k?(e(),u(K,{key:0,error:k},null,8,["error"])):$?(e(),u(K,{key:1,error:$},null,8,["error"])):P===void 0||r===void 0?(e(),u(q,{key:2})):(e(),u(N,{key:3},{default:a(()=>[h(me,{"policy-types-by-name":r.policies.reduce((E,L)=>Object.assign(E,{[L.name]:L}),{}),"gateway-dataplane":P},null,8,["policy-types-by-name","gateway-dataplane"])]),_:2},1024))]),_:2},1032,["src"])]),_:2},1024)):(e(),u(g,{key:1,src:"/*/policy-types"},{default:a(({data:r,error:k})=>[h(g,{src:`/meshes/${t.params.mesh}/dataplanes/${t.params.dataPlane}/sidecar-dataplane-policies`},{default:a(({data:P,error:$})=>[h(g,{src:`/meshes/${t.params.mesh}/dataplanes/${t.params.dataPlane}/rules`},{default:a(({data:E,error:L})=>[k?(e(),u(K,{key:0,error:k},null,8,["error"])):$?(e(),u(K,{key:1,error:$},null,8,["error"])):L?(e(),u(K,{key:2,error:L},null,8,["error"])):r===void 0||P===void 0||E===void 0?(e(),u(q,{key:3})):(e(),u(Se,{key:4,"policy-types-by-name":r.policies.reduce((D,M)=>Object.assign(D,{[M.name]:M}),{}),"sidecar-dataplanes":P.items,"inspect-rules-for-dataplane":E,"show-policies-section":!f("use zones")},null,8,["policy-types-by-name","sidecar-dataplanes","inspect-rules-for-dataplane","show-policies-section"]))]),_:2},1032,["src"])]),_:2},1032,["src"])]),_:2},1024))]}),_:2},1024)]),_:1})}}});export{Ye as default};
