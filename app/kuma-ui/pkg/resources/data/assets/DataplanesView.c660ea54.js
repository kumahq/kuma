import{m as st,K as k,_ as Z,r as c,o as s,b as E,w as i,d as u,f as l,j as D,h as a,n as T,t as m,F as v,e as S,M as at,P as nt,k as it,q as ot,cu as rt,cv as lt,cw as F,cx as j,V as q,cy as ct,cz as H,cA as pt,cB as dt,cC as ut,l as mt,s as ht,cD as yt,cE as _t,Y as gt,Z as ft,$ as bt,p as Dt,z as vt,B as Et}from"./index.6180ff6f.js";import{S as wt,a as It}from"./SubscriptionHeader.f3e62532.js";import{d as Lt}from"./datadogEvents.f0c2b8e0.js";import{E as kt}from"./EntityURLControl.1c6f3e0f.js";import{F as Tt}from"./FrameSkeleton.9d8fd5de.js";import{D as St,L as Pt}from"./LabelList.33120ec9.js";import{T as At}from"./TabsWidget.6e628a3c.js";import{Y as Ct}from"./YamlView.d3fe5dc5.js";import{W as Vt}from"./WarningsWidget.947749b9.js";import{A as G,a as X}from"./AccordionItem.ddeeebdc.js";import{g as Nt}from"./tableDataUtils.9642ba3f.js";import{S as Q,E as Ut}from"./EnvoyData.6062ceda.js";const Kt={inbound:"Policies applied on incoming connection on address",outbound:"Policies applied on outgoing connection to the address",service:"Policies applied on outgoing connections to service",dataplane:"Policies applied on all incoming and outgoing connections to the selected data plane proxy"},xt={name:"DataplanePolicies",components:{StatusInfo:Q,AccordionList:G,AccordionItem:X},props:{mesh:{type:String,required:!0},dppName:{type:String,required:!0}},data(){return{items:[],hasItems:!1,isLoading:!0,error:null,searchInput:"",POLICY_TYPE_SUBTITLE:Kt}},computed:{...st({policiesByType:e=>e.policiesByType})},watch:{dppName(){this.fetchPolicies()}},mounted(){this.fetchPolicies()},methods:{async fetchPolicies(){this.error=null,this.isLoading=!0;try{const{items:e,total:n,kind:o}=await k.getDataplanePolicies({mesh:this.mesh,dppName:this.dppName});(o===void 0||o==="SidecarDataplane")&&(this.processItems(e),this.items=e,this.hasItems=n>0)}catch(e){this.error=e}finally{this.isLoading=!1}},processItems(e){for(const n of e){n.policyTypes={};for(const o in n.matchedPolicies){const d=this.policiesByType[o],t={pluralDisplayName:d.pluralDisplayName,policies:n.matchedPolicies[o]};for(const r of t.policies)r.route={name:d.path,query:{ns:r.name},params:{mesh:r.mesh}};n.policyTypes[o]=t}}}}},Bt={class:"flex items-center justify-between"},Mt={key:0,class:"text-lg"},Ot={key:1,class:"text-lg"},Rt={class:"subtitle"},Wt={key:0},zt={key:1},Yt={class:"flex flex-wrap justify-end"},Ft={class:"policy-wrapper"},jt={class:"policy-type"};function qt(e,n,o,d,t,r){const y=c("KIcon"),w=c("KPop"),I=c("KBadge"),b=c("router-link"),P=c("AccordionItem"),N=c("AccordionList"),A=c("KCard"),C=c("StatusInfo");return s(),E(C,{"has-error":t.error!==null,"is-loading":t.isLoading,error:t.error,"is-empty":!t.hasItems},{default:i(()=>[u(A,{"border-variant":"noBorder"},{body:i(()=>[u(N,{"initially-open":[],"multiple-open":""},{default:i(()=>[(s(!0),l(v,null,D(t.items,(_,f)=>(s(),E(P,{key:f},{"accordion-header":i(()=>[a("div",Bt,[a("div",null,[_.type==="dataplane"?(s(),l("p",Mt," Dataplane ")):T("",!0),_.type!=="dataplane"?(s(),l("p",Ot,m(_.service),1)):T("",!0),a("p",Rt,[_.type==="inbound"||_.type==="outbound"?(s(),l("span",Wt,m(_.type)+" "+m(_.name),1)):_.type==="service"||_.type==="dataplane"?(s(),l("span",zt,m(_.type),1)):T("",!0),u(w,{width:"300",placement:"right",trigger:"hover"},{content:i(()=>[a("div",null,m(t.POLICY_TYPE_SUBTITLE[_.type]),1)]),default:i(()=>[u(y,{icon:"help",size:"16",class:"ml-1"})]),_:2},1024)])]),a("div",Yt,[(s(!0),l(v,null,D(_.matchedPolicies,(L,h)=>(s(),E(I,{key:`${f}-${h}`,class:"mr-2 mb-2"},{default:i(()=>[S(m(h),1)]),_:2},1024))),128))])])]),"accordion-content":i(()=>[a("div",Ft,[(s(!0),l(v,null,D(_.policyTypes,(L,h)=>(s(),l("div",{key:`${f}-${h}`,class:"policy-item"},[a("h4",jt,m(L.pluralDisplayName),1),a("ul",null,[(s(!0),l(v,null,D(L.policies,(V,U)=>(s(),l("li",{key:`${f}-${h}-${U}`,class:"my-1","data-testid":"policy-name"},[u(b,{to:V.route},{default:i(()=>[S(m(V.name),1)]),_:2},1032,["to"])]))),128))])]))),128))])]),_:2},1024))),128))]),_:1})]),_:1})]),_:1},8,["has-error","is-loading","error","is-empty"])}const Ht=Z(xt,[["render",qt],["__scopeId","data-v-b6380898"]]);const Zt={name:"DataplanesView",components:{EnvoyData:Ut,WarningsWidget:Vt,EntityURLControl:kt,FrameSkeleton:Tt,DataOverview:St,TabsWidget:At,YamlView:Ct,LabelList:Pt,AccordionList:G,AccordionItem:X,SubscriptionDetails:wt,SubscriptionHeader:It,DataplanePolicies:Ht,StatusInfo:Q},props:{nsBackButtonRoute:{type:Object,default(){return{name:"dataplanes"}}},emptyStateMsg:{type:String,default:"There are no data plane proxies present."},dataplaneApiParams:{type:Object,default(){return{}}},tableHeaders:{type:Array,default(){return[{key:"actions",hideLabel:!0},{label:"Status",key:"status"},{label:"Name",key:"name"},{label:"Mesh",key:"mesh"},{label:"Type",key:"type"},{label:"Tags",key:"tags"},{label:"Last Connected",key:"lastConnected"},{label:"Last Updated",key:"lastUpdated"},{label:"Total Updates",key:"totalUpdates"},{label:"Kuma DP version",key:"dpVersion"},{label:"Envoy version",key:"envoyVersion"},{key:"warnings",hideLabel:!0}]}},tabs:{type:Array,default(){return[{hash:"#overview",title:"Overview"},{hash:"#insights",title:"DPP Insights"},{hash:"#dpp-policies",title:"Policies"},{hash:"#xds-configuration",title:"XDS Configuration"},{hash:"#envoy-stats",title:"Stats"},{hash:"#envoy-clusters",title:"Clusters"},{hash:"#mtls",title:"Certificate Insights"},{hash:"#yaml",title:"YAML"},{hash:"#warnings",title:"Warnings"}]}}},data(){return{productName:at,isLoading:!0,isEmpty:!1,hasError:!1,entityIsLoading:!0,entityIsEmpty:!1,warnings:[],tableDataIsEmpty:!1,tableData:{headers:[],data:[]},subscriptionsReversed:[],entity:{},rawEntity:{},pageSize:nt,next:null,shownTLSTab:!1,rawData:null}},computed:{...it({environment:"config/getEnvironment",queryNamespace:"getItemQueryNamespace",multicluster:"config/getMulticlusterStatus"}),dataplaneWizardRoute(){return this.environment==="universal"?{name:"universal-dataplane"}:{name:"kubernetes-dataplane"}},kumaDocsVersion(){const e=this.$store.getters.getKumaDocsVersion;return e!==null?e:"latest"},entityName(){var e,n;return((n=(e=this.entity)==null?void 0:e.basicData)==null?void 0:n.name)||""},entityMesh(){var e,n;return((n=(e=this.entity)==null?void 0:e.basicData)==null?void 0:n.mesh)||""}},watch:{$route(){this.isLoading=!0,this.isEmpty=!1,this.hasError=!1,this.entityIsLoading=!0,this.entityIsEmpty=!1,this.tableDataIsEmpty=!1,this.loadData()}},beforeMount(){this.loadData()},methods:{onCreateClick(){ot.logger.info(Lt.CREATE_DATA_PLANE_PROXY_CLICKED)},buildEntity(e,n,o,d){const t=o.mTLS?rt(o.mTLS):null;return{basicData:e,tags:n,mtls:t,versions:d}},init(){this.loadData()},getEmptyState(){return{title:"No Data",message:this.emptyStateMsg}},filterTabs(){return this.warnings.length?this.tabs:this.tabs.filter(e=>e.hash!=="#warnings")},buildTableData(){return{...this.tableData,headers:this.tableHeaders}},compatibilityKind(e){return lt(e)},tableAction(e){const n=e;this.getEntity(n)},async parseData(e){const{dataplane:n={},dataplaneInsight:o={}}=e,{name:d="",mesh:t=""}=e,{subscriptions:r=[]}=o,y=F(n),{status:w}=j(n,o),{totalUpdates:I,totalRejectedUpdates:b,dpVersion:P,envoyVersion:N,selectedTime:A,selectedUpdateTime:C,version:_}=r.reduce((h,V)=>{const{status:U={},connectTime:R,version:x={}}=V,{total:W={},lastUpdateTime:p}=U,{responsesSent:g="0",responsesRejected:B="0"}=W,{kumaDp:J={},envoy:$={}}=x,{version:tt}=J,{version:et}=$;let{selectedTime:M,selectedUpdateTime:O}=h;const z=Date.parse(R),Y=Date.parse(p);return z&&(!M||z>M)&&(M=z),Y&&(!O||Y>O)&&(O=Y),{totalUpdates:h.totalUpdates+parseInt(g,10),totalRejectedUpdates:h.totalRejectedUpdates+parseInt(B,10),dpVersion:tt||h.dpVersion,envoyVersion:et||h.envoyVersion,selectedTime:M,selectedUpdateTime:O,version:x||h.version}},{totalUpdates:0,totalRejectedUpdates:0,dpVersion:"-",envoyVersion:"-",selectedTime:NaN,selectedUpdateTime:NaN,version:{}}),f={name:d,mesh:t,tags:y,status:w,totalUpdates:I,totalRejectedUpdates:b,dpVersion:P,envoyVersion:N,withWarnings:!1,unsupportedEnvoyVersion:!1,unsupportedKumaDPVersion:!1,kumaDpAndKumaCpMismatch:!1,lastUpdated:C?q(new Date(C).toUTCString()):"never",lastConnected:A?q(new Date(A).toUTCString()):"never",type:ct(n)},{kind:L}=this.compatibilityKind(_);switch(L){case bt:f.unsupportedEnvoyVersion=!0,f.withWarnings=!0;break;case ft:f.unsupportedKumaDPVersion=!0,f.withWarnings=!0;break}if(this.multicluster){const{compatible:h}=await H(y,P);h||(f.withWarnings=!0,f.kumaDpAndKumaCpMismatch=!0)}return f},async loadData(e="0"){this.isLoading=!0;const n=this.$route.params.mesh||null,o=this.$route.query.ns||null;try{const{data:d,next:t}=await Nt({getSingleEntity:k.getDataplaneOverviewFromMesh.bind(k),getAllEntities:k.getAllDataplaneOverviews.bind(k),getAllEntitiesFromMesh:k.getAllDataplaneOverviewsFromMesh.bind(k),size:this.pageSize,offset:e,mesh:n,query:o,params:{...this.dataplaneApiParams}});if(d.length){this.next=t,this.rawData=d,this.getEntity({name:d[0].name});const r=await Promise.all(d.map(y=>this.parseData(y)));this.tableData.data=r,this.tableDataIsEmpty=!1,this.isEmpty=!1}else this.tableData.data=[],this.tableDataIsEmpty=!0,this.isEmpty=!0}catch(d){this.hasError=!0,this.isEmpty=!0,console.error(d)}finally{this.isLoading=!1}},async getEntity(e){this.entityIsLoading=!0,this.entityIsEmpty=!1;const n=this.rawData.find(d=>d.name===e.name),o=pt(n);if(o){const d=["type","name","mesh"],t=dt(n)||{},r=j(o,t),y=F(o),w=ut(t),I={...mt(o,d),status:r};this.entity=this.buildEntity(I,y,t,w),this.warnings=[];const{subscriptions:b=[]}=t;this.subscriptionsReversed=Array.from(b).reverse(),b.length&&this.setEntityWarnings(b,y),this.rawEntity=ht(o)}else this.entity={},this.entityIsEmpty=!0;this.entityIsLoading=!1},async setEntityWarnings(e,n){const{version:o={}}=e[e.length-1],{kumaDp:d={},envoy:t={}}=o;if(d&&t){const r=this.compatibilityKind(o),{kind:y}=r;y!==yt&&y!==_t&&this.warnings.push(r)}if(this.multicluster){const{compatible:r,payload:y}=await H(n,d.version);r||this.warnings.push({kind:gt,payload:y})}}}},K=e=>(vt("data-v-8f30c133"),e=e(),Et(),e),Gt=K(()=>a("span",{class:"custom-control-icon"}," + ",-1)),Xt=S(" Create data plane proxy "),Qt=K(()=>a("span",{class:"custom-control-icon"}," \u2190 ",-1)),Jt=S(" View All "),$t={key:0},te={key:0},ee={class:"entity-status__label"},se={class:"reason-list"},ae=K(()=>a("span",{class:"entity-status__dot"},null,-1)),ne={key:1},ie=K(()=>a("h4",null,"Tags",-1)),oe={key:0},re=K(()=>a("h4",null,"Versions",-1)),le={key:0},ce=S(" This data plane proxy does not yet have mTLS configured \u2014 "),pe=["href"];function de(e,n,o,d,t,r){const y=c("KButton"),w=c("DataOverview"),I=c("EntityURLControl"),b=c("LabelList"),P=c("SubscriptionHeader"),N=c("SubscriptionDetails"),A=c("AccordionItem"),C=c("AccordionList"),_=c("KCard"),f=c("StatusInfo"),L=c("DataplanePolicies"),h=c("EnvoyData"),V=c("KAlert"),U=c("YamlView"),R=c("WarningsWidget"),x=c("TabsWidget"),W=c("FrameSkeleton");return s(),E(W,null,{default:i(()=>[u(w,{"page-size":t.pageSize,"has-error":t.hasError,"is-loading":t.isLoading,"empty-state":r.getEmptyState(),"table-data":r.buildTableData(),"table-data-is-empty":t.tableDataIsEmpty,"show-warnings":t.tableData.data.some(p=>p.withWarnings),next:t.next,onTableAction:r.tableAction,onLoadData:n[0]||(n[0]=p=>r.loadData(p))},{additionalControls:i(()=>[u(y,{class:"add-dp-button",appearance:"primary",size:"small",to:r.dataplaneWizardRoute,onClick:r.onCreateClick},{default:i(()=>[Gt,Xt]),_:1},8,["to","onClick"]),e.$route.query.ns?(s(),E(y,{key:0,class:"back-button",appearance:"primary",size:"small",to:o.nsBackButtonRoute},{default:i(()=>[Qt,Jt]),_:1},8,["to"])):T("",!0)]),_:1},8,["page-size","has-error","is-loading","empty-state","table-data","table-data-is-empty","show-warnings","next","onTableAction"]),t.isEmpty===!1?(s(),E(x,{key:0,"has-error":t.hasError,"is-loading":t.isLoading,tabs:r.filterTabs(),"initial-tab-override":"overview"},{tabHeader:i(()=>[a("div",null,[t.entity.basicData?(s(),l("h3",$t," DPP: "+m(t.entity.basicData.name),1)):T("",!0)]),a("div",null,[u(I,{name:r.entityName,mesh:r.entityMesh},null,8,["name","mesh"])])]),overview:i(()=>[u(b,{"is-loading":t.entityIsLoading,"is-empty":t.entityIsEmpty},{default:i(()=>[a("div",null,[a("ul",null,[(s(!0),l(v,null,D(t.entity.basicData,(p,g)=>(s(),l("li",{key:g},[g==="status"?(s(),l("div",te,[a("h4",null,m(g),1),a("div",{class:Dt(["entity-status",{"is-offline":p.status.toString().toLowerCase()==="offline"||p.status===!1,"is-degraded":p.status.toString().toLowerCase()==="partially degraded"||p.status===!1}])},[a("span",ee,m(p.status),1)],2),a("div",se,[a("ul",null,[(s(!0),l(v,null,D(p.reason,B=>(s(),l("li",{key:B},[ae,S(" "+m(B),1)]))),128))])])])):(s(),l("div",ne,[a("h4",null,m(g),1),S(" "+m(p),1)]))]))),128))])]),a("div",null,[ie,a("p",null,[(s(!0),l(v,null,D(t.entity.tags,(p,g)=>(s(),l("span",{key:g,class:"tag-cols"},[a("span",null,m(p.label)+": ",1),a("span",null,m(p.value),1)]))),128))]),t.entity.versions?(s(),l("div",oe,[re,a("p",null,[(s(!0),l(v,null,D(t.entity.versions,(p,g)=>(s(),l("span",{key:g,class:"tag-cols"},[a("span",null,m(g)+": ",1),a("span",null,m(p),1)]))),128))])])):T("",!0)])]),_:1},8,["is-loading","is-empty"])]),insights:i(()=>[u(f,{"is-empty":t.subscriptionsReversed.length===0},{default:i(()=>[u(_,{"border-variant":"noBorder"},{body:i(()=>[u(C,{"initially-open":0},{default:i(()=>[(s(!0),l(v,null,D(t.subscriptionsReversed,(p,g)=>(s(),E(A,{key:g},{"accordion-header":i(()=>[u(P,{details:p},null,8,["details"])]),"accordion-content":i(()=>[u(N,{details:p,"is-discovery-subscription":""},null,8,["details"])]),_:2},1024))),128))]),_:1})]),_:1})]),_:1},8,["is-empty"])]),"dpp-policies":i(()=>[u(L,{mesh:t.rawEntity.mesh,"dpp-name":t.rawEntity.name},null,8,["mesh","dpp-name"])]),"xds-configuration":i(()=>[u(h,{"data-path":"xds",mesh:t.rawEntity.mesh,"dpp-name":t.rawEntity.name},null,8,["mesh","dpp-name"])]),"envoy-stats":i(()=>[u(h,{"data-path":"stats",mesh:t.rawEntity.mesh,"dpp-name":t.rawEntity.name},null,8,["mesh","dpp-name"])]),"envoy-clusters":i(()=>[u(h,{"data-path":"clusters",mesh:t.rawEntity.mesh,"dpp-name":t.rawEntity.name},null,8,["mesh","dpp-name"])]),mtls:i(()=>[u(b,{"is-loading":t.entityIsLoading,"is-empty":t.entityIsEmpty},{default:i(()=>[t.entity.mtls?(s(),l("ul",le,[(s(!0),l(v,null,D(t.entity.mtls,(p,g)=>(s(),l("li",{key:g},[a("h4",null,m(p.label),1),a("p",null,m(p.value),1)]))),128))])):(s(),E(V,{key:1,appearance:"danger"},{alertMessage:i(()=>[ce,a("a",{href:`https://kuma.io/docs/${r.kumaDocsVersion}/documentation/security/#certificates`,class:"external-link",target:"_blank"}," Learn About Certificates in "+m(t.productName),9,pe)]),_:1}))]),_:1},8,["is-loading","is-empty"])]),yaml:i(()=>[u(U,{"is-loading":t.entityIsLoading,"is-empty":t.entityIsEmpty,content:t.rawEntity},null,8,["is-loading","is-empty","content"])]),warnings:i(()=>[u(R,{warnings:t.warnings},null,8,["warnings"])]),_:1},8,["has-error","is-loading","tabs"])):T("",!0)]),_:1})}const Ie=Z(Zt,[["render",de],["__scopeId","data-v-8f30c133"]]);export{Ie as D};
