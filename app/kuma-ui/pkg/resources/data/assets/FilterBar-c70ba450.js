var ie=Object.defineProperty;var oe=(s,i,t)=>i in s?ie(s,i,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[i]=t;var V=(s,i,t)=>(oe(s,typeof i!="symbol"?i+"":i,t),t);import{K as B}from"./index-52545d1d.js";import{d as ee,l as le,a as J,o as m,b as Z,a0 as re,w as S,r as te,e as C,f as p,t as _,c as g,F as z,q as f,p as k,B as se,s as U,W as ue,_ as ne,m as A,N as Q,aa as Y,at as ce,au as de,av as fe,n as G,aw as me,ax as pe,I as ge,T as ve,z as he,A as ye}from"./index-baa571c4.js";import{b as be,g as ke}from"./index-6d871659.js";import{A as _e}from"./AppCollection-07d36810.js";import{S as Se}from"./StatusBadge-7a073617.js";import{T as Te}from"./TagList-92ca50e0.js";import{_ as we}from"./WarningIcon.vue_vue_type_script_setup_true_lang-ce954803.js";import{c as Ce,C as xe}from"./dataplane-007a0b6b.js";const Ie={key:0},Le=ee({__name:"DataPlaneList",props:{total:{default:0},pageNumber:{},pageSize:{},items:{},error:{},isSelectedRow:{type:[Function,null],default:null},summaryRouteName:{},canUseZones:{type:Boolean}},emits:["change"],setup(s,{emit:i}){const{t,formatIsoDate:T}=le(),r=s,a=i;function o(v){return v.map(l=>{var q,F,$,M,N,P,j;const{mesh:c,name:h}=l,n=(q=l.dataplane.networking.gateway)!=null&&q.type?t(`data-planes.type.${l.dataplane.networking.gateway.type.toLowerCase()}`):t("data-planes.type.standard"),y=be(l),x=y.filter(b=>b.label==="kuma.io/service"),{status:O}=ke(l),H=((F=l.dataplaneInsight)==null?void 0:F.subscriptions)??[],W={dpVersion:null,version:null},I=H.reduce((b,w)=>{var K;return{dpVersion:((K=w.version)==null?void 0:K.kumaDp.version)||b.dpVersion,version:w.version||b.version}},W);let D;(M=($=l.dataplaneInsight)==null?void 0:$.mTLS)!=null&&M.certificateExpirationTime?D=T(l.dataplaneInsight.mTLS.certificateExpirationTime):D=t("data-planes.components.data-plane-list.certificate.none");const L={name:h,type:n,mesh:c,services:x,status:O,warnings:{version_mismatch:!1,cert_expired:!1},certificate:D};if(I.version){const{kind:b}=Ce(I.version);b!==xe&&(L.warnings.version_mismatch=!0)}r.canUseZones&&I.dpVersion&&y.find(w=>w.label==="kuma.io/zone")&&typeof((N=I.version)==null?void 0:N.kumaDp.kumaCpCompatible)=="boolean"&&!I.version.kumaDp.kumaCpCompatible&&(L.warnings.version_mismatch=!0);const E=(j=(P=l.dataplaneInsight)==null?void 0:P.mTLS)==null?void 0:j.certificateExpirationTime;return E&&Date.now()>new Date(E).getTime()&&(L.warnings.cert_expired=!0),L})}return(v,l)=>{const c=J("RouterLink"),h=J("KTooltip");return m(),Z(_e,{class:"data-plane-collection","empty-state-message":f(t)("common.emptyState.message",{type:"Data Plane Proxies"}),"empty-state-cta-to":f(t)("data-planes.href.docs.data_plane_proxy"),"empty-state-cta-text":f(t)("common.documentation"),headers:[{label:"Name",key:"name"},{label:"Type",key:"type"},{label:"Services",key:"services"},{label:"Certificate Info",key:"certificate"},{label:"Status",key:"status"},{label:"Warnings",key:"warnings",hideLabel:!0},{label:"Details",key:"details",hideLabel:!0}],"page-number":r.pageNumber,"page-size":r.pageSize,total:r.total,items:r.items?o(r.items):void 0,error:r.error,"is-selected-row":r.isSelectedRow,onChange:l[0]||(l[0]=n=>a("change",n))},re({name:S(({row:n})=>[C(c,{class:"name-link",title:n.name,to:{name:r.summaryRouteName,params:{mesh:n.mesh,dataPlane:n.name},query:{page:r.pageNumber,size:r.pageSize}}},{default:S(()=>[p(_(n.name),1)]),_:2},1032,["title","to"])]),services:S(({row:n})=>[n.services.length>0?(m(),Z(Te,{key:0,tags:n.services,"should-truncate":"","hide-label-key":""},null,8,["tags"])):(m(),g(z,{key:1},[p(_(f(t)("common.collection.none")),1)],64))]),status:S(({row:n})=>[C(Se,{status:n.status},null,8,["status"])]),warnings:S(({row:n})=>[Object.values(n.warnings).some(y=>y)?(m(),Z(h,{key:0},{content:S(()=>[k("ul",null,[(m(!0),g(z,null,se(n.warnings,(y,x)=>(m(),g(z,{key:x},[y?(m(),g("li",Ie,_(f(t)(`data-planes.components.data-plane-list.${x}`)),1)):U("",!0)],64))),128))])]),default:S(()=>[p(),C(we,{class:"mr-1",size:f(B),"hide-title":""},null,8,["size"])]),_:2},1024)):(m(),g(z,{key:1},[p(_(f(t)("common.collection.none")),1)],64))]),details:S(({row:n})=>[C(c,{class:"details-link","data-testid":"details-link",to:{name:"data-plane-detail-view",params:{dataPlane:n.name}}},{default:S(()=>[p(_(f(t)("common.collection.details_link"))+" ",1),C(f(ue),{display:"inline-block",decorative:"",size:f(B)},null,8,["size"])]),_:2},1032,["to"])]),_:2},[v.$slots.toolbar?{name:"toolbar",fn:S(()=>[te(v.$slots,"toolbar",{},void 0,!0)]),key:"0"}:void 0]),1032,["empty-state-message","empty-state-cta-to","empty-state-cta-text","page-number","page-size","total","items","error","is-selected-row"])}}});const at=ne(Le,[["__scopeId","data-v-695042d4"]]);function Ae(s,i,t){return Math.max(i,Math.min(s,t))}const De=["ControlLeft","ControlRight","ShiftLeft","ShiftRight","AltLeft"];class Fe{constructor(i,t){V(this,"commands");V(this,"keyMap");V(this,"boundTriggerShortcuts");this.commands=t,this.keyMap=Object.fromEntries(Object.entries(i).map(([T,r])=>[T.toLowerCase(),r])),this.boundTriggerShortcuts=this.triggerShortcuts.bind(this)}registerListener(){document.addEventListener("keydown",this.boundTriggerShortcuts)}unRegisterListener(){document.removeEventListener("keydown",this.boundTriggerShortcuts)}triggerShortcuts(i){Ne(i,this.keyMap,this.commands)}}function Ne(s,i,t){const T=ze(s.code),r=[s.ctrlKey?"ctrl":"",s.shiftKey?"shift":"",s.altKey?"alt":"",T].filter(v=>v!=="").join("+"),a=i[r];if(!a)return;const o=t[a];o.isAllowedContext&&!o.isAllowedContext(s)||(o.shouldPreventDefaultAction&&s.preventDefault(),!(o.isDisabled&&o.isDisabled())&&o.trigger(s))}function ze(s){return De.includes(s)?"":s.replace(/^Key/,"").toLowerCase()}function Be(s,i){const t=" "+s,T=t.matchAll(/ ([-\s\w]+):\s*/g),r=[];for(const a of Array.from(T)){if(a.index===void 0)continue;const o=Ee(a[1]);if(i.length>0&&!i.includes(o))throw new Error(`Unknown field “${o}”. Known fields: ${i.join(", ")}`);const v=a.index+a[0].length,l=t.substring(v);let c;if(/^\s*["']/.test(l)){const n=l.match(/['"](.*?)['"]/);if(n!==null)c=n[1];else throw new Error(`Quote mismatch for field “${o}”.`)}else{const n=l.indexOf(" "),y=n===-1?l.length:n;c=l.substring(0,y)}c!==""&&r.push([o,c])}return r}function Ee(s){return s.trim().replace(/\s+/g,"-").replace(/-[a-z]/g,(i,t)=>t===0?i:i.substring(1).toUpperCase())}let X=0;const qe=(s="unique")=>(X++,`${s}-${X}`),ae=s=>(he("data-v-349996e3"),s=s(),ye(),s),$e=ae(()=>k("span",{class:"visually-hidden"},"Focus filter",-1)),Me={class:"k-filter-icon"},Pe=["for"],je=["id","placeholder"],Ke={key:0,class:"k-suggestion-box","data-testid":"k-filter-bar-suggestion-box"},Re={class:"k-suggestion-list"},Ve={key:0,class:"k-filter-bar-error"},Qe={key:0},Ue=["title","data-filter-field"],Oe={class:"visually-hidden"},He=ae(()=>k("span",{class:"visually-hidden"},"Clear query",-1)),We=ee({__name:"FilterBar",props:{id:{type:String,required:!1,default:()=>qe("k-filter-bar")},fields:{type:Object,required:!0},placeholder:{type:String,required:!1,default:null},query:{type:String,required:!1,default:""}},emits:["fields-change"],setup(s,{emit:i}){const t=s,T=i,r=A(null),a=A(null),o=A(t.query),v=A([]),l=A(null),c=A(!1),h=A(-1),n=Q(()=>Object.keys(t.fields)),y=Q(()=>Object.entries(t.fields).slice(0,5).map(([e,u])=>({fieldName:e,...u}))),x=Q(()=>n.value.length>0?`Filter by ${n.value.join(", ")}`:"Filter"),O=Q(()=>t.placeholder??x.value);Y(()=>v.value,function(e,u){K(e,u)||(l.value=null,T("fields-change",{fields:e,query:o.value}))}),Y(()=>o.value,function(){o.value===""&&(l.value=null),c.value=!0});const H={Enter:"submitQuery",Escape:"closeSuggestionBox",ArrowDown:"jumpToNextSuggestion",ArrowUp:"jumpToPreviousSuggestion"},W={submitQuery:{trigger:L,isAllowedContext(e){return a.value!==null&&e.composedPath().includes(a.value)},shouldPreventDefaultAction:!0},jumpToNextSuggestion:{trigger:E,isAllowedContext(e){return a.value!==null&&e.composedPath().includes(a.value)},shouldPreventDefaultAction:!0},jumpToPreviousSuggestion:{trigger:q,isAllowedContext(e){return a.value!==null&&e.composedPath().includes(a.value)},shouldPreventDefaultAction:!0},closeSuggestionBox:{trigger:b,isAllowedContext(e){return r.value!==null&&e.composedPath().includes(r.value)}}};function I(){const e=new Fe(H,W);ge(function(){e.registerListener()}),ve(function(){e.unRegisterListener()}),w(o.value)}I();function D(e){const u=e.target;w(u.value)}function L(){if(a.value instanceof HTMLInputElement)if(h.value===-1)w(a.value.value),c.value=!1;else{const e=y.value[h.value].fieldName;e&&N(a.value,e)}}function E(){F(1)}function q(){F(-1)}function F(e){h.value=Ae(h.value+e,-1,y.value.length-1)}function $(){a.value instanceof HTMLInputElement&&a.value.focus()}function M(e){const d=e.currentTarget.getAttribute("data-filter-field");d&&a.value instanceof HTMLInputElement&&N(a.value,d)}function N(e,u){const d=o.value===""||o.value.endsWith(" ")?"":" ";o.value+=d+u+":",e.focus(),h.value=-1}function P(){o.value="",a.value instanceof HTMLInputElement&&(a.value.value="",a.value.focus(),w(""))}function j(e){e.relatedTarget===null&&b(),r.value instanceof HTMLElement&&e.relatedTarget instanceof Node&&!r.value.contains(e.relatedTarget)&&b()}function b(){c.value=!1}function w(e){l.value=null;try{const u=Be(e,n.value);u.sort((d,R)=>d[0].localeCompare(R[0])),v.value=u}catch(u){if(u instanceof Error)l.value=u,c.value=!0;else throw u}}function K(e,u){return JSON.stringify(e)===JSON.stringify(u)}return(e,u)=>(m(),g("div",{ref_key:"filterBar",ref:r,class:"k-filter-bar","data-testid":"k-filter-bar"},[k("button",{class:"k-focus-filter-input-button",title:"Focus filter",type:"button","data-testid":"k-filter-bar-focus-filter-input-button",onClick:$},[$e,p(),k("span",Me,[C(f(ce),{decorative:"","data-testid":"k-filter-bar-filter-icon","hide-title":"",size:f(B)},null,8,["size"])])]),p(),k("label",{for:`${t.id}-filter-bar-input`,class:"visually-hidden"},[te(e.$slots,"default",{},()=>[p(_(x.value),1)],!0)],8,Pe),p(),de(k("input",{id:`${t.id}-filter-bar-input`,ref_key:"filterInput",ref:a,"onUpdate:modelValue":u[0]||(u[0]=d=>o.value=d),class:"k-filter-bar-input",type:"text",placeholder:O.value,"data-testid":"k-filter-bar-filter-input",onFocus:u[1]||(u[1]=d=>c.value=!0),onBlur:j,onChange:D},null,40,je),[[fe,o.value]]),p(),c.value?(m(),g("div",Ke,[k("div",Re,[l.value!==null?(m(),g("p",Ve,_(l.value.message),1)):(m(),g("button",{key:1,class:G(["k-submit-query-button",{"k-submit-query-button-is-selected":h.value===-1}]),title:"Submit query",type:"button","data-testid":"k-filter-bar-submit-query-button",onClick:L},`
          Submit `+_(o.value),3)),p(),(m(!0),g(z,null,se(y.value,(d,R)=>(m(),g("div",{key:`${t.id}-${R}`,class:G(["k-suggestion-list-item",{"k-suggestion-list-item-is-selected":h.value===R}])},[k("b",null,_(d.fieldName),1),d.description!==""?(m(),g("span",Qe,": "+_(d.description),1)):U("",!0),p(),k("button",{class:"k-apply-suggestion-button",title:`Add ${d.fieldName}:`,type:"button","data-filter-field":d.fieldName,"data-testid":"k-filter-bar-apply-suggestion-button",onClick:M},[k("span",Oe,"Add "+_(d.fieldName)+":",1),p(),C(f(me),{decorative:"","hide-title":"",size:f(B)},null,8,["size"])],8,Ue)],2))),128))])])):U("",!0),p(),o.value!==""?(m(),g("button",{key:1,class:"k-clear-query-button",title:"Clear query",type:"button","data-testid":"k-filter-bar-clear-query-button",onClick:P},[He,p(),C(f(pe),{decorative:"","hide-title":"",size:f(B)},null,8,["size"])])):U("",!0)],512))}});const it=ne(We,[["__scopeId","data-v-349996e3"]]);export{at as D,it as F};
