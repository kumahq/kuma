import{d as he,f as S,cB as ge,cw as ve,cC as be,cD as Ke,cE as Oe,o as r,j as v,l as e,a as R,w as O,b as q,t as k,A as Le,u as c,z,F as L,n as j,K as Ne,i as Re,B as ke,C as De,D as we,p as $e,r as P,g as xe,V as ye,k as Me,c as B,m as ze,cF as je,cG as He,cH as Be,e as fe,q as qe,E as Ge,G as Ye,cu as _e,cI as Fe,cJ as Ze,cK as Qe,cy as Je,cz as We,cL as Xe,cx as et}from"./index.5e6a498d.js";import{C as tt}from"./ContentWrapper.f02e15b4.js";import{D as at}from"./DataOverview.6ba2a998.js";import{T as nt}from"./TagList.3ce46ad7.js";import{Y as st}from"./YamlView.3d819c6c.js";import{_ as lt}from"./EmptyBlock.vue_vue_type_script_setup_true_lang.96ee2fb2.js";import"./ErrorBlock.25a46a68.js";import"./LoadingBlock.vue_vue_type_script_setup_true_lang.20a923ed.js";import"./index.58caa11d.js";import"./CodeBlock.vue_vue_type_style_index_0_lang.c7d4a9fd.js";import"./_commonjsHelpers.f037b798.js";const A=a=>(ke("data-v-3700a709"),a=a(),De(),a),ot={class:"entity-summary entity-section-list"},it={class:"entity-title"},rt=A(()=>e("span",{class:"kutil-sr-only"},"Data plane proxy:",-1)),dt={class:"definition"},ct=A(()=>e("span",null,"Mesh:",-1)),ut={key:0},pt=A(()=>e("h4",null,"Tags",-1)),mt={key:1},vt=A(()=>e("h4",null,"Dependencies",-1)),yt={class:"mt-2 heading-with-icon"},ft=A(()=>e("h4",null,"Insights",-1)),_t={class:"entity-section-list"},ht=["data-testid"],gt=A(()=>e("span",null,"Connect time:",-1)),bt=["data-testid"],kt=A(()=>e("span",null,"Disconnect time:",-1)),Dt={class:"definition"},wt=A(()=>e("span",null,"Control plane instance ID:",-1)),Ct={key:0},Tt=A(()=>e("summary",null," Responses (acknowledged / sent) ",-1)),Pt=["data-testid"],St=he({__name:"DataPlaneEntitySummary",props:{dataPlaneOverview:{type:Object,required:!0}},setup(a){const m=a,y={"Partially degraded":"partially_degraded",Offline:"offline",Online:"online"},K=S(()=>{const{name:i,mesh:d,dataplane:f}=m.dataPlaneOverview;return{type:"Dataplane",name:i,mesh:d,networking:f.networking}}),I=S(()=>ge(m.dataPlaneOverview.dataplane)),U=S(()=>{const i=Array.from(m.dataPlaneOverview.dataplaneInsight.subscriptions);return i.reverse(),i.map(d=>{const f=d.connectTime!==void 0?ve(d.connectTime):"\u2014",l=d.disconnectTime!==void 0?ve(d.disconnectTime):"\u2014",u=Object.entries(d.status).filter(([D])=>!["total","lastUpdateTime"].includes(D)).map(([D,w])=>{var G,$,Y,F,Z;const C=`${(G=w.responsesAcknowledged)!=null?G:0} / ${($=w.responsesSent)!=null?$:0}`;return{type:D.toUpperCase(),ratio:C,responsesSent:(Y=w.responsesSent)!=null?Y:0,responsesAcknowledged:(F=w.responsesAcknowledged)!=null?F:0,responsesRejected:(Z=w.responsesRejected)!=null?Z:0}});return{subscription:d,formattedConnectDate:f,formattedDisconnectDate:l,statuses:u}})}),h=S(()=>{const{status:i}=be(m.dataPlaneOverview.dataplane,m.dataPlaneOverview.dataplaneInsight);return Ke[y[i]]}),V=S(()=>{const i=Oe(m.dataPlaneOverview.dataplaneInsight);return i!==null?Object.entries(i).map(([d,f])=>({name:d,version:f})):[]}),g=S(()=>{const{subscriptions:i}=m.dataPlaneOverview.dataplaneInsight;if(i.length===0)return[];const d=i[i.length-1];if(!d.version)return[];const f=[],l=d.version.envoy,u=d.version.kumaDp;if(!(l.kumaDpCompatible!==void 0?l.kumaDpCompatible:!0)){const C=`Envoy ${l.version} is not supported by Kuma DP ${u.version}.`;f.push(C)}if(!(u.kumaCpCompatible!==void 0?u.kumaCpCompatible:!0)){const C=`Kuma DP ${u.version} is not supported by this Kuma control plane.`;f.push(C)}return f});return(i,d)=>{const f=Re("router-link");return r(),v("div",ot,[e("section",null,[e("h3",it,[rt,R(f,{to:{name:"data-plane-detail-view",params:{mesh:a.dataPlaneOverview.mesh,dataPlane:a.dataPlaneOverview.name}}},{default:O(()=>[q(k(a.dataPlaneOverview.name),1)]),_:1},8,["to"]),e("div",{class:Le(`status status--${c(h).appearance}`),"data-testid":"data-plane-status-badge"},k(c(h).title.toLowerCase()),3)]),e("div",dt,[ct,e("span",null,k(a.dataPlaneOverview.mesh),1)])]),c(I).length>0?(r(),v("section",ut,[pt,R(nt,{tags:c(I)},null,8,["tags"])])):z("",!0),c(V).length>0?(r(),v("section",mt,[vt,(r(!0),v(L,null,j(c(V),(l,u)=>(r(),v("div",{key:u,class:"definition"},[e("span",null,k(l.name)+":",1),e("span",null,k(l.version),1)]))),128)),c(g).length>0?(r(),v(L,{key:0},[e("h5",yt,[q(" Warnings "),R(c(Ne),{class:"ml-1",icon:"warning",color:"var(--black-75)","secondary-color":"var(--yellow-300)",size:"20"})]),(r(!0),v(L,null,j(c(g),(l,u)=>(r(),v("p",{key:u},k(l),1))),128))],64)):z("",!0)])):z("",!0),c(U).length>0?(r(),v(L,{key:2},[e("section",null,[ft,e("div",_t,[(r(!0),v(L,null,j(c(U),(l,u)=>(r(),v("div",{key:u},[e("div",{class:"definition","data-testid":`data-plane-connect-time-${u}`},[gt,e("span",null,k(l.formattedConnectDate),1)],8,ht),e("div",{class:"definition","data-testid":`data-plane-disconnect-time-${u}`},[kt,e("span",null,k(l.formattedDisconnectDate),1)],8,bt),e("div",Dt,[wt,e("span",null,k(l.subscription.controlPlaneInstanceId),1)]),l.statuses.length>0?(r(),v("details",Ct,[Tt,(r(!0),v(L,null,j(l.statuses,(D,w)=>(r(),v("div",{key:`${u}-${w}`,class:"definition","data-testid":`data-plane-subscription-status-${u}-${w}`},[e("span",null,k(D.type)+":",1),e("span",null,k(D.ratio),1)],8,Pt))),128))])):z("",!0)]))),128))])]),e("section",null,[R(st,{id:"code-block-data-plane-summary",content:c(K),"code-max-height":"250px"},null,8,["content"])])],64)):z("",!0)])}}});const Ut=we(St,[["__scopeId","data-v-3700a709"]]),Ce=[{key:"status",label:"Status"},{key:"name",label:"Name"},{key:"mesh",label:"Mesh"},{key:"type",label:"Type"},{key:"service",label:"Service"},{key:"protocol",label:"Protocol"},{key:"zone",label:"Zone"},{key:"lastConnected",label:"Last Connected"},{key:"lastUpdated",label:"Last Updated"},{key:"totalUpdates",label:"Total Updates"},{key:"dpVersion",label:"Kuma DP version"},{key:"envoyVersion",label:"Envoy version"},{key:"details",label:"Details",hideLabel:!0}],Vt=["name","details"],Et=Ce.filter(a=>!Vt.includes(a.key)).map(a=>({tableHeaderKey:a.key,label:a.label,isChecked:!1})),Te=["status","name","mesh","type","service","protocol","zone","lastUpdated","dpVersion","details"];function It(a,m=Te){return Ce.filter(y=>m.includes(y.key)?a?!0:y.key!=="zone":!1)}function ee(a,m){const y=window.history.state;if(y===null)return;const K=y.current.indexOf("?"),I=K>-1?y.current.substring(K):"",U=new URLSearchParams(I);m!=null?U.set(a,String(m)):U.has(a)&&U.delete(a);const h=U.toString(),V=h===""?"":"?"+h;let g="";if(K>-1?g=y.current.substring(0,K)+V:g=y.current+V,y.current!==g){const i=Object.assign({},y);i.current=g,window.history.replaceState(i,"","#"+g)}}const te=a=>(ke("data-v-4d75ed1b"),a=a(),De(),a),At=te(()=>e("label",{for:"data-planes-type-filter",class:"mr-2"}," Type: ",-1)),Kt=["value"],Ot=["for"],Lt=["id","checked","onChange"],Nt=te(()=>e("span",{class:"custom-control-icon"}," + ",-1)),Rt=te(()=>e("span",{class:"custom-control-icon"}," \u2190 ",-1)),$t=he({__name:"DataPlaneListView",props:{name:{type:String,required:!1,default:null},offset:{type:Number,required:!1,default:0}},setup(a){const m=a,y=50,K=["All","Standard","Gateway (builtin)","Gateway (provided)"],I=$e(),U=qe(),h=P(Te),V=P(!0),g=P(!1),i=P(null),d=P(!1),f=P({headers:[],data:[]}),l=P([]),u=P(null),D=P("All"),w=P(m.offset),C=P(null),G=S(()=>U.getters["config/getEnvironment"]),$=S(()=>U.getters["config/getMulticlusterStatus"]),Y=S(()=>G.value==="universal"?{name:"universal-dataplane"}:{name:"kubernetes-dataplane"}),F=S(()=>{const t=f.value.data.filter(_=>D.value==="All"?!0:_.type.toLowerCase()===D.value.toLowerCase()),s=It($.value,h.value);return{data:t,headers:s}}),Z=S(()=>Et.filter(t=>$.value?!0:t.tableHeaderKey!=="zone").map(t=>{const s=h.value.includes(t.tableHeaderKey);return{...t,isChecked:s}}));xe(()=>I.params.mesh,function(){I.name==="data-plane-list-view"&&(V.value=!0,g.value=!1,i.value=null,d.value=!1,Q(0))});const ae=ye.get("dpVisibleTableHeaderKeys");Array.isArray(ae)&&(h.value=ae),Q(m.offset);function Pe(t){t.stopPropagation()}function Se(t,s){const _=t.target,o=h.value.findIndex(p=>p===s);_.checked&&o===-1?h.value.push(s):!_.checked&&o>-1&&h.value.splice(o,1),ye.set("dpVisibleTableHeaderKeys",Array.from(new Set(h.value)))}function Ue(){Ge.logger.info(Ye.CREATE_DATA_PLANE_PROXY_CLICKED)}function Ve(){return{title:"No Data",message:"There are no data plane proxies present."}}async function Ee(t){var se,le,oe,ie,re;const s=t.mesh,_=t.name,o={name:"data-plane-detail-view",params:{mesh:s,dataPlane:_}},p={name:"mesh-detail-view",params:{mesh:s}},H=["kuma.io/protocol","kuma.io/service","kuma.io/zone"],x=ge(t.dataplane).filter(n=>H.includes(n.label)),T=(se=x.find(n=>n.label==="kuma.io/service"))==null?void 0:se.value,N=(le=x.find(n=>n.label==="kuma.io/protocol"))==null?void 0:le.value,W=(oe=x.find(n=>n.label==="kuma.io/zone"))==null?void 0:oe.value;let ne;T!==void 0&&(ne={name:"service-insight-detail-view",params:{mesh:s,service:T}});const{status:Ie}=be(t.dataplane,t.dataplaneInsight),Ae={totalUpdates:0,totalRejectedUpdates:0,dpVersion:null,envoyVersion:null,selectedTime:NaN,selectedUpdateTime:NaN,version:null},b=t.dataplaneInsight.subscriptions.reduce((n,E)=>{var de,ce,ue,pe;if(E.connectTime){const me=Date.parse(E.connectTime);(!n.selectedTime||me>n.selectedTime)&&(n.selectedTime=me)}const X=Date.parse(E.status.lastUpdateTime);return X&&(!n.selectedUpdateTime||X>n.selectedUpdateTime)&&(n.selectedUpdateTime=X),{totalUpdates:n.totalUpdates+parseInt((de=E.status.total.responsesSent)!=null?de:"0",10),totalRejectedUpdates:n.totalRejectedUpdates+parseInt((ce=E.status.total.responsesRejected)!=null?ce:"0",10),dpVersion:((ue=E.version)==null?void 0:ue.kumaDp.version)||n.dpVersion,envoyVersion:((pe=E.version)==null?void 0:pe.envoy.version)||n.envoyVersion,selectedTime:n.selectedTime,selectedUpdateTime:n.selectedUpdateTime,version:E.version||n.version}},Ae),M={name:_,nameRoute:o,mesh:s,meshRoute:p,zone:W!=null?W:"\u2014",service:T!=null?T:"\u2014",serviceInsightRoute:ne,protocol:N!=null?N:"\u2014",status:Ie,totalUpdates:b.totalUpdates,totalRejectedUpdates:b.totalRejectedUpdates,dpVersion:(ie=b.dpVersion)!=null?ie:"\u2014",envoyVersion:(re=b.envoyVersion)!=null?re:"\u2014",warnings:[],unsupportedEnvoyVersion:!1,unsupportedKumaDPVersion:!1,kumaDpAndKumaCpMismatch:!1,lastUpdated:b.selectedUpdateTime?_e(new Date(b.selectedUpdateTime).toUTCString()):"\u2014",lastConnected:b.selectedTime?_e(new Date(b.selectedTime).toUTCString()):"\u2014",type:Fe(t.dataplane)};if(b.version){const{kind:n}=Ze(b.version);switch(n!==Qe&&M.warnings.push(n),n){case We:M.unsupportedEnvoyVersion=!0;break;case Je:M.unsupportedKumaDPVersion=!0;break}}return $.value&&b.dpVersion&&x.find(E=>E.label===Xe)&&typeof b.version.kumaDp.kumaCpCompatible=="boolean"&&!b.version.kumaDp.kumaCpCompatible&&(M.warnings.push(et),M.kumaDpAndKumaCpMismatch=!0),M}async function Q(t){var o;V.value=!0,w.value=t,ee("offset",t>0?t:null);const s=I.params.mesh,_=y;try{const{items:p,next:H}=await Me.getAllDataplaneOverviewsFromMesh({mesh:s},{size:_,offset:t});if(Array.isArray(p)&&p.length>0){p.sort(function(T,N){return T.name===N.name?T.mesh>N.mesh?1:-1:T.name.localeCompare(N.name)}),u.value=H,l.value=p,J((o=m.name)!=null?o:p[0].name);const x=await Promise.all(l.value.map(T=>Ee(T)));f.value.data=x,d.value=!1,g.value=!1}else J(null),f.value.data=[],d.value=!0,g.value=!0}catch(p){p instanceof Error?i.value=p:console.error(p),g.value=!0}finally{V.value=!1}}function J(t){var s;t&&l.value.length>0?(C.value=(s=l.value.find(_=>_.name===t))!=null?s:l.value[0],ee("name",C.value.name)):(C.value=null,ee("name",null))}return(t,s)=>(r(),B(tt,null,{content:O(()=>{var _;return[R(at,{"selected-entity-name":(_=C.value)==null?void 0:_.name,"page-size":y,"is-loading":V.value,error:i.value,"empty-state":Ve(),"table-data":c(F),"table-data-is-empty":d.value,"show-details":"",next:u.value!==null,"page-offset":w.value,onTableAction:s[1]||(s[1]=o=>J(o.name)),onLoadData:s[2]||(s[2]=o=>Q(o))},{additionalControls:O(()=>[e("div",null,[At,ze(e("select",{id:"data-planes-type-filter","onUpdate:modelValue":s[0]||(s[0]=o=>D.value=o),"data-testid":"data-planes-type-filter"},[(r(),v(L,null,j(K,(o,p)=>e("option",{key:p,value:o},k(o),9,Kt)),64))],512),[[je,D.value]])]),R(c(He),{label:"Columns",icon:"cogwheel","button-appearance":"outline"},{items:O(()=>[e("div",{onClick:Pe},[(r(!0),v(L,null,j(c(Z),(o,p)=>(r(),B(c(Be),{key:p,class:"table-header-selector-item",item:o},{default:O(()=>[e("label",{for:`data-plane-table-header-checkbox-${p}`,class:"k-checkbox table-header-selector-item-checkbox"},[e("input",{id:`data-plane-table-header-checkbox-${p}`,checked:o.isChecked,type:"checkbox",class:"k-input",onChange:H=>Se(H,o.tableHeaderKey)},null,40,Lt),q(" "+k(o.label),1)],8,Ot)]),_:2},1032,["item"]))),128))])]),_:1}),R(c(fe),{class:"add-dp-button",appearance:"primary",to:c(Y),"data-testid":"data-plane-create-data-plane-button",onClick:Ue},{default:O(()=>[Nt,q(" Create data plane proxy ")]),_:1},8,["to"]),c(I).query.ns?(r(),B(c(fe),{key:0,appearance:"primary",to:{name:"data-plane-list-view"},"data-testid":"data-plane-ns-back-button"},{default:O(()=>[Rt,q(" View All ")]),_:1})):z("",!0)]),_:1},8,["selected-entity-name","is-loading","error","empty-state","table-data","table-data-is-empty","next","page-offset"])]}),sidebar:O(()=>[C.value!==null?(r(),B(Ut,{key:0,"data-plane-overview":C.value},null,8,["data-plane-overview"])):(r(),B(lt,{key:1}))]),_:1}))}});const Qt=we($t,[["__scopeId","data-v-4d75ed1b"]]);export{Qt as default};
