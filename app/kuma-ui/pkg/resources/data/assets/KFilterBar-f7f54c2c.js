var de=Object.defineProperty;var me=(s,o,e)=>o in s?de(s,o,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[o]=e;var Q=(s,o,e)=>(me(s,typeof o!="symbol"?o+"":o,e),e);import{d as ie,g as pe,f as fe,r as ge,o as d,i as M,w as g,U as le,j as I,n as p,H as h,l as b,F as A,W as ve,k as u,aa as ye,p as w,I as re,m as O,v as he,K as $,a1 as be,Y as ke,a2 as _e,a3 as Te,a0 as Se,t as ue,y as L,h as H,as as ne,at as we,au as Ce,av as xe,B as se,aw as De,ax as Ie,z as ze,V as Ue,D as Le,G as Ae}from"./index-23176b1b.js";import{d as Ne,a as Fe,c as je,C as Ee}from"./dataplane-0a086c06.js";const Be={key:0},Me=ie({__name:"DataPlaneList",props:{total:{default:0},pageNumber:{},pageSize:{},items:{},error:{},gateways:{type:Boolean,default:!1}},emits:["load-data","change"],setup(s,{emit:o}){const{t:e,formatIsoDate:S}=pe(),k=fe(),a=s,i=o,C=k("use zones");function _(v){return v.map(c=>{var E,z,V,t,l,m,U,X;const f=c.mesh,n=c.name,T=((E=c.dataplane.networking.gateway)==null?void 0:E.type)||"STANDARD",D={name:T==="STANDARD"?"data-plane-detail-view":"gateway-detail-view",params:{mesh:f,dataPlane:n}},Z=["kuma.io/protocol","kuma.io/service","kuma.io/zone"],N=Ne(c.dataplane).filter(r=>Z.includes(r.label)),B=(z=N.find(r=>r.label==="kuma.io/service"))==null?void 0:z.value,W=(V=N.find(r=>r.label==="kuma.io/protocol"))==null?void 0:V.value,F=(t=N.find(r=>r.label==="kuma.io/zone"))==null?void 0:t.value;let P;B!==void 0&&(P={name:"service-detail-view",params:{mesh:f,service:B}});let R;F!==void 0&&(R={name:"zone-cp-detail-view",params:{zone:F}});const{status:q}=Fe(c.dataplane,c.dataplaneInsight),G=((l=c.dataplaneInsight)==null?void 0:l.subscriptions)??[],J={totalUpdates:0,totalRejectedUpdates:0,dpVersion:null,envoyVersion:null,selectedTime:NaN,selectedUpdateTime:NaN,version:null},y=G.reduce((r,x)=>{var ee,te;if(x.connectTime){const ae=Date.parse(x.connectTime);(!r.selectedTime||ae>r.selectedTime)&&(r.selectedTime=ae)}const Y=Date.parse(x.status.lastUpdateTime);return Y&&(!r.selectedUpdateTime||Y>r.selectedUpdateTime)&&(r.selectedUpdateTime=Y),{totalUpdates:r.totalUpdates+parseInt(x.status.total.responsesSent??"0",10),totalRejectedUpdates:r.totalRejectedUpdates+parseInt(x.status.total.responsesRejected??"0",10),dpVersion:((ee=x.version)==null?void 0:ee.kumaDp.version)||r.dpVersion,envoyVersion:((te=x.version)==null?void 0:te.envoy.version)||r.envoyVersion,selectedTime:r.selectedTime,selectedUpdateTime:r.selectedUpdateTime,version:x.version||r.version}},J),j={name:n,dataplaneInsight:c.dataplaneInsight,detailViewRoute:D,type:T,zone:{title:F??e("common.collection.none"),route:R},service:{title:B??e("common.collection.none"),route:P},protocol:W??e("common.collection.none"),status:q,totalUpdates:y.totalUpdates,totalRejectedUpdates:y.totalRejectedUpdates,envoyVersion:y.envoyVersion??e("common.collection.none"),warnings:{version_mismatch:!1,cert_expired:!1},lastUpdated:y.selectedUpdateTime?S(new Date(y.selectedUpdateTime).toUTCString()):e("common.collection.none"),lastConnected:y.selectedTime?S(new Date(y.selectedTime).toUTCString()):e("common.collection.none"),overview:c};if(y.version){const{kind:r}=je(y.version);r!==Ee&&(j.warnings.version_mismatch=!0)}C&&y.dpVersion&&N.find(x=>x.label==="kuma.io/zone")&&typeof((m=y.version)==null?void 0:m.kumaDp.kumaCpCompatible)=="boolean"&&!y.version.kumaDp.kumaCpCompatible&&(j.warnings.version_mismatch=!0);const K=(X=(U=c.dataplaneInsight)==null?void 0:U.mTLS)==null?void 0:X.certificateExpirationTime;return K&&Date.now()>new Date(K).getTime()&&(j.warnings.cert_expired=!0),j})}return(v,c)=>{const f=ge("RouterLink");return d(),M(Se,{"empty-state-message":u(e)("common.emptyState.message",{type:a.gateways?"Gateways":"Data Plane Proxies"}),"empty-state-cta-to":u(e)(`data-planes.href.docs.${a.gateways?"gateway":"data_plane_proxy"}`),"empty-state-cta-text":u(e)("common.documentation"),headers:[{label:"Name",key:"name"},...a.gateways?[{label:"Type",key:"type"}]:[],{label:"Service",key:"service"},...a.gateways?[]:[{label:"Protocol",key:"protocol"}],...u(C)?[{label:"Zone",key:"zone"}]:[],{label:"Last Updated",key:"lastUpdated"},{label:"Certificate Info",key:"certificate"},{label:"Status",key:"status"},{label:"Warnings",key:"warnings",hideLabel:!0},{label:"Actions",key:"actions",hideLabel:!0}],"page-number":a.pageNumber,"page-size":a.pageSize,total:a.total,items:a.items?_(a.items):void 0,error:a.error,onChange:c[0]||(c[0]=n=>i("change",n))},{toolbar:g(()=>[le(v.$slots,"toolbar",{},void 0,!0)]),name:g(({row:n})=>[I(f,{to:{name:a.gateways?"gateway-detail-view":"data-plane-detail-view",params:{dataPlane:n.name}},"data-testid":"detail-view-link"},{default:g(()=>[p(h(n.name),1)]),_:2},1032,["to"])]),service:g(({rowValue:n})=>[n.route?(d(),M(f,{key:0,to:n.route},{default:g(()=>[p(h(n.title),1)]),_:2},1032,["to"])):(d(),b(A,{key:1},[p(h(n.title),1)],64))]),zone:g(({rowValue:n})=>[n.route?(d(),M(f,{key:0,to:n.route},{default:g(()=>[p(h(n.title),1)]),_:2},1032,["to"])):(d(),b(A,{key:1},[p(h(n.title),1)],64))]),status:g(({rowValue:n})=>[n?(d(),M(ve,{key:0,status:n},null,8,["status"])):(d(),b(A,{key:1},[p(h(u(e)("common.collection.none")),1)],64))]),warnings:g(({row:n})=>[Object.values(n.warnings).some(T=>T)?(d(),M(u(ye),{key:0},{content:g(()=>[w("ul",null,[(d(!0),b(A,null,re(n.warnings,(T,D)=>(d(),b(A,{key:D},[T?(d(),b("li",Be,h(u(e)(`data-planes.components.data-plane-list.${D}`)),1)):O("",!0)],64))),128))])]),default:g(()=>[p(),I(he,{class:"mr-1",size:u($),"hide-title":""},null,8,["size"])]),_:2},1024)):(d(),b(A,{key:1},[p(h(u(e)("common.collection.none")),1)],64))]),certificate:g(({row:n})=>{var T,D;return[p(h((D=(T=n.dataplaneInsight)==null?void 0:T.mTLS)!=null&&D.certificateExpirationTime?u(S)(new Date(n.dataplaneInsight.mTLS.certificateExpirationTime).toUTCString()):u(e)("data-planes.components.data-plane-list.certificate.none")),1)]}),actions:g(({row:n})=>[I(u(be),{class:"actions-dropdown","kpop-attributes":{placement:"bottomEnd",popoverClasses:"mt-5 more-actions-popover"},width:"150"},{default:g(()=>[I(u(ke),{class:"non-visual-button",appearance:"secondary",size:"small"},{default:g(()=>[I(u(_e),{size:u($)},null,8,["size"])]),_:1})]),items:g(()=>[I(u(Te),{item:{to:{name:a.gateways?"gateway-detail-view":"data-plane-detail-view",params:{dataPlane:n.name}},label:u(e)("common.collection.actions.view")}},null,8,["item"])]),_:2},1024)]),_:3},8,["empty-state-message","empty-state-cta-to","empty-state-cta-text","headers","page-number","page-size","total","items","error"])}}});const rt=ue(Me,[["__scopeId","data-v-c24aa601"]]);function $e(s,o,e){return Math.max(o,Math.min(s,e))}const Pe=["ControlLeft","ControlRight","ShiftLeft","ShiftRight","AltLeft"];class Re{constructor(o,e){Q(this,"commands");Q(this,"keyMap");Q(this,"boundTriggerShortcuts");this.commands=e,this.keyMap=Object.fromEntries(Object.entries(o).map(([S,k])=>[S.toLowerCase(),k])),this.boundTriggerShortcuts=this.triggerShortcuts.bind(this)}registerListener(){document.addEventListener("keydown",this.boundTriggerShortcuts)}unRegisterListener(){document.removeEventListener("keydown",this.boundTriggerShortcuts)}triggerShortcuts(o){qe(o,this.keyMap,this.commands)}}function qe(s,o,e){const S=Ke(s.code),k=[s.ctrlKey?"ctrl":"",s.shiftKey?"shift":"",s.altKey?"alt":"",S].filter(C=>C!=="").join("+"),a=o[k];if(!a)return;const i=e[a];i.isAllowedContext&&!i.isAllowedContext(s)||(i.shouldPreventDefaultAction&&s.preventDefault(),!(i.isDisabled&&i.isDisabled())&&i.trigger(s))}function Ke(s){return Pe.includes(s)?"":s.replace(/^Key/,"").toLowerCase()}function Ve(s,o){const e=" "+s,S=e.matchAll(/ ([-\s\w]+):\s*/g),k=[];for(const a of Array.from(S)){if(a.index===void 0)continue;const i=Qe(a[1]);if(o.length>0&&!o.includes(i))throw new Error(`Unknown field “${i}”. Known fields: ${o.join(", ")}`);const C=a.index+a[0].length,_=e.substring(C);let v;if(/^\s*["']/.test(_)){const f=_.match(/['"](.*?)['"]/);if(f!==null)v=f[1];else throw new Error(`Quote mismatch for field “${i}”.`)}else{const f=_.indexOf(" "),n=f===-1?_.length:f;v=_.substring(0,n)}v!==""&&k.push([i,v])}return k}function Qe(s){return s.trim().replace(/\s+/g,"-").replace(/-[a-z]/g,(o,e)=>e===0?o:o.substring(1).toUpperCase())}let oe=0;const He=(s="unique")=>(oe++,`${s}-${oe}`),ce=s=>(Le("data-v-9e2bf5f8"),s=s(),Ae(),s),Oe=ce(()=>w("span",{class:"visually-hidden"},"Focus filter",-1)),Ze={class:"k-filter-icon"},We=["for"],Ge=["id","placeholder"],Je={key:0,class:"k-suggestion-box","data-testid":"k-filter-bar-suggestion-box"},Ye={class:"k-suggestion-list"},Xe={key:0,class:"k-filter-bar-error"},et={key:0},tt=["title","data-filter-field"],at={class:"visually-hidden"},nt=ce(()=>w("span",{class:"visually-hidden"},"Clear query",-1)),st=ie({__name:"KFilterBar",props:{id:{type:String,required:!1,default:()=>He("k-filter-bar")},fields:{type:Object,required:!0},placeholder:{type:String,required:!1,default:null},query:{type:String,required:!1,default:""}},emits:["fields-change"],setup(s,{emit:o}){const e=s,S=o,k=L(null),a=L(null),i=L(e.query),C=L([]),_=L(null),v=L(!1),c=L(-1),f=H(()=>Object.keys(e.fields)),n=H(()=>Object.entries(e.fields).slice(0,5).map(([t,l])=>({fieldName:t,...l}))),T=H(()=>f.value.length>0?`Filter by ${f.value.join(", ")}`:"Filter"),D=H(()=>e.placeholder??T.value);ne(()=>C.value,function(t,l){V(t,l)||(_.value=null,S("fields-change",{fields:t,query:i.value}))}),ne(()=>i.value,function(){i.value===""&&(_.value=null),v.value=!0});const Z={Enter:"submitQuery",Escape:"closeSuggestionBox",ArrowDown:"jumpToNextSuggestion",ArrowUp:"jumpToPreviousSuggestion"},N={submitQuery:{trigger:F,isAllowedContext(t){return a.value!==null&&t.composedPath().includes(a.value)},shouldPreventDefaultAction:!0},jumpToNextSuggestion:{trigger:P,isAllowedContext(t){return a.value!==null&&t.composedPath().includes(a.value)},shouldPreventDefaultAction:!0},jumpToPreviousSuggestion:{trigger:R,isAllowedContext(t){return a.value!==null&&t.composedPath().includes(a.value)},shouldPreventDefaultAction:!0},closeSuggestionBox:{trigger:E,isAllowedContext(t){return k.value!==null&&t.composedPath().includes(k.value)}}};function B(){const t=new Re(Z,N);ze(function(){t.registerListener()}),Ue(function(){t.unRegisterListener()}),z(i.value)}B();function W(t){const l=t.target;z(l.value)}function F(){if(a.value instanceof HTMLInputElement)if(c.value===-1)z(a.value.value),v.value=!1;else{const t=n.value[c.value].fieldName;t&&y(a.value,t)}}function P(){q(1)}function R(){q(-1)}function q(t){c.value=$e(c.value+t,-1,n.value.length-1)}function G(){a.value instanceof HTMLInputElement&&a.value.focus()}function J(t){const m=t.currentTarget.getAttribute("data-filter-field");m&&a.value instanceof HTMLInputElement&&y(a.value,m)}function y(t,l){const m=i.value===""||i.value.endsWith(" ")?"":" ";i.value+=m+l+":",t.focus(),c.value=-1}function j(){i.value="",a.value instanceof HTMLInputElement&&(a.value.value="",a.value.focus(),z(""))}function K(t){t.relatedTarget===null&&E(),k.value instanceof HTMLElement&&t.relatedTarget instanceof Node&&!k.value.contains(t.relatedTarget)&&E()}function E(){v.value=!1}function z(t){_.value=null;try{const l=Ve(t,f.value);l.sort((m,U)=>m[0].localeCompare(U[0])),C.value=l}catch(l){if(l instanceof Error)_.value=l,v.value=!0;else throw l}}function V(t,l){return JSON.stringify(t)===JSON.stringify(l)}return(t,l)=>(d(),b("div",{ref_key:"filterBar",ref:k,class:"k-filter-bar","data-testid":"k-filter-bar"},[w("button",{class:"k-focus-filter-input-button",title:"Focus filter",type:"button","data-testid":"k-filter-bar-focus-filter-input-button",onClick:G},[Oe,p(),w("span",Ze,[I(u(we),{decorative:"","data-testid":"k-filter-bar-filter-icon","hide-title":"",size:u($)},null,8,["size"])])]),p(),w("label",{for:`${e.id}-filter-bar-input`,class:"visually-hidden"},[le(t.$slots,"default",{},()=>[p(h(T.value),1)],!0)],8,We),p(),Ce(w("input",{id:`${e.id}-filter-bar-input`,ref_key:"filterInput",ref:a,"onUpdate:modelValue":l[0]||(l[0]=m=>i.value=m),class:"k-filter-bar-input",type:"text",placeholder:D.value,"data-testid":"k-filter-bar-filter-input",onFocus:l[1]||(l[1]=m=>v.value=!0),onBlur:K,onChange:W},null,40,Ge),[[xe,i.value]]),p(),v.value?(d(),b("div",Je,[w("div",Ye,[_.value!==null?(d(),b("p",Xe,h(_.value.message),1)):(d(),b("button",{key:1,class:se(["k-submit-query-button",{"k-submit-query-button-is-selected":c.value===-1}]),title:"Submit query",type:"button","data-testid":"k-filter-bar-submit-query-button",onClick:F},`
          Submit `+h(i.value),3)),p(),(d(!0),b(A,null,re(n.value,(m,U)=>(d(),b("div",{key:`${e.id}-${U}`,class:se(["k-suggestion-list-item",{"k-suggestion-list-item-is-selected":c.value===U}])},[w("b",null,h(m.fieldName),1),m.description!==""?(d(),b("span",et,": "+h(m.description),1)):O("",!0),p(),w("button",{class:"k-apply-suggestion-button",title:`Add ${m.fieldName}:`,type:"button","data-filter-field":m.fieldName,"data-testid":"k-filter-bar-apply-suggestion-button",onClick:J},[w("span",at,"Add "+h(m.fieldName)+":",1),p(),I(u(De),{decorative:"","hide-title":"",size:u($)},null,8,["size"])],8,tt)],2))),128))])])):O("",!0),p(),i.value!==""?(d(),b("button",{key:1,class:"k-clear-query-button",title:"Clear query",type:"button","data-testid":"k-filter-bar-clear-query-button",onClick:j},[nt,p(),I(u(Ie),{decorative:"","hide-title":"",size:u($)},null,8,["size"])])):O("",!0)],512))}});const ut=ue(st,[["__scopeId","data-v-9e2bf5f8"]]);export{rt as D,ut as K};
