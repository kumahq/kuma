import{A as G,a as j}from"./AccordionList-77e092d6.js";import{d as D,M as S,a as w,o as e,c as l,p,f as c,F as m,I as B,t as y,e as h,w as a,s as N,b as u,a0 as q,y as Y,z as J,_ as V,l as Q,n as ee,q as x}from"./index-b97eeae1.js";import{_ as U}from"./CodeBlock.vue_vue_type_style_index_0_lang-23784d65.js";import{P as W}from"./PolicyTypeTag-b497c4de.js";import{T as z}from"./TagList-2c88e736.js";import{_ as te}from"./EmptyBlock.vue_vue_type_script_setup_true_lang-e1bd4f0f.js";import{t as M}from"./toYaml-4e00099e.js";import{E as I}from"./ErrorBlock-d7d8f5ea.js";import{_ as H}from"./LoadingBlock.vue_vue_type_script_setup_true_lang-8f09b7a9.js";import"./index-fce48c05.js";import"./TextWithCopyButton-6c31a1a4.js";import"./CopyButton-338cbf10.js";import"./WarningIcon.vue_vue_type_script_setup_true_lang-a0ae6ec4.js";const A=v=>(Y("data-v-d33ad9ee"),v=v(),J(),v),se={class:"policies-list","data-testid":"builtin-gateway-dataplane-policies"},oe={class:"mesh-gateway-policy-list"},ne=A(()=>p("h3",{class:"mb-2"},`
        Gateway policies
      `,-1)),ae={key:0},le=A(()=>p("h3",{class:"mt-6 mb-2"},`
        Listeners
      `,-1)),ce=A(()=>p("b",null,"Host",-1)),ie=A(()=>p("h4",{class:"mt-2 mb-2"},`
                Routes
              `,-1)),re={class:"dataplane-policy-header"},ue=A(()=>p("b",null,"Route",-1)),pe=A(()=>p("b",null,"Service",-1)),de={key:0,class:"badge-list"},ye={class:"mt-1"},_e=D({__name:"BuiltinGatewayPolicies",props:{gatewayDataplane:{},policyTypesByName:{}},setup(v){const b=v,_=S(()=>T(b.gatewayDataplane)),C=S(()=>L(b.gatewayDataplane.policies));function T(g){const $=[],d=g.listeners??[];for(const f of d)for(const t of f.hosts)for(const o of t.routes){const s=[];for(const n of o.destinations){const i=L(n.policies),r={routeName:o.route,route:{name:"policy-detail-view",params:{mesh:g.gateway.mesh,policyPath:"meshgatewayroutes",policy:o.route}},service:n.tags["kuma.io/service"],policies:i};s.push(r)}$.push({protocol:f.protocol,port:f.port,hostName:t.hostName,routeEntries:s})}return $}function L(g){if(g===void 0)return[];const $=[];for(const d of Object.values(g)){const f=b.policyTypesByName[d.type];$.push({type:d.type,name:d.name,route:{name:"policy-detail-view",params:{mesh:d.mesh,policyPath:f.path,policy:d.name}}})}return $}return(g,$)=>{const d=w("router-link"),f=w("KBadge"),t=w("RouterLink");return e(),l("div",se,[p("div",oe,[ne,c(),C.value.length>0?(e(),l("ul",ae,[(e(!0),l(m,null,B(C.value,(o,s)=>(e(),l("li",{key:s},[p("span",null,y(o.type),1),c(`:

          `),h(d,{to:o.route},{default:a(()=>[c(y(o.name),1)]),_:2},1032,["to"])]))),128))])):N("",!0),c(),le,c(),p("div",null,[(e(!0),l(m,null,B(_.value,(o,s)=>(e(),l("div",{key:s},[p("div",null,[p("div",null,[ce,c(": "+y(o.hostName)+":"+y(o.port)+" ("+y(o.protocol)+`)
            `,1)]),c(),o.routeEntries.length>0?(e(),l(m,{key:0},[ie,c(),h(j,{"initially-open":[],"multiple-open":""},{default:a(()=>[(e(!0),l(m,null,B(o.routeEntries,(n,i)=>(e(),u(G,{key:i},q({"accordion-header":a(()=>[p("div",re,[p("div",null,[p("div",null,[ue,c(": "),h(d,{to:n.route},{default:a(()=>[c(y(n.routeName),1)]),_:2},1032,["to"])]),c(),p("div",null,[pe,c(": "+y(n.service),1)])]),c(),n.policies.length>0?(e(),l("div",de,[(e(!0),l(m,null,B(n.policies,(r,k)=>(e(),u(f,{key:`${s}-${k}`},{default:a(()=>[c(y(r.type),1)]),_:2},1024))),128))])):N("",!0)])]),_:2},[n.policies.length>0?{name:"accordion-content",fn:a(()=>[p("ul",ye,[(e(!0),l(m,null,B(n.policies,(r,k)=>(e(),l("li",{key:`${s}-${k}`},[c(y(r.type)+`:

                        `,1),h(t,{to:r.route},{default:a(()=>[c(y(r.name),1)]),_:2},1032,["to"])]))),128))])]),key:"0"}:void 0]),1024))),128))]),_:2},1024)],64)):N("",!0)])]))),128))])])])}}});const me=V(_e,[["__scopeId","data-v-d33ad9ee"]]),he={class:"policy-type-heading"},fe={class:"policy-list"},ge={key:0},ke=D({__name:"PolicyTypeEntryList",props:{id:{},policyTypeEntries:{}},setup(v){const b=[{label:"From",key:"sourceTags"},{label:"To",key:"destinationTags"},{label:"On",key:"name"},{label:"Conf",key:"config"},{label:"Origin policies",key:"origins"}],_=v;function C({headerKey:T}){return{class:`cell-${T}`}}return(T,L)=>{const g=w("router-link"),$=w("KTable");return e(),u(j,{"initially-open":[],"multiple-open":""},{default:a(()=>[(e(!0),l(m,null,B(_.policyTypeEntries,(d,f)=>(e(),u(G,{key:f},{"accordion-header":a(()=>[p("h3",he,[h(W,{"policy-type":d.type},{default:a(()=>[c(y(d.type)+" ("+y(d.connections.length)+`)
          `,1)]),_:2},1032,["policy-type"])])]),"accordion-content":a(()=>[p("div",fe,[h($,{class:"policy-type-table",fetcher:()=>({data:d.connections,total:d.connections.length}),headers:b,"cell-attrs":C,"disable-pagination":"","is-clickable":""},{sourceTags:a(({rowValue:t})=>[t.length>0?(e(),u(z,{key:0,class:"tag-list","should-truncate":"",tags:t},null,8,["tags"])):(e(),l(m,{key:1},[c(`
                —
              `)],64))]),destinationTags:a(({rowValue:t})=>[t.length>0?(e(),u(z,{key:0,class:"tag-list","should-truncate":"",tags:t},null,8,["tags"])):(e(),l(m,{key:1},[c(`
                —
              `)],64))]),name:a(({rowValue:t})=>[t!==null?(e(),l(m,{key:0},[c(y(t),1)],64)):(e(),l(m,{key:1},[c(`
                —
              `)],64))]),origins:a(({rowValue:t})=>[t.length>0?(e(),l("ul",ge,[(e(!0),l(m,null,B(t,(o,s)=>(e(),l("li",{key:`${f}-${s}`},[h(g,{to:o.route},{default:a(()=>[c(y(o.name),1)]),_:2},1032,["to"])]))),128))])):(e(),l(m,{key:1},[c(`
                —
              `)],64))]),config:a(({rowValue:t,rowKey:o})=>[t!==null?(e(),u(U,{key:0,id:`${_.id}-${f}-${o}-code-block`,code:t,language:"yaml","show-copy-button":!1},null,8,["id","code"])):(e(),l(m,{key:1},[c(`
                —
              `)],64))]),_:2},1032,["fetcher"])])]),_:2},1024))),128))]),_:1})}}});const ve=V(ke,[["__scopeId","data-v-cd1528a1"]]),be=v=>(Y("data-v-45db36fa"),v=v(),J(),v),$e={class:"policy-type-heading"},we={class:"policy-list"},Te={key:0,class:"matcher"},Re={key:0,class:"matcher__and"},Pe=be(()=>p("br",null,null,-1)),Be={key:1,class:"matcher__not"},Ce={class:"matcher__term"},Le={key:1},Ne={key:0},Ee=D({__name:"RuleEntryList",props:{id:{},ruleEntries:{},showMatchers:{type:Boolean,default:!0}},setup(v){const{t:b}=Q(),_=v;function C({headerKey:T}){return{class:`cell-${T}`}}return(T,L)=>{const g=w("RouterLink"),$=w("KTable");return e(),u(j,{"initially-open":[],"multiple-open":""},{default:a(()=>[(e(!0),l(m,null,B(_.ruleEntries,(d,f)=>(e(),u(G,{key:f},{"accordion-header":a(()=>[p("h3",$e,[h(W,{"policy-type":d.type},{default:a(()=>[c(y(d.type),1)]),_:2},1032,["policy-type"])])]),"accordion-content":a(()=>[p("div",we,[h($,{class:ee(["policy-type-table",{"has-matchers":_.showMatchers}]),fetcher:()=>({data:d.rules,total:d.rules.length}),headers:[..._.showMatchers?[{label:"Matchers",key:"matchers"}]:[],{label:"Origin policies",key:"origins"},{label:"Conf",key:"config"}],"cell-attrs":C,"disable-pagination":""},q({origins:a(({row:t})=>[t.origins.length>0?(e(),l("ul",Ne,[(e(!0),l(m,null,B(t.origins,(o,s)=>(e(),l("li",{key:`${f}-${s}`},[h(g,{to:o.route},{default:a(()=>[c(y(o.name),1)]),_:2},1032,["to"])]))),128))])):(e(),l(m,{key:1},[c(y(x(b)("common.collection.none")),1)],64))]),config:a(({row:t,rowKey:o})=>[t.config!==void 0?(e(),u(U,{key:0,id:`${_.id}-${f}-${o}-code-block`,code:t.config,language:"yaml","show-copy-button":!1},null,8,["id","code"])):(e(),l(m,{key:1},[c(y(x(b)("common.collection.none")),1)],64))]),_:2},[_.showMatchers?{name:"matchers",fn:a(({row:t})=>[t.matchers&&t.matchers.length>0?(e(),l("span",Te,[(e(!0),l(m,null,B(t.matchers,({key:o,value:s,not:n},i)=>(e(),l(m,{key:i},[i>0?(e(),l("span",Re,[c(" and"),Pe])):N("",!0),n?(e(),l("span",Be,"!")):N("",!0),p("span",Ce,y(`${o}:${s}`),1)],64))),128))])):(e(),l("i",Le,y(x(b)("data-planes.routes.item.matches_everything")),1))]),key:"0"}:void 0]),1032,["class","fetcher","headers"])])]),_:2},1024))),128))]),_:1})}}});const F=V(Ee,[["__scopeId","data-v-45db36fa"]]),xe={"data-testid":"standard-dataplane-policies",class:"stack"},Se={class:"mb-2"},Ae=D({__name:"StandardDataplanePolicies",props:{sidecarDataplanes:{},inspectRulesForDataplane:{},policyTypesByName:{},showPoliciesSection:{type:Boolean}},setup(v){const{t:b}=Q(),_=v,C=S(()=>$(_.sidecarDataplanes)),T=S(()=>{const t=_.inspectRulesForDataplane.rules.find(r=>r.proxyRule);if(!t||!t.proxyRule)return null;const{type:o,proxyRule:s}=t,n=s.conf&&Object.keys(s.conf).length>0?M(s.conf):void 0,i=s.origin.map(r=>{const k=_.policyTypesByName[r.type];return{name:r.name,route:{name:"policy-detail-view",params:{mesh:r.mesh,policyPath:k.path,policy:r.name}}}});return{type:o,rules:[{config:n,origins:i}]}}),L=S(()=>{const t=[];for(const o of _.inspectRulesForDataplane.rules){const s=o.toRules??[];s.length>0&&t.push({type:o.type,rules:f(s)})}return t.sort((o,s)=>o.type.localeCompare(s.type)),t}),g=S(()=>{const t=new Map;for(const s of _.inspectRulesForDataplane.rules){const n=s.fromRules??[];if(n.length!==0)for(const i of n)t.has(i.inbound.port)||t.set(i.inbound.port,[]),t.get(i.inbound.port).push({type:s.type,rules:f(i.rules)})}for(const[,s]of t)s.sort((n,i)=>n.type.localeCompare(i.type));const o=Array.from(t);return o.sort(([s],[n])=>n-s),o.map(([s,n])=>({port:s,ruleEntries:n}))});function $(t){const o=new Map;for(const n of t){const{type:i,service:r}=n,k=typeof r=="string"&&r!==""?[{label:"kuma.io/service",value:r}]:[],R=i==="inbound"||i==="outbound"?n.name:null;for(const[P,E]of Object.entries(n.matchedPolicies)){o.has(P)||o.set(P,{type:P,connections:[]});const K=o.get(P),O=_.policyTypesByName[P];for(const X of E){const Z=d(X,O,n,k,R);K.connections.push(...Z)}}}const s=Array.from(o.values());return s.sort((n,i)=>n.type.localeCompare(i.type)),s}function d(t,o,s,n,i){const r=t.conf&&Object.keys(t.conf).length>0?M(t.conf):null,R=[{name:t.name,route:{name:"policy-detail-view",params:{mesh:t.mesh,policyPath:o.path,policy:t.name}}}],P=[];if(s.type==="inbound"&&Array.isArray(t.sources))for(const{match:E}of t.sources){const O={sourceTags:[{label:"kuma.io/service",value:E["kuma.io/service"]}],destinationTags:n,name:i,config:r,origins:R};P.push(O)}else{const K={sourceTags:[],destinationTags:n,name:i,config:r,origins:R};P.push(K)}return P}function f(t){return t.map(({conf:o,matchers:s,origin:n})=>{const i=o&&Object.keys(o).length>0?M(o):void 0,r=n.map(k=>{const R=_.policyTypesByName[k.type];return{name:k.name,route:{name:"policy-detail-view",params:{mesh:k.mesh,policyPath:R.path,policy:k.name}}}});return{config:i,matchers:s,origins:r}})}return(t,o)=>{const s=w("KCard");return e(),l("div",xe,[(!_.showPoliciesSection||_.sidecarDataplanes.length===0)&&_.inspectRulesForDataplane.rules.length===0?(e(),u(s,{key:0},{default:a(()=>[h(te)]),_:1})):(e(),l(m,{key:1},[_.showPoliciesSection?(e(),u(s,{key:0},{default:a(()=>[h(ve,{id:"policies","policy-type-entries":C.value,"data-testid":"policy-list"},null,8,["policy-type-entries"])]),_:1})):N("",!0),c(),T.value?(e(),u(s,{key:1},{default:a(()=>[p("h3",null,y(x(b)("data-planes.routes.item.proxy_rule")),1),c(),h(F,{id:"proxy-rules",class:"mt-2","rule-entries":[T.value],"show-matchers":!1,"data-testid":"proxy-rule-list"},null,8,["rule-entries"])]),_:1})):N("",!0),c(),L.value.length>0?(e(),u(s,{key:2},{default:a(()=>[p("h3",null,y(x(b)("data-planes.routes.item.to_rules")),1),c(),h(F,{id:"to-rules",class:"mt-2","rule-entries":L.value,"data-testid":"to-rule-list"},null,8,["rule-entries"])]),_:1})):N("",!0),c(),g.value.length>0?(e(),u(s,{key:3},{default:a(()=>[p("h3",Se,y(x(b)("data-planes.routes.item.from_rules")),1),c(),(e(!0),l(m,null,B(g.value,(n,i)=>(e(),l("div",{key:i},[p("h4",null,y(x(b)("data-planes.routes.item.port",{port:n.port})),1),c(),h(F,{id:`from-rules-${i}`,class:"mt-2","rule-entries":n.ruleEntries,"data-testid":`from-rule-list-${i}`},null,8,["id","rule-entries","data-testid"])]))),128))]),_:1})):N("",!0)],64))])}}}),Je=D({__name:"DataPlanePoliciesView",props:{data:{}},setup(v){const b=v;return(_,C)=>{const T=w("RouteTitle"),L=w("KCard"),g=w("DataSource"),$=w("AppView"),d=w("RouteView");return e(),u(d,{name:"data-plane-policies-view",params:{mesh:"",dataPlane:""}},{default:a(({can:f,route:t,t:o})=>[h($,null,{title:a(()=>[p("h2",null,[h(T,{title:o("data-planes.routes.item.navigation.data-plane-policies-view")},null,8,["title"])])]),default:a(()=>[c(),b.data.dataplaneType==="builtin"?(e(),u(g,{key:0,src:"/*/policy-types"},{default:a(({data:s,error:n})=>[h(g,{src:`/meshes/${t.params.mesh}/dataplanes/${t.params.dataPlane}/gateway-dataplane-policies`},{default:a(({data:i,error:r})=>[n?(e(),u(I,{key:0,error:n},null,8,["error"])):r?(e(),u(I,{key:1,error:r},null,8,["error"])):i===void 0||s===void 0?(e(),u(H,{key:2})):(e(),u(L,{key:3},{default:a(()=>[h(me,{"policy-types-by-name":s.policies.reduce((k,R)=>Object.assign(k,{[R.name]:R}),{}),"gateway-dataplane":i},null,8,["policy-types-by-name","gateway-dataplane"])]),_:2},1024))]),_:2},1032,["src"])]),_:2},1024)):(e(),u(g,{key:1,src:"/*/policy-types"},{default:a(({data:s,error:n})=>[h(g,{src:`/meshes/${t.params.mesh}/dataplanes/${t.params.dataPlane}/sidecar-dataplane-policies`},{default:a(({data:i,error:r})=>[h(g,{src:`/meshes/${t.params.mesh}/dataplanes/${t.params.dataPlane}/rules`},{default:a(({data:k,error:R})=>[n?(e(),u(I,{key:0,error:n},null,8,["error"])):r?(e(),u(I,{key:1,error:r},null,8,["error"])):R?(e(),u(I,{key:2,error:R},null,8,["error"])):s===void 0||i===void 0||k===void 0?(e(),u(H,{key:3})):(e(),u(Ae,{key:4,"policy-types-by-name":s.policies.reduce((P,E)=>Object.assign(P,{[E.name]:E}),{}),"sidecar-dataplanes":i.items,"inspect-rules-for-dataplane":k,"show-policies-section":!f("use zones")},null,8,["policy-types-by-name","sidecar-dataplanes","inspect-rules-for-dataplane","show-policies-section"]))]),_:2},1032,["src"])]),_:2},1032,["src"])]),_:2},1024))]),_:2},1024)]),_:1})}}});export{Je as default};
