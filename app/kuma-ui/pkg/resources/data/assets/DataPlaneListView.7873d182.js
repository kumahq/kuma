import{d as ke,e as P,cz as De,cu as _e,cA as Te,cB as $e,cC as Le,o as i,i as v,j as e,a as L,w as A,b as G,t as g,A as Ne,u as r,z as M,F as E,n as z,v as Re,h as xe,B as Ce,C as we,D as Pe,p as Me,r as D,f as ze,R as he,k as je,c as q,l as He,cD as Be,cE as qe,cF as Ge,M as ge,q as Ye,E as Ze,G as Fe,cs as be,cG as Je,cH as Qe,cI as We,cw as Xe,cx as et,cJ as tt,cv as at}from"./index.3bc39668.js";import{C as nt}from"./ContentWrapper.82c8233c.js";import{p as ae,D as st}from"./patchQueryParam.65a1b943.js";import{T as lt}from"./TagList.3d4ee64d.js";import{Y as ot}from"./YamlView.24c9d3cb.js";import{_ as it}from"./EmptyBlock.vue_vue_type_script_setup_true_lang.74b6b406.js";import"./ErrorBlock.f4ac98cc.js";import"./LoadingBlock.vue_vue_type_script_setup_true_lang.13b03cfc.js";import"./index.58caa11d.js";import"./CodeBlock.vue_vue_type_style_index_0_lang.b3d38a49.js";import"./_commonjsHelpers.f037b798.js";const U=l=>(Ce("data-v-b0ed64d1"),l=l(),we(),l),rt={class:"entity-summary entity-section-list"},dt={class:"entity-title","data-testid":"data-plane-proxy-title"},ct=U(()=>e("span",{class:"kutil-sr-only"},"Data plane proxy:",-1)),ut={class:"definition"},pt=U(()=>e("span",null,"Mesh:",-1)),mt={key:0},vt=U(()=>e("h4",null,"Tags",-1)),ft={key:1},yt=U(()=>e("h4",null,"Dependencies",-1)),_t={class:"mt-2 heading-with-icon"},ht=U(()=>e("h4",null,"Insights",-1)),gt={class:"entity-section-list"},bt=["data-testid"],kt=U(()=>e("span",null,"Connect time:",-1)),Dt=["data-testid"],Tt=U(()=>e("span",null,"Disconnect time:",-1)),Ct={class:"definition"},wt=U(()=>e("span",null,"Control plane instance ID:",-1)),Pt={key:0},Ut=U(()=>e("summary",null," Responses (acknowledged / sent) ",-1)),Vt=["data-testid"],At=ke({__name:"DataPlaneEntitySummary",props:{dataPlaneOverview:{type:Object,required:!0}},setup(l){const y=l,I={"Partially degraded":"partially_degraded",Offline:"offline",Online:"online"},Q=P(()=>{const{name:u,mesh:p,dataplane:m}=y.dataPlaneOverview;return{type:"Dataplane",name:u,mesh:p,networking:m.networking}}),S=P(()=>De(y.dataPlaneOverview.dataplane)),j=P(()=>{var p,m;const u=Array.from((m=(p=y.dataPlaneOverview.dataplaneInsight)==null?void 0:p.subscriptions)!=null?m:[]);return u.reverse(),u.map(t=>{const d=t.connectTime!==void 0?_e(t.connectTime):"\u2014",C=t.disconnectTime!==void 0?_e(t.disconnectTime):"\u2014",V=Object.entries(t.status).filter(([_])=>!["total","lastUpdateTime"].includes(_)).map(([_,b])=>{var Y,Z,H,F,J;const K=`${(Y=b.responsesAcknowledged)!=null?Y:0} / ${(Z=b.responsesSent)!=null?Z:0}`;return{type:_.toUpperCase(),ratio:K,responsesSent:(H=b.responsesSent)!=null?H:0,responsesAcknowledged:(F=b.responsesAcknowledged)!=null?F:0,responsesRejected:(J=b.responsesRejected)!=null?J:0}});return{subscription:t,formattedConnectDate:d,formattedDisconnectDate:C,statuses:V}})}),T=P(()=>{const{status:u}=Te(y.dataPlaneOverview.dataplane,y.dataPlaneOverview.dataplaneInsight);return $e[I[u]]}),N=P(()=>{const u=Le(y.dataPlaneOverview.dataplaneInsight);return u!==null?Object.entries(u).map(([p,m])=>({name:p,version:m})):[]}),O=P(()=>{var _,b;const u=(b=(_=y.dataPlaneOverview.dataplaneInsight)==null?void 0:_.subscriptions)!=null?b:[];if(u.length===0)return[];const p=u[u.length-1];if(!p.version)return[];const m=[],t=p.version.envoy,d=p.version.kumaDp;if(!(t.kumaDpCompatible!==void 0?t.kumaDpCompatible:!0)){const K=`Envoy ${t.version} is not supported by Kuma DP ${d.version}.`;m.push(K)}if(!(d.kumaCpCompatible!==void 0?d.kumaCpCompatible:!0)){const K=`Kuma DP ${d.version} is not supported by this Kuma control plane.`;m.push(K)}return m});return(u,p)=>{const m=xe("router-link");return i(),v("div",rt,[e("section",null,[e("h3",dt,[ct,L(m,{to:{name:"data-plane-detail-view",params:{mesh:l.dataPlaneOverview.mesh,dataPlane:l.dataPlaneOverview.name}}},{default:A(()=>[G(g(l.dataPlaneOverview.name),1)]),_:1},8,["to"]),e("div",{class:Ne(`status status--${r(T).appearance}`),"data-testid":"data-plane-status-badge"},g(r(T).title.toLowerCase()),3)]),e("div",ut,[pt,e("span",null,g(l.dataPlaneOverview.mesh),1)])]),r(S).length>0?(i(),v("section",mt,[vt,L(lt,{tags:r(S)},null,8,["tags"])])):M("",!0),r(N).length>0?(i(),v("section",ft,[yt,(i(!0),v(E,null,z(r(N),(t,d)=>(i(),v("div",{key:d,class:"definition"},[e("span",null,g(t.name)+":",1),e("span",null,g(t.version),1)]))),128)),r(O).length>0?(i(),v(E,{key:0},[e("h5",_t,[G(" Warnings "),L(r(Re),{class:"ml-1",icon:"warning",color:"var(--black-75)","secondary-color":"var(--yellow-300)",size:"20"})]),(i(!0),v(E,null,z(r(O),(t,d)=>(i(),v("p",{key:d},g(t),1))),128))],64)):M("",!0)])):M("",!0),r(j).length>0?(i(),v(E,{key:2},[e("section",null,[ht,e("div",gt,[(i(!0),v(E,null,z(r(j),(t,d)=>(i(),v("div",{key:d},[e("div",{class:"definition","data-testid":`data-plane-connect-time-${d}`},[kt,e("span",null,g(t.formattedConnectDate),1)],8,bt),e("div",{class:"definition","data-testid":`data-plane-disconnect-time-${d}`},[Tt,e("span",null,g(t.formattedDisconnectDate),1)],8,Dt),e("div",Ct,[wt,e("span",null,g(t.subscription.controlPlaneInstanceId),1)]),t.statuses.length>0?(i(),v("details",Pt,[Ut,(i(!0),v(E,null,z(t.statuses,(C,V)=>(i(),v("div",{key:`${d}-${V}`,class:"definition","data-testid":`data-plane-subscription-status-${d}-${V}`},[e("span",null,g(C.type)+":",1),e("span",null,g(C.ratio),1)],8,Vt))),128))])):M("",!0)]))),128))])]),e("section",null,[L(ot,{id:"code-block-data-plane-summary",content:r(Q),"code-max-height":"250px"},null,8,["content"])])],64)):M("",!0)])}}});const Et=Pe(At,[["__scopeId","data-v-b0ed64d1"]]),Ue=[{key:"status",label:"Status"},{key:"name",label:"Name"},{key:"type",label:"Type"},{key:"service",label:"Service"},{key:"protocol",label:"Protocol"},{key:"zone",label:"Zone"},{key:"lastConnected",label:"Last Connected"},{key:"lastUpdated",label:"Last Updated"},{key:"totalUpdates",label:"Total Updates"},{key:"dpVersion",label:"Kuma DP version"},{key:"envoyVersion",label:"Envoy version"},{key:"details",label:"Details",hideLabel:!0}],It=["name","details"],St=Ue.filter(l=>!It.includes(l.key)).map(l=>({tableHeaderKey:l.key,label:l.label,isChecked:!1})),Ve=["status","name","type","service","protocol","zone","lastUpdated","dpVersion","details"];function Ot(l,y=Ve){return Ue.filter(I=>y.includes(I.key)?l?!0:I.key!=="zone":!1)}const ne=l=>(Ce("data-v-f2989e9f"),l=l(),we(),l),Kt=ne(()=>e("label",{for:"data-planes-type-filter",class:"mr-2"}," Type: ",-1)),$t=["value"],Lt=["for"],Nt=["id","checked","onChange"],Rt=ne(()=>e("span",{class:"custom-control-icon"}," + ",-1)),xt=ne(()=>e("span",{class:"custom-control-icon"}," \u2190 ",-1)),Mt=ke({__name:"DataPlaneListView",props:{name:{type:String,required:!1,default:null},offset:{type:Number,required:!1,default:0}},setup(l){const y=l,I=50,Q=["All","Standard","Gateway (builtin)","Gateway (delegated)"],S=Me(),j=Ye(),T=D(Ve),N=D(!0),O=D(!1),u=D(null),p=D(!1),m=D({headers:[],data:[]}),t=D([]),d=D(null),C=D("All"),V=D(y.offset),_=D(null),b=P(()=>j.getters["config/getMulticlusterStatus"]),K=P(()=>({name:j.getters["config/getEnvironment"]==="universal"?"universal-dataplane":"kubernetes-dataplane"})),Y=P(()=>{const a=m.value.data.filter(f=>C.value==="All"?!0:f.type.toLowerCase()===C.value.toLowerCase()),s=Ot(b.value,T.value);return{data:a,headers:s}}),Z=P(()=>St.filter(a=>b.value?!0:a.tableHeaderKey!=="zone").map(a=>{const s=T.value.includes(a.tableHeaderKey);return{...a,isChecked:s}}));ze(()=>S.params.mesh,function(){S.name==="data-plane-list-view"&&(O.value=!1,u.value=null,p.value=!1,W(0))});const H=he.get("dpVisibleTableHeaderKeys");Array.isArray(H)&&(T.value=H),W(y.offset);function F(a){a.stopPropagation()}function J(a,s){const f=a.target,o=T.value.findIndex(c=>c===s);f.checked&&o===-1?T.value.push(s):!f.checked&&o>-1&&T.value.splice(o,1),he.set("dpVisibleTableHeaderKeys",Array.from(new Set(T.value)))}function Ae(){Ze.logger.info(Fe.CREATE_DATA_PLANE_PROXY_CLICKED)}function Ee(){return{title:"No Data",message:"There are no data plane proxies present."}}async function Ie(a){var le,oe,ie,re,de,ce,ue;const s=a.mesh,f=a.name,o={name:"data-plane-detail-view",params:{mesh:s,dataPlane:f}},c={name:"mesh-detail-view",params:{mesh:s}},B=["kuma.io/protocol","kuma.io/service","kuma.io/zone"],R=De(a.dataplane).filter(n=>B.includes(n.label)),k=(le=R.find(n=>n.label==="kuma.io/service"))==null?void 0:le.value,$=(oe=R.find(n=>n.label==="kuma.io/protocol"))==null?void 0:oe.value,ee=(ie=R.find(n=>n.label==="kuma.io/zone"))==null?void 0:ie.value;let se;k!==void 0&&(se={name:"service-insight-detail-view",params:{mesh:s,service:k}});const{status:Se}=Te(a.dataplane,a.dataplaneInsight),Oe=(de=(re=a.dataplaneInsight)==null?void 0:re.subscriptions)!=null?de:[],Ke={totalUpdates:0,totalRejectedUpdates:0,dpVersion:null,envoyVersion:null,selectedTime:NaN,selectedUpdateTime:NaN,version:null},h=Oe.reduce((n,w)=>{var pe,me,ve,fe;if(w.connectTime){const ye=Date.parse(w.connectTime);(!n.selectedTime||ye>n.selectedTime)&&(n.selectedTime=ye)}const te=Date.parse(w.status.lastUpdateTime);return te&&(!n.selectedUpdateTime||te>n.selectedUpdateTime)&&(n.selectedUpdateTime=te),{totalUpdates:n.totalUpdates+parseInt((pe=w.status.total.responsesSent)!=null?pe:"0",10),totalRejectedUpdates:n.totalRejectedUpdates+parseInt((me=w.status.total.responsesRejected)!=null?me:"0",10),dpVersion:((ve=w.version)==null?void 0:ve.kumaDp.version)||n.dpVersion,envoyVersion:((fe=w.version)==null?void 0:fe.envoy.version)||n.envoyVersion,selectedTime:n.selectedTime,selectedUpdateTime:n.selectedUpdateTime,version:w.version||n.version}},Ke),x={name:f,nameRoute:o,mesh:s,meshRoute:c,zone:ee!=null?ee:"\u2014",service:k!=null?k:"\u2014",serviceInsightRoute:se,protocol:$!=null?$:"\u2014",status:Se,totalUpdates:h.totalUpdates,totalRejectedUpdates:h.totalRejectedUpdates,dpVersion:(ce=h.dpVersion)!=null?ce:"\u2014",envoyVersion:(ue=h.envoyVersion)!=null?ue:"\u2014",warnings:[],unsupportedEnvoyVersion:!1,unsupportedKumaDPVersion:!1,kumaDpAndKumaCpMismatch:!1,lastUpdated:h.selectedUpdateTime?be(new Date(h.selectedUpdateTime).toUTCString()):"\u2014",lastConnected:h.selectedTime?be(new Date(h.selectedTime).toUTCString()):"\u2014",type:Je(a.dataplane)};if(h.version){const{kind:n}=Qe(h.version);switch(n!==We&&x.warnings.push(n),n){case et:x.unsupportedEnvoyVersion=!0;break;case Xe:x.unsupportedKumaDPVersion=!0;break}}return b.value&&h.dpVersion&&R.find(w=>w.label===tt)&&typeof h.version.kumaDp.kumaCpCompatible=="boolean"&&!h.version.kumaDp.kumaCpCompatible&&(x.warnings.push(at),x.kumaDpAndKumaCpMismatch=!0),x}async function W(a){var o;V.value=a,ae("offset",a>0?a:null),N.value=!0;const s=S.params.mesh,f=I;try{const{items:c,next:B}=await je.getAllDataplaneOverviewsFromMesh({mesh:s},{size:f,offset:a});if(Array.isArray(c)&&c.length>0){c.sort(function(k,$){return k.name===$.name?k.mesh>$.mesh?1:-1:k.name.localeCompare($.name)}),d.value=B,t.value=c,X((o=y.name)!=null?o:c[0].name);const R=await Promise.all(t.value.map(k=>Ie(k)));m.value.data=R,p.value=!1,O.value=!1}else X(null),m.value.data=[],p.value=!0,O.value=!0}catch(c){c instanceof Error?u.value=c:console.error(c),O.value=!0}finally{N.value=!1}}function X(a){var s;a&&t.value.length>0?(_.value=(s=t.value.find(f=>f.name===a))!=null?s:t.value[0],ae("name",_.value.name)):(_.value=null,ae("name",null))}return(a,s)=>(i(),q(nt,null,{content:A(()=>{var f;return[L(st,{"selected-entity-name":(f=_.value)==null?void 0:f.name,"page-size":I,"is-loading":N.value,error:u.value,"empty-state":Ee(),"table-data":r(Y),"table-data-is-empty":p.value,"show-details":"",next:d.value!==null,"page-offset":V.value,onTableAction:s[1]||(s[1]=o=>X(o.name)),onLoadData:s[2]||(s[2]=o=>W(o))},{additionalControls:A(()=>[e("div",null,[Kt,He(e("select",{id:"data-planes-type-filter","onUpdate:modelValue":s[0]||(s[0]=o=>C.value=o),"data-testid":"data-planes-type-filter"},[(i(),v(E,null,z(Q,(o,c)=>e("option",{key:c,value:o},g(o),9,$t)),64))],512),[[Be,C.value]])]),L(r(qe),{label:"Columns",icon:"cogwheel","button-appearance":"outline"},{items:A(()=>[e("div",{onClick:F},[(i(!0),v(E,null,z(r(Z),(o,c)=>(i(),q(r(Ge),{key:c,class:"table-header-selector-item",item:o},{default:A(()=>[e("label",{for:`data-plane-table-header-checkbox-${c}`,class:"k-checkbox table-header-selector-item-checkbox"},[e("input",{id:`data-plane-table-header-checkbox-${c}`,checked:o.isChecked,type:"checkbox",class:"k-input",onChange:B=>J(B,o.tableHeaderKey)},null,40,Nt),G(" "+g(o.label),1)],8,Lt)]),_:2},1032,["item"]))),128))])]),_:1}),L(r(ge),{class:"add-dp-button",appearance:"primary",to:r(K),"data-testid":"data-plane-create-data-plane-button",onClick:Ae},{default:A(()=>[Rt,G(" Create data plane proxy ")]),_:1},8,["to"]),r(S).query.ns?(i(),q(r(ge),{key:0,appearance:"primary",to:{name:"data-plane-list-view"},"data-testid":"data-plane-ns-back-button"},{default:A(()=>[xt,G(" View All ")]),_:1})):M("",!0)]),_:1},8,["selected-entity-name","is-loading","error","empty-state","table-data","table-data-is-empty","next","page-offset"])]}),sidebar:A(()=>[_.value!==null?(i(),q(Et,{key:0,"data-plane-overview":_.value},null,8,["data-plane-overview"])):(i(),q(it,{key:1}))]),_:1}))}});const Wt=Pe(Mt,[["__scopeId","data-v-f2989e9f"]]);export{Wt as default};
