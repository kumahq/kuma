var de=Object.defineProperty;var pe=(n,s,a)=>s in n?de(n,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):n[s]=a;var Q=(n,s,a)=>(pe(n,typeof s!="symbol"?s+"":s,a),a);import{d as ie,$ as me,I as fe,r as ge,o as p,g as j,w as y,P as le,h as I,l as f,C as b,j as k,F as z,S as ve,i as u,a7 as ye,m as C,D as re,k as O,V as he,K as B,am as be,U as ke,a2 as H,Z as _e,an as Te,Y as Se,q as ue,t as L,f as V,ao as ne,ap as we,aq as Ce,ar as xe,x as oe,v as Ie,Q as De,z as Ue,B as Le}from"./index-622cbb72.js";import{d as ze,a as Ae,c as Ne,C as Ee}from"./dataplane-0a086c06.js";const Re={key:0},Fe=ie({__name:"DataPlaneList",props:{total:{default:0},pageNumber:{},pageSize:{},items:{},error:{},gateways:{type:Boolean,default:!1}},emits:["load-data","change"],setup(n,{emit:s}){const a=n,{t:i,formatIsoDate:o}=me(),g=fe()("use zones");function T(v){return v.map(l=>{var R,D,K,e,r,m,U,Y;const S=l.mesh,t=l.name,_=((R=l.dataplane.networking.gateway)==null?void 0:R.type)||"STANDARD",x={name:_==="STANDARD"?"data-plane-detail-view":"gateway-detail-view",params:{mesh:S,dataPlane:t}},Z=["kuma.io/protocol","kuma.io/service","kuma.io/zone"],A=ze(l.dataplane).filter(c=>Z.includes(c.label)),F=(D=A.find(c=>c.label==="kuma.io/service"))==null?void 0:D.value,W=(K=A.find(c=>c.label==="kuma.io/protocol"))==null?void 0:K.value,N=(e=A.find(c=>c.label==="kuma.io/zone"))==null?void 0:e.value;let M;F!==void 0&&(M={name:"service-detail-view",params:{mesh:S,service:F}});let q;N!==void 0&&(q={name:"zone-cp-detail-view",params:{zone:N}});const{status:P}=Ae(l.dataplane,l.dataplaneInsight),G=((r=l.dataplaneInsight)==null?void 0:r.subscriptions)??[],J={totalUpdates:0,totalRejectedUpdates:0,dpVersion:null,envoyVersion:null,selectedTime:NaN,selectedUpdateTime:NaN,version:null},h=G.reduce((c,w)=>{var ee,te;if(w.connectTime){const ae=Date.parse(w.connectTime);(!c.selectedTime||ae>c.selectedTime)&&(c.selectedTime=ae)}const X=Date.parse(w.status.lastUpdateTime);return X&&(!c.selectedUpdateTime||X>c.selectedUpdateTime)&&(c.selectedUpdateTime=X),{totalUpdates:c.totalUpdates+parseInt(w.status.total.responsesSent??"0",10),totalRejectedUpdates:c.totalRejectedUpdates+parseInt(w.status.total.responsesRejected??"0",10),dpVersion:((ee=w.version)==null?void 0:ee.kumaDp.version)||c.dpVersion,envoyVersion:((te=w.version)==null?void 0:te.envoy.version)||c.envoyVersion,selectedTime:c.selectedTime,selectedUpdateTime:c.selectedUpdateTime,version:w.version||c.version}},J),E={name:t,dataplaneInsight:l.dataplaneInsight,detailViewRoute:x,type:_,zone:{title:N??i("common.collection.none"),route:q},service:{title:F??i("common.collection.none"),route:M},protocol:W??i("common.collection.none"),status:P,totalUpdates:h.totalUpdates,totalRejectedUpdates:h.totalRejectedUpdates,envoyVersion:h.envoyVersion??i("common.collection.none"),warnings:{version_mismatch:!1,cert_expired:!1},lastUpdated:h.selectedUpdateTime?o(new Date(h.selectedUpdateTime).toUTCString()):i("common.collection.none"),lastConnected:h.selectedTime?o(new Date(h.selectedTime).toUTCString()):i("common.collection.none"),overview:l};if(h.version){const{kind:c}=Ne(h.version);c!==Ee&&(E.warnings.version_mismatch=!0)}g&&h.dpVersion&&A.find(w=>w.label==="kuma.io/zone")&&typeof((m=h.version)==null?void 0:m.kumaDp.kumaCpCompatible)=="boolean"&&!h.version.kumaDp.kumaCpCompatible&&(E.warnings.version_mismatch=!0);const $=(Y=(U=l.dataplaneInsight)==null?void 0:U.mTLS)==null?void 0:Y.certificateExpirationTime;return $&&Date.now()>new Date($).getTime()&&(E.warnings.cert_expired=!0),E})}return(v,l)=>{const S=ge("RouterLink");return p(),j(Se,{"empty-state-message":u(i)("common.emptyState.message",{type:a.gateways?"Gateways":"Data Plane Proxies"}),"empty-state-cta-to":u(i)(`data-planes.href.docs.${a.gateways?"gateway":"data_plane_proxy"}`),"empty-state-cta-text":u(i)("common.documentation"),headers:[{label:"Name",key:"name"},...a.gateways?[{label:"Type",key:"type"}]:[],{label:"Service",key:"service"},...a.gateways?[]:[{label:"Protocol",key:"protocol"}],...u(g)?[{label:"Zone",key:"zone"}]:[],{label:"Last Updated",key:"lastUpdated"},{label:"Certificate Info",key:"certificate"},{label:"Status",key:"status"},{label:"Warnings",key:"warnings",hideLabel:!0},{label:"Actions",key:"actions",hideLabel:!0}],"page-number":a.pageNumber,"page-size":a.pageSize,total:a.total,items:a.items?T(a.items):void 0,error:a.error,onChange:l[0]||(l[0]=t=>s("change",t))},{toolbar:y(()=>[le(v.$slots,"toolbar",{},void 0,!0)]),name:y(({row:t})=>[I(S,{to:{name:a.gateways?"gateway-detail-view":"data-plane-detail-view",params:{dataPlane:t.name}},"data-testid":"detail-view-link"},{default:y(()=>[f(b(t.name),1)]),_:2},1032,["to"])]),service:y(({rowValue:t})=>[t.route?(p(),j(S,{key:0,to:t.route},{default:y(()=>[f(b(t.title),1)]),_:2},1032,["to"])):(p(),k(z,{key:1},[f(b(t.title),1)],64))]),zone:y(({rowValue:t})=>[t.route?(p(),j(S,{key:0,to:t.route},{default:y(()=>[f(b(t.title),1)]),_:2},1032,["to"])):(p(),k(z,{key:1},[f(b(t.title),1)],64))]),status:y(({rowValue:t})=>[t?(p(),j(ve,{key:0,status:t},null,8,["status"])):(p(),k(z,{key:1},[f(b(u(i)("common.collection.none")),1)],64))]),warnings:y(({row:t})=>[Object.values(t.warnings).some(_=>_)?(p(),j(u(ye),{key:0},{content:y(()=>[C("ul",null,[(p(!0),k(z,null,re(t.warnings,(_,x)=>(p(),k(z,{key:x},[_?(p(),k("li",Re,b(u(i)(`data-planes.components.data-plane-list.${x}`)),1)):O("",!0)],64))),128))])]),default:y(()=>[f(),I(he,{class:"mr-1",size:u(B),"hide-title":""},null,8,["size"])]),_:2},1024)):(p(),k(z,{key:1},[f(b(u(i)("common.collection.none")),1)],64))]),certificate:y(({row:t})=>{var _,x;return[f(b((x=(_=t.dataplaneInsight)==null?void 0:_.mTLS)!=null&&x.certificateExpirationTime?u(o)(new Date(t.dataplaneInsight.mTLS.certificateExpirationTime).toUTCString()):u(i)("data-planes.components.data-plane-list.certificate.none")),1)]}),actions:y(({row:t})=>[I(u(be),{class:"actions-dropdown","kpop-attributes":{placement:"bottomEnd",popoverClasses:"mt-5 more-actions-popover"},width:"150"},{default:y(()=>[I(u(ke),{class:"non-visual-button",appearance:"secondary",size:"small"},{icon:y(()=>[I(u(H),{color:u(_e),icon:"more",size:u(B)},null,8,["color","size"])]),_:1})]),items:y(()=>[I(u(Te),{item:{to:{name:a.gateways?"gateway-detail-view":"data-plane-detail-view",params:{dataPlane:t.name}},label:u(i)("common.collection.actions.view")}},null,8,["item"])]),_:2},1024)]),_:3},8,["empty-state-message","empty-state-cta-to","empty-state-cta-text","headers","page-number","page-size","total","items","error"])}}});const st=ue(Fe,[["__scopeId","data-v-81d1bfc6"]]);function je(n,s,a){return Math.max(s,Math.min(n,a))}const Be=["ControlLeft","ControlRight","ShiftLeft","ShiftRight","AltLeft"];class Me{constructor(s,a){Q(this,"commands");Q(this,"keyMap");Q(this,"boundTriggerShortcuts");this.commands=a,this.keyMap=Object.fromEntries(Object.entries(s).map(([i,o])=>[i.toLowerCase(),o])),this.boundTriggerShortcuts=this.triggerShortcuts.bind(this)}registerListener(){document.addEventListener("keydown",this.boundTriggerShortcuts)}unRegisterListener(){document.removeEventListener("keydown",this.boundTriggerShortcuts)}triggerShortcuts(s){qe(s,this.keyMap,this.commands)}}function qe(n,s,a){const i=Pe(n.code),o=[n.ctrlKey?"ctrl":"",n.shiftKey?"shift":"",n.altKey?"alt":"",i].filter(T=>T!=="").join("+"),d=s[o];if(!d)return;const g=a[d];g.isAllowedContext&&!g.isAllowedContext(n)||(g.shouldPreventDefaultAction&&n.preventDefault(),!(g.isDisabled&&g.isDisabled())&&g.trigger(n))}function Pe(n){return Be.includes(n)?"":n.replace(/^Key/,"").toLowerCase()}function $e(n,s){const a=" "+n,i=a.matchAll(/ ([-\s\w]+):\s*/g),o=[];for(const d of Array.from(i)){if(d.index===void 0)continue;const g=Ke(d[1]);if(s.length>0&&!s.includes(g))throw new Error(`Unknown field “${g}”. Known fields: ${s.join(", ")}`);const T=d.index+d[0].length,v=a.substring(T);let l;if(/^\s*["']/.test(v)){const t=v.match(/['"](.*?)['"]/);if(t!==null)l=t[1];else throw new Error(`Quote mismatch for field “${g}”.`)}else{const t=v.indexOf(" "),_=t===-1?v.length:t;l=v.substring(0,_)}l!==""&&o.push([g,l])}return o}function Ke(n){return n.trim().replace(/\s+/g,"-").replace(/-[a-z]/g,(s,a)=>a===0?s:s.substring(1).toUpperCase())}let se=0;const Qe=(n="unique")=>(se++,`${n}-${se}`),ce=n=>(Ue("data-v-e5b88bf8"),n=n(),Le(),n),Ve=ce(()=>C("span",{class:"visually-hidden"},"Focus filter",-1)),Oe=["for"],He=["id","placeholder"],Ze={key:0,class:"k-suggestion-box","data-testid":"k-filter-bar-suggestion-box"},We={class:"k-suggestion-list"},Ge={key:0,class:"k-filter-bar-error"},Je={key:0},Xe=["title","data-filter-field"],Ye={class:"visually-hidden"},et=ce(()=>C("span",{class:"visually-hidden"},"Clear query",-1)),tt=ie({__name:"KFilterBar",props:{id:{type:String,required:!1,default:()=>Qe("k-filter-bar")},fields:{type:Object,required:!0},placeholder:{type:String,required:!1,default:null},query:{type:String,required:!1,default:""}},emits:["fields-change"],setup(n,{emit:s}){const a=n,i=L(null),o=L(null),d=L(a.query),g=L([]),T=L(null),v=L(!1),l=L(-1),S=V(()=>Object.keys(a.fields)),t=V(()=>Object.entries(a.fields).slice(0,5).map(([e,r])=>({fieldName:e,...r}))),_=V(()=>S.value.length>0?`Filter by ${S.value.join(", ")}`:"Filter"),x=V(()=>a.placeholder??_.value);ne(()=>g.value,function(e,r){K(e,r)||(T.value=null,s("fields-change",{fields:e,query:d.value}))}),ne(()=>d.value,function(){d.value===""&&(T.value=null),v.value=!0});const Z={Enter:"submitQuery",Escape:"closeSuggestionBox",ArrowDown:"jumpToNextSuggestion",ArrowUp:"jumpToPreviousSuggestion"},A={submitQuery:{trigger:N,isAllowedContext(e){return o.value!==null&&e.composedPath().includes(o.value)},shouldPreventDefaultAction:!0},jumpToNextSuggestion:{trigger:M,isAllowedContext(e){return o.value!==null&&e.composedPath().includes(o.value)},shouldPreventDefaultAction:!0},jumpToPreviousSuggestion:{trigger:q,isAllowedContext(e){return o.value!==null&&e.composedPath().includes(o.value)},shouldPreventDefaultAction:!0},closeSuggestionBox:{trigger:R,isAllowedContext(e){return i.value!==null&&e.composedPath().includes(i.value)}}};function F(){const e=new Me(Z,A);Ie(function(){e.registerListener()}),De(function(){e.unRegisterListener()}),D(d.value)}F();function W(e){const r=e.target;D(r.value)}function N(){if(o.value instanceof HTMLInputElement)if(l.value===-1)D(o.value.value),v.value=!1;else{const e=t.value[l.value].fieldName;e&&h(o.value,e)}}function M(){P(1)}function q(){P(-1)}function P(e){l.value=je(l.value+e,-1,t.value.length-1)}function G(){o.value instanceof HTMLInputElement&&o.value.focus()}function J(e){const m=e.currentTarget.getAttribute("data-filter-field");m&&o.value instanceof HTMLInputElement&&h(o.value,m)}function h(e,r){const m=d.value===""||d.value.endsWith(" ")?"":" ";d.value+=m+r+":",e.focus(),l.value=-1}function E(){d.value="",o.value instanceof HTMLInputElement&&(o.value.value="",o.value.focus(),D(""))}function $(e){e.relatedTarget===null&&R(),i.value instanceof HTMLElement&&e.relatedTarget instanceof Node&&!i.value.contains(e.relatedTarget)&&R()}function R(){v.value=!1}function D(e){T.value=null;try{const r=$e(e,S.value);r.sort((m,U)=>m[0].localeCompare(U[0])),g.value=r}catch(r){if(r instanceof Error)T.value=r,v.value=!0;else throw r}}function K(e,r){return JSON.stringify(e)===JSON.stringify(r)}return(e,r)=>(p(),k("div",{ref_key:"filterBar",ref:i,class:"k-filter-bar","data-testid":"k-filter-bar"},[C("button",{class:"k-focus-filter-input-button",title:"Focus filter",type:"button","data-testid":"k-filter-bar-focus-filter-input-button",onClick:G},[Ve,f(),I(u(H),{"aria-hidden":"true",class:"k-filter-icon",color:u(we),"data-testid":"k-filter-bar-filter-icon","hide-title":"",icon:"filter",size:u(B)},null,8,["color","size"])]),f(),C("label",{for:`${a.id}-filter-bar-input`,class:"visually-hidden"},[le(e.$slots,"default",{},()=>[f(b(_.value),1)],!0)],8,Oe),f(),Ce(C("input",{id:`${a.id}-filter-bar-input`,ref_key:"filterInput",ref:o,"onUpdate:modelValue":r[0]||(r[0]=m=>d.value=m),class:"k-filter-bar-input",type:"text",placeholder:x.value,"data-testid":"k-filter-bar-filter-input",onFocus:r[1]||(r[1]=m=>v.value=!0),onBlur:$,onChange:W},null,40,He),[[xe,d.value]]),f(),v.value?(p(),k("div",Ze,[C("div",We,[T.value!==null?(p(),k("p",Ge,b(T.value.message),1)):(p(),k("button",{key:1,class:oe(["k-submit-query-button",{"k-submit-query-button-is-selected":l.value===-1}]),title:"Submit query",type:"button","data-testid":"k-filter-bar-submit-query-button",onClick:N},`
          Submit `+b(d.value),3)),f(),(p(!0),k(z,null,re(t.value,(m,U)=>(p(),k("div",{key:`${a.id}-${U}`,class:oe(["k-suggestion-list-item",{"k-suggestion-list-item-is-selected":l.value===U}])},[C("b",null,b(m.fieldName),1),m.description!==""?(p(),k("span",Je,": "+b(m.description),1)):O("",!0),f(),C("button",{class:"k-apply-suggestion-button",title:`Add ${m.fieldName}:`,type:"button","data-filter-field":m.fieldName,"data-testid":"k-filter-bar-apply-suggestion-button",onClick:J},[C("span",Ye,"Add "+b(m.fieldName)+":",1),f(),I(u(H),{"aria-hidden":"true",color:"currentColor","hide-title":"",icon:"chevronRight",size:u(B)},null,8,["size"])],8,Xe)],2))),128))])])):O("",!0),f(),d.value!==""?(p(),k("button",{key:1,class:"k-clear-query-button",title:"Clear query",type:"button","data-testid":"k-filter-bar-clear-query-button",onClick:E},[et,f(),I(u(H),{"aria-hidden":"true",color:"currentColor",icon:"clear","hide-title":"",size:u(B)},null,8,["size"])])):O("",!0)],512))}});const it=ue(tt,[["__scopeId","data-v-e5b88bf8"]]);export{st as D,it as K};
