import{d as fe,M as O,h as p,i as t,e as A,w as K,q as be,N as b,t as f,F as w,k as C,p as I,f as R,cw as ee,a1 as W,cx as te,cy as ge,cz as De,r as T,o as r,b as N,B as we,u as ae,x as se,_ as ne,y as ke,cA as Pe,cB as Te,a2 as Ce,l as Ee,cC as X,z as Oe,A as Se,$ as J,cD as Ke,cE as Ie,cF as Ae,a4 as Ve,a5 as Ue,cG as Le,a3 as Ne,K as S,j as Re,cH as Me}from"./index.f2463021.js";import{g as $e}from"./tableDataUtils.233f95a0.js";import{D as Be}from"./DataOverview.e6547ee7.js";import{E as He}from"./EntityTag.1082faf5.js";import{Y as ze}from"./YamlView.dbf4ab2f.js";import{_ as xe}from"./EmptyBlock.vue_vue_type_script_setup_true_lang.79e60fc9.js";import"./ErrorBlock.6b7b6a0a.js";import"./LoadingBlock.vue_vue_type_script_setup_true_lang.92dd8129.js";import"./index.58caa11d.js";import"./CodeBlock.f31221ad.js";const ie=[{key:"status",label:"Status"},{key:"name",label:"Name"},{key:"mesh",label:"Mesh"},{key:"type",label:"Type"},{key:"service",label:"Service"},{key:"protocol",label:"Protocol"},{key:"zone",label:"Zone"},{key:"lastConnected",label:"Last Connected"},{key:"lastUpdated",label:"Last Updated"},{key:"totalUpdates",label:"Total Updates"},{key:"dpVersion",label:"Kuma DP version"},{key:"envoyVersion",label:"Envoy version"},{key:"details",label:"Details",hideLabel:!0}],je=["name","details"],qe=ie.filter(e=>!je.includes(e.key)).map(e=>({tableHeaderKey:e.key,label:e.label,isChecked:!1})),oe=["status","name","mesh","type","service","protocol","zone","lastUpdated","dpVersion","details"];function Fe(e,a=oe){return ie.filter(i=>a.includes(i.key)?e?!0:i.key!=="zone":!1)}function q(e,a){const i=window.history.state;if(i===null)return;const u=i.current.indexOf("?"),n=u>-1?i.current.substring(u):"",c=new URLSearchParams(n);a!=null?c.set(e,String(a)):c.has(e)&&c.delete(e);const g=c.toString(),D=g===""?"":"?"+g;let _="";if(u>-1?_=i.current.substring(0,u)+D:_=i.current+D,i.current!==_){const l=Object.assign({},i);l.current=_,window.history.replaceState(l,"","#"+_)}}const k=e=>(ae("data-v-5236dda8"),e=e(),se(),e),Ye={class:"entity-summary entity-section-list"},Ge={class:"entity-title"},Qe=k(()=>t("span",{class:"kutil-sr-only"},"Data plane:",-1)),Ze={class:"definition"},We=k(()=>t("span",null,"Mesh:",-1)),Xe={key:0},Je=k(()=>t("h4",null,"Tags",-1)),et={class:"tag-list"},tt={key:1},at=k(()=>t("h4",null,"Dependencies",-1)),st={class:"mt-2 heading-with-icon"},nt=R(" Warnings "),it=k(()=>t("h4",null,"Insights",-1)),ot={class:"entity-section-list"},lt=["data-testid"],rt=k(()=>t("span",null,"Connect time:",-1)),dt=["data-testid"],ct=k(()=>t("span",null,"Disconnect time:",-1)),pt={class:"definition"},ut=k(()=>t("span",null,"Control plane instance ID:",-1)),mt={key:0},ht=k(()=>t("summary",null," Responses (acknowledged / sent) ",-1)),yt=["data-testid"],vt=fe({__name:"DataPlaneEntitySummary",props:{dataPlaneOverview:{type:Object,required:!0}},setup(e){const a=e,i={"Partially degraded":"partially_degraded",Offline:"offline",Online:"online"},u=O(()=>{const{name:l,mesh:d,dataplane:m}=a.dataPlaneOverview;return{type:"Dataplane",name:l,mesh:d,networking:m.networking}}),n=O(()=>ee(a.dataPlaneOverview.dataplane)),c=O(()=>{const l=Array.from(a.dataPlaneOverview.dataplaneInsight.subscriptions);return l.reverse(),l.map(d=>{const m=d.connectTime!==void 0?W(d.connectTime):"\u2014",o=d.disconnectTime!==void 0?W(d.disconnectTime):"\u2014",s=Object.entries(d.status).filter(([h])=>!["total","lastUpdateTime"].includes(h)).map(([h,v])=>{var V,M,U,L,$;const P=`${(V=v.responsesAcknowledged)!=null?V:0} / ${(M=v.responsesSent)!=null?M:0}`;return{type:h.toUpperCase(),ratio:P,responsesSent:(U=v.responsesSent)!=null?U:0,responsesAcknowledged:(L=v.responsesAcknowledged)!=null?L:0,responsesRejected:($=v.responsesRejected)!=null?$:0}});return{subscription:d,formattedConnectDate:m,formattedDisconnectDate:o,statuses:s}})}),g=O(()=>{const{status:l}=te(a.dataPlaneOverview.dataplane,a.dataPlaneOverview.dataplaneInsight);return ge[i[l]]}),D=O(()=>{const l=De(a.dataPlaneOverview.dataplaneInsight);return l!==null?Object.entries(l).map(([d,m])=>({name:d,version:m})):[]}),_=O(()=>{const{subscriptions:l}=a.dataPlaneOverview.dataplaneInsight;if(l.length===0)return[];const d=[],m=l[l.length-1],o=m.version.envoy,s=m.version.kumaDp,h=o.kumaDpCompatible!==void 0?o.kumaDpCompatible:!0,v=s.kumaCpCompatible!==void 0?s.kumaCpCompatible:!0;if(!h){const P=`Envoy ${o.version} is not supported by Kuma DP ${s.version}.`;d.push(P)}if(!v){const P=`Kuma DP ${s.version} is not supported by this Kuma control plane.`;d.push(P)}return d});return(l,d)=>{const m=T("router-link");return r(),p("div",Ye,[t("section",null,[t("h3",Ge,[Qe,A(m,{to:{name:"data-plane-detail-view",params:{mesh:e.dataPlaneOverview.mesh,dataPlane:e.dataPlaneOverview.name}}},{default:K(()=>[R(f(e.dataPlaneOverview.name),1)]),_:1},8,["to"]),t("div",{class:be(`status status--${b(g).appearance}`),"data-testid":"data-plane-status-badge"},f(b(g).title.toLowerCase()),3)]),t("div",Ze,[We,t("span",null,f(e.dataPlaneOverview.mesh),1)])]),b(n).length>0?(r(),p("section",Xe,[Je,t("div",et,[(r(!0),p(w,null,C(b(n),(o,s)=>(r(),N(He,{key:s,tag:o},null,8,["tag"]))),128))])])):I("",!0),b(D).length>0?(r(),p("section",tt,[at,(r(!0),p(w,null,C(b(D),(o,s)=>(r(),p("div",{key:s,class:"definition"},[t("span",null,f(o.name)+":",1),t("span",null,f(o.version),1)]))),128)),b(_).length>0?(r(),p(w,{key:0},[t("h5",st,[nt,A(b(we),{class:"ml-1",icon:"warning",color:"var(--black-75)","secondary-color":"var(--yellow-300)",size:"20"})]),(r(!0),p(w,null,C(b(_),(o,s)=>(r(),p("p",{key:s},f(o),1))),128))],64)):I("",!0)])):I("",!0),b(c).length>0?(r(),p(w,{key:2},[t("section",null,[it,t("div",ot,[(r(!0),p(w,null,C(b(c),(o,s)=>(r(),p("div",{key:s},[t("div",{class:"definition","data-testid":`data-plane-connect-time-${s}`},[rt,t("span",null,f(o.formattedConnectDate),1)],8,lt),t("div",{class:"definition","data-testid":`data-plane-disconnect-time-${s}`},[ct,t("span",null,f(o.formattedDisconnectDate),1)],8,dt),t("div",pt,[ut,t("span",null,f(o.subscription.controlPlaneInstanceId),1)]),o.statuses.length>0?(r(),p("details",mt,[ht,(r(!0),p(w,null,C(o.statuses,(h,v)=>(r(),p("div",{key:`${s}-${v}`,class:"definition","data-testid":`data-plane-subscription-status-${s}-${v}`},[t("span",null,f(h.type)+":",1),t("span",null,f(h.ratio),1)],8,yt))),128))])):I("",!0)]))),128))])]),t("section",null,[A(ze,{content:b(u)},null,8,["content"])])],64)):I("",!0)])}}});const _t=ne(vt,[["__scopeId","data-v-5236dda8"]]);const ft={name:"DataPlaneListView",dataPlaneTypes:["All","Standard","Gateway (builtin)","Gateway (provided)"],emptyStateMsg:"There are no data plane proxies present.",nsBackButtonRoute:{name:"data-plane-list-view"},dataplaneApiParams:{},components:{DataOverview:Be,DataPlaneEntitySummary:_t,KButton:ke,KDropdownItem:Pe,KDropdownMenu:Te,EmptyBlock:xe},props:{name:{type:String,required:!1,default:null},offset:{type:Number,required:!1,default:0}},data(){return{visibleTableHeaderKeys:oe,productName:Ce,isLoading:!0,isEmpty:!1,hasError:!1,tableDataIsEmpty:!1,tableData:{headers:[],data:[]},pageSize:50,next:null,shownTLSTab:!1,rawData:null,filteredDataPlaneType:"All",pageOffset:this.offset,dataPlaneOverview:null}},computed:{...Ee({environment:"config/getEnvironment",queryNamespace:"getItemQueryNamespace",multicluster:"config/getMulticlusterStatus"}),dataplaneWizardRoute(){return this.environment==="universal"?{name:"universal-dataplane"}:{name:"kubernetes-dataplane"}},filteredTableData(){const e=this.tableData.data.filter(i=>this.filteredDataPlaneType==="All"?!0:i.type.toLowerCase()===this.filteredDataPlaneType.toLowerCase()),a=Fe(this.multicluster,this.visibleTableHeaderKeys);return{data:e,headers:a}},columnsDropdownItems(){return qe.filter(e=>this.multicluster?!0:e.tableHeaderKey!=="zone").map(e=>{const a=this.visibleTableHeaderKeys.includes(e.tableHeaderKey);return{...e,isChecked:a}})}},watch:{"$route.params.mesh":function(){this.$route.name==="data-plane-list-view"&&(this.isLoading=!0,this.isEmpty=!1,this.hasError=!1,this.tableDataIsEmpty=!1,this.loadData(0))}},created(){const e=X.get("dpVisibleTableHeaderKeys");Array.isArray(e)&&(this.visibleTableHeaderKeys=e)},beforeMount(){this.loadData(this.offset)},methods:{stopPropagatingClickEvent(e){e.stopPropagation()},updateVisibleTableHeaders(e,a){const i=e.target,u=this.visibleTableHeaderKeys.findIndex(n=>n===a);i.checked&&u===-1?this.visibleTableHeaderKeys.push(a):!i.checked&&u>-1&&this.visibleTableHeaderKeys.splice(u,1),X.set("dpVisibleTableHeaderKeys",Array.from(new Set(this.visibleTableHeaderKeys)))},onCreateClick(){Oe.logger.info(Se.CREATE_DATA_PLANE_PROXY_CLICKED)},getEmptyState(){return{title:"No Data",message:this.$options.emptyStateMsg}},async parseData(e){var Y,G,Q;const{dataplane:a={},dataplaneInsight:i={}}=e,{name:u="",mesh:n=""}=e,{subscriptions:c=[]}=i,g={name:"data-plane-detail-view",params:{mesh:n,dataPlane:u}},D={name:"mesh-child",params:{mesh:n}},_=["kuma.io/protocol","kuma.io/service","kuma.io/zone"],l=ee(a).filter(y=>_.includes(y.label)),d=(Y=l.find(y=>y.label==="kuma.io/service"))==null?void 0:Y.value,m=(G=l.find(y=>y.label==="kuma.io/protocol"))==null?void 0:G.value,o=(Q=l.find(y=>y.label==="kuma.io/zone"))==null?void 0:Q.value;let s;d!==void 0&&(s={name:"service-insight-detail-view",params:{mesh:n,service:d}});const{status:h}=te(a,i),{totalUpdates:v,totalRejectedUpdates:P,dpVersion:V,envoyVersion:M,selectedTime:U,selectedUpdateTime:L,version:$}=c.reduce((y,le)=>{const{status:re={},connectTime:de,version:Z={}}=le,{total:ce={},lastUpdateTime:pe}=re,{responsesSent:ue="0",responsesRejected:me="0"}=ce,{kumaDp:he={},envoy:ye={}}=Z,{version:ve}=he,{version:_e}=ye;let{selectedTime:B,selectedUpdateTime:H}=y;const x=Date.parse(de),j=Date.parse(pe);return x&&(!B||x>B)&&(B=x),j&&(!H||j>H)&&(H=j),{totalUpdates:y.totalUpdates+parseInt(ue,10),totalRejectedUpdates:y.totalRejectedUpdates+parseInt(me,10),dpVersion:ve||y.dpVersion,envoyVersion:_e||y.envoyVersion,selectedTime:B,selectedUpdateTime:H,version:Z||y.version}},{totalUpdates:0,totalRejectedUpdates:0,dpVersion:"\u2014",envoyVersion:"\u2014",selectedTime:NaN,selectedUpdateTime:NaN,version:{}}),E={name:u,nameRoute:g,mesh:n,meshRoute:D,zone:o!=null?o:"\u2014",service:d!=null?d:"\u2014",serviceInsightRoute:s,protocol:m!=null?m:"\u2014",status:h,totalUpdates:v,totalRejectedUpdates:P,dpVersion:V,envoyVersion:M,warnings:[],unsupportedEnvoyVersion:!1,unsupportedKumaDPVersion:!1,kumaDpAndKumaCpMismatch:!1,lastUpdated:L?J(new Date(L).toUTCString()):"\u2014",lastConnected:U?J(new Date(U).toUTCString()):"\u2014",type:Ke(a)},{kind:z}=Ie($);switch(z!==Ae&&E.warnings.push(z),z){case Ue:E.unsupportedEnvoyVersion=!0;break;case Ve:E.unsupportedKumaDPVersion=!0;break}if(this.multicluster){const{compatible:y}=await Le(l,V);y||(E.warnings.push(Ne),E.kumaDpAndKumaCpMismatch=!0)}return E},async loadData(e){var u;this.isLoading=!0,this.pageOffset=e,q("offset",e>0?e:null);const a=this.$route.params.mesh||null,i=this.$route.query.ns||null;try{const{data:n,next:c}=await $e({getSingleEntity:S.getDataplaneOverviewFromMesh.bind(S),getAllEntities:S.getAllDataplaneOverviews.bind(S),getAllEntitiesFromMesh:S.getAllDataplaneOverviewsFromMesh.bind(S),size:this.pageSize,offset:e,mesh:a,query:i,params:{...this.$options.dataplaneApiParams}});if(n.length>0){this.next=c,this.rawData=n,this.selectDataPlaneOverview((u=this.name)!=null?u:n[0].name);const g=await Promise.all(n.map(D=>this.parseData(D)));this.tableData.data=g,this.tableDataIsEmpty=!1,this.isEmpty=!1}else this.selectDataPlaneOverview(null),this.tableData.data=[],this.tableDataIsEmpty=!0,this.isEmpty=!0}catch(n){this.hasError=!0,this.isEmpty=!0,console.error(n)}finally{this.isLoading=!1}},async selectDataPlaneOverview(e){var a;e?(this.dataPlaneOverview=(a=this.rawData.find(i=>i.name===e))!=null?a:this.rawData[0],q("name",this.dataPlaneOverview.name)):(this.dataPlaneOverview=null,q("name",null))}}},F=e=>(ae("data-v-da684f81"),e=e(),se(),e),bt={class:"data-planes-container"},gt={class:"data-planes-content component-frame"},Dt=F(()=>t("label",{for:"data-planes-type-filter",class:"mr-2"}," Type: ",-1)),wt=["value"],kt=["for"],Pt=["id","checked","onChange"],Tt=F(()=>t("span",{class:"custom-control-icon"}," + ",-1)),Ct=R(" Create data plane proxy "),Et=F(()=>t("span",{class:"custom-control-icon"}," \u2190 ",-1)),Ot=R(" View All "),St={class:"data-planes-sidebar component-frame"};function Kt(e,a,i,u,n,c){var o;const g=T("KDropdownItem"),D=T("KDropdownMenu"),_=T("KButton"),l=T("DataOverview"),d=T("DataPlaneEntitySummary"),m=T("EmptyBlock");return r(),p("div",bt,[t("div",gt,[A(l,{"selected-entity-name":(o=n.dataPlaneOverview)==null?void 0:o.name,"page-size":n.pageSize,"has-error":n.hasError,"is-loading":n.isLoading,"empty-state":c.getEmptyState(),"table-data":c.filteredTableData,"table-data-is-empty":n.tableDataIsEmpty,"show-details":"",next:n.next,"page-offset":n.pageOffset,onTableAction:a[2]||(a[2]=s=>c.selectDataPlaneOverview(s.name)),onLoadData:a[3]||(a[3]=s=>c.loadData(s))},{additionalControls:K(()=>[t("div",null,[Dt,Re(t("select",{id:"data-planes-type-filter","onUpdate:modelValue":a[0]||(a[0]=s=>n.filteredDataPlaneType=s),"data-testid":"data-planes-type-filter"},[(r(!0),p(w,null,C(e.$options.dataPlaneTypes,(s,h)=>(r(),p("option",{key:h,value:s},f(s),9,wt))),128))],512),[[Me,n.filteredDataPlaneType]])]),A(D,{label:"Columns",icon:"cogwheel","button-appearance":"outline"},{items:K(()=>[t("div",{onClick:a[1]||(a[1]=(...s)=>c.stopPropagatingClickEvent&&c.stopPropagatingClickEvent(...s))},[(r(!0),p(w,null,C(c.columnsDropdownItems,(s,h)=>(r(),N(g,{key:h,class:"table-header-selector-item",item:s},{default:K(()=>[t("label",{for:`data-plane-table-header-checkbox-${h}`,class:"k-checkbox table-header-selector-item-checkbox"},[t("input",{id:`data-plane-table-header-checkbox-${h}`,checked:s.isChecked,type:"checkbox",class:"k-input",onChange:v=>c.updateVisibleTableHeaders(v,s.tableHeaderKey)},null,40,Pt),R(" "+f(s.label),1)],8,kt)]),_:2},1032,["item"]))),128))])]),_:1}),A(_,{class:"add-dp-button",appearance:"primary",to:c.dataplaneWizardRoute,"data-testid":"data-plane-create-data-plane-button",onClick:c.onCreateClick},{default:K(()=>[Tt,Ct]),_:1},8,["to","onClick"]),e.$route.query.ns?(r(),N(_,{key:0,appearance:"primary",to:e.$options.nsBackButtonRoute,"data-testid":"data-plane-ns-back-button"},{default:K(()=>[Et,Ot]),_:1},8,["to"])):I("",!0)]),_:1},8,["selected-entity-name","page-size","has-error","is-loading","empty-state","table-data","table-data-is-empty","next","page-offset"])]),t("div",St,[n.dataPlaneOverview!==null?(r(),N(d,{key:0,"data-plane-overview":n.dataPlaneOverview},null,8,["data-plane-overview"])):(r(),N(m,{key:1}))])])}const Ht=ne(ft,[["render",Kt],["__scopeId","data-v-da684f81"]]);export{Ht as default};
