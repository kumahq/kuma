import{d as S,r as E,o as t,g as _,w as i,j as a,F as p,D as B,m as C,h as y,l,C as v,i as I,ad as H,q as K,k as x,f as F,E as D,s as G}from"./index-77212499.js";import{A as M,a as W}from"./AccordionList-64a7926a.js";import{_ as Y}from"./CodeBlock.vue_vue_type_style_index_0_lang-336f6480.js";import{P as z}from"./PolicyTypeTag-17c7418f.js";import{T as N}from"./TagList-c3a1fa30.js";import{t as w}from"./toYaml-4e00099e.js";const J={class:"policy-type-heading"},Q={class:"policy-list"},U={key:0},X=S({__name:"PolicyTypeEntryList",props:{id:{type:String,required:!1,default:"entry-list"},policyTypeEntries:{type:Object,required:!0}},setup(P){const f=P,A=[{label:"From",key:"sourceTags"},{label:"To",key:"destinationTags"},{label:"On",key:"name"},{label:"Conf",key:"config"},{label:"Origin policies",key:"origins"}];function T({headerKey:h}){return{class:`cell-${h}`}}return(h,R)=>{const $=E("router-link");return t(),_(W,{"initially-open":[],"multiple-open":""},{default:i(()=>[(t(!0),a(p,null,B(f.policyTypeEntries,(u,n)=>(t(),_(M,{key:n},{"accordion-header":i(()=>[C("h3",J,[y(z,{"policy-type":u.type},{default:i(()=>[l(v(u.type)+" ("+v(u.connections.length)+`)
          `,1)]),_:2},1032,["policy-type"])])]),"accordion-content":i(()=>[C("div",Q,[y(I(H),{class:"policy-type-table",fetcher:()=>({data:u.connections,total:u.connections.length}),headers:A,"cell-attrs":T,"disable-pagination":"","is-clickable":""},{sourceTags:i(({rowValue:e})=>[e.length>0?(t(),_(N,{key:0,class:"tag-list",tags:e},null,8,["tags"])):(t(),a(p,{key:1},[l(`
                —
              `)],64))]),destinationTags:i(({rowValue:e})=>[e.length>0?(t(),_(N,{key:0,class:"tag-list",tags:e},null,8,["tags"])):(t(),a(p,{key:1},[l(`
                —
              `)],64))]),name:i(({rowValue:e})=>[e!==null?(t(),a(p,{key:0},[l(v(e),1)],64)):(t(),a(p,{key:1},[l(`
                —
              `)],64))]),origins:i(({rowValue:e})=>[e.length>0?(t(),a("ul",U,[(t(!0),a(p,null,B(e,(o,s)=>(t(),a("li",{key:`${n}-${s}`},[y($,{to:o.route},{default:i(()=>[l(v(o.name),1)]),_:2},1032,["to"])]))),128))])):(t(),a(p,{key:1},[l(`
                —
              `)],64))]),config:i(({rowValue:e,rowKey:o})=>[e!==null?(t(),_(Y,{key:0,id:`${f.id}-${n}-${o}-code-block`,code:e,language:"yaml","show-copy-button":!1},null,8,["id","code"])):(t(),a(p,{key:1},[l(`
                —
              `)],64))]),_:2},1032,["fetcher"])])]),_:2},1024))),128))]),_:1})}}});const Z=K(X,[["__scopeId","data-v-9a1971d5"]]),V={class:"policy-type-heading"},ee={class:"policy-list"},te={key:1,class:"tag-list-wrapper"},se={key:0},ne={key:1},oe={key:0},ae={key:0},ie=S({__name:"RuleEntryList",props:{id:{type:String,required:!1,default:"entry-list"},ruleEntries:{type:Object,required:!0}},setup(P){const f=P,A=[{label:"Type",key:"type"},{label:"Addresses",key:"addresses"},{label:"Conf",key:"config"},{label:"Origin policies",key:"origins"}];function T({headerKey:h}){return{class:`cell-${h}`}}return(h,R)=>{const $=E("router-link");return t(),_(W,{"initially-open":[],"multiple-open":""},{default:i(()=>[(t(!0),a(p,null,B(f.ruleEntries,(u,n)=>(t(),_(M,{key:n},{"accordion-header":i(()=>[C("h3",V,[y(z,{"policy-type":u.type},{default:i(()=>[l(v(u.type)+" ("+v(u.connections.length)+`)
          `,1)]),_:2},1032,["policy-type"])])]),"accordion-content":i(()=>[C("div",ee,[y(I(H),{class:"policy-type-table",fetcher:()=>({data:u.connections,total:u.connections.length}),headers:A,"cell-attrs":T,"disable-pagination":"","is-clickable":""},{type:i(({rowValue:e})=>[e.sourceTags.length===0&&e.destinationTags.length===0?(t(),a(p,{key:0},[l(`
                —
              `)],64)):(t(),a("div",te,[e.sourceTags.length>0?(t(),a("div",se,[l(`
                  From

                  `),y(N,{class:"tag-list",tags:e.sourceTags},null,8,["tags"])])):x("",!0),l(),e.destinationTags.length>0?(t(),a("div",ne,[l(`
                  To

                  `),y(N,{class:"tag-list",tags:e.destinationTags},null,8,["tags"])])):x("",!0)]))]),addresses:i(({rowValue:e})=>[e.length>0?(t(),a("ul",oe,[(t(!0),a(p,null,B(e,(o,s)=>(t(),a("li",{key:`${n}-${s}`},v(o),1))),128))])):(t(),a(p,{key:1},[l(`
                —
              `)],64))]),origins:i(({rowValue:e})=>[e.length>0?(t(),a("ul",ae,[(t(!0),a(p,null,B(e,(o,s)=>(t(),a("li",{key:`${n}-${s}`},[y($,{to:o.route},{default:i(()=>[l(v(o.name),1)]),_:2},1032,["to"])]))),128))])):(t(),a(p,{key:1},[l(`
                —
              `)],64))]),config:i(({rowValue:e,rowKey:o})=>[e!==null?(t(),_(Y,{key:0,id:`${f.id}-${n}-${o}-code-block`,code:e,language:"yaml","show-copy-button":!1},null,8,["id","code"])):(t(),a(p,{key:1},[l(`
                —
              `)],64))]),_:2},1032,["fetcher"])])]),_:2},1024))),128))]),_:1})}}});const le=K(ie,[["__scopeId","data-v-3e59037c"]]),ce=C("h2",{class:"visually-hidden"},`
    Policies
  `,-1),re={key:0,class:"mt-2"},pe=C("h2",{class:"mb-2"},`
      Rules
    `,-1),ye=S({__name:"SidecarDataplanePolicyList",props:{sidecarDataplanes:{},rules:{},policyTypesByName:{}},setup(P){const f=P,A=F(()=>h(f.sidecarDataplanes)),T=F(()=>$(f.rules));function h(n){const e=new Map;for(const s of n){const{type:r,service:d}=s,m=typeof d=="string"&&d!==""?[{label:"kuma.io/service",value:d}]:[],g=r==="inbound"||r==="outbound"?s.name:null;for(const[c,k]of Object.entries(s.matchedPolicies)){e.has(c)||e.set(c,{type:c,connections:[]});const L=e.get(c),O=f.policyTypesByName[c];for(const q of k){const b=R(q,O,s,m,g);L.connections.push(...b)}}}const o=Array.from(e.values());return o.sort((s,r)=>s.type.localeCompare(r.type)),o}function R(n,e,o,s,r){const d=n.conf&&Object.keys(n.conf).length>0?w(n.conf):null,g=[{name:n.name,route:{name:"policy-detail-view",params:{mesh:n.mesh,policyPath:e.path,policy:n.name}}}],c=[];if(o.type==="inbound"&&Array.isArray(n.sources))for(const{match:k}of n.sources){const O={sourceTags:[{label:"kuma.io/service",value:k["kuma.io/service"]}],destinationTags:s,name:r,config:d,origins:g};c.push(O)}else{const L={sourceTags:[],destinationTags:s,name:r,config:d,origins:g};c.push(L)}return c}function $(n){const e=new Map;for(const s of n){e.has(s.policyType)||e.set(s.policyType,{type:s.policyType,connections:[]});const r=e.get(s.policyType),d=f.policyTypesByName[s.policyType],m=u(s,d);r.connections.push(...m)}const o=Array.from(e.values());return o.sort((s,r)=>s.type.localeCompare(r.type)),o}function u(n,e){const{type:o,service:s,subset:r,conf:d}=n,m=r?Object.entries(r):[];let g,c;o==="ClientSubset"?m.length>0?g=m.map(([b,j])=>({label:b,value:j})):g=[{label:"kuma.io/service",value:"*"}]:g=[],o==="DestinationSubset"?m.length>0?c=m.map(([b,j])=>({label:b,value:j})):typeof s=="string"&&s!==""?c=[{label:"kuma.io/service",value:s}]:c=[{label:"kuma.io/service",value:"*"}]:o==="ClientSubset"&&typeof s=="string"&&s!==""?c=[{label:"kuma.io/service",value:s}]:c=[];const k=n.addresses??[],L=d&&Object.keys(d).length>0?w(d):null,O=[];for(const b of n.origins)O.push({name:b.name,route:{name:"policy-detail-view",params:{mesh:b.mesh,policyPath:e.path,policy:b.name}}});return[{type:{sourceTags:g,destinationTags:c},addresses:k,config:L,origins:O}]}return(n,e)=>(t(),a(p,null,[ce,l(),y(Z,{id:"policies","policy-type-entries":A.value,"data-testid":"policy-list"},null,8,["policy-type-entries"]),l(),T.value.length>0?(t(),a("div",re,[pe,l(),y(le,{id:"rules","rule-entries":T.value,"data-testid":"rule-list"},null,8,["rule-entries"])])):x("",!0)],64))}}),he=S({__name:"DataPlanePoliciesView",setup(P){return(f,A)=>{const T=E("RouteTitle"),h=E("DataSource"),R=E("KCard"),$=E("AppView"),u=E("RouteView");return t(),_(u,{name:"data-plane-policies-view",params:{mesh:"",dataPlane:""}},{default:i(({route:n,t:e})=>[y($,null,{title:i(()=>[C("h2",null,[y(T,{title:e("data-planes.routes.item.navigation.data-plane-policies-view"),render:!0},null,8,["title"])])]),default:i(()=>[l(),y(R,null,{body:i(()=>[y(h,{src:"/*/policy-types"},{default:i(({data:o,error:s})=>[y(h,{src:`/meshes/${n.params.mesh}/dataplanes/${n.params.dataPlane}/sidecar-dataplanes-policies`},{default:i(({data:r,error:d})=>[y(h,{src:`/meshes/${n.params.mesh}/dataplanes/${n.params.dataPlane}/rules`},{default:i(({data:m,error:g})=>[s?(t(),_(D,{key:0,error:s},null,8,["error"])):d?(t(),_(D,{key:1,error:d},null,8,["error"])):g?(t(),_(D,{key:2,error:g},null,8,["error"])):o===void 0||r===void 0||m===void 0?(t(),_(G,{key:3})):(t(),_(ye,{key:4,"policy-types-by-name":o.policies.reduce((c,k)=>Object.assign(c,{[k.name]:k}),{}),"sidecar-dataplanes":r.items,rules:m.items},null,8,["policy-types-by-name","sidecar-dataplanes","rules"]))]),_:2},1032,["src"])]),_:2},1032,["src"])]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:1})}}});export{he as default};
