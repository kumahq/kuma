var le=Object.defineProperty;var re=(s,i,a)=>i in s?le(s,i,{enumerable:!0,configurable:!0,writable:!0,value:a}):s[i]=a;var q=(s,i,a)=>(re(s,typeof i!="symbol"?i+"":i,a),a);import{e as ue,h as ce,S as de,k as M,K as pe,j as me,f as oe,p as fe}from"./RouteView.vue_vue_type_script_setup_true_lang-07b4cab0.js";import{d as ne,c as z,r as ge,o as m,a as E,w as y,B as se,h as w,g as p,t as k,e as _,F as R,b as c,C as ve,R as ye,D as he,m as $,n as be,K as _e,z as D,A as ee,k as S,G as ke,H as Te,I as te,q as Se,f as J,J as we,L as Ce,v as Ae,x as De}from"./index-5cc1bd9e.js";import{_ as xe}from"./WarningIcon.vue_vue_type_script_setup_true_lang-bebc6d7a.js";import{d as Ie,g as Ne,c as Ue,C as Le,b as Ee}from"./dataplane-e7ae9fed.js";import{n as ze}from"./notEmpty-7f452b20.js";const Re=ne({__name:"DataPlaneList",props:{total:{default:0},pageNumber:{},pageSize:{},items:{},error:{},gateways:{type:Boolean,default:!1}},emits:["load-data","change"],setup(s,{emit:i}){const a=s,h=ue(),{t:o,formatIsoDate:u}=ce(),d=z(()=>h.getters["config/getMulticlusterStatus"]);function b(f){return f.map(r=>{var j,N,A,K,t,l;const T=r.mesh,n=r.name,C=((j=r.dataplane.networking.gateway)==null?void 0:j.type)||"STANDARD",O={name:C==="STANDARD"?"data-plane-detail-view":"gateway-detail-view",params:{mesh:T,dataPlane:n}},V=["kuma.io/protocol","kuma.io/service","kuma.io/zone"],x=Ie(r.dataplane).filter(e=>V.includes(e.label)),U=(N=x.find(e=>e.label==="kuma.io/service"))==null?void 0:N.value,Q=(A=x.find(e=>e.label==="kuma.io/protocol"))==null?void 0:A.value,I=(K=x.find(e=>e.label==="kuma.io/zone"))==null?void 0:K.value;let F;U!==void 0&&(F={name:"service-detail-view",params:{mesh:T,service:U}});let P;I!==void 0&&(P={name:"zone-cp-detail-view",params:{zone:I}});const{status:B}=Ne(r.dataplane,r.dataplaneInsight),H=((t=r.dataplaneInsight)==null?void 0:t.subscriptions)??[],Z={totalUpdates:0,totalRejectedUpdates:0,dpVersion:null,envoyVersion:null,selectedTime:NaN,selectedUpdateTime:NaN,version:null},g=H.reduce((e,v)=>{var W,X;if(v.connectTime){const Y=Date.parse(v.connectTime);(!e.selectedTime||Y>e.selectedTime)&&(e.selectedTime=Y)}const G=Date.parse(v.status.lastUpdateTime);return G&&(!e.selectedUpdateTime||G>e.selectedUpdateTime)&&(e.selectedUpdateTime=G),{totalUpdates:e.totalUpdates+parseInt(v.status.total.responsesSent??"0",10),totalRejectedUpdates:e.totalRejectedUpdates+parseInt(v.status.total.responsesRejected??"0",10),dpVersion:((W=v.version)==null?void 0:W.kumaDp.version)||e.dpVersion,envoyVersion:((X=v.version)==null?void 0:X.envoy.version)||e.envoyVersion,selectedTime:e.selectedTime,selectedUpdateTime:e.selectedUpdateTime,version:v.version||e.version}},Z),L={name:n,detailViewRoute:O,type:C,zone:{title:I??o("common.collection.none"),route:P},service:{title:U??o("common.collection.none"),route:F},protocol:Q??o("common.collection.none"),status:B,totalUpdates:g.totalUpdates,totalRejectedUpdates:g.totalRejectedUpdates,envoyVersion:g.envoyVersion??o("common.collection.none"),warnings:[],lastUpdated:g.selectedUpdateTime?u(new Date(g.selectedUpdateTime).toUTCString()):o("common.collection.none"),lastConnected:g.selectedTime?u(new Date(g.selectedTime).toUTCString()):o("common.collection.none"),overview:r};if(g.version){const{kind:e}=Ue(g.version);e!==Le&&L.warnings.push(e)}return d.value&&g.dpVersion&&x.find(v=>v.label===_e)&&typeof((l=g.version)==null?void 0:l.kumaDp.kumaCpCompatible)=="boolean"&&!g.version.kumaDp.kumaCpCompatible&&L.warnings.push(Ee),L})}return(f,r)=>{const T=ge("RouterLink");return m(),E(me,{"empty-state-message":c(o)("common.emptyState.message",{type:a.gateways?"Gateways":"Data Plane Proxies"}),"empty-state-cta-to":c(o)(`data-planes.href.docs.${a.gateways?"gateway":"data_plane_proxy"}`),"empty-state-cta-text":c(o)("common.documentation"),headers:[{label:"Name",key:"name"},a.gateways?{label:"Type",key:"type"}:void 0,{label:"Service",key:"service"},a.gateways?void 0:{label:"Protocol",key:"protocol"},d.value?{label:"Zone",key:"zone"}:void 0,{label:"Last Updated",key:"lastUpdated"},{label:"Status",key:"status"},{label:"Warnings",key:"warnings",hideLabel:!0},{label:"Actions",key:"actions",hideLabel:!0}].filter(c(ze)),"page-number":a.pageNumber,"page-size":a.pageSize,total:a.total,items:a.items?b(a.items):void 0,error:a.error,onChange:r[0]||(r[0]=n=>i("change",n))},{toolbar:y(()=>[se(f.$slots,"toolbar",{},void 0,!0)]),name:y(({row:n})=>[w(T,{to:{name:a.gateways?"gateway-detail-view":"data-plane-detail-view",params:{dataPlane:n.name}},"data-testid":"detail-view-link"},{default:y(()=>[p(k(n.name),1)]),_:2},1032,["to"])]),service:y(({rowValue:n})=>[n.route?(m(),E(T,{key:0,to:n.route},{default:y(()=>[p(k(n.title),1)]),_:2},1032,["to"])):(m(),_(R,{key:1},[p(k(n.title),1)],64))]),zone:y(({rowValue:n})=>[n.route?(m(),E(T,{key:0,to:n.route},{default:y(()=>[p(k(n.title),1)]),_:2},1032,["to"])):(m(),_(R,{key:1},[p(k(n.title),1)],64))]),status:y(({rowValue:n})=>[n?(m(),E(de,{key:0,status:n},null,8,["status"])):(m(),_(R,{key:1},[p(k(c(o)("common.collection.none")),1)],64))]),warnings:y(({rowValue:n})=>[n.length>0?(m(),E(c(ve),{key:0,label:c(o)("data-planes.list.version_mismatch")},{default:y(()=>[w(xe,{class:"mr-1",size:c(M),"hide-title":""},null,8,["size"])]),_:1},8,["label"])):(m(),_(R,{key:1},[p(`
         
      `)],64))]),actions:y(({row:n})=>[w(c(ye),{class:"actions-dropdown","kpop-attributes":{placement:"bottomEnd",popoverClasses:"mt-5 more-actions-popover"},width:"150"},{default:y(()=>[w(c(he),{class:"non-visual-button",appearance:"secondary",size:"small"},{icon:y(()=>[w(c($),{color:c(pe),icon:"more",size:c(M)},null,8,["color","size"])]),_:1})]),items:y(()=>[w(c(be),{item:{to:{name:a.gateways?"gateway-detail-view":"data-plane-detail-view",params:{dataPlane:n.name}},label:c(o)("common.collection.actions.view")}},null,8,["item"])]),_:2},1024)]),_:3},8,["empty-state-message","empty-state-cta-to","empty-state-cta-text","headers","page-number","page-size","total","items","error"])}}});const lt=oe(Re,[["__scopeId","data-v-8b455410"]]);function Me(s,i,a){return Math.max(i,Math.min(s,a))}const Fe=["ControlLeft","ControlRight","ShiftLeft","ShiftRight","AltLeft"];class Pe{constructor(i,a){q(this,"commands");q(this,"keyMap");q(this,"boundTriggerShortcuts");this.commands=a,this.keyMap=Object.fromEntries(Object.entries(i).map(([h,o])=>[h.toLowerCase(),o])),this.boundTriggerShortcuts=this.triggerShortcuts.bind(this)}registerListener(){document.addEventListener("keydown",this.boundTriggerShortcuts)}unRegisterListener(){document.removeEventListener("keydown",this.boundTriggerShortcuts)}triggerShortcuts(i){Be(i,this.keyMap,this.commands)}}function Be(s,i,a){const h=je(s.code),o=[s.ctrlKey?"ctrl":"",s.shiftKey?"shift":"",s.altKey?"alt":"",h].filter(b=>b!=="").join("+"),u=i[o];if(!u)return;const d=a[u];d.isAllowedContext&&!d.isAllowedContext(s)||(d.shouldPreventDefaultAction&&s.preventDefault(),!(d.isDisabled&&d.isDisabled())&&d.trigger(s))}function je(s){return Fe.includes(s)?"":s.replace(/^Key/,"").toLowerCase()}function Ke(s,i){const a=" "+s,h=a.matchAll(/ ([-\s\w]+):\s*/g),o=[];for(const u of Array.from(h)){if(u.index===void 0)continue;const d=qe(u[1]);if(i.length>0&&!i.includes(d))throw new Error(`Unknown field “${d}”. Known fields: ${i.join(", ")}`);const b=u.index+u[0].length,f=a.substring(b);let r;if(/^\s*["']/.test(f)){const n=f.match(/['"](.*?)['"]/);if(n!==null)r=n[1];else throw new Error(`Quote mismatch for field “${d}”.`)}else{const n=f.indexOf(" "),C=n===-1?f.length:n;r=f.substring(0,C)}r!==""&&o.push([d,r])}return o}function qe(s){return s.trim().replace(/\s+/g,"-").replace(/-[a-z]/g,(i,a)=>a===0?i:i.substring(1).toUpperCase())}let ae=0;const $e=(s="unique")=>(ae++,`${s}-${ae}`),ie=s=>(Ae("data-v-91b196c9"),s=s(),De(),s),Oe=ie(()=>S("span",{class:"visually-hidden"},"Focus filter",-1)),Ve=["for"],Qe=["id","placeholder"],He={key:0,class:"k-suggestion-box","data-testid":"k-filter-bar-suggestion-box"},Ze={class:"k-suggestion-list"},Ge={key:0,class:"k-filter-bar-error"},Je={key:0},We=["title","data-filter-field"],Xe={class:"visually-hidden"},Ye=ie(()=>S("span",{class:"visually-hidden"},"Clear query",-1)),et=ne({__name:"KFilterBar",props:{id:{type:String,required:!1,default:()=>$e("k-filter-bar")},fields:{type:Object,required:!0},placeholder:{type:String,required:!1,default:null},query:{type:String,required:!1,default:""}},emits:["fields-change"],setup(s,{emit:i}){const a=s,h=D(null),o=D(null),u=D(a.query),d=D([]),b=D(null),f=D(!1),r=D(-1),T=z(()=>Object.keys(a.fields)),n=z(()=>Object.entries(a.fields).slice(0,5).map(([t,l])=>({fieldName:t,...l}))),C=z(()=>T.value.length>0?`Filter by ${T.value.join(", ")}`:"Filter"),O=z(()=>a.placeholder??C.value);ee(()=>d.value,function(t,l){K(t,l)||(b.value=null,i("fields-change",{fields:t,query:u.value}))}),ee(()=>u.value,function(){u.value===""&&(b.value=null),f.value=!0});const V={Enter:"submitQuery",Escape:"closeSuggestionBox",ArrowDown:"jumpToNextSuggestion",ArrowUp:"jumpToPreviousSuggestion"},x={submitQuery:{trigger:I,isAllowedContext(t){return o.value!==null&&t.composedPath().includes(o.value)},shouldPreventDefaultAction:!0},jumpToNextSuggestion:{trigger:F,isAllowedContext(t){return o.value!==null&&t.composedPath().includes(o.value)},shouldPreventDefaultAction:!0},jumpToPreviousSuggestion:{trigger:P,isAllowedContext(t){return o.value!==null&&t.composedPath().includes(o.value)},shouldPreventDefaultAction:!0},closeSuggestionBox:{trigger:N,isAllowedContext(t){return h.value!==null&&t.composedPath().includes(h.value)}}};function U(){const t=new Pe(V,x);we(function(){t.registerListener()}),Ce(function(){t.unRegisterListener()}),A(u.value)}U();function Q(t){const l=t.target;A(l.value)}function I(){if(o.value instanceof HTMLInputElement)if(r.value===-1)A(o.value.value),f.value=!1;else{const t=n.value[r.value].fieldName;t&&g(o.value,t)}}function F(){B(1)}function P(){B(-1)}function B(t){r.value=Me(r.value+t,-1,n.value.length-1)}function H(){o.value instanceof HTMLInputElement&&o.value.focus()}function Z(t){const e=t.currentTarget.getAttribute("data-filter-field");e&&o.value instanceof HTMLInputElement&&g(o.value,e)}function g(t,l){const e=u.value===""||u.value.endsWith(" ")?"":" ";u.value+=e+l+":",t.focus(),r.value=-1}function L(){u.value="",o.value instanceof HTMLInputElement&&(o.value.value="",o.value.focus(),A(""))}function j(t){t.relatedTarget===null&&N(),h.value instanceof HTMLElement&&t.relatedTarget instanceof Node&&!h.value.contains(t.relatedTarget)&&N()}function N(){f.value=!1}function A(t){b.value=null;try{const l=Ke(t,T.value);l.sort((e,v)=>e[0].localeCompare(v[0])),d.value=l}catch(l){if(l instanceof Error)b.value=l,f.value=!0;else throw l}}function K(t,l){return JSON.stringify(t)===JSON.stringify(l)}return(t,l)=>(m(),_("div",{ref_key:"filterBar",ref:h,class:"k-filter-bar","data-testid":"k-filter-bar"},[S("button",{class:"k-focus-filter-input-button",title:"Focus filter",type:"button","data-testid":"k-filter-bar-focus-filter-input-button",onClick:H},[Oe,p(),w(c($),{"aria-hidden":"true",class:"k-filter-icon",color:c(fe),"data-testid":"k-filter-bar-filter-icon","hide-title":"",icon:"filter",size:c(M)},null,8,["color","size"])]),p(),S("label",{for:`${a.id}-filter-bar-input`,class:"visually-hidden"},[se(t.$slots,"default",{},()=>[p(k(C.value),1)],!0)],8,Ve),p(),ke(S("input",{id:`${a.id}-filter-bar-input`,ref_key:"filterInput",ref:o,"onUpdate:modelValue":l[0]||(l[0]=e=>u.value=e),class:"k-filter-bar-input",type:"text",placeholder:O.value,"data-testid":"k-filter-bar-filter-input",onFocus:l[1]||(l[1]=e=>f.value=!0),onBlur:j,onChange:Q},null,40,Qe),[[Te,u.value]]),p(),f.value?(m(),_("div",He,[S("div",Ze,[b.value!==null?(m(),_("p",Ge,k(b.value.message),1)):(m(),_("button",{key:1,class:te(["k-submit-query-button",{"k-submit-query-button-is-selected":r.value===-1}]),title:"Submit query",type:"button","data-testid":"k-filter-bar-submit-query-button",onClick:I},`
          Submit `+k(u.value),3)),p(),(m(!0),_(R,null,Se(n.value,(e,v)=>(m(),_("div",{key:`${a.id}-${v}`,class:te(["k-suggestion-list-item",{"k-suggestion-list-item-is-selected":r.value===v}])},[S("b",null,k(e.fieldName),1),e.description!==""?(m(),_("span",Je,": "+k(e.description),1)):J("",!0),p(),S("button",{class:"k-apply-suggestion-button",title:`Add ${e.fieldName}:`,type:"button","data-filter-field":e.fieldName,"data-testid":"k-filter-bar-apply-suggestion-button",onClick:Z},[S("span",Xe,"Add "+k(e.fieldName)+":",1),p(),w(c($),{"aria-hidden":"true",color:"currentColor","hide-title":"",icon:"chevronRight",size:c(M)},null,8,["size"])],8,We)],2))),128))])])):J("",!0),p(),u.value!==""?(m(),_("button",{key:1,class:"k-clear-query-button",title:"Clear query",type:"button","data-testid":"k-filter-bar-clear-query-button",onClick:L},[Ye,p(),w(c($),{"aria-hidden":"true",color:"currentColor",icon:"clear","hide-title":"",size:c(M)},null,8,["size"])])):J("",!0)],512))}});const rt=oe(et,[["__scopeId","data-v-91b196c9"]]);export{lt as D,rt as K};
