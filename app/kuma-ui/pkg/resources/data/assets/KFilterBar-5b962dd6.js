var ie=Object.defineProperty;var le=(o,i,a)=>i in o?ie(o,i,{enumerable:!0,configurable:!0,writable:!0,value:a}):o[i]=a;var K=(o,i,a)=>(le(o,typeof i!="symbol"?i+"":i,a),a);import{d as ae,c as M,r as re,o as g,a as R,w as h,A as se,h as D,g as m,t as b,e as _,F as V,s as S,n as G,b as T,$ as ue,E as ce,x as j,H as de,K as pe,k as N,J as ee,M as me,N as fe,v as ge,f as J,l as ve,B as ye,p as he,q as be}from"./index-2a9ba339.js";import{A as ke}from"./DataSource.vue_vue_type_script_setup_true_lang-c18fdd22.js";import{S as _e}from"./StatusBadge-4403951c.js";import{e as Se,g as Te,t as Ce,r as we,x as De,C as Ae,z as Ne,B as Ue,y as xe,f as oe}from"./RouteView.vue_vue_type_script_setup_true_lang-5d6806ed.js";const Ie=ae({__name:"DataPlaneList",props:{total:{default:0},pageNumber:{},pageSize:{},items:{},error:{},gateways:{type:Boolean,default:!1}},emits:["load-data","change"],setup(o,{emit:i}){const a=o,v=Se(),{t:n,formatIsoDate:u}=Te(),c=M(()=>v.getters["config/getMulticlusterStatus"]);function y(d){return d.map(r=>{var z,I,A,F,t,l;const k=r.mesh,s=r.name,C=((z=r.dataplane.networking.gateway)==null?void 0:z.type)||"STANDARD",q={name:C==="STANDARD"?"data-plane-detail-view":"gateway-detail-view",params:{mesh:k,dataPlane:s}},$=["kuma.io/protocol","kuma.io/service","kuma.io/zone"],U=Ce(r.dataplane).filter(e=>$.includes(e.label)),E=(I=U.find(e=>e.label==="kuma.io/service"))==null?void 0:I.value,O=(A=U.find(e=>e.label==="kuma.io/protocol"))==null?void 0:A.value,x=(F=U.find(e=>e.label==="kuma.io/zone"))==null?void 0:F.value;let P;E!==void 0&&(P={name:"service-detail-view",params:{mesh:k,service:E}});let L;x!==void 0&&(L={name:"zone-cp-detail-view",params:{zone:x}});const{status:B}=we(r.dataplane,r.dataplaneInsight),Q=((t=r.dataplaneInsight)==null?void 0:t.subscriptions)??[],H={totalUpdates:0,totalRejectedUpdates:0,dpVersion:null,envoyVersion:null,selectedTime:NaN,selectedUpdateTime:NaN,version:null},p=Q.reduce((e,f)=>{var Y,W;if(f.connectTime){const X=Date.parse(f.connectTime);(!e.selectedTime||X>e.selectedTime)&&(e.selectedTime=X)}const Z=Date.parse(f.status.lastUpdateTime);return Z&&(!e.selectedUpdateTime||Z>e.selectedUpdateTime)&&(e.selectedUpdateTime=Z),{totalUpdates:e.totalUpdates+parseInt(f.status.total.responsesSent??"0",10),totalRejectedUpdates:e.totalRejectedUpdates+parseInt(f.status.total.responsesRejected??"0",10),dpVersion:((Y=f.version)==null?void 0:Y.kumaDp.version)||e.dpVersion,envoyVersion:((W=f.version)==null?void 0:W.envoy.version)||e.envoyVersion,selectedTime:e.selectedTime,selectedUpdateTime:e.selectedUpdateTime,version:f.version||e.version}},H),w={name:s,detailViewRoute:q,type:C,zone:{title:x??"—",route:L},service:{title:E??"—",route:P},protocol:O??"—",status:B,totalUpdates:p.totalUpdates,totalRejectedUpdates:p.totalRejectedUpdates,dpVersion:p.dpVersion??"—",envoyVersion:p.envoyVersion??"—",warnings:[],unsupportedEnvoyVersion:!1,unsupportedKumaDPVersion:!1,kumaDpAndKumaCpMismatch:!1,lastUpdated:p.selectedUpdateTime?u(new Date(p.selectedUpdateTime).toUTCString()):"—",lastConnected:p.selectedTime?u(new Date(p.selectedTime).toUTCString()):"—",overview:r};if(p.version){const{kind:e}=De(p.version);switch(e!==Ae&&w.warnings.push(e),e){case Ue:w.unsupportedEnvoyVersion=!0;break;case Ne:w.unsupportedKumaDPVersion=!0;break}}return c.value&&p.dpVersion&&U.find(f=>f.label===pe)&&typeof((l=p.version)==null?void 0:l.kumaDp.kumaCpCompatible)=="boolean"&&!p.version.kumaDp.kumaCpCompatible&&(w.warnings.push(xe),w.kumaDpAndKumaCpMismatch=!0),w})}return(d,r)=>{const k=re("RouterLink");return g(),R(ke,{"empty-state-title":T(n)("common.emptyState.title"),"empty-state-message":T(n)("common.emptyState.message",{type:a.gateways?"Gateways":"Data plane proxies"}),headers:[{label:"Name",key:"name"},a.gateways?{label:"Type",key:"type"}:void 0,{label:"Service",key:"service"},a.gateways?void 0:{label:"Protocol",key:"protocol"},c.value?{label:"Zone",key:"zone"}:void 0,{label:"Last Updated",key:"lastUpdated"},{label:"Kuma DP version",key:"dpVersion"},{label:"Status",key:"status"},{label:"Actions",key:"actions",hideLabel:!0}].filter(Boolean),"page-number":a.pageNumber,"page-size":a.pageSize,total:a.total,items:a.items?y(a.items):void 0,error:a.error,onChange:r[0]||(r[0]=s=>i("change",s))},{toolbar:h(()=>[se(d.$slots,"toolbar",{},void 0,!0)]),name:h(({row:s})=>[D(k,{to:{name:a.gateways?"gateway-detail-view":"data-plane-detail-view",params:{dataPlane:s.name}},"data-testid":"detail-view-link"},{default:h(()=>[m(b(s.name),1)]),_:2},1032,["to"])]),service:h(({rowValue:s})=>[s.route?(g(),R(k,{key:0,to:s.route},{default:h(()=>[m(b(s.title),1)]),_:2},1032,["to"])):(g(),_(V,{key:1},[m(b(s.title),1)],64))]),dpVersion:h(({row:s,rowValue:C})=>[S("div",{class:G({"with-warnings":s.unsupportedEnvoyVersion||s.unsupportedKumaDPVersion||s.kumaDpAndKumaCpMismatch})},b(C),3)]),zone:h(({rowValue:s})=>[s.route?(g(),R(k,{key:0,to:s.route},{default:h(()=>[m(b(s.title),1)]),_:2},1032,["to"])):(g(),_(V,{key:1},[m(b(s.title),1)],64))]),status:h(({rowValue:s})=>[s?(g(),R(_e,{key:0,status:s},null,8,["status"])):(g(),_(V,{key:1},[m(`
        —
      `)],64))]),actions:h(({row:s})=>[D(T(ue),{class:"actions-dropdown","kpop-attributes":{placement:"bottomEnd",popoverClasses:"mt-5 more-actions-popover"},width:"150"},{default:h(()=>[D(T(ce),{class:"non-visual-button",appearance:"secondary",size:"small"},{icon:h(()=>[D(T(j),{color:"var(--black-400)",icon:"more",size:"16"})]),_:1})]),items:h(()=>[D(T(de),{item:{to:{name:a.gateways?"gateway-detail-view":"data-plane-detail-view",params:{dataPlane:s.name}},label:T(n)("common.collection.actions.view")}},null,8,["item"])]),_:2},1024)]),_:3},8,["empty-state-title","empty-state-message","headers","page-number","page-size","total","items","error"])}}});const at=oe(Ie,[["__scopeId","data-v-9e7d1c23"]]);function Ee(o,i,a){return Math.max(i,Math.min(o,a))}const Me=["ControlLeft","ControlRight","ShiftLeft","ShiftRight","AltLeft"];class Pe{constructor(i,a){K(this,"commands");K(this,"keyMap");K(this,"boundTriggerShortcuts");this.commands=a,this.keyMap=Object.fromEntries(Object.entries(i).map(([v,n])=>[v.toLowerCase(),n])),this.boundTriggerShortcuts=this.triggerShortcuts.bind(this)}registerListener(){document.addEventListener("keydown",this.boundTriggerShortcuts)}unRegisterListener(){document.removeEventListener("keydown",this.boundTriggerShortcuts)}triggerShortcuts(i){Le(i,this.keyMap,this.commands)}}function Le(o,i,a){const v=Be(o.code),n=[o.ctrlKey?"ctrl":"",o.shiftKey?"shift":"",o.altKey?"alt":"",v].filter(y=>y!=="").join("+"),u=i[n];if(!u)return;const c=a[u];c.isAllowedContext&&!c.isAllowedContext(o)||(c.shouldPreventDefaultAction&&o.preventDefault(),!(c.isDisabled&&c.isDisabled())&&c.trigger(o))}function Be(o){return Me.includes(o)?"":o.replace(/^Key/,"").toLowerCase()}function ze(o,i){const a=" "+o,v=a.matchAll(/ ([-\s\w]+):\s*/g),n=[];for(const u of Array.from(v)){if(u.index===void 0)continue;const c=Fe(u[1]);if(i.length>0&&!i.includes(c))throw new Error(`Unknown field “${c}”. Known fields: ${i.join(", ")}`);const y=u.index+u[0].length,d=a.substring(y);let r;if(/^\s*["']/.test(d)){const s=d.match(/['"](.*?)['"]/);if(s!==null)r=s[1];else throw new Error(`Quote mismatch for field “${c}”.`)}else{const s=d.indexOf(" "),C=s===-1?d.length:s;r=d.substring(0,C)}r!==""&&n.push([c,r])}return n}function Fe(o){return o.trim().replace(/\s+/g,"-").replace(/-[a-z]/g,(i,a)=>a===0?i:i.substring(1).toUpperCase())}let te=0;const Ke=(o="unique")=>(te++,`${o}-${te}`),ne=o=>(he("data-v-2f238162"),o=o(),be(),o),Re=ne(()=>S("span",{class:"visually-hidden"},"Focus filter",-1)),Ve=["for"],je=["id","placeholder"],qe={key:0,class:"k-suggestion-box","data-testid":"k-filter-bar-suggestion-box"},$e={class:"k-suggestion-list"},Oe={key:0,class:"k-filter-bar-error"},Qe={key:0},He=["title","data-filter-field"],Ze={class:"visually-hidden"},Je=ne(()=>S("span",{class:"visually-hidden"},"Clear query",-1)),Ge=ae({__name:"KFilterBar",props:{id:{type:String,required:!1,default:()=>Ke("k-filter-bar")},fields:{type:Object,required:!0},placeholder:{type:String,required:!1,default:null},query:{type:String,required:!1,default:""}},emits:["fields-change"],setup(o,{emit:i}){const a=o,v=N(null),n=N(null),u=N(a.query),c=N([]),y=N(null),d=N(!1),r=N(-1),k=M(()=>Object.keys(a.fields)),s=M(()=>Object.entries(a.fields).slice(0,5).map(([t,l])=>({fieldName:t,...l}))),C=M(()=>k.value.length>0?`Filter by ${k.value.join(", ")}`:"Filter"),q=M(()=>a.placeholder??C.value);ee(()=>c.value,function(t,l){F(t,l)||(y.value=null,i("fields-change",{fields:t,query:u.value}))}),ee(()=>u.value,function(){u.value===""&&(y.value=null),d.value=!0});const $={Enter:"submitQuery",Escape:"closeSuggestionBox",ArrowDown:"jumpToNextSuggestion",ArrowUp:"jumpToPreviousSuggestion"},U={submitQuery:{trigger:x,isAllowedContext(t){return n.value!==null&&t.composedPath().includes(n.value)},shouldPreventDefaultAction:!0},jumpToNextSuggestion:{trigger:P,isAllowedContext(t){return n.value!==null&&t.composedPath().includes(n.value)},shouldPreventDefaultAction:!0},jumpToPreviousSuggestion:{trigger:L,isAllowedContext(t){return n.value!==null&&t.composedPath().includes(n.value)},shouldPreventDefaultAction:!0},closeSuggestionBox:{trigger:I,isAllowedContext(t){return v.value!==null&&t.composedPath().includes(v.value)}}};function E(){const t=new Pe($,U);ve(function(){t.registerListener()}),ye(function(){t.unRegisterListener()}),A(u.value)}E();function O(t){const l=t.target;A(l.value)}function x(){if(n.value instanceof HTMLInputElement)if(r.value===-1)A(n.value.value),d.value=!1;else{const t=s.value[r.value].fieldName;t&&p(n.value,t)}}function P(){B(1)}function L(){B(-1)}function B(t){r.value=Ee(r.value+t,-1,s.value.length-1)}function Q(){n.value instanceof HTMLInputElement&&n.value.focus()}function H(t){const e=t.currentTarget.getAttribute("data-filter-field");e&&n.value instanceof HTMLInputElement&&p(n.value,e)}function p(t,l){const e=u.value===""||u.value.endsWith(" ")?"":" ";u.value+=e+l+":",t.focus(),r.value=-1}function w(){u.value="",n.value instanceof HTMLInputElement&&(n.value.value="",n.value.focus(),A(""))}function z(t){t.relatedTarget===null&&I(),v.value instanceof HTMLElement&&t.relatedTarget instanceof Node&&!v.value.contains(t.relatedTarget)&&I()}function I(){d.value=!1}function A(t){y.value=null;try{const l=ze(t,k.value);l.sort((e,f)=>e[0].localeCompare(f[0])),c.value=l}catch(l){if(l instanceof Error)y.value=l,d.value=!0;else throw l}}function F(t,l){return JSON.stringify(t)===JSON.stringify(l)}return(t,l)=>(g(),_("div",{ref_key:"filterBar",ref:v,class:"k-filter-bar","data-testid":"k-filter-bar"},[S("button",{class:"k-focus-filter-input-button",title:"Focus filter",type:"button","data-testid":"k-filter-bar-focus-filter-input-button",onClick:Q},[Re,m(),D(T(j),{"aria-hidden":"true",class:"k-filter-icon",color:"var(--grey-400)","data-testid":"k-filter-bar-filter-icon","hide-title":"",icon:"filter",size:"20"})]),m(),S("label",{for:`${a.id}-filter-bar-input`,class:"visually-hidden"},[se(t.$slots,"default",{},()=>[m(b(C.value),1)],!0)],8,Ve),m(),me(S("input",{id:`${a.id}-filter-bar-input`,ref_key:"filterInput",ref:n,"onUpdate:modelValue":l[0]||(l[0]=e=>u.value=e),class:"k-filter-bar-input",type:"text",placeholder:q.value,"data-testid":"k-filter-bar-filter-input",onFocus:l[1]||(l[1]=e=>d.value=!0),onBlur:z,onChange:O},null,40,je),[[fe,u.value]]),m(),d.value?(g(),_("div",qe,[S("div",$e,[y.value!==null?(g(),_("p",Oe,b(y.value.message),1)):(g(),_("button",{key:1,class:G(["k-submit-query-button",{"k-submit-query-button-is-selected":r.value===-1}]),title:"Submit query",type:"button","data-testid":"k-filter-bar-submit-query-button",onClick:x},`
          Submit `+b(u.value),3)),m(),(g(!0),_(V,null,ge(s.value,(e,f)=>(g(),_("div",{key:`${a.id}-${f}`,class:G(["k-suggestion-list-item",{"k-suggestion-list-item-is-selected":r.value===f}])},[S("b",null,b(e.fieldName),1),e.description!==""?(g(),_("span",Qe,": "+b(e.description),1)):J("",!0),m(),S("button",{class:"k-apply-suggestion-button",title:`Add ${e.fieldName}:`,type:"button","data-filter-field":e.fieldName,"data-testid":"k-filter-bar-apply-suggestion-button",onClick:H},[S("span",Ze,"Add "+b(e.fieldName)+":",1),m(),D(T(j),{"aria-hidden":"true",color:"currentColor","hide-title":"",icon:"chevronRight",size:"16"})],8,He)],2))),128))])])):J("",!0),m(),u.value!==""?(g(),_("button",{key:1,class:"k-clear-query-button",title:"Clear query",type:"button","data-testid":"k-filter-bar-clear-query-button",onClick:w},[Je,m(),D(T(j),{"aria-hidden":"true",color:"currentColor",icon:"clear","hide-title":"",size:"20"})])):J("",!0)],512))}});const st=oe(Ge,[["__scopeId","data-v-2f238162"]]);export{at as D,st as K};
