import{U as S,P as E}from"./kongponents.es-aa96ab2e.js";import{d as F,u as U,q as f,c as v,s as q,o as u,e as h,h as o,g as c,r as X,a as y,w as i,b as p,k as T,j as N,t as w,F as D,f as K}from"./index-e8e69e62.js";import{k as W,j as z,f as G,s as R,t as H,D as P,h as J,v as A,g as Y,_ as Z}from"./RouteView.vue_vue_type_script_setup_true_lang-b28dd8e7.js";import{_ as ee}from"./RouteTitle.vue_vue_type_script_setup_true_lang-8f9a216a.js";import{D as O,a as j}from"./DefinitionListItem-86d63286.js";import{M as te}from"./MeshResources-62f27858.js";import{_ as ae}from"./ResourceCodeBlock.vue_vue_type_script_setup_true_lang-3f62641e.js";import{_ as se}from"./StatusInfo.vue_vue_type_script_setup_true_lang-a5fbb478.js";import{T as ne}from"./TextWithCopyButton-73715a8a.js";import"./CodeBlock.vue_vue_type_style_index_0_lang-cc5f6631.js";import"./toYaml-4e00099e.js";import"./EmptyBlock.vue_vue_type_script_setup_true_lang-04152738.js";import"./ErrorBlock-63a54e88.js";import"./LoadingBlock.vue_vue_type_script_setup_true_lang-63e74df2.js";const le={class:"chart-box-list"},oe=F({__name:"MeshCharts",setup(Q){const r=W(),x=z(),g=U(),d=G(),k=f(!1),_=f({total:0,online:0,partiallyDegraded:0,offline:0}),l=f({total:0,internal:0,external:0}),m=f({kumaDp:{},envoy:{}}),V=v(()=>{const t=[],{internal:a,external:e}=l.value;return a&&d.state.selectedMesh!==null&&t.push({title:r.t("common.charts.services.internalLabel"),data:a,route:{name:"services-list-view",params:{mesh:d.state.selectedMesh}}}),e&&d.state.selectedMesh!==null&&t.push({title:r.t("common.charts.services.externalLabel"),data:e,route:{name:"services-list-view",params:{mesh:d.state.selectedMesh}}}),{title:r.t("common.charts.services.title"),showTotal:!0,dataPoints:t}}),$=v(()=>{const t=[],{total:a,online:e,partiallyDegraded:n}=_.value;if(a>0){t.push({title:r.t("http.api.value.online"),statusKeyword:"online",data:e}),n>0&&t.push({title:r.t("http.api.value.partially_degraded"),statusKeyword:"partially_degraded",data:n});const M=a-n-e;M>0&&t.push({title:r.t("http.api.value.offline"),statusKeyword:"offline",data:M})}return{title:r.t("common.charts.dataPlaneProxies.title"),showTotal:!0,dataPoints:t}}),B=v(()=>{const t=Object.entries(m.value.kumaDp).map(([a,e])=>({title:a,data:e.total??0}));return t.sort((a,e)=>a.title==="unknown"?1:e.title==="unknown"?-1:R(a.title,e.title)),{title:r.t("common.charts.kumaDp.title"),subtitle:r.t("common.charts.kumaDp.subtitle"),dataPoints:t}}),I=v(()=>{const t=Object.entries(m.value.envoy).map(([a,e])=>({title:a,data:e.total??0}));return t.sort((a,e)=>a.title==="unknown"?1:e.title==="unknown"?-1:R(a.title,e.title)),{title:r.t("common.charts.envoy.title"),subtitle:r.t("common.charts.envoy.subtitle"),dataPoints:t}});q(()=>g.params.mesh,function(t){typeof t=="string"&&C(t)},{immediate:!0});async function C(t){k.value=!0;try{const a=await x.getMeshInsights({name:t}),e=H([a]);b(e),L(e),s(e)}catch{_.value={total:0,online:0,partiallyDegraded:0,offline:0},l.value={total:0,internal:0,external:0},m.value={kumaDp:{},envoy:{}}}finally{k.value=!1}}function b(t){const{total:a,online:e,partiallyDegraded:n}=t.dataplanes;_.value={total:a,online:e,partiallyDegraded:n,offline:a-e-n}}function L(t){const{total:a,internal:e,external:n}=t.services;l.value={total:a,internal:e,external:n}}function s(t){m.value=t.dpVersions}return(t,a)=>(u(),h("div",le,[o(P,{data:V.value},null,8,["data"]),c(),o(P,{data:$.value},null,8,["data"]),c(),o(P,{data:B.value},null,8,["data"]),c(),o(P,{data:I.value},null,8,["data"])]))}});const re=J(oe,[["__scopeId","data-v-b9f3c277"]]),ie={class:"kcard-stack"},ue={class:"columns"},ce={key:0},me=F({__name:"MeshOverviewView",setup(Q){const{t:r}=W(),x=z(),g=U(),d=G(),k=f(!0),_=f(!1),l=f(null),m=f(null),V=v(()=>{if(l.value===null||m.value===null)return null;const{name:s,creationTime:t,modificationTime:a}=l.value;return{name:s,created:A(t),modified:A(a),"Data Plane Proxies":m.value.dataplanes.total}}),$=v(()=>{var M;if(l.value===null)return null;const s=b(l.value,"mtls"),t=b(l.value,"logging"),a=b(l.value,"metrics"),e=b(l.value,"tracing"),n=!!((M=l.value.routing)!=null&&M.localityAwareLoadBalancing);return{mtls:s,logging:t,metrics:a,tracing:e,localityAwareLoadBalancing:n}}),B=v(()=>d.state.sidebar.insights.mesh.policies.total),I=v(()=>d.state.policyTypes.map(s=>{var t,a;return{...s,length:((a=(t=m.value)==null?void 0:t.policies[s.name])==null?void 0:a.total)??0}}));q(()=>g.params.mesh,function(){g.name==="single-mesh-overview"&&C()}),C();async function C(){k.value=!0,_.value=!1;const s=g.params.mesh;try{l.value=await x.getMesh({name:s}),m.value=await x.getMeshInsights({name:s});const t=H([m.value]);d.state.currentMeshPolicies=t.policies}catch(t){_.value=!0,l.value=null,m.value=null,console.error(t)}finally{k.value=!1}}function b(s,t){if(s===null||s[t]===void 0)return!1;const a=s[t].enabledBackend??s[t].defaultBackend??s[t].backends[0].name,e=s[t].backends.find(n=>n.name===a);return`${e.type} / ${e.name}`}async function L(s){const t=g.params.mesh;return await x.getMesh({name:t},s)}return(s,t)=>{const a=X("router-link");return u(),y(Z,{module:"meshes"},{default:i(()=>[o(ee,{title:p(r)("meshes.routes.overview.title")},null,8,["title"]),c(),o(Y,null,{default:i(()=>[T("div",ie,[o(p(S),null,{body:i(()=>[o(re)]),_:1}),c(),l.value!==null?(u(),y(p(S),{key:0},{body:i(()=>[T("div",ue,[o(se,{"is-loading":k.value,"has-error":_.value,"is-empty":l.value===null||m.value===null},{default:i(()=>[o(O,null,{default:i(()=>[(u(!0),h(D,null,N(V.value,(e,n)=>(u(),y(j,{key:n,term:p(r)(`http.api.property.${n}`)},{default:i(()=>[typeof e=="boolean"?(u(),y(p(E),{key:0,appearance:e?"success":"danger"},{default:i(()=>[c(w(e?"Enabled":"Disabled"),1)]),_:2},1032,["appearance"])):n==="name"&&typeof e=="string"?(u(),y(ne,{key:1,text:e},null,8,["text"])):(u(),h(D,{key:2},[c(w(e),1)],64))]),_:2},1032,["term"]))),128))]),_:1})]),_:1},8,["is-loading","has-error","is-empty"]),c(),o(O,null,{default:i(()=>[(u(!0),h(D,null,N($.value,(e,n)=>(u(),y(j,{key:n,term:p(r)(`http.api.property.${n}`)},{default:i(()=>[typeof e=="boolean"?(u(),y(p(E),{key:0,appearance:e?"success":"danger"},{default:i(()=>[c(w(e?"Enabled":"Disabled"),1)]),_:2},1032,["appearance"])):(u(),h(D,{key:1},[c(w(e),1)],64))]),_:2},1032,["term"]))),128))]),_:1}),c(),o(O,null,{default:i(()=>[o(j,{term:`Policies (${B.value})`},{default:i(()=>[T("ul",null,[(u(!0),h(D,null,N(I.value,(e,n)=>(u(),h(D,{key:n},[e.length!==0?(u(),h("li",ce,[o(a,{to:{name:"policies-list-view",params:{policyPath:e.path}}},{default:i(()=>[c(w(e.name)+": "+w(e.length),1)]),_:2},1032,["to"])])):K("",!0)],64))),128))])]),_:1},8,["term"])]),_:1})])]),_:1})):K("",!0),c(),o(p(S),null,{body:i(()=>{var e;return[o(ae,{id:"code-block-mesh","resource-fetcher":L,"resource-fetcher-watch-key":((e=l.value)==null?void 0:e.name)||null},null,8,["resource-fetcher-watch-key"])]}),_:1}),c(),o(te)])]),_:1})]),_:1})}}});const Ce=J(me,[["__scopeId","data-v-f07e883a"]]);export{Ce as default};
