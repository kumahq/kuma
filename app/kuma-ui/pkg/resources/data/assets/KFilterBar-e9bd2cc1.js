var me=Object.defineProperty;var fe=(s,o,e)=>o in s?me(s,o,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[o]=e;var V=(s,o,e)=>(fe(s,typeof o!="symbol"?o+"":o,e),e);import{d as re,g as ge,f as ve,r as ye,o as d,i as M,w as g,S as ue,j as I,n as m,H as h,l as b,F as A,V as he,k as c,aa as be,p as S,I as ce,m as G,v as ke,K as R,a1 as _e,Y as Te,a2 as we,a3 as Se,a0 as Ce,t as de,y as L,h as H,as as oe,at as xe,au as De,av as Ie,B as ie,aw as ze,ax as Ue,z as Le,U as Ae,D as Ne,G as Fe}from"./index-9e09c995.js";import{d as je,a as Ee,c as Be,C as Me}from"./dataplane-0a086c06.js";const Re={key:0},$e=re({__name:"DataPlaneList",props:{total:{default:0},pageNumber:{},pageSize:{},items:{},error:{},gateways:{type:Boolean,default:!1}},emits:["load-data","change"],setup(s,{emit:o}){const{t:e,formatIsoDate:w}=ge(),k=ve(),a=s,i=o,C=k("use zones");function _(v){return v.map(u=>{var E,z,Q,t,l,p,U,X,ee,te;const f=u.mesh,n=u.name,T=((E=u.dataplane.networking.gateway)==null?void 0:E.type)||"STANDARD",D={name:T==="STANDARD"?"data-plane-detail-view":"gateway-detail-view",params:{mesh:f,dataPlane:n}},O=["kuma.io/protocol","kuma.io/service","kuma.io/zone"],N=je(u.dataplane).filter(r=>O.includes(r.label)),B=(z=N.find(r=>r.label==="kuma.io/service"))==null?void 0:z.value,Z=(Q=N.find(r=>r.label==="kuma.io/protocol"))==null?void 0:Q.value,F=(t=N.find(r=>r.label==="kuma.io/zone"))==null?void 0:t.value;let $;B!==void 0&&($={name:"service-detail-view",params:{mesh:f,service:B}});let q;F!==void 0&&(q={name:"zone-cp-detail-view",params:{zone:F}});const{status:P}=Ee(u.dataplane,u.dataplaneInsight),J=((l=u.dataplaneInsight)==null?void 0:l.subscriptions)??[],W={totalUpdates:0,totalRejectedUpdates:0,dpVersion:null,envoyVersion:null,selectedTime:NaN,selectedUpdateTime:NaN,version:null},y=J.reduce((r,x)=>{var ae,ne;if(x.connectTime){const se=Date.parse(x.connectTime);(!r.selectedTime||se>r.selectedTime)&&(r.selectedTime=se)}const Y=Date.parse(x.status.lastUpdateTime);return Y&&(!r.selectedUpdateTime||Y>r.selectedUpdateTime)&&(r.selectedUpdateTime=Y),{totalUpdates:r.totalUpdates+parseInt(x.status.total.responsesSent??"0",10),totalRejectedUpdates:r.totalRejectedUpdates+parseInt(x.status.total.responsesRejected??"0",10),dpVersion:((ae=x.version)==null?void 0:ae.kumaDp.version)||r.dpVersion,envoyVersion:((ne=x.version)==null?void 0:ne.envoy.version)||r.envoyVersion,selectedTime:r.selectedTime,selectedUpdateTime:r.selectedUpdateTime,version:x.version||r.version}},W),j={name:n,dataplaneInsight:u.dataplaneInsight,detailViewRoute:D,type:T,zone:{title:F??e("common.collection.none"),route:q},service:{title:B??e("common.collection.none"),route:$},protocol:Z??e("common.collection.none"),status:P,totalUpdates:y.totalUpdates,totalRejectedUpdates:y.totalRejectedUpdates,envoyVersion:y.envoyVersion??e("common.collection.none"),warnings:{version_mismatch:!1,cert_expired:!1},lastUpdated:y.selectedUpdateTime?w(new Date(y.selectedUpdateTime).toUTCString()):e("common.collection.none"),lastConnected:y.selectedTime?w(new Date(y.selectedTime).toUTCString()):e("common.collection.none"),overview:u,isGateway:((U=(p=u.dataplane)==null?void 0:p.networking)==null?void 0:U.gateway)!==void 0};if(y.version){const{kind:r}=Be(y.version);r!==Me&&(j.warnings.version_mismatch=!0)}C&&y.dpVersion&&N.find(x=>x.label==="kuma.io/zone")&&typeof((X=y.version)==null?void 0:X.kumaDp.kumaCpCompatible)=="boolean"&&!y.version.kumaDp.kumaCpCompatible&&(j.warnings.version_mismatch=!0);const K=(te=(ee=u.dataplaneInsight)==null?void 0:ee.mTLS)==null?void 0:te.certificateExpirationTime;return K&&Date.now()>new Date(K).getTime()&&(j.warnings.cert_expired=!0),j})}return(v,u)=>{const f=ye("RouterLink");return d(),M(Ce,{"empty-state-message":c(e)("common.emptyState.message",{type:a.gateways?"Gateways":"Data Plane Proxies"}),"empty-state-cta-to":c(e)(`data-planes.href.docs.${a.gateways?"gateway":"data_plane_proxy"}`),"empty-state-cta-text":c(e)("common.documentation"),headers:[{label:"Name",key:"name"},...a.gateways?[{label:"Type",key:"type"}]:[],{label:"Service",key:"service"},...a.gateways?[]:[{label:"Protocol",key:"protocol"}],...c(C)?[{label:"Zone",key:"zone"}]:[],{label:"Last Updated",key:"lastUpdated"},{label:"Certificate Info",key:"certificate"},{label:"Status",key:"status"},{label:"Warnings",key:"warnings",hideLabel:!0},{label:"Actions",key:"actions",hideLabel:!0}],"page-number":a.pageNumber,"page-size":a.pageSize,total:a.total,items:a.items?_(a.items):void 0,error:a.error,onChange:u[0]||(u[0]=n=>i("change",n))},{toolbar:g(()=>[ue(v.$slots,"toolbar",{},void 0,!0)]),name:g(({row:n})=>[I(f,{to:{name:n.isGateway?"gateway-detail-view":"data-plane-detail-view",params:{dataPlane:n.name}},"data-testid":"detail-view-link"},{default:g(()=>[m(h(n.name),1)]),_:2},1032,["to"])]),service:g(({rowValue:n})=>[n.route?(d(),M(f,{key:0,to:n.route},{default:g(()=>[m(h(n.title),1)]),_:2},1032,["to"])):(d(),b(A,{key:1},[m(h(n.title),1)],64))]),zone:g(({rowValue:n})=>[n.route?(d(),M(f,{key:0,to:n.route},{default:g(()=>[m(h(n.title),1)]),_:2},1032,["to"])):(d(),b(A,{key:1},[m(h(n.title),1)],64))]),status:g(({rowValue:n})=>[n?(d(),M(he,{key:0,status:n},null,8,["status"])):(d(),b(A,{key:1},[m(h(c(e)("common.collection.none")),1)],64))]),warnings:g(({row:n})=>[Object.values(n.warnings).some(T=>T)?(d(),M(c(be),{key:0},{content:g(()=>[S("ul",null,[(d(!0),b(A,null,ce(n.warnings,(T,D)=>(d(),b(A,{key:D},[T?(d(),b("li",Re,h(c(e)(`data-planes.components.data-plane-list.${D}`)),1)):G("",!0)],64))),128))])]),default:g(()=>[m(),I(ke,{class:"mr-1",size:c(R),"hide-title":""},null,8,["size"])]),_:2},1024)):(d(),b(A,{key:1},[m(h(c(e)("common.collection.none")),1)],64))]),certificate:g(({row:n})=>{var T,D;return[m(h((D=(T=n.dataplaneInsight)==null?void 0:T.mTLS)!=null&&D.certificateExpirationTime?c(w)(new Date(n.dataplaneInsight.mTLS.certificateExpirationTime).toUTCString()):c(e)("data-planes.components.data-plane-list.certificate.none")),1)]}),actions:g(({row:n})=>[I(c(_e),{class:"actions-dropdown","kpop-attributes":{placement:"bottomEnd",popoverClasses:"mt-5 more-actions-popover"},width:"150"},{default:g(()=>[I(c(Te),{class:"non-visual-button",appearance:"secondary",size:"small"},{default:g(()=>[I(c(we),{size:c(R)},null,8,["size"])]),_:1})]),items:g(()=>[I(c(Se),{item:{to:{name:n.isGateway?"gateway-detail-view":"data-plane-detail-view",params:{dataPlane:n.name}},label:c(e)("common.collection.actions.view")}},null,8,["item"])]),_:2},1024)]),_:3},8,["empty-state-message","empty-state-cta-to","empty-state-cta-text","headers","page-number","page-size","total","items","error"])}}});const ct=de($e,[["__scopeId","data-v-7f04bb83"]]);function qe(s,o,e){return Math.max(o,Math.min(s,e))}const Pe=["ControlLeft","ControlRight","ShiftLeft","ShiftRight","AltLeft"];class Ke{constructor(o,e){V(this,"commands");V(this,"keyMap");V(this,"boundTriggerShortcuts");this.commands=e,this.keyMap=Object.fromEntries(Object.entries(o).map(([w,k])=>[w.toLowerCase(),k])),this.boundTriggerShortcuts=this.triggerShortcuts.bind(this)}registerListener(){document.addEventListener("keydown",this.boundTriggerShortcuts)}unRegisterListener(){document.removeEventListener("keydown",this.boundTriggerShortcuts)}triggerShortcuts(o){Qe(o,this.keyMap,this.commands)}}function Qe(s,o,e){const w=Ve(s.code),k=[s.ctrlKey?"ctrl":"",s.shiftKey?"shift":"",s.altKey?"alt":"",w].filter(C=>C!=="").join("+"),a=o[k];if(!a)return;const i=e[a];i.isAllowedContext&&!i.isAllowedContext(s)||(i.shouldPreventDefaultAction&&s.preventDefault(),!(i.isDisabled&&i.isDisabled())&&i.trigger(s))}function Ve(s){return Pe.includes(s)?"":s.replace(/^Key/,"").toLowerCase()}function He(s,o){const e=" "+s,w=e.matchAll(/ ([-\s\w]+):\s*/g),k=[];for(const a of Array.from(w)){if(a.index===void 0)continue;const i=Ge(a[1]);if(o.length>0&&!o.includes(i))throw new Error(`Unknown field “${i}”. Known fields: ${o.join(", ")}`);const C=a.index+a[0].length,_=e.substring(C);let v;if(/^\s*["']/.test(_)){const f=_.match(/['"](.*?)['"]/);if(f!==null)v=f[1];else throw new Error(`Quote mismatch for field “${i}”.`)}else{const f=_.indexOf(" "),n=f===-1?_.length:f;v=_.substring(0,n)}v!==""&&k.push([i,v])}return k}function Ge(s){return s.trim().replace(/\s+/g,"-").replace(/-[a-z]/g,(o,e)=>e===0?o:o.substring(1).toUpperCase())}let le=0;const Oe=(s="unique")=>(le++,`${s}-${le}`),pe=s=>(Ne("data-v-9e2bf5f8"),s=s(),Fe(),s),Ze=pe(()=>S("span",{class:"visually-hidden"},"Focus filter",-1)),Je={class:"k-filter-icon"},We=["for"],Ye=["id","placeholder"],Xe={key:0,class:"k-suggestion-box","data-testid":"k-filter-bar-suggestion-box"},et={class:"k-suggestion-list"},tt={key:0,class:"k-filter-bar-error"},at={key:0},nt=["title","data-filter-field"],st={class:"visually-hidden"},ot=pe(()=>S("span",{class:"visually-hidden"},"Clear query",-1)),it=re({__name:"KFilterBar",props:{id:{type:String,required:!1,default:()=>Oe("k-filter-bar")},fields:{type:Object,required:!0},placeholder:{type:String,required:!1,default:null},query:{type:String,required:!1,default:""}},emits:["fields-change"],setup(s,{emit:o}){const e=s,w=o,k=L(null),a=L(null),i=L(e.query),C=L([]),_=L(null),v=L(!1),u=L(-1),f=H(()=>Object.keys(e.fields)),n=H(()=>Object.entries(e.fields).slice(0,5).map(([t,l])=>({fieldName:t,...l}))),T=H(()=>f.value.length>0?`Filter by ${f.value.join(", ")}`:"Filter"),D=H(()=>e.placeholder??T.value);oe(()=>C.value,function(t,l){Q(t,l)||(_.value=null,w("fields-change",{fields:t,query:i.value}))}),oe(()=>i.value,function(){i.value===""&&(_.value=null),v.value=!0});const O={Enter:"submitQuery",Escape:"closeSuggestionBox",ArrowDown:"jumpToNextSuggestion",ArrowUp:"jumpToPreviousSuggestion"},N={submitQuery:{trigger:F,isAllowedContext(t){return a.value!==null&&t.composedPath().includes(a.value)},shouldPreventDefaultAction:!0},jumpToNextSuggestion:{trigger:$,isAllowedContext(t){return a.value!==null&&t.composedPath().includes(a.value)},shouldPreventDefaultAction:!0},jumpToPreviousSuggestion:{trigger:q,isAllowedContext(t){return a.value!==null&&t.composedPath().includes(a.value)},shouldPreventDefaultAction:!0},closeSuggestionBox:{trigger:E,isAllowedContext(t){return k.value!==null&&t.composedPath().includes(k.value)}}};function B(){const t=new Ke(O,N);Le(function(){t.registerListener()}),Ae(function(){t.unRegisterListener()}),z(i.value)}B();function Z(t){const l=t.target;z(l.value)}function F(){if(a.value instanceof HTMLInputElement)if(u.value===-1)z(a.value.value),v.value=!1;else{const t=n.value[u.value].fieldName;t&&y(a.value,t)}}function $(){P(1)}function q(){P(-1)}function P(t){u.value=qe(u.value+t,-1,n.value.length-1)}function J(){a.value instanceof HTMLInputElement&&a.value.focus()}function W(t){const p=t.currentTarget.getAttribute("data-filter-field");p&&a.value instanceof HTMLInputElement&&y(a.value,p)}function y(t,l){const p=i.value===""||i.value.endsWith(" ")?"":" ";i.value+=p+l+":",t.focus(),u.value=-1}function j(){i.value="",a.value instanceof HTMLInputElement&&(a.value.value="",a.value.focus(),z(""))}function K(t){t.relatedTarget===null&&E(),k.value instanceof HTMLElement&&t.relatedTarget instanceof Node&&!k.value.contains(t.relatedTarget)&&E()}function E(){v.value=!1}function z(t){_.value=null;try{const l=He(t,f.value);l.sort((p,U)=>p[0].localeCompare(U[0])),C.value=l}catch(l){if(l instanceof Error)_.value=l,v.value=!0;else throw l}}function Q(t,l){return JSON.stringify(t)===JSON.stringify(l)}return(t,l)=>(d(),b("div",{ref_key:"filterBar",ref:k,class:"k-filter-bar","data-testid":"k-filter-bar"},[S("button",{class:"k-focus-filter-input-button",title:"Focus filter",type:"button","data-testid":"k-filter-bar-focus-filter-input-button",onClick:J},[Ze,m(),S("span",Je,[I(c(xe),{decorative:"","data-testid":"k-filter-bar-filter-icon","hide-title":"",size:c(R)},null,8,["size"])])]),m(),S("label",{for:`${e.id}-filter-bar-input`,class:"visually-hidden"},[ue(t.$slots,"default",{},()=>[m(h(T.value),1)],!0)],8,We),m(),De(S("input",{id:`${e.id}-filter-bar-input`,ref_key:"filterInput",ref:a,"onUpdate:modelValue":l[0]||(l[0]=p=>i.value=p),class:"k-filter-bar-input",type:"text",placeholder:D.value,"data-testid":"k-filter-bar-filter-input",onFocus:l[1]||(l[1]=p=>v.value=!0),onBlur:K,onChange:Z},null,40,Ye),[[Ie,i.value]]),m(),v.value?(d(),b("div",Xe,[S("div",et,[_.value!==null?(d(),b("p",tt,h(_.value.message),1)):(d(),b("button",{key:1,class:ie(["k-submit-query-button",{"k-submit-query-button-is-selected":u.value===-1}]),title:"Submit query",type:"button","data-testid":"k-filter-bar-submit-query-button",onClick:F},`
          Submit `+h(i.value),3)),m(),(d(!0),b(A,null,ce(n.value,(p,U)=>(d(),b("div",{key:`${e.id}-${U}`,class:ie(["k-suggestion-list-item",{"k-suggestion-list-item-is-selected":u.value===U}])},[S("b",null,h(p.fieldName),1),p.description!==""?(d(),b("span",at,": "+h(p.description),1)):G("",!0),m(),S("button",{class:"k-apply-suggestion-button",title:`Add ${p.fieldName}:`,type:"button","data-filter-field":p.fieldName,"data-testid":"k-filter-bar-apply-suggestion-button",onClick:W},[S("span",st,"Add "+h(p.fieldName)+":",1),m(),I(c(ze),{decorative:"","hide-title":"",size:c(R)},null,8,["size"])],8,nt)],2))),128))])])):G("",!0),m(),i.value!==""?(d(),b("button",{key:1,class:"k-clear-query-button",title:"Clear query",type:"button","data-testid":"k-filter-bar-clear-query-button",onClick:j},[ot,m(),I(c(Ue),{decorative:"","hide-title":"",size:c(R)},null,8,["size"])])):G("",!0)],512))}});const dt=de(it,[["__scopeId","data-v-9e2bf5f8"]]);export{ct as D,dt as K};
