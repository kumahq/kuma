import{d as he,k as S,cx as ge,cs as ve,cy as be,cz as Ke,cA as Oe,o,f as v,g as e,a as H,w as L,b as q,t as k,q as Le,n as u,F as I,i as R,c as z,p as j,D as Ne,r as Re,y as ke,z as De,e as we,u as $e,j as P,l as xe,T as fe,K as Me,x as ze,cq as ye,cB as je,cC as He,cD as Be,cu as qe,cv as Ge,cE as Ye,ct as Fe,h as Ze,cF as Qe,cG as We,cH as Xe,A as _e,B as Je,C as et}from"./index.f4381a04.js";import{C as tt}from"./ContentWrapper.34b274d5.js";import{D as at}from"./DataOverview.2dc14e2d.js";import{E as nt}from"./EntityTag.819c2a1f.js";import{Y as st}from"./YamlView.8ed40dd6.js";import{_ as lt}from"./EmptyBlock.vue_vue_type_script_setup_true_lang.a081fa47.js";import"./ErrorBlock.3c391f50.js";import"./LoadingBlock.vue_vue_type_script_setup_true_lang.52c551fa.js";import"./index.58caa11d.js";import"./CodeBlock.2eccb873.js";import"./_commonjsHelpers.f037b798.js";const K=a=>(ke("data-v-df9c455f"),a=a(),De(),a),ot={class:"entity-summary entity-section-list"},it={class:"entity-title"},rt=K(()=>e("span",{class:"kutil-sr-only"},"Data plane proxy:",-1)),dt={class:"definition"},ct=K(()=>e("span",null,"Mesh:",-1)),ut={key:0},pt=K(()=>e("h4",null,"Tags",-1)),mt={class:"tag-list"},vt={key:1},ft=K(()=>e("h4",null,"Dependencies",-1)),yt={class:"mt-2 heading-with-icon"},_t=K(()=>e("h4",null,"Insights",-1)),ht={class:"entity-section-list"},gt=["data-testid"],bt=K(()=>e("span",null,"Connect time:",-1)),kt=["data-testid"],Dt=K(()=>e("span",null,"Disconnect time:",-1)),wt={class:"definition"},Ct=K(()=>e("span",null,"Control plane instance ID:",-1)),Tt={key:0},Pt=K(()=>e("summary",null," Responses (acknowledged / sent) ",-1)),St=["data-testid"],Ut=he({__name:"DataPlaneEntitySummary",props:{dataPlaneOverview:{type:Object,required:!0}},setup(a){const p=a,f={"Partially degraded":"partially_degraded",Offline:"offline",Online:"online"},O=S(()=>{const{name:r,mesh:c,dataplane:y}=p.dataPlaneOverview;return{type:"Dataplane",name:r,mesh:c,networking:y.networking}}),A=S(()=>ge(p.dataPlaneOverview.dataplane)),U=S(()=>{const r=Array.from(p.dataPlaneOverview.dataplaneInsight.subscriptions);return r.reverse(),r.map(c=>{const y=c.connectTime!==void 0?ve(c.connectTime):"\u2014",s=c.disconnectTime!==void 0?ve(c.disconnectTime):"\u2014",d=Object.entries(c.status).filter(([D])=>!["total","lastUpdateTime"].includes(D)).map(([D,w])=>{var G,$,Y,F,Z;const C=`${(G=w.responsesAcknowledged)!=null?G:0} / ${($=w.responsesSent)!=null?$:0}`;return{type:D.toUpperCase(),ratio:C,responsesSent:(Y=w.responsesSent)!=null?Y:0,responsesAcknowledged:(F=w.responsesAcknowledged)!=null?F:0,responsesRejected:(Z=w.responsesRejected)!=null?Z:0}});return{subscription:c,formattedConnectDate:y,formattedDisconnectDate:s,statuses:d}})}),h=S(()=>{const{status:r}=be(p.dataPlaneOverview.dataplane,p.dataPlaneOverview.dataplaneInsight);return Ke[f[r]]}),V=S(()=>{const r=Oe(p.dataPlaneOverview.dataplaneInsight);return r!==null?Object.entries(r).map(([c,y])=>({name:c,version:y})):[]}),g=S(()=>{const{subscriptions:r}=p.dataPlaneOverview.dataplaneInsight;if(r.length===0)return[];const c=r[r.length-1];if(!c.version)return[];const y=[],s=c.version.envoy,d=c.version.kumaDp;if(!(s.kumaDpCompatible!==void 0?s.kumaDpCompatible:!0)){const C=`Envoy ${s.version} is not supported by Kuma DP ${d.version}.`;y.push(C)}if(!(d.kumaCpCompatible!==void 0?d.kumaCpCompatible:!0)){const C=`Kuma DP ${d.version} is not supported by this Kuma control plane.`;y.push(C)}return y});return(r,c)=>{const y=Re("router-link");return o(),v("div",ot,[e("section",null,[e("h3",it,[rt,H(y,{to:{name:"data-plane-detail-view",params:{mesh:a.dataPlaneOverview.mesh,dataPlane:a.dataPlaneOverview.name}}},{default:L(()=>[q(k(a.dataPlaneOverview.name),1)]),_:1},8,["to"]),e("div",{class:Le(`status status--${u(h).appearance}`),"data-testid":"data-plane-status-badge"},k(u(h).title.toLowerCase()),3)]),e("div",dt,[ct,e("span",null,k(a.dataPlaneOverview.mesh),1)])]),u(A).length>0?(o(),v("section",ut,[pt,e("div",mt,[(o(!0),v(I,null,R(u(A),(s,d)=>(o(),z(nt,{key:d,tag:s},null,8,["tag"]))),128))])])):j("",!0),u(V).length>0?(o(),v("section",vt,[ft,(o(!0),v(I,null,R(u(V),(s,d)=>(o(),v("div",{key:d,class:"definition"},[e("span",null,k(s.name)+":",1),e("span",null,k(s.version),1)]))),128)),u(g).length>0?(o(),v(I,{key:0},[e("h5",yt,[q(" Warnings "),H(u(Ne),{class:"ml-1",icon:"warning",color:"var(--black-75)","secondary-color":"var(--yellow-300)",size:"20"})]),(o(!0),v(I,null,R(u(g),(s,d)=>(o(),v("p",{key:d},k(s),1))),128))],64)):j("",!0)])):j("",!0),u(U).length>0?(o(),v(I,{key:2},[e("section",null,[_t,e("div",ht,[(o(!0),v(I,null,R(u(U),(s,d)=>(o(),v("div",{key:d},[e("div",{class:"definition","data-testid":`data-plane-connect-time-${d}`},[bt,e("span",null,k(s.formattedConnectDate),1)],8,gt),e("div",{class:"definition","data-testid":`data-plane-disconnect-time-${d}`},[Dt,e("span",null,k(s.formattedDisconnectDate),1)],8,kt),e("div",wt,[Ct,e("span",null,k(s.subscription.controlPlaneInstanceId),1)]),s.statuses.length>0?(o(),v("details",Tt,[Pt,(o(!0),v(I,null,R(s.statuses,(D,w)=>(o(),v("div",{key:`${d}-${w}`,class:"definition","data-testid":`data-plane-subscription-status-${d}-${w}`},[e("span",null,k(D.type)+":",1),e("span",null,k(D.ratio),1)],8,St))),128))])):j("",!0)]))),128))])]),e("section",null,[H(st,{id:"code-block-data-plane-summary",content:u(O),"code-max-height":"250px"},null,8,["content"])])],64)):j("",!0)])}}});const Vt=we(Ut,[["__scopeId","data-v-df9c455f"]]),Ce=[{key:"status",label:"Status"},{key:"name",label:"Name"},{key:"mesh",label:"Mesh"},{key:"type",label:"Type"},{key:"service",label:"Service"},{key:"protocol",label:"Protocol"},{key:"zone",label:"Zone"},{key:"lastConnected",label:"Last Connected"},{key:"lastUpdated",label:"Last Updated"},{key:"totalUpdates",label:"Total Updates"},{key:"dpVersion",label:"Kuma DP version"},{key:"envoyVersion",label:"Envoy version"},{key:"details",label:"Details",hideLabel:!0}],Et=["name","details"],At=Ce.filter(a=>!Et.includes(a.key)).map(a=>({tableHeaderKey:a.key,label:a.label,isChecked:!1})),Te=["status","name","mesh","type","service","protocol","zone","lastUpdated","dpVersion","details"];function It(a,p=Te){return Ce.filter(f=>p.includes(f.key)?a?!0:f.key!=="zone":!1)}function ee(a,p){const f=window.history.state;if(f===null)return;const O=f.current.indexOf("?"),A=O>-1?f.current.substring(O):"",U=new URLSearchParams(A);p!=null?U.set(a,String(p)):U.has(a)&&U.delete(a);const h=U.toString(),V=h===""?"":"?"+h;let g="";if(O>-1?g=f.current.substring(0,O)+V:g=f.current+V,f.current!==g){const r=Object.assign({},f);r.current=g,window.history.replaceState(r,"","#"+g)}}const te=a=>(ke("data-v-9fa1cc22"),a=a(),De(),a),Kt=te(()=>e("label",{for:"data-planes-type-filter",class:"mr-2"}," Type: ",-1)),Ot=["value"],Lt=["for"],Nt=["id","checked","onChange"],Rt=te(()=>e("span",{class:"custom-control-icon"}," + ",-1)),$t=te(()=>e("span",{class:"custom-control-icon"}," \u2190 ",-1)),xt=he({__name:"DataPlaneListView",props:{name:{type:String,required:!1,default:null},offset:{type:Number,required:!1,default:0}},setup(a){const p=a,f=50,O=["All","Standard","Gateway (builtin)","Gateway (provided)"],A=$e(),U=ze(),h=P(Te),V=P(!0),g=P(!1),r=P(!1),c=P(!1),y=P({headers:[],data:[]}),s=P([]),d=P(null),D=P("All"),w=P(p.offset),C=P(null),G=S(()=>U.getters["config/getEnvironment"]),$=S(()=>U.getters["config/getMulticlusterStatus"]),Y=S(()=>G.value==="universal"?{name:"universal-dataplane"}:{name:"kubernetes-dataplane"}),F=S(()=>{const t=y.value.data.filter(_=>D.value==="All"?!0:_.type.toLowerCase()===D.value.toLowerCase()),l=It($.value,h.value);return{data:t,headers:l}}),Z=S(()=>At.filter(t=>$.value?!0:t.tableHeaderKey!=="zone").map(t=>{const l=h.value.includes(t.tableHeaderKey);return{...t,isChecked:l}}));xe(()=>A.params.mesh,function(){A.name==="data-plane-list-view"&&(V.value=!0,g.value=!1,r.value=!1,c.value=!1,Q(0))});const ae=fe.get("dpVisibleTableHeaderKeys");Array.isArray(ae)&&(h.value=ae),Q(p.offset);function Pe(t){t.stopPropagation()}function Se(t,l){const _=t.target,i=h.value.findIndex(m=>m===l);_.checked&&i===-1?h.value.push(l):!_.checked&&i>-1&&h.value.splice(i,1),fe.set("dpVisibleTableHeaderKeys",Array.from(new Set(h.value)))}function Ue(){Je.logger.info(et.CREATE_DATA_PLANE_PROXY_CLICKED)}function Ve(){return{title:"No Data",message:"There are no data plane proxies present."}}async function Ee(t){var se,le,oe,ie,re;const l=t.mesh,_=t.name,i={name:"data-plane-detail-view",params:{mesh:l,dataPlane:_}},m={name:"mesh-detail-view",params:{mesh:l}},B=["kuma.io/protocol","kuma.io/service","kuma.io/zone"],x=ge(t.dataplane).filter(n=>B.includes(n.label)),T=(se=x.find(n=>n.label==="kuma.io/service"))==null?void 0:se.value,N=(le=x.find(n=>n.label==="kuma.io/protocol"))==null?void 0:le.value,X=(oe=x.find(n=>n.label==="kuma.io/zone"))==null?void 0:oe.value;let ne;T!==void 0&&(ne={name:"service-insight-detail-view",params:{mesh:l,service:T}});const{status:Ae}=be(t.dataplane,t.dataplaneInsight),Ie={totalUpdates:0,totalRejectedUpdates:0,dpVersion:null,envoyVersion:null,selectedTime:NaN,selectedUpdateTime:NaN,version:null},b=t.dataplaneInsight.subscriptions.reduce((n,E)=>{var de,ce,ue,pe;if(E.connectTime){const me=Date.parse(E.connectTime);(!n.selectedTime||me>n.selectedTime)&&(n.selectedTime=me)}const J=Date.parse(E.status.lastUpdateTime);return J&&(!n.selectedUpdateTime||J>n.selectedUpdateTime)&&(n.selectedUpdateTime=J),{totalUpdates:n.totalUpdates+parseInt((de=E.status.total.responsesSent)!=null?de:"0",10),totalRejectedUpdates:n.totalRejectedUpdates+parseInt((ce=E.status.total.responsesRejected)!=null?ce:"0",10),dpVersion:((ue=E.version)==null?void 0:ue.kumaDp.version)||n.dpVersion,envoyVersion:((pe=E.version)==null?void 0:pe.envoy.version)||n.envoyVersion,selectedTime:n.selectedTime,selectedUpdateTime:n.selectedUpdateTime,version:E.version||n.version}},Ie),M={name:_,nameRoute:i,mesh:l,meshRoute:m,zone:X!=null?X:"\u2014",service:T!=null?T:"\u2014",serviceInsightRoute:ne,protocol:N!=null?N:"\u2014",status:Ae,totalUpdates:b.totalUpdates,totalRejectedUpdates:b.totalRejectedUpdates,dpVersion:(ie=b.dpVersion)!=null?ie:"\u2014",envoyVersion:(re=b.envoyVersion)!=null?re:"\u2014",warnings:[],unsupportedEnvoyVersion:!1,unsupportedKumaDPVersion:!1,kumaDpAndKumaCpMismatch:!1,lastUpdated:b.selectedUpdateTime?ye(new Date(b.selectedUpdateTime).toUTCString()):"\u2014",lastConnected:b.selectedTime?ye(new Date(b.selectedTime).toUTCString()):"\u2014",type:je(t.dataplane)};if(b.version){const{kind:n}=He(b.version);switch(n!==Be&&M.warnings.push(n),n){case Ge:M.unsupportedEnvoyVersion=!0;break;case qe:M.unsupportedKumaDPVersion=!0;break}}return $.value&&b.dpVersion&&x.find(E=>E.label===Ye)&&typeof b.version.kumaDp.kumaCpCompatible=="boolean"&&!b.version.kumaDp.kumaCpCompatible&&(M.warnings.push(Fe),M.kumaDpAndKumaCpMismatch=!0),M}async function Q(t){var i;V.value=!0,w.value=t,ee("offset",t>0?t:null);const l=A.params.mesh,_=f;try{const{items:m,next:B}=await Me.getAllDataplaneOverviewsFromMesh({mesh:l},{size:_,offset:t});if(Array.isArray(m)&&m.length>0){m.sort(function(T,N){return T.name===N.name?T.mesh>N.mesh?1:-1:T.name.localeCompare(N.name)}),d.value=B,s.value=m,W((i=p.name)!=null?i:m[0].name);const x=await Promise.all(s.value.map(T=>Ee(T)));y.value.data=x,c.value=!1,g.value=!1}else W(null),y.value.data=[],c.value=!0,g.value=!0}catch(m){r.value=!0,g.value=!0,console.error(m)}finally{V.value=!1}}function W(t){var l;t&&s.value.length>0?(C.value=(l=s.value.find(_=>_.name===t))!=null?l:s.value[0],ee("name",C.value.name)):(C.value=null,ee("name",null))}return(t,l)=>(o(),z(tt,null,{content:L(()=>{var _;return[H(at,{"selected-entity-name":(_=C.value)==null?void 0:_.name,"page-size":f,"has-error":r.value,"is-loading":V.value,"empty-state":Ve(),"table-data":u(F),"table-data-is-empty":c.value,"show-details":"",next:d.value!==null,"page-offset":w.value,onTableAction:l[1]||(l[1]=i=>W(i.name)),onLoadData:l[2]||(l[2]=i=>Q(i))},{additionalControls:L(()=>[e("div",null,[Kt,Ze(e("select",{id:"data-planes-type-filter","onUpdate:modelValue":l[0]||(l[0]=i=>D.value=i),"data-testid":"data-planes-type-filter"},[(o(),v(I,null,R(O,(i,m)=>e("option",{key:m,value:i},k(i),9,Ot)),64))],512),[[Qe,D.value]])]),H(u(We),{label:"Columns",icon:"cogwheel","button-appearance":"outline"},{items:L(()=>[e("div",{onClick:Pe},[(o(!0),v(I,null,R(u(Z),(i,m)=>(o(),z(u(Xe),{key:m,class:"table-header-selector-item",item:i},{default:L(()=>[e("label",{for:`data-plane-table-header-checkbox-${m}`,class:"k-checkbox table-header-selector-item-checkbox"},[e("input",{id:`data-plane-table-header-checkbox-${m}`,checked:i.isChecked,type:"checkbox",class:"k-input",onChange:B=>Se(B,i.tableHeaderKey)},null,40,Nt),q(" "+k(i.label),1)],8,Lt)]),_:2},1032,["item"]))),128))])]),_:1}),H(u(_e),{class:"add-dp-button",appearance:"primary",to:u(Y),"data-testid":"data-plane-create-data-plane-button",onClick:Ue},{default:L(()=>[Rt,q(" Create data plane proxy ")]),_:1},8,["to"]),u(A).query.ns?(o(),z(u(_e),{key:0,appearance:"primary",to:{name:"data-plane-list-view"},"data-testid":"data-plane-ns-back-button"},{default:L(()=>[$t,q(" View All ")]),_:1})):j("",!0)]),_:1},8,["selected-entity-name","has-error","is-loading","empty-state","table-data","table-data-is-empty","next","page-offset"])]}),sidebar:L(()=>[C.value!==null?(o(),z(Vt,{key:0,"data-plane-overview":C.value},null,8,["data-plane-overview"])):(o(),z(lt,{key:1}))]),_:1}))}});const Wt=we(xt,[["__scopeId","data-v-9fa1cc22"]]);export{Wt as default};
