import{d as _e,f as C,cB as ge,cw as ve,cC as be,cD as Ke,cE as Oe,o as i,j as v,l as e,a as L,w as E,b as B,t as g,A as Le,u as d,z as x,F as I,n as M,K as Ne,i as Re,B as ke,C as De,D as we,p as $e,r as T,g as xe,V as fe,k as Me,c as H,m as ze,cF as je,cG as He,cH as Be,e as ye,q as Ge,E as qe,G as Ye,cu as he,cI as Fe,cJ as Ze,cK as Je,cy as Qe,cz as We,cL as Xe,cx as et}from"./index.7fb3bbf1.js";import{C as tt}from"./ContentWrapper.bb3d1fb1.js";import{D as at}from"./DataOverview.b260f3d9.js";import{T as nt}from"./TagList.e2aa7193.js";import{Y as st}from"./YamlView.77c21317.js";import{_ as lt}from"./EmptyBlock.vue_vue_type_script_setup_true_lang.4c2c295a.js";import"./ErrorBlock.ea8501b0.js";import"./LoadingBlock.vue_vue_type_script_setup_true_lang.489330d0.js";import"./index.58caa11d.js";import"./CodeBlock.vue_vue_type_style_index_0_lang.69d70663.js";import"./_commonjsHelpers.f037b798.js";const V=a=>(ke("data-v-3700a709"),a=a(),De(),a),ot={class:"entity-summary entity-section-list"},it={class:"entity-title"},rt=V(()=>e("span",{class:"kutil-sr-only"},"Data plane proxy:",-1)),dt={class:"definition"},ct=V(()=>e("span",null,"Mesh:",-1)),ut={key:0},pt=V(()=>e("h4",null,"Tags",-1)),mt={key:1},vt=V(()=>e("h4",null,"Dependencies",-1)),ft={class:"mt-2 heading-with-icon"},yt=V(()=>e("h4",null,"Insights",-1)),ht={class:"entity-section-list"},_t=["data-testid"],gt=V(()=>e("span",null,"Connect time:",-1)),bt=["data-testid"],kt=V(()=>e("span",null,"Disconnect time:",-1)),Dt={class:"definition"},wt=V(()=>e("span",null,"Control plane instance ID:",-1)),Tt={key:0},Ct=V(()=>e("summary",null," Responses (acknowledged / sent) ",-1)),Pt=["data-testid"],Ut=_e({__name:"DataPlaneEntitySummary",props:{dataPlaneOverview:{type:Object,required:!0}},setup(a){const m=a,h={"Partially degraded":"partially_degraded",Offline:"offline",Online:"online"},Z=C(()=>{const{name:p,mesh:r,dataplane:f}=m.dataPlaneOverview;return{type:"Dataplane",name:p,mesh:r,networking:f.networking}}),S=C(()=>ge(m.dataPlaneOverview.dataplane)),z=C(()=>{const p=Array.from(m.dataPlaneOverview.dataplaneInsight.subscriptions);return p.reverse(),p.map(r=>{const f=r.connectTime!==void 0?ve(r.connectTime):"\u2014",l=r.disconnectTime!==void 0?ve(r.disconnectTime):"\u2014",c=Object.entries(r.status).filter(([b])=>!["total","lastUpdateTime"].includes(b)).map(([b,k])=>{var G,N,q,Y,F;const D=`${(G=k.responsesAcknowledged)!=null?G:0} / ${(N=k.responsesSent)!=null?N:0}`;return{type:b.toUpperCase(),ratio:D,responsesSent:(q=k.responsesSent)!=null?q:0,responsesAcknowledged:(Y=k.responsesAcknowledged)!=null?Y:0,responsesRejected:(F=k.responsesRejected)!=null?F:0}});return{subscription:r,formattedConnectDate:f,formattedDisconnectDate:l,statuses:c}})}),P=C(()=>{const{status:p}=be(m.dataPlaneOverview.dataplane,m.dataPlaneOverview.dataplaneInsight);return Ke[h[p]]}),A=C(()=>{const p=Oe(m.dataPlaneOverview.dataplaneInsight);return p!==null?Object.entries(p).map(([r,f])=>({name:r,version:f})):[]}),K=C(()=>{const{subscriptions:p}=m.dataPlaneOverview.dataplaneInsight;if(p.length===0)return[];const r=p[p.length-1];if(!r.version)return[];const f=[],l=r.version.envoy,c=r.version.kumaDp;if(!(l.kumaDpCompatible!==void 0?l.kumaDpCompatible:!0)){const D=`Envoy ${l.version} is not supported by Kuma DP ${c.version}.`;f.push(D)}if(!(c.kumaCpCompatible!==void 0?c.kumaCpCompatible:!0)){const D=`Kuma DP ${c.version} is not supported by this Kuma control plane.`;f.push(D)}return f});return(p,r)=>{const f=Re("router-link");return i(),v("div",ot,[e("section",null,[e("h3",it,[rt,L(f,{to:{name:"data-plane-detail-view",params:{mesh:a.dataPlaneOverview.mesh,dataPlane:a.dataPlaneOverview.name}}},{default:E(()=>[B(g(a.dataPlaneOverview.name),1)]),_:1},8,["to"]),e("div",{class:Le(`status status--${d(P).appearance}`),"data-testid":"data-plane-status-badge"},g(d(P).title.toLowerCase()),3)]),e("div",dt,[ct,e("span",null,g(a.dataPlaneOverview.mesh),1)])]),d(S).length>0?(i(),v("section",ut,[pt,L(nt,{tags:d(S)},null,8,["tags"])])):x("",!0),d(A).length>0?(i(),v("section",mt,[vt,(i(!0),v(I,null,M(d(A),(l,c)=>(i(),v("div",{key:c,class:"definition"},[e("span",null,g(l.name)+":",1),e("span",null,g(l.version),1)]))),128)),d(K).length>0?(i(),v(I,{key:0},[e("h5",ft,[B(" Warnings "),L(d(Ne),{class:"ml-1",icon:"warning",color:"var(--black-75)","secondary-color":"var(--yellow-300)",size:"20"})]),(i(!0),v(I,null,M(d(K),(l,c)=>(i(),v("p",{key:c},g(l),1))),128))],64)):x("",!0)])):x("",!0),d(z).length>0?(i(),v(I,{key:2},[e("section",null,[yt,e("div",ht,[(i(!0),v(I,null,M(d(z),(l,c)=>(i(),v("div",{key:c},[e("div",{class:"definition","data-testid":`data-plane-connect-time-${c}`},[gt,e("span",null,g(l.formattedConnectDate),1)],8,_t),e("div",{class:"definition","data-testid":`data-plane-disconnect-time-${c}`},[kt,e("span",null,g(l.formattedDisconnectDate),1)],8,bt),e("div",Dt,[wt,e("span",null,g(l.subscription.controlPlaneInstanceId),1)]),l.statuses.length>0?(i(),v("details",Tt,[Ct,(i(!0),v(I,null,M(l.statuses,(b,k)=>(i(),v("div",{key:`${c}-${k}`,class:"definition","data-testid":`data-plane-subscription-status-${c}-${k}`},[e("span",null,g(b.type)+":",1),e("span",null,g(b.ratio),1)],8,Pt))),128))])):x("",!0)]))),128))])]),e("section",null,[L(st,{id:"code-block-data-plane-summary",content:d(Z),"code-max-height":"250px"},null,8,["content"])])],64)):x("",!0)])}}});const Vt=we(Ut,[["__scopeId","data-v-3700a709"]]),Te=[{key:"status",label:"Status"},{key:"name",label:"Name"},{key:"mesh",label:"Mesh"},{key:"type",label:"Type"},{key:"service",label:"Service"},{key:"protocol",label:"Protocol"},{key:"zone",label:"Zone"},{key:"lastConnected",label:"Last Connected"},{key:"lastUpdated",label:"Last Updated"},{key:"totalUpdates",label:"Total Updates"},{key:"dpVersion",label:"Kuma DP version"},{key:"envoyVersion",label:"Envoy version"},{key:"details",label:"Details",hideLabel:!0}],Et=["name","details"],It=Te.filter(a=>!Et.includes(a.key)).map(a=>({tableHeaderKey:a.key,label:a.label,isChecked:!1})),Ce=["status","name","mesh","type","service","protocol","zone","lastUpdated","dpVersion","details"];function St(a,m=Ce){return Te.filter(h=>m.includes(h.key)?a?!0:h.key!=="zone":!1)}function ee(a,m){const h=new URL(window.location.href);m!=null?h.searchParams.set(a,String(m)):h.searchParams.has(a)&&h.searchParams.delete(a),window.history.replaceState({path:h.href},"",h.href)}const te=a=>(ke("data-v-b12ab631"),a=a(),De(),a),At=te(()=>e("label",{for:"data-planes-type-filter",class:"mr-2"}," Type: ",-1)),Kt=["value"],Ot=["for"],Lt=["id","checked","onChange"],Nt=te(()=>e("span",{class:"custom-control-icon"}," + ",-1)),Rt=te(()=>e("span",{class:"custom-control-icon"}," \u2190 ",-1)),$t=_e({__name:"DataPlaneListView",props:{name:{type:String,required:!1,default:null},offset:{type:Number,required:!1,default:0}},setup(a){const m=a,h=50,Z=["All","Standard","Gateway (builtin)","Gateway (delegated)"],S=$e(),z=Ge(),P=T(Ce),A=T(!0),K=T(!1),p=T(null),r=T(!1),f=T({headers:[],data:[]}),l=T([]),c=T(null),b=T("All"),k=T(m.offset),D=T(null),G=C(()=>z.getters["config/getEnvironment"]),N=C(()=>z.getters["config/getMulticlusterStatus"]),q=C(()=>G.value==="universal"?{name:"universal-dataplane"}:{name:"kubernetes-dataplane"}),Y=C(()=>{const t=f.value.data.filter(y=>b.value==="All"?!0:y.type.toLowerCase()===b.value.toLowerCase()),s=St(N.value,P.value);return{data:t,headers:s}}),F=C(()=>It.filter(t=>N.value?!0:t.tableHeaderKey!=="zone").map(t=>{const s=P.value.includes(t.tableHeaderKey);return{...t,isChecked:s}}));xe(()=>S.params.mesh,function(){S.name==="data-plane-list-view"&&(A.value=!0,K.value=!1,p.value=null,r.value=!1,J(0))});const ae=fe.get("dpVisibleTableHeaderKeys");Array.isArray(ae)&&(P.value=ae),J(m.offset);function Pe(t){t.stopPropagation()}function Ue(t,s){const y=t.target,o=P.value.findIndex(u=>u===s);y.checked&&o===-1?P.value.push(s):!y.checked&&o>-1&&P.value.splice(o,1),fe.set("dpVisibleTableHeaderKeys",Array.from(new Set(P.value)))}function Ve(){qe.logger.info(Ye.CREATE_DATA_PLANE_PROXY_CLICKED)}function Ee(){return{title:"No Data",message:"There are no data plane proxies present."}}async function Ie(t){var se,le,oe,ie,re;const s=t.mesh,y=t.name,o={name:"data-plane-detail-view",params:{mesh:s,dataPlane:y}},u={name:"mesh-detail-view",params:{mesh:s}},j=["kuma.io/protocol","kuma.io/service","kuma.io/zone"],R=ge(t.dataplane).filter(n=>j.includes(n.label)),w=(se=R.find(n=>n.label==="kuma.io/service"))==null?void 0:se.value,O=(le=R.find(n=>n.label==="kuma.io/protocol"))==null?void 0:le.value,W=(oe=R.find(n=>n.label==="kuma.io/zone"))==null?void 0:oe.value;let ne;w!==void 0&&(ne={name:"service-insight-detail-view",params:{mesh:s,service:w}});const{status:Se}=be(t.dataplane,t.dataplaneInsight),Ae={totalUpdates:0,totalRejectedUpdates:0,dpVersion:null,envoyVersion:null,selectedTime:NaN,selectedUpdateTime:NaN,version:null},_=t.dataplaneInsight.subscriptions.reduce((n,U)=>{var de,ce,ue,pe;if(U.connectTime){const me=Date.parse(U.connectTime);(!n.selectedTime||me>n.selectedTime)&&(n.selectedTime=me)}const X=Date.parse(U.status.lastUpdateTime);return X&&(!n.selectedUpdateTime||X>n.selectedUpdateTime)&&(n.selectedUpdateTime=X),{totalUpdates:n.totalUpdates+parseInt((de=U.status.total.responsesSent)!=null?de:"0",10),totalRejectedUpdates:n.totalRejectedUpdates+parseInt((ce=U.status.total.responsesRejected)!=null?ce:"0",10),dpVersion:((ue=U.version)==null?void 0:ue.kumaDp.version)||n.dpVersion,envoyVersion:((pe=U.version)==null?void 0:pe.envoy.version)||n.envoyVersion,selectedTime:n.selectedTime,selectedUpdateTime:n.selectedUpdateTime,version:U.version||n.version}},Ae),$={name:y,nameRoute:o,mesh:s,meshRoute:u,zone:W!=null?W:"\u2014",service:w!=null?w:"\u2014",serviceInsightRoute:ne,protocol:O!=null?O:"\u2014",status:Se,totalUpdates:_.totalUpdates,totalRejectedUpdates:_.totalRejectedUpdates,dpVersion:(ie=_.dpVersion)!=null?ie:"\u2014",envoyVersion:(re=_.envoyVersion)!=null?re:"\u2014",warnings:[],unsupportedEnvoyVersion:!1,unsupportedKumaDPVersion:!1,kumaDpAndKumaCpMismatch:!1,lastUpdated:_.selectedUpdateTime?he(new Date(_.selectedUpdateTime).toUTCString()):"\u2014",lastConnected:_.selectedTime?he(new Date(_.selectedTime).toUTCString()):"\u2014",type:Fe(t.dataplane)};if(_.version){const{kind:n}=Ze(_.version);switch(n!==Je&&$.warnings.push(n),n){case We:$.unsupportedEnvoyVersion=!0;break;case Qe:$.unsupportedKumaDPVersion=!0;break}}return N.value&&_.dpVersion&&R.find(U=>U.label===Xe)&&typeof _.version.kumaDp.kumaCpCompatible=="boolean"&&!_.version.kumaDp.kumaCpCompatible&&($.warnings.push(et),$.kumaDpAndKumaCpMismatch=!0),$}async function J(t){var o;A.value=!0,k.value=t,ee("offset",t>0?t:null);const s=S.params.mesh,y=h;try{const{items:u,next:j}=await Me.getAllDataplaneOverviewsFromMesh({mesh:s},{size:y,offset:t});if(Array.isArray(u)&&u.length>0){u.sort(function(w,O){return w.name===O.name?w.mesh>O.mesh?1:-1:w.name.localeCompare(O.name)}),c.value=j,l.value=u,Q((o=m.name)!=null?o:u[0].name);const R=await Promise.all(l.value.map(w=>Ie(w)));f.value.data=R,r.value=!1,K.value=!1}else Q(null),f.value.data=[],r.value=!0,K.value=!0}catch(u){u instanceof Error?p.value=u:console.error(u),K.value=!0}finally{A.value=!1}}function Q(t){var s;t&&l.value.length>0?(D.value=(s=l.value.find(y=>y.name===t))!=null?s:l.value[0],ee("name",D.value.name)):(D.value=null,ee("name",null))}return(t,s)=>(i(),H(tt,null,{content:E(()=>{var y;return[L(at,{"selected-entity-name":(y=D.value)==null?void 0:y.name,"page-size":h,"is-loading":A.value,error:p.value,"empty-state":Ee(),"table-data":d(Y),"table-data-is-empty":r.value,"show-details":"",next:c.value!==null,"page-offset":k.value,onTableAction:s[1]||(s[1]=o=>Q(o.name)),onLoadData:s[2]||(s[2]=o=>J(o))},{additionalControls:E(()=>[e("div",null,[At,ze(e("select",{id:"data-planes-type-filter","onUpdate:modelValue":s[0]||(s[0]=o=>b.value=o),"data-testid":"data-planes-type-filter"},[(i(),v(I,null,M(Z,(o,u)=>e("option",{key:u,value:o},g(o),9,Kt)),64))],512),[[je,b.value]])]),L(d(He),{label:"Columns",icon:"cogwheel","button-appearance":"outline"},{items:E(()=>[e("div",{onClick:Pe},[(i(!0),v(I,null,M(d(F),(o,u)=>(i(),H(d(Be),{key:u,class:"table-header-selector-item",item:o},{default:E(()=>[e("label",{for:`data-plane-table-header-checkbox-${u}`,class:"k-checkbox table-header-selector-item-checkbox"},[e("input",{id:`data-plane-table-header-checkbox-${u}`,checked:o.isChecked,type:"checkbox",class:"k-input",onChange:j=>Ue(j,o.tableHeaderKey)},null,40,Lt),B(" "+g(o.label),1)],8,Ot)]),_:2},1032,["item"]))),128))])]),_:1}),L(d(ye),{class:"add-dp-button",appearance:"primary",to:d(q),"data-testid":"data-plane-create-data-plane-button",onClick:Ve},{default:E(()=>[Nt,B(" Create data plane proxy ")]),_:1},8,["to"]),d(S).query.ns?(i(),H(d(ye),{key:0,appearance:"primary",to:{name:"data-plane-list-view"},"data-testid":"data-plane-ns-back-button"},{default:E(()=>[Rt,B(" View All ")]),_:1})):x("",!0)]),_:1},8,["selected-entity-name","is-loading","error","empty-state","table-data","table-data-is-empty","next","page-offset"])]}),sidebar:E(()=>[D.value!==null?(i(),H(Vt,{key:0,"data-plane-overview":D.value},null,8,["data-plane-overview"])):(i(),H(lt,{key:1}))]),_:1}))}});const Jt=we($t,[["__scopeId","data-v-b12ab631"]]);export{Jt as default};
