import{d as ge,j as P,cz as be,a4 as ve,cA as ke,cB as $e,cC as Le,o as i,e as v,f as e,a as j,w as L,b as B,t as b,p as Ne,m as u,F as A,h as N,c as M,n as z,C as Re,r as xe,x as De,y as we,_ as Ce,u as Me,i as T,k as ze,S as fe,K as ye,q as je,a2 as _e,cD as He,cE as Be,cF as qe,a7 as Ge,a8 as Ye,cG as Fe,a6 as Ze,g as Qe,cH as Je,cI as We,cJ as Xe,z as he,A as et,B as tt}from"./index.ff83acd2.js";import{C as at}from"./ContentWrapper.e0e4aa44.js";import{D as nt}from"./DataOverview.e89d4fb7.js";import{E as st}from"./EntityTag.94d06403.js";import{Y as lt}from"./YamlView.c808cec1.js";import{_ as ot}from"./EmptyBlock.vue_vue_type_script_setup_true_lang.a3bd4170.js";import"./ErrorBlock.f11c1f94.js";import"./LoadingBlock.vue_vue_type_script_setup_true_lang.3473bd21.js";import"./index.58caa11d.js";import"./CodeBlock.9a481ee8.js";import"./_commonjsHelpers.712cc82f.js";const K=a=>(De("data-v-a0dca689"),a=a(),we(),a),it={class:"entity-summary entity-section-list"},rt={class:"entity-title"},dt=K(()=>e("span",{class:"kutil-sr-only"},"Data plane:",-1)),ct={class:"definition"},ut=K(()=>e("span",null,"Mesh:",-1)),pt={key:0},mt=K(()=>e("h4",null,"Tags",-1)),vt={class:"tag-list"},ft={key:1},yt=K(()=>e("h4",null,"Dependencies",-1)),_t={class:"mt-2 heading-with-icon"},ht=K(()=>e("h4",null,"Insights",-1)),gt={class:"entity-section-list"},bt=["data-testid"],kt=K(()=>e("span",null,"Connect time:",-1)),Dt=["data-testid"],wt=K(()=>e("span",null,"Disconnect time:",-1)),Ct={class:"definition"},Tt=K(()=>e("span",null,"Control plane instance ID:",-1)),Pt={key:0},St=K(()=>e("summary",null," Responses (acknowledged / sent) ",-1)),Ut=["data-testid"],Vt=ge({__name:"DataPlaneEntitySummary",props:{dataPlaneOverview:{type:Object,required:!0}},setup(a){const p=a,f={"Partially degraded":"partially_degraded",Offline:"offline",Online:"online"},O=P(()=>{const{name:r,mesh:c,dataplane:y}=p.dataPlaneOverview;return{type:"Dataplane",name:r,mesh:c,networking:y.networking}}),$=P(()=>be(p.dataPlaneOverview.dataplane)),S=P(()=>{const r=Array.from(p.dataPlaneOverview.dataplaneInsight.subscriptions);return r.reverse(),r.map(c=>{const y=c.connectTime!==void 0?ve(c.connectTime):"\u2014",o=c.disconnectTime!==void 0?ve(c.disconnectTime):"\u2014",d=Object.entries(c.status).filter(([k])=>!["total","lastUpdateTime"].includes(k)).map(([k,D])=>{var q,R,G,Y,F;const w=`${(q=D.responsesAcknowledged)!=null?q:0} / ${(R=D.responsesSent)!=null?R:0}`;return{type:k.toUpperCase(),ratio:w,responsesSent:(G=D.responsesSent)!=null?G:0,responsesAcknowledged:(Y=D.responsesAcknowledged)!=null?Y:0,responsesRejected:(F=D.responsesRejected)!=null?F:0}});return{subscription:c,formattedConnectDate:y,formattedDisconnectDate:o,statuses:d}})}),_=P(()=>{const{status:r}=ke(p.dataPlaneOverview.dataplane,p.dataPlaneOverview.dataplaneInsight);return $e[f[r]]}),U=P(()=>{const r=Le(p.dataPlaneOverview.dataplaneInsight);return r!==null?Object.entries(r).map(([c,y])=>({name:c,version:y})):[]}),h=P(()=>{const{subscriptions:r}=p.dataPlaneOverview.dataplaneInsight;if(r.length===0)return[];const c=r[r.length-1];if(!c.version)return[];const y=[],o=c.version.envoy,d=c.version.kumaDp;if(!(o.kumaDpCompatible!==void 0?o.kumaDpCompatible:!0)){const w=`Envoy ${o.version} is not supported by Kuma DP ${d.version}.`;y.push(w)}if(!(d.kumaCpCompatible!==void 0?d.kumaCpCompatible:!0)){const w=`Kuma DP ${d.version} is not supported by this Kuma control plane.`;y.push(w)}return y});return(r,c)=>{const y=xe("router-link");return i(),v("div",it,[e("section",null,[e("h3",rt,[dt,j(y,{to:{name:"data-plane-detail-view",params:{mesh:a.dataPlaneOverview.mesh,dataPlane:a.dataPlaneOverview.name}}},{default:L(()=>[B(b(a.dataPlaneOverview.name),1)]),_:1},8,["to"]),e("div",{class:Ne(`status status--${u(_).appearance}`),"data-testid":"data-plane-status-badge"},b(u(_).title.toLowerCase()),3)]),e("div",ct,[ut,e("span",null,b(a.dataPlaneOverview.mesh),1)])]),u($).length>0?(i(),v("section",pt,[mt,e("div",vt,[(i(!0),v(A,null,N(u($),(o,d)=>(i(),M(st,{key:d,tag:o},null,8,["tag"]))),128))])])):z("",!0),u(U).length>0?(i(),v("section",ft,[yt,(i(!0),v(A,null,N(u(U),(o,d)=>(i(),v("div",{key:d,class:"definition"},[e("span",null,b(o.name)+":",1),e("span",null,b(o.version),1)]))),128)),u(h).length>0?(i(),v(A,{key:0},[e("h5",_t,[B(" Warnings "),j(u(Re),{class:"ml-1",icon:"warning",color:"var(--black-75)","secondary-color":"var(--yellow-300)",size:"20"})]),(i(!0),v(A,null,N(u(h),(o,d)=>(i(),v("p",{key:d},b(o),1))),128))],64)):z("",!0)])):z("",!0),u(S).length>0?(i(),v(A,{key:2},[e("section",null,[ht,e("div",gt,[(i(!0),v(A,null,N(u(S),(o,d)=>(i(),v("div",{key:d},[e("div",{class:"definition","data-testid":`data-plane-connect-time-${d}`},[kt,e("span",null,b(o.formattedConnectDate),1)],8,bt),e("div",{class:"definition","data-testid":`data-plane-disconnect-time-${d}`},[wt,e("span",null,b(o.formattedDisconnectDate),1)],8,Dt),e("div",Ct,[Tt,e("span",null,b(o.subscription.controlPlaneInstanceId),1)]),o.statuses.length>0?(i(),v("details",Pt,[St,(i(!0),v(A,null,N(o.statuses,(k,D)=>(i(),v("div",{key:`${d}-${D}`,class:"definition","data-testid":`data-plane-subscription-status-${d}-${D}`},[e("span",null,b(k.type)+":",1),e("span",null,b(k.ratio),1)],8,Ut))),128))])):z("",!0)]))),128))])]),e("section",null,[j(lt,{id:"code-block-data-plane-summary",content:u(O),"code-max-height":"250px"},null,8,["content"])])],64)):z("",!0)])}}});const Et=Ce(Vt,[["__scopeId","data-v-a0dca689"]]),Te=[{key:"status",label:"Status"},{key:"name",label:"Name"},{key:"mesh",label:"Mesh"},{key:"type",label:"Type"},{key:"service",label:"Service"},{key:"protocol",label:"Protocol"},{key:"zone",label:"Zone"},{key:"lastConnected",label:"Last Connected"},{key:"lastUpdated",label:"Last Updated"},{key:"totalUpdates",label:"Total Updates"},{key:"dpVersion",label:"Kuma DP version"},{key:"envoyVersion",label:"Envoy version"},{key:"details",label:"Details",hideLabel:!0}],It=["name","details"],At=Te.filter(a=>!It.includes(a.key)).map(a=>({tableHeaderKey:a.key,label:a.label,isChecked:!1})),Pe=["status","name","mesh","type","service","protocol","zone","lastUpdated","dpVersion","details"];function Kt(a,p=Pe){return Te.filter(f=>p.includes(f.key)?a?!0:f.key!=="zone":!1)}function ee(a,p){const f=window.history.state;if(f===null)return;const O=f.current.indexOf("?"),$=O>-1?f.current.substring(O):"",S=new URLSearchParams($);p!=null?S.set(a,String(p)):S.has(a)&&S.delete(a);const _=S.toString(),U=_===""?"":"?"+_;let h="";if(O>-1?h=f.current.substring(0,O)+U:h=f.current+U,f.current!==h){const r=Object.assign({},f);r.current=h,window.history.replaceState(r,"","#"+h)}}const te=a=>(De("data-v-bee730dc"),a=a(),we(),a),Ot=te(()=>e("label",{for:"data-planes-type-filter",class:"mr-2"}," Type: ",-1)),$t=["value"],Lt=["for"],Nt=["id","checked","onChange"],Rt=te(()=>e("span",{class:"custom-control-icon"}," + ",-1)),xt=te(()=>e("span",{class:"custom-control-icon"}," \u2190 ",-1)),Mt=ge({__name:"DataPlaneListView",props:{name:{type:String,required:!1,default:null},offset:{type:Number,required:!1,default:0}},setup(a){const p=a,f=50,O=["All","Standard","Gateway (builtin)","Gateway (provided)"],$=Me(),S=je(),_=T(Pe),U=T(!0),h=T(!1),r=T(!1),c=T(!1),y=T({headers:[],data:[]}),o=T([]),d=T(null),k=T("All"),D=T(p.offset),w=T(null),q=P(()=>S.getters["config/getEnvironment"]),R=P(()=>S.getters["config/getMulticlusterStatus"]),G=P(()=>q.value==="universal"?{name:"universal-dataplane"}:{name:"kubernetes-dataplane"}),Y=P(()=>{const t=y.value.data.filter(m=>k.value==="All"?!0:m.type.toLowerCase()===k.value.toLowerCase()),l=Kt(R.value,_.value);return{data:t,headers:l}}),F=P(()=>At.filter(t=>R.value?!0:t.tableHeaderKey!=="zone").map(t=>{const l=_.value.includes(t.tableHeaderKey);return{...t,isChecked:l}}));ze(()=>$.params.mesh,function(){$.name==="data-plane-list-view"&&(U.value=!0,h.value=!1,r.value=!1,c.value=!1,Z(0))});const ae=fe.get("dpVisibleTableHeaderKeys");Array.isArray(ae)&&(_.value=ae),Z(p.offset);function Se(t){t.stopPropagation()}function Ue(t,l){const m=t.target,n=_.value.findIndex(C=>C===l);m.checked&&n===-1?_.value.push(l):!m.checked&&n>-1&&_.value.splice(n,1),fe.set("dpVisibleTableHeaderKeys",Array.from(new Set(_.value)))}function Ve(){et.logger.info(tt.CREATE_DATA_PLANE_PROXY_CLICKED)}function Ee(){return{title:"No Data",message:"There are no data plane proxies present."}}async function Ie(t){var se,le,oe,ie,re;const l=t.mesh,m=t.name,n={name:"data-plane-detail-view",params:{mesh:l,dataPlane:m}},C={name:"mesh-child",params:{mesh:l}},H=["kuma.io/protocol","kuma.io/service","kuma.io/zone"],V=be(t.dataplane).filter(s=>H.includes(s.label)),I=(se=V.find(s=>s.label==="kuma.io/service"))==null?void 0:se.value,J=(le=V.find(s=>s.label==="kuma.io/protocol"))==null?void 0:le.value,W=(oe=V.find(s=>s.label==="kuma.io/zone"))==null?void 0:oe.value;let ne;I!==void 0&&(ne={name:"service-insight-detail-view",params:{mesh:l,service:I}});const{status:Ke}=ke(t.dataplane,t.dataplaneInsight),Oe={totalUpdates:0,totalRejectedUpdates:0,dpVersion:null,envoyVersion:null,selectedTime:NaN,selectedUpdateTime:NaN,version:null},g=t.dataplaneInsight.subscriptions.reduce((s,E)=>{var de,ce,ue,pe;if(E.connectTime){const me=Date.parse(E.connectTime);(!s.selectedTime||me>s.selectedTime)&&(s.selectedTime=me)}const X=Date.parse(E.status.lastUpdateTime);return X&&(!s.selectedUpdateTime||X>s.selectedUpdateTime)&&(s.selectedUpdateTime=X),{totalUpdates:s.totalUpdates+parseInt((de=E.status.total.responsesSent)!=null?de:"0",10),totalRejectedUpdates:s.totalRejectedUpdates+parseInt((ce=E.status.total.responsesRejected)!=null?ce:"0",10),dpVersion:((ue=E.version)==null?void 0:ue.kumaDp.version)||s.dpVersion,envoyVersion:((pe=E.version)==null?void 0:pe.envoy.version)||s.envoyVersion,selectedTime:s.selectedTime,selectedUpdateTime:s.selectedUpdateTime,version:E.version||s.version}},Oe),x={name:m,nameRoute:n,mesh:l,meshRoute:C,zone:W!=null?W:"\u2014",service:I!=null?I:"\u2014",serviceInsightRoute:ne,protocol:J!=null?J:"\u2014",status:Ke,totalUpdates:g.totalUpdates,totalRejectedUpdates:g.totalRejectedUpdates,dpVersion:(ie=g.dpVersion)!=null?ie:"\u2014",envoyVersion:(re=g.envoyVersion)!=null?re:"\u2014",warnings:[],unsupportedEnvoyVersion:!1,unsupportedKumaDPVersion:!1,kumaDpAndKumaCpMismatch:!1,lastUpdated:g.selectedUpdateTime?_e(new Date(g.selectedUpdateTime).toUTCString()):"\u2014",lastConnected:g.selectedTime?_e(new Date(g.selectedTime).toUTCString()):"\u2014",type:He(t.dataplane)};if(g.version){const{kind:s}=Be(g.version);switch(s!==qe&&x.warnings.push(s),s){case Ye:x.unsupportedEnvoyVersion=!0;break;case Ge:x.unsupportedKumaDPVersion=!0;break}}return R.value&&g.dpVersion&&V.find(E=>E.label===Fe)&&typeof g.version.kumaDp.kumaCpCompatible=="boolean"&&!g.version.kumaDp.kumaCpCompatible&&(x.warnings.push(Ze),x.kumaDpAndKumaCpMismatch=!0),x}async function Z(t){var m;U.value=!0,D.value=t,ee("offset",t>0?t:null);const l=$.params.mesh||null;try{const{items:n,next:C}=await Ae(l,f,t);if(n.length>0){n.sort(function(V,I){return V.name===I.name?V.mesh>I.mesh?1:-1:V.name.localeCompare(I.name)}),d.value=C,o.value=n,Q((m=p.name)!=null?m:n[0].name);const H=await Promise.all(o.value.map(V=>Ie(V)));y.value.data=H,c.value=!1,h.value=!1}else Q(null),y.value.data=[],c.value=!0,h.value=!0}catch(n){r.value=!0,h.value=!0,console.error(n)}finally{U.value=!1}}function Ae(t,l,m){return t==="all"||t===null?ye.getAllDataplaneOverviews({size:l,offset:m}):ye.getAllDataplaneOverviewsFromMesh({mesh:t})}function Q(t){var l;t&&o.value.length>0?(w.value=(l=o.value.find(m=>m.name===t))!=null?l:o.value[0],ee("name",w.value.name)):(w.value=null,ee("name",null))}return(t,l)=>(i(),M(at,null,{content:L(()=>{var m;return[j(nt,{"selected-entity-name":(m=w.value)==null?void 0:m.name,"page-size":f,"has-error":r.value,"is-loading":U.value,"empty-state":Ee(),"table-data":u(Y),"table-data-is-empty":c.value,"show-details":"",next:d.value!==null,"page-offset":D.value,onTableAction:l[1]||(l[1]=n=>Q(n.name)),onLoadData:l[2]||(l[2]=n=>Z(n))},{additionalControls:L(()=>[e("div",null,[Ot,Qe(e("select",{id:"data-planes-type-filter","onUpdate:modelValue":l[0]||(l[0]=n=>k.value=n),"data-testid":"data-planes-type-filter"},[(i(),v(A,null,N(O,(n,C)=>e("option",{key:C,value:n},b(n),9,$t)),64))],512),[[Je,k.value]])]),j(u(We),{label:"Columns",icon:"cogwheel","button-appearance":"outline"},{items:L(()=>[e("div",{onClick:Se},[(i(!0),v(A,null,N(u(F),(n,C)=>(i(),M(u(Xe),{key:C,class:"table-header-selector-item",item:n},{default:L(()=>[e("label",{for:`data-plane-table-header-checkbox-${C}`,class:"k-checkbox table-header-selector-item-checkbox"},[e("input",{id:`data-plane-table-header-checkbox-${C}`,checked:n.isChecked,type:"checkbox",class:"k-input",onChange:H=>Ue(H,n.tableHeaderKey)},null,40,Nt),B(" "+b(n.label),1)],8,Lt)]),_:2},1032,["item"]))),128))])]),_:1}),j(u(he),{class:"add-dp-button",appearance:"primary",to:u(G),"data-testid":"data-plane-create-data-plane-button",onClick:Ve},{default:L(()=>[Rt,B(" Create data plane proxy ")]),_:1},8,["to"]),t.$route.query.ns?(i(),M(u(he),{key:0,appearance:"primary",to:{name:"data-plane-list-view"},"data-testid":"data-plane-ns-back-button"},{default:L(()=>[xt,B(" View All ")]),_:1})):z("",!0)]),_:1},8,["selected-entity-name","has-error","is-loading","empty-state","table-data","table-data-is-empty","next","page-offset"])]}),sidebar:L(()=>[w.value!==null?(i(),M(Et,{key:0,"data-plane-overview":w.value},null,8,["data-plane-overview"])):(i(),M(ot,{key:1}))]),_:1}))}});const Wt=Ce(Mt,[["__scopeId","data-v-bee730dc"]]);export{Wt as default};
