{
   "annotations": {
      "list": [
         {
            "datasource": {
               "type": "datasource",
               "uid": "grafana"
            },
            "enable": true,
            "hide": true,
            "iconColor": "rgba(0, 211, 255, 1)",
            "name": "Annotations & Alerts",
            "target": {
               "limit": 100,
               "matchAny": false,
               "tags": [ ],
               "type": "dashboard"
            },
            "type": "dashboard"
         }
      ]
   },
   "editable": true,
   "fiscalYearStartMonth": 0,
   "graphTooltip": 0,
   "links": [ ],
   "liveNow": false,
   "panels": [
      {
         "datasource": {
            "type": "prometheus",
            "uid": "${DS_PROMETHEUS}"
         },
         "fieldConfig": {
            "defaults": {
               "color": {
                  "mode": "fixed"
               },
               "thresholds": {
                  "mode": "absolute"
               }
            }
         },
         "id": 1,
         "targets": [
            {
               "expr": "count(envoy_server_live{kuma_io_services=~\".*$service.*\"})",
               "legendFormat": "",
               "refId": "A"
            }
         ],
         "title": "Dataplanes",
         "type": "stat"
      },
      {
         "datasource": {
            "type": "prometheus",
            "uid": "${DS_PROMETHEUS}"
         },
         "fieldConfig": {
            "defaults": {
               "color": {
                  "mode": "thresholds"
               }
            }
         },
         "id": 2,
         "targets": [
            {
               "expr": "sum(envoy_server_live{kuma_io_services=~\".*$service.*\"}) by (dataplane)",
               "instant": true,
               "legendFormat": "",
               "refId": "A"
            }
         ],
         "title": "Dataplanes",
         "transformations": [
            {
               "id": "labelsToFields",
               "options": { }
            },
            {
               "id": "merge",
               "options": { }
            },
            {
               "id": "organize",
               "options": { }
            },
            {
               "id": "merge",
               "options": { }
            }
         ],
         "type": "table"
      },
      {
         "datasource": {
            "type": "prometheus",
            "uid": "${DS_PROMETHEUS}"
         },
         "fieldConfig": {
            "defaults": {
               "color": {
                  "mode": "thresholds"
               }
            }
         },
         "id": 3,
         "targets": [
            {
               "expr": "sum(rate(envoy_cluster_upstream_rq_total{mesh=\"$mesh\",kuma_io_zone=~\"$zone\",kuma_io_services=~\".*$service.*\",envoy_cluster_name=~\"localhost_.*\"}[1m]))",
               "hide": false,
               "legendFormat": "",
               "refId": "C"
            }
         ],
         "title": "",
         "type": "stat"
      },
      {
         "datasource": {
            "type": "prometheus",
            "uid": "${DS_PROMETHEUS}"
         },
         "fieldConfig": {
            "defaults": {
               "color": {
                  "mode": "thresholds"
               }
            }
         },
         "id": 4,
         "targets": [
            {
               "expr": "sum(rate(envoy_cluster_upstream_rq_total{mesh=\"$mesh\",kuma_io_zone=~\"$zone\",kuma_io_services=~\".*$service.*\",envoy_cluster_name!~\"localhost_.*\",envoy_cluster_name!=\"kuma_envoy_admin\",envoy_cluster_name!=\"kuma_metrics_hijacker\"}[1m]))",
               "hide": false,
               "legendFormat": "",
               "refId": "C"
            }
         ],
         "title": "",
         "type": "stat"
      },
      {
         "collapsed": false,
         "datasource": {
            "type": "prometheus",
            "uid": "${DS_PROMETHEUS}"
         },
         "id": 5,
         "panels": [ ],
         "title": "HTTP",
         "type": "row"
      },
      {
         "datasource": {
            "type": "prometheus",
            "uid": "${DS_PROMETHEUS}"
         },
         "id": 6,
         "targets": [
            {
               "expr": "max(histogram_quantile(0.99, rate(envoy_cluster_upstream_rq_time_bucket{kuma_io_services=~\".*$service.*\",kuma_io_zone=~\"$zone\",mesh=\"$mesh\",envoy_cluster_name=~\"localhost_.*\"}[1m])))",
               "hide": false,
               "legendFormat": "p99",
               "refId": "A"
            },
            {
               "expr": "max(histogram_quantile(0.95, rate(envoy_cluster_upstream_rq_time_bucket{kuma_io_services=~\".*$service.*\",kuma_io_zone=~\"$zone\",mesh=\"$mesh\",envoy_cluster_name=~\"localhost_.*\"}[1m])))",
               "hide": false,
               "legendFormat": "p95",
               "refId": "C"
            },
            {
               "expr": "max(histogram_quantile(0.50, rate(envoy_cluster_upstream_rq_time_bucket{kuma_io_services=~\".*$service.*\",kuma_io_zone=~\"$zone\",mesh=\"$mesh\",envoy_cluster_name=~\"localhost_.*\"}[1m])))",
               "hide": false,
               "legendFormat": "p50",
               "refId": "D"
            }
         ],
         "title": "Latency",
         "type": "timeseries"
      },
      {
         "datasource": {
            "type": "prometheus",
            "uid": "${DS_PROMETHEUS}"
         },
         "id": 7,
         "targets": [
            {
               "expr": "sum(rate(envoy_cluster_upstream_rq_total{mesh=\"$mesh\",kuma_io_zone=~\"$zone\",kuma_io_services=~\".*$service.*\", envoy_cluster_name=~\"localhost_.*\"}[1m]))",
               "hide": false,
               "legendFormat": "Incoming",
               "refId": "C"
            },
            {
               "expr": "sum(rate(envoy_cluster_upstream_rq_total{mesh=\"$mesh\",kuma_io_zone=~\"$zone\",kuma_io_services=~\".*$service.*\", envoy_cluster_name!~\"localhost_.*\", envoy_cluster_name!=\"kuma_envoy_admin\",envoy_cluster_name!=\"kuma_metrics_hijacker\"}[1m]))",
               "hide": false,
               "legendFormat": "Outgoing",
               "refId": "A"
            }
         ],
         "title": "Traffic",
         "type": "timeseries"
      },
      {
         "datasource": {
            "type": "prometheus",
            "uid": "${DS_PROMETHEUS}"
         },
         "id": 8,
         "targets": [
            {
               "expr": "sum(rate(envoy_cluster_external_upstream_rq_xx{mesh=\"$mesh\",kuma_io_zone=~\"$zone\",kuma_io_services=~\".*$service.*\", envoy_cluster_name=~\"localhost_.*\"}[1m])) by (envoy_response_code_class)",
               "hide": false,
               "legendFormat": "Incoming {{envoy_response_code_class}}xx",
               "refId": "A"
            },
            {
               "expr": "sum(rate(envoy_cluster_external_upstream_rq_xx{mesh=\"$mesh\",kuma_io_zone=~\"$zone\",kuma_io_services=~\".*$service.*\", envoy_cluster_name!~\"localhost_.*\", envoy_cluster_name!=\"kuma_envoy_admin\", envoy_cluster_name!=\"kuma_metrics_hijacker\"}[1m])) by (envoy_response_code_class)",
               "hide": false,
               "legendFormat": "Outgoing {{envoy_response_code_class}}xx",
               "refId": "B"
            }
         ],
         "title": "Status codes",
         "type": "timeseries"
      },
      {
         "collapsed": false,
         "datasource": {
            "type": "prometheus",
            "uid": "${DS_PROMETHEUS}"
         },
         "id": 9,
         "panels": [ ],
         "title": "Kubernetes",
         "type": "row"
      },
      {
         "datasource": {
            "type": "prometheus",
            "uid": "${DS_PROMETHEUS}"
         },
         "id": 10,
         "targets": [
            {
               "expr": "max(sum(rate(container_cpu_usage_seconds_total[1m])) by (namespace, pod) * on (namespace, pod) group_right(kuma_io_service) envoy_server_live{kuma_io_services=~\".*$service.*\"}) by (dataplane) /\nmax(sum(kube_pod_container_resource_limits{resource=\"cpu\",unit=\"core\"}) by (namespace, pod) * on (namespace, pod) group_right(kuma_io_service) envoy_server_live{kuma_io_services=~\".*$service.*\"}) by (dataplane)",
               "hide": false,
               "legendFormat": "{{dataplane}}",
               "refId": "B"
            }
         ],
         "title": "CPU",
         "type": "timeseries"
      },
      {
         "datasource": {
            "type": "prometheus",
            "uid": "${DS_PROMETHEUS}"
         },
         "id": 11,
         "targets": [
            {
               "expr": "max(sum(container_memory_working_set_bytes{image!=\"\"}) by (namespace, pod) * on (namespace, pod) group_right(kuma_io_service) envoy_server_live{kuma_io_services=~\".*$service.*\"}) by (dataplane)",
               "hide": false,
               "legendFormat": "{{dataplane}}",
               "refId": "B"
            }
         ],
         "title": "Memory Utilization",
         "type": "timeseries"
      },
      {
         "datasource": {
            "type": "prometheus",
            "uid": "${DS_PROMETHEUS}"
         },
         "id": 12,
         "targets": [
            {
               "expr": "max(sum(container_memory_working_set_bytes) by (namespace, pod) * on (namespace, pod) group_right(kuma_io_service) envoy_server_live{kuma_io_services=~\".*$service.*\"}) by (dataplane) / max(sum(kube_pod_container_resource_limits{resource=\"memory\",unit=\"byte\"}) by (namespace, pod) * on (namespace, pod) group_right(kuma_io_service) envoy_server_live{kuma_io_services=~\".*$service.*\"}) by (dataplane)",
               "hide": false,
               "legendFormat": "{{dataplane}}",
               "refId": "A"
            }
         ],
         "title": "Memory Saturation",
         "type": "timeseries"
      }
   ],
   "refresh": "5s",
   "schemaVersion": 36,
   "style": "dark",
   "tags": [ ],
   "templating": {
      "list": [
         {
            "datasource": {
               "type": "prometheus",
               "uid": "${DS_PROMETHEUS}"
            },
            "includeAll": false,
            "label": "Mesh",
            "multi": false,
            "name": "mesh",
            "query": "label_values(envoy_server_live, mesh)",
            "type": "query"
         },
         {
            "datasource": {
               "type": "prometheus",
               "uid": "${DS_PROMETHEUS}"
            },
            "includeAll": true,
            "label": "Zone",
            "multi": true,
            "name": "zone",
            "query": "label_values(envoy_server_live{mesh=\"$mesh\"}, kuma_io_zone)",
            "type": "query"
         },
         {
            "datasource": {
               "type": "prometheus",
               "uid": "${DS_PROMETHEUS}"
            },
            "includeAll": false,
            "label": "Service",
            "multi": false,
            "name": "service",
            "query": "label_values(envoy_server_live{mesh=\"$mesh\",kuma_io_zone=~\"$zone\",kuma_io_mesh_gateway=\"\"}, kuma_io_service)",
            "type": "query"
         }
      ]
   },
   "time": {
      "from": "now-6h",
      "to": "now"
   },
   "timepicker": {
      "refresh_intervals": [
         "5s",
         "10s",
         "30s",
         "1m",
         "5m",
         "15m",
         "30m",
         "1h",
         "2h",
         "1d"
      ]
   },
   "timezone": "utc",
   "title": "Kuma Service",
   "version": 1
}
