FROM debian:11 as envoy
ARG ENVOY_VERSION
ARG ARCH

COPY /build/artifacts-linux-$ARCH/envoy/envoy-$ENVOY_VERSION-alpine /envoy

RUN apt-get update && \
    apt-get install --no-install-recommends -y libcap2-bin=1:2.44-1 && \
    setcap cap_net_bind_service+ep /envoy

FROM kumahq/base-debian11:1.0.0
ARG ARCH

COPY /build/artifacts-linux-$ARCH/kuma-dp/kuma-dp \
    /build/artifacts-linux-$ARCH/coredns/coredns \
    /usr/bin/

COPY --from=envoy /envoy /usr/bin/envoy

ENTRYPOINT ["kuma-dp"]
