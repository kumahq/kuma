openapi: 3.1.0
info:
  version: v1alpha1
  title: Kuma API
  description: Kuma API
paths:
  /meshes/{mesh}/meshtraces/{name}:
    get:
      operationId: getMeshTrace
      summary: Returns MeshTrace entity
      tags: ["MeshTrace"]
      parameters:
        - in: path
          name: mesh
          schema:
            type: string
          required: true
          description: name of the mesh
        - in: path
          name: name
          schema:
            type: string
          required: true
          description: name of the MeshTrace
      responses:
        '200':
          $ref: "#/components/responses/MeshTraceItem"
        '404':
          $ref: "../../base/specs/common/error_schema.yaml#/components/responses/NotFound"
    put:
      operationId: putMeshTrace
      summary: Creates or Updates MeshTrace entity
      tags: ["MeshTrace"]
      parameters:
        - in: path
          name: mesh
          schema:
            type: string
          required: true
          description: name of the mesh
        - in: path
          name: name
          schema:
            type: string
          required: true
          description: name of the MeshTrace
      requestBody:
        description: Put request
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MeshTraceItem'
      responses:
        '200':
          $ref: '#/components/responses/MeshTraceCreateOrUpdateSuccessResponse'
        '201':
          $ref: '#/components/responses/MeshTraceCreateOrUpdateSuccessResponse'
    delete:
      operationId: deleteMeshTrace
      summary: Deletes MeshTrace entity
      tags: ["MeshTrace"]
      parameters:
        - in: path
          name: mesh
          schema:
            type: string
          required: true
          description: name of the mesh
        - in: path
          name: name
          schema:
            type: string
          required: true
          description: name of the MeshTrace
      responses:
        '200':
          $ref: '#/components/responses/MeshTraceDeleteSuccessResponse'
        '404':
          $ref: "../../base/specs/common/error_schema.yaml#/components/responses/NotFound"
  /meshes/{mesh}/meshtraces:
    get:
      operationId: getMeshTraceList
      summary: Returns a list of MeshTrace in the mesh.
      tags: ["MeshTrace"]
      parameters:
        - in: query
          name: offset
          description: offset in the list of entities
          required: false
          schema:
            type: integer
          example: 0
        - in: query
          name: size
          description: the number of items per page
          required: false
          schema:
            type: integer
            default: 100
            maximum: 1000
            minimum: 1
        - in: query
          name: filter
          description: filter by labels when multiple filters are present, they are ANDed
          required: false
          schema:
            type: object
            properties:
              key:
                type: string
              value:
                type: string
          example:
            label.k8s.kuma.io/namespace: my-ns
        - in: path
          name: mesh
          schema:
            type: string
          required: true
          description: name of the mesh
      responses:
        '200':
          $ref: "#/components/responses/MeshTraceList"
components:
  schemas:
    MeshTraceItem:
      type: object
      required: [type, name, spec]
      properties:
        type:
          description: 'the type of the resource'
          type: string
          enum:
            - MeshTrace
        mesh:
          description: 'Mesh is the name of the Kuma mesh this resource belongs to. It may be omitted for cluster-scoped resources.'
          type: string
          default: default
        kri:
          description: 'A unique identifier for this resource instance used by internal tooling and integrations. Typically derived from resource attributes and may be used for cross-references or indexing'
          type: string
          readOnly: true
          example: 'kri_mtr_default_zone-east_kuma-demo_mypolicy1_'
        name:
          description: 'Name of the Kuma resource'
          type: string
        labels:
          additionalProperties:
            type: string
          description: 'The labels to help identity resources'
          type: object
        spec:
          description: Spec is the specification of the Kuma MeshTrace resource.
          properties:
            default:
              description: MeshTrace configuration.
              properties:
                backends:
                  description: |-
                    A one element array of backend definition.
                    Envoy allows configuring only 1 backend, so the natural way of
                    representing that would be just one object. Unfortunately due to the
                    reasons explained in MADR 009-tracing-policy this has to be a one element
                    array for now.
                  items:
                    description: Only one of zipkin, datadog or openTelemetry can be used.
                    properties:
                      datadog:
                        description: Datadog backend configuration.
                        properties:
                          splitService:
                            default: false
                            description: |-
                              Determines if datadog service name should be split based on traffic
                              direction and destination. For example, with `splitService: true` and a
                              `backend` service that communicates with a couple of databases, you would
                              get service names like `backend_INBOUND`, `backend_OUTBOUND_db1`, and
                              `backend_OUTBOUND_db2` in Datadog.
                            type: boolean
                          url:
                            description: |-
                              Address of Datadog collector, only host and port are allowed (no paths,
                              fragments etc.)
                            type: string
                        required:
                          - url
                        type: object
                      openTelemetry:
                        description: OpenTelemetry backend configuration.
                        properties:
                          endpoint:
                            description: Address of OpenTelemetry collector.
                            example: otel-collector:4317
                            minLength: 1
                            type: string
                        required:
                          - endpoint
                        type: object
                      type:
                        enum:
                          - Zipkin
                          - Datadog
                          - OpenTelemetry
                        type: string
                      zipkin:
                        description: Zipkin backend configuration.
                        properties:
                          apiVersion:
                            default: httpJson
                            description: |-
                              Version of the API.
                              https://github.com/envoyproxy/envoy/blob/v1.22.0/api/envoy/config/trace/v3/zipkin.proto#L66
                            enum:
                              - httpJson
                              - httpProto
                            type: string
                          sharedSpanContext:
                            default: true
                            description: |-
                              Determines whether client and server spans will share the same span
                              context.
                              https://github.com/envoyproxy/envoy/blob/v1.22.0/api/envoy/config/trace/v3/zipkin.proto#L63
                            type: boolean
                          traceId128bit:
                            default: false
                            description: Generate 128bit traces.
                            type: boolean
                          url:
                            description: Address of Zipkin collector.
                            type: string
                        required:
                          - url
                        type: object
                    required:
                      - type
                    type: object
                  maxItems: 1
                  type: array
                sampling:
                  description: |-
                    Sampling configuration.
                    Sampling is the process by which a decision is made on whether to
                    process/export a span or not.
                  properties:
                    client:
                      anyOf:
                        - type: integer
                        - type: string
                      description: |-
                        Target percentage of requests that will be force traced if the
                        'x-client-trace-id' header is set. Mirror of client_sampling in Envoy
                        https://github.com/envoyproxy/envoy/blob/v1.22.0/api/envoy/config/filter/network/http_connection_manager/v2/http_connection_manager.proto#L127-L133
                        Either int or decimal represented as string.
                        If not specified then the default value is 100.
                      x-kubernetes-int-or-string: true
                    overall:
                      anyOf:
                        - type: integer
                        - type: string
                      description: |-
                        Target percentage of requests will be traced
                        after all other sampling checks have been applied (client, force tracing,
                        random sampling). This field functions as an upper limit on the total
                        configured sampling rate. For instance, setting client to 100
                        but overall to 1 will result in only 1% of client requests with
                        the appropriate headers to be force traced. Mirror of
                        overall_sampling in Envoy
                        https://github.com/envoyproxy/envoy/blob/v1.22.0/api/envoy/config/filter/network/http_connection_manager/v2/http_connection_manager.proto#L142-L150
                        Either int or decimal represented as string.
                        If not specified then the default value is 100.
                      x-kubernetes-int-or-string: true
                    random:
                      anyOf:
                        - type: integer
                        - type: string
                      description: |-
                        Target percentage of requests that will be randomly selected for trace
                        generation, if not requested by the client or not forced.
                        Mirror of random_sampling in Envoy
                        https://github.com/envoyproxy/envoy/blob/v1.22.0/api/envoy/config/filter/network/http_connection_manager/v2/http_connection_manager.proto#L135-L140
                        Either int or decimal represented as string.
                        If not specified then the default value is 100.
                      x-kubernetes-int-or-string: true
                  type: object
                tags:
                  description: |-
                    Custom tags configuration. You can add custom tags to traces based on
                    headers or literal values.
                  items:
                    description: |-
                      Custom tags configuration.
                      Only one of literal or header can be used.
                    properties:
                      header:
                        description: Tag taken from a header.
                        properties:
                          default:
                            description: |-
                              Default value to use if header is missing.
                              If the default is missing and there is no value the tag will not be
                              included.
                            type: string
                          name:
                            description: Name of the header.
                            type: string
                        required:
                          - name
                        type: object
                      literal:
                        description: Tag taken from literal value.
                        type: string
                      name:
                        description: Name of the tag.
                        type: string
                    required:
                      - name
                    type: object
                  type: array
              type: object
            targetRef:
              description: |-
                TargetRef is a reference to the resource the policy takes an effect on.
                The resource could be either a real store object or virtual resource
                defined inplace.
              properties:
                kind:
                  description: Kind of the referenced resource
                  enum:
                    - Mesh
                    - MeshSubset
                    - MeshGateway
                    - MeshService
                    - MeshExternalService
                    - MeshMultiZoneService
                    - MeshServiceSubset
                    - MeshHTTPRoute
                    - Dataplane
                  type: string
                labels:
                  additionalProperties:
                    type: string
                  description: |-
                    Labels are used to select group of MeshServices that match labels. Either Labels or
                    Name and Namespace can be used.
                  type: object
                mesh:
                  description: Mesh is reserved for future use to identify cross mesh resources.
                  type: string
                name:
                  description: |-
                    Name of the referenced resource. Can only be used with kinds: `MeshService`,
                    `MeshServiceSubset` and `MeshGatewayRoute`
                  type: string
                namespace:
                  description: |-
                    Namespace specifies the namespace of target resource. If empty only resources in policy namespace
                    will be targeted.
                  type: string
                proxyTypes:
                  description: |-
                    ProxyTypes specifies the data plane types that are subject to the policy. When not specified,
                    all data plane types are targeted by the policy.
                  items:
                    enum:
                      - Sidecar
                      - Gateway
                    type: string
                  type: array
                sectionName:
                  description: |-
                    SectionName is used to target specific section of resource.
                    For example, you can target port from MeshService.ports[] by its name. Only traffic to this port will be affected.
                  type: string
                tags:
                  additionalProperties:
                    type: string
                  description: |-
                    Tags used to select a subset of proxies by tags. Can only be used with kinds
                    `MeshSubset` and `MeshServiceSubset`
                  type: object
              required:
                - kind
              type: object
          type: object
        creationTime:
          readOnly: true
          type: string
          description: 'Time at which the resource was created'
          format: date-time
          example: '0001-01-01T00:00:00Z'
        modificationTime:
          readOnly: true
          type: string
          description: 'Time at which the resource was updated'
          format: date-time
          example: '0001-01-01T00:00:00Z'
  responses:
    MeshTraceItem:
      description: Successful response
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/MeshTraceItem'
    MeshTraceList:
      description: List
      content:
        application/json:
          schema:
            type: object
            properties:
              items:
                type: array
                items:
                  $ref: "#/components/schemas/MeshTraceItem"
              total:
                type: number
                description: The total number of entities
              next:
                type: string
                description: URL to the next page
    MeshTraceCreateOrUpdateSuccessResponse:
      description: Successful response
      content:
        application/json:
          schema:
            type: object
            properties:
              warnings:
                type: array
                readOnly: true
                description: |
                  warnings is a list of warning messages to return to the requesting Kuma API clients.
                  Warning messages describe a problem the client making the API request should correct or be aware of.
                items:
                  type: string
    MeshTraceDeleteSuccessResponse:
      description: Successful response
      content:
        application/json:
          schema:
            type: object
