name: SCA
on:
  workflow_call:
    inputs:
      images:
        required: true
        type: string
        description: The JSON array of docker images / tar files to be analyzed. Must be present on disk
      artifact_name:
        required: false
        type: string
        description: The artifact name to download docker image TAR files
jobs:
  # SBOM and CVE scan for project package managers + dependent project boms
  # Any dependent SBOMs are detected (Ex: gui) using SBOM cataloger
  # Refer Syft [Configuration](https://github.com/anchore/syft?tab=readme-ov-file#configuration) is picked from .syft/config.yaml
  scan-project:
    name: Scan Project
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          fetch-depth: 0
          path: ${{ github.repository }}

      - name: Scan Project Dirs
        id: sca
        uses: Kong/public-shared-actions/security-actions/sca@b0ef627fa71528272d1daa9257b71dc90246cc46
        with:
          asset_prefix: ${{ github.repository }} # Unique asset_prefix must be specified to avoid artifact upload conflict
          dir: ${{ github.repository }}
          config: ${{ github.repository }}/.syft/config.yaml

  # SBOM and CVE scan for binaries analyzing the docker images
  scan-images:
    name: Scan Images
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        image: ${{ fromJSON(inputs.images) }}
    steps:
      - uses: actions/download-artifact@v4
        if: ${{ inputs.artifact_name != '' }}
        id: download-image-artifacts
        with:
          name: ${{ inputs.artifact_name }}
      - name: Inspect build directory
        if: ${{ inputs.artifact_name != '' }}
        run: |
          ls -alR ${{ steps.download-image-artifacts.outputs.download-path }}
      - name: Get Asset Prefix
        id: img_meta
        env:
          ARTIFACT_NAME: ${{ inputs.artifact_name }}
        run: |
          if [[ -n "${ARTIFACT_NAME}" ]]; then
            asset=$(echo ${{ matrix.image }} | rev | cut -d "/" -f 1 | rev)
            echo "asset_prefix=${asset%.*}"
            echo "asset_prefix=${asset%.*}" >> "$GITHUB_OUTPUT"
          else
            asset=$(echo ${{ matrix.image }} | cut -d ":" -f 1)
            echo "asset_prefix=${asset}" >> "$GITHUB_OUTPUT"
          fi
      - name: Scan Image
        id: sca
        uses: Kong/public-shared-actions/security-actions/scan-docker-image@b0ef627fa71528272d1daa9257b71dc90246cc46
        with:
          asset_prefix: ${{ steps.img_meta.outputs.asset_prefix }} # Unique asset_prefix must be specified to avoid artifact upload conflict
          image: ${{ matrix.image }}
