name: "Workflows & Scripts"

# Customize run name to show selected linters in manual runs (e.g., "Validate: actionlint + yamllint")
run-name: >-
  ${{
    github.event_name == 'workflow_dispatch' &&
    format('Validate: {0}{1}{2}',
      inputs.run_actionlint && 'actionlint' || '',
      inputs.run_actionlint && inputs.run_yamllint && ' + ' ||
      inputs.run_actionlint && inputs.run_shellcheck && ' + ' ||
      inputs.run_yamllint && inputs.run_shellcheck && ' + ' || '',
      inputs.run_yamllint && 'yamllint' ||
      inputs.run_shellcheck && 'shellcheck' || 'none'
    ) ||
    github.event_name
  }}

on:
  pull_request:
  workflow_dispatch:
    inputs:
      run_actionlint:
        description: 'Run actionlint'
        type: boolean
        default: true
      run_yamllint:
        description: 'Run yamllint'
        type: boolean
        default: true
      run_shellcheck:
        description: 'Run shellcheck'
        type: boolean
        default: true

permissions:
  contents: read

# Separate concurrency groups for manual vs automatic runs
# Manual: grouped by workflow name (cancels previous manual runs only)
# Automatic: grouped by ref (cancels previous runs on same branch/PR)
concurrency:
  group: >-
    ${{
      github.event_name == 'workflow_dispatch' &&
      format('{0}-manual', github.workflow) ||
      format('{0}-{1}', github.workflow, github.ref)
    }}
  cancel-in-progress: true

env:
  IS_MANUAL_RUN: ${{ github.event_name == 'workflow_dispatch' }}

jobs:
  setup:
    name: "Setup Execution Plan"
    runs-on: ubuntu-24.04
    timeout-minutes: 5
    outputs:
      should_run_actionlint: ${{ steps.plan.outputs.should_run_actionlint }}
      should_run_yamllint: ${{ steps.plan.outputs.should_run_yamllint }}
      should_run_shellcheck: ${{ steps.plan.outputs.should_run_shellcheck }}
      should_run_workflows_job: ${{ steps.plan.outputs.should_run_workflows_job }}
      should_run_shellcheck_job: ${{ steps.plan.outputs.should_run_shellcheck_job }}
      workflows_changed: ${{ steps.changes.outputs.workflows }}
      scripts_changed: ${{ steps.changes.outputs.scripts }}

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: changes
        with:
          filters: |
            workflows:
              - '.github/workflows/**'
            scripts:
              - '**/*.sh'

      - id: plan
        run: |
          IS_MANUAL_RUN="${{ env.IS_MANUAL_RUN }}"
          RUN_ACTIONLINT="${{ inputs.run_actionlint || 'false' }}"
          RUN_YAMLLINT="${{ inputs.run_yamllint || 'false' }}"
          RUN_SHELLCHECK="${{ inputs.run_shellcheck || 'false' }}"
          WORKFLOWS_CHANGED="${{ steps.changes.outputs.workflows }}"
          SCRIPTS_CHANGED="${{ steps.changes.outputs.scripts }}"

          if [[ "$IS_MANUAL_RUN" == "true" ]]; then
            {
              echo "should_run_actionlint=$RUN_ACTIONLINT"
              echo "should_run_yamllint=$RUN_YAMLLINT"
              echo "should_run_shellcheck=$RUN_SHELLCHECK"
              if [[ "$RUN_ACTIONLINT" == "true" || "$RUN_YAMLLINT" == "true" ]]; then
                echo "should_run_workflows_job=true"
              else
                echo "should_run_workflows_job=false"
              fi
              echo "should_run_shellcheck_job=$RUN_SHELLCHECK"
            } >> "$GITHUB_OUTPUT"
          else
            {
              echo "should_run_actionlint=true"
              echo "should_run_yamllint=true"
              echo "should_run_shellcheck=true"
              echo "should_run_workflows_job=$WORKFLOWS_CHANGED"
              echo "should_run_shellcheck_job=$SCRIPTS_CHANGED"
            } >> "$GITHUB_OUTPUT"
          fi

  workflows:
    name: "Validate Workflows"
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    needs: setup
    if: needs.setup.outputs.should_run_workflows_job == 'true'
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Generate GitHub App Token
        id: github-app-token
        uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42 # v2.1.4
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - uses: reviewdog/action-yamllint@f01d8a48fd8d89f89895499fca2cff09f9e9e8c0 # v1.21.0
        if: needs.setup.outputs.should_run_yamllint == 'true'
        with:
          github_token: ${{ steps.github-app-token.outputs.token }}
          reporter: github-pr-review
          fail_level: error
          filter_mode: diff_context
          yamllint_flags: "-d relaxed .github/workflows"

      - uses: reviewdog/action-actionlint@f00ad0691526c10be4021a91b2510f0a769b14d0 # v1.68.0
        if: always() && needs.setup.outputs.should_run_actionlint == 'true'
        with:
          github_token: ${{ steps.github-app-token.outputs.token }}
          reporter: github-pr-review
          fail_level: error
          filter_mode: diff_context

  shellcheck:
    name: "Validate Shell Scripts"
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    needs: setup
    if: needs.setup.outputs.should_run_shellcheck_job == 'true'

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Generate GitHub App Token
        id: github-app-token
        uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42 # v2.1.4
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - uses: reviewdog/action-shellcheck@4c07458293ac342d477251099501a718ae5ef86e # v1.32.0
        if: needs.setup.outputs.should_run_shellcheck == 'true'
        with:
          github_token: ${{ steps.github-app-token.outputs.token }}
          reporter: github-pr-review
          fail_level: error
          filter_mode: diff_context
          shellcheck_flags: "-P SCRIPTDIR -x"
          pattern: "*.sh"

  summary:
    name: "Validation Summary"
    runs-on: ubuntu-24.04
    needs: [setup, workflows, shellcheck]
    if: always()
    env:
      WORKFLOWS_JOB_RAN: ${{ needs.setup.outputs.should_run_workflows_job }}
      SHELLCHECK_JOB_RAN: ${{ needs.setup.outputs.should_run_shellcheck_job }}
      WORKFLOWS_RESULT: ${{ needs.workflows.result }}
      SHELLCHECK_RESULT: ${{ needs.shellcheck.result }}
    steps:
      - run: |
          if [[ "$WORKFLOWS_JOB_RAN" != "true" && "$SHELLCHECK_JOB_RAN" != "true" ]]; then
            echo "No workflows or scripts to validate - skipping"
            exit 0
          fi

          if [[ "$WORKFLOWS_RESULT" == "failure" || "$SHELLCHECK_RESULT" == "failure" ]]; then
            echo "Validation failed"
            exit 1
          fi

          echo "Validation passed"
