name: "Update docs"
on:
  push:
    paths:
      - CHANGELOG.md
      - versions.yml
      - UPGRADE.md
      - docs/generated/raw/**
    branches: ["master"]
  workflow_dispatch: {}
  schedule:
    - cron: 0 8 * * *
env:
  DOCS_REPO: kuma-website
  OUTPUT_PATH: app/assets
  VERSION_FILE: app/_data/versions.yml
  EDITION: kuma
permissions:
  contents: read
jobs:
  active-branches:
    uses: ./.github/workflows/_get-active-branches.yaml
  generate-docs:
    needs: active-branches
    timeout-minutes: 10
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          ref: master
          path: repo
      - uses: jdx/mise-action@c53b9236f0b3370f31520f8b142f141256d839c6 # v3.6.0
        env:
          GITHUB_TOKEN: ${{ github.token }}
      - name: "sync docs" # loop over all the branches and generate the docs
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
          GH_DEBUG: ${{ runner.debug == '1' }}
          BRANCHES: ${{ needs.active-branches.outputs.out }}
        run: |
          [[ "${GH_DEBUG}" == "1" ]] && set -x
          set -euo pipefail
          cd repo

          # Use active branches from reusable workflow output
          # shellcheck disable=SC2153
          branches="${BRANCHES}"
          
          # Loop over branches and generate docs
          jq -r '.[]' <<< "$branches" | while read -r b; do
            name="$(echo "$b" | sed 's/^release-\(.*\)/\1.x/' | sed 's/^master$/dev/')"
            echo "Processing branch $b -> $name"

            git checkout --force "$b"
            mkdir -p "../docs-build/${name}/raw"
            cp -R docs/generated/raw "../docs-build/${name}/"

            mkdir -p ../docs-build/raw
            if [[ "$b" == "master" ]]; then
              [[ -f UPGRADE.md ]] && cp UPGRADE.md ../docs-build/raw/
              [[ -f CHANGELOG.md ]] && cp CHANGELOG.md ../docs-build/raw/
              [[ -f versions.yml ]] && cp versions.yml ../docs-build/raw/
            fi
          done
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          repository: ${{ github.repository_owner }}/${{ env.DOCS_REPO }}
          path: docs
      - name: "update versions"
        run: |
          cd docs
          cp -R ../docs-build/* ${{ env.OUTPUT_PATH }}/
          yq -i 'del(.[] | select(.edition == "${{ env.EDITION }}")) | . += load("${{ env.OUTPUT_PATH}}/raw/versions.yml")' ${{ env.VERSION_FILE }}
          rm ${{ env.OUTPUT_PATH }}/raw/versions.yml
      - name: Generate GitHub app token
        id: github-app-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: ${{ env.DOCS_REPO }}
      - name: "Create Pull Request"
        uses: peter-evans/create-pull-request@98357b18bf14b5342f975ff684046ec3b2a07725 # v8.0.0
        with:
          path: docs
          commit-message: "chore(deps): update docs from repo source"
          signoff: true
          branch: chore/docs-sync-${{github.repository}}
          body: |
            Syncing docs from source code.

            Generated by [action](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          delete-branch: true
          title: "chore(deps): update docs from repo source"
          draft: false
          token: ${{ steps.github-app-token.outputs.token }}
          committer: kumahq[bot] <110050114+kumahq[bot]@users.noreply.github.com>
          author: kumahq[bot] <110050114+kumahq[bot]@users.noreply.github.com>
