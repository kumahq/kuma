# SNI for MeshService, MeshExternalService etc.

* Status: accepted

## Context and Problem Statement

Currently, the SNI format is `<kuma.io/service>{mesh=<mesh>,tag1=value1}`. For example:
* `backend{mesh=demo}`
* `backend{mesh=demo,version=2}`

We need to introduce SNI format for `MeshService` and `MeshExternalService` etc.
Current format does not work, because we need to differentiate between `kuma.io/service` and MeshService.
Current format also has other problems:
* It violates [SNI spec](https://datatracker.ietf.org/doc/html/rfc3546#page-8). It should be a valid hostname. Using characters like `,{/` is not valid.
  Envoy does not complain about it right now, but it can bite us in the future.
* It can be too long. See https://github.com/kumahq/kuma/issues/8915

## Considered Options

* New format

## Decision Outcome

Chosen option: "New format", because it solves existing problem and lets us differentiate MeshService from old service.

## Pros and Cons of the Options

### New format

It's important to note that we never parse SNI. We only use it for multizone communication on zone proxies to associate to which service pass the data.
It means that we can hash the data as long as it's consistent hashing.
We cannot put tags in the original form because they can violate hostname requirements. For example `/` in `kuma.io/service` is not ok.
The new format could look like this then:
`<resource-name>.<mesh-name>.<extra-hash-if-needed>.<resource-type>`
* `<resource-name>` - (required) name of the resource. Name of MeshService or MeshExternalService
* `<mesh-name>` - (required) name of the mesh
* `<extra-hash-if-needed>` - (optional) 16 characters of SHA256. In case of MeshService tags it's `SHA256(<tag1>=<value1>,<tag2>=<value2>)` sorted by keys.
* `<resource-type>` - (required) `ms` (MeshService) or `mes` (MeshExternalService)

Examples:
* `backend.demo.ms` - MeshService named `backend` in `demo` mesh
* `redis.kuma-demo.default.ms` - MeshService named `redis` in `kuma-demo` namespace in `default` mesh
* `google.default.mes` - MeshExternalService named `google` in `default` mesh
* `backend.demo.e3b0c44298fc1c.ms` - subset of MeshService named `backend` in `demo` mesh for tags `version=v2`

Resource name can be at most 255 chars long. Mesh should not be longer than 64 chars.
If we go over the limit we compute SHA256 hash `<resource-name>.<mesh-name>.<extra-hash-if-needed>`.
For example:
* `super-long-name-aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa.default.e3b0c44298fc1c14.ms`
  Changes to `e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.ms`

The format is only relevant for the new resources (MeshService, MeshExternalService, MeshMultizoneService),
we don't want to modify existing format to avoid breaking changes.

Advantages:
* It solves existing problems

Disadvantages:
* We can lose a bit of visibility if we just look at SNI, because we always hash tags (or even everything).
  However, it's still clear what specific filter chain of the SNI points to by cluster name and LB subset. 
