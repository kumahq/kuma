# Certificate Authority rotation

## Context

Kuma helps us secure connections between the applications by applying mTLS.
To do this, we need to specify a backend (for example - builtin) and then enable this backend in the Mesh policy.
Right now, Kuma does not support backend rotation. Whenever we need to change the backend, we need to disable mTLS and enable new backend.
This means that for short period of time we will experience connection problems because data plane proxies' configs are not evenly propagated at the same time.
Technically this problem can be mitigated by using retries etc. However, the goal of this proposal is to introduce CA rotation which is a way to change mTLS backend without any downtime.

## Requirements

* Data plane proxy certificates should be generated by using one specified backend.
* Data plane proxy should support connection verification against many backends.

## UX

Assuming there is already mTLS enabled

```yaml
apiVersion: kuma.io/v1alpha1
kind: Mesh
metadata:
  name: default
spec:
  mtls:
    enabledBackend: ca-1
    backends:
      - name: ca-1
        type: builtin
```

If we want to switch mTLS backend, we need to
* Define a new backend.
* Change `enabledBackend`.
* Specify old backend in `secondaryBackends`.

All 3 steps can be applied as a one policy change

```yaml
apiVersion: kuma.io/v1alpha1
kind: Mesh
metadata:
  name: default
spec:
  mtls:
    enabledBackend: ca-2
    secondaryBackends:
      - ca-1
    backends:
      - name: ca-1
        type: builtin
      - name: ca-2
        type: provided
        dpCert:
          rotation:
            expiration: 1d
        conf:
          cert:
            secret: name-of-secret
          key:
            secret: name-of-secret
```

After a while when all data plane proxies will acquire new certs, we can remove the old backend

```yaml
apiVersion: kuma.io/v1alpha1
kind: Mesh
metadata:
  name: default
spec:
  mtls:
    enabledBackend: ca-2
    backends:
      - name: ca-2
        type: provided
        dpCert:
          rotation:
            expiration: 1d
        conf:
          cert:
            secret: name-of-secret
          key:
            secret: name-of-secret
```

### DP cert backend indication

How can we know that all data plane proxies obtained certificates from the new mTLS backend?

In the `DataplaneInsight`, we can add what is the mTLS backend that was used to generate cert.
Then, in the `MeshInsight` we can aggregate statistics for every mesh.
As a last step, present those statistics in a pie chart on the GUI.

## Implementation notes

* I did a PoC and Envoy supports many CA certs in one SDS secret.
* Almost the whole logic of SDS stays the same. We just need to take into account other CA certs.

## Multizone

The feature works the same way both on Standalone and Multizone

## Backwards compatibility

The feature is backwards compatible since we are keeping `enabledBackend` property.
